<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Raoni Queiroz · Simulador de Investimentos</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 32 32'><rect width='32' height='32' rx='8' fill='%23111418'/><polyline points='4,24 10,16 16,20 22,10 28,14' stroke='%233dd68c' stroke-width='2.5' fill='none' stroke-linecap='round' stroke-linejoin='round'/></svg>">
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;0,9..144,900;1,9..144,300&family=Inter:wght@400;500;600;700&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
/* temas */
:root {
  --bg:#070809;--panel:#0d0f12;--card:#111418;--border:#1c2028;--border2:#252a33;
  --text:#dde2ea;--muted:#7a8b9e;--footer-text:#252e3a;
  --chart-grid:#0c1016;--chart-tick:#2a3545;--tooltip-bg:#111418;
  --green:#3dd68c;--green-faint:rgba(61,214,140,.08);
  --yellow:#f5c518;--yellow-faint:rgba(245,197,24,.08);
  --orange:#f07b3a;--orange-faint:rgba(240,123,58,.08);
  --blue:#5b9cf6;--blue-faint:rgba(91,156,246,.08);
  --violet:#a88bfa;--violet-faint:rgba(168,139,250,.08);
  --red:#f26065;--red-faint:rgba(242,96,101,.08);
  --teal:#2dd4bf;--teal-faint:rgba(45,212,191,.08);
  --radius:12px;--radius-sm:8px;--shadow:0 4px 24px rgba(0,0,0,.32);--shadow-sm:0 2px 10px rgba(0,0,0,.22);
}
:root[data-theme="light"] {
  --bg:#f8f9fb;--panel:#f0f2f5;--card:#fff;--border:#dde1e8;--border2:#c8cdd7;
  --text:#1a1e26;--muted:#7a8597;--footer-text:#b0b8c8;
  --chart-grid:#edf0f4;--chart-tick:#b0b8c8;--tooltip-bg:#fff;
  --green:#179e5f;--green-faint:rgba(23,158,95,.07);
  --yellow:#c49800;--yellow-faint:rgba(196,152,0,.08);
  --orange:#c45a15;--orange-faint:rgba(196,90,21,.08);
  --blue:#2c6fd4;--blue-faint:rgba(44,111,212,.08);
  --violet:#6d4fc7;--violet-faint:rgba(109,79,199,.08);
  --red:#c4383c;--red-faint:rgba(196,56,60,.08);
  --teal:#0e9488;--teal-faint:rgba(14,148,136,.08);
  --radius:12px;--radius-sm:8px;--shadow:0 4px 24px rgba(0,0,0,.07);--shadow-sm:0 2px 10px rgba(0,0,0,.05);
}


*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'Inter',system-ui,sans-serif;font-size:13px;line-height:1.6;min-height:100vh;-webkit-font-smoothing:antialiased;}


.page-nav {
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);background:var(--panel);
  padding:0 40px;height:52px;position:sticky;top:0;z-index:200;
}
.nav-left{display:flex;align-items:center;gap:10px;}
.nav-brand{font-family:'Inter',sans-serif;font-size:15px;font-weight:700;color:var(--text);letter-spacing:-.3px;}
.nav-brand span{color:var(--green);}
.nav-active-label{font-family:'Inter',sans-serif;font-size:10px;letter-spacing:.5px;font-weight:500;color:var(--muted);}

/* Hamburger button */
.hamburger-btn {
  background:var(--card);border:1px solid var(--border);color:var(--muted);
  font-family:'Inter',sans-serif;font-size:11px;font-weight:500;padding:7px 14px;
  cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .2s;
  position:relative;border-radius:var(--radius-sm);
}
.hamburger-btn:hover{border-color:var(--border2);color:var(--text);}
.hamburger-btn.open{border-color:var(--green);color:var(--green);}
.hamburger-icon{display:flex;flex-direction:column;gap:4px;width:16px;}
.hamburger-icon span{display:block;height:1.5px;background:currentColor;transition:all .25s;border-radius:1px;}
.hamburger-btn.open .hamburger-icon span:nth-child(1){transform:translateY(5.5px) rotate(45deg);}
.hamburger-btn.open .hamburger-icon span:nth-child(2){opacity:0;transform:scaleX(0);}
.hamburger-btn.open .hamburger-icon span:nth-child(3){transform:translateY(-5.5px) rotate(-45deg);}

/* Dropdown */
.nav-dropdown {
  position:absolute;top:52px;left:0;
  background:var(--panel);border:1px solid var(--border);border-top:none;
  min-width:280px;display:none;flex-direction:column;
  box-shadow:var(--shadow);border-radius:0 0 var(--radius) var(--radius);
  z-index:300;overflow:hidden;
}
.nav-dropdown.open{display:flex;}
.nav-dropdown-item {
  display:flex;align-items:center;gap:12px;
  padding:14px 20px;border:none;background:transparent;
  color:var(--muted);font-family:'Inter',sans-serif;font-size:12px;
  cursor:pointer;text-align:left;transition:all .15s;border-bottom:1px solid var(--border);
  letter-spacing:0;
}
.nav-dropdown-item:last-child{border-bottom:none;}
.nav-dropdown-item:hover{background:var(--card);color:var(--text);}
.nav-dropdown-item.active{color:var(--green);background:var(--green-faint);}
.nav-dropdown-item .nav-icon{font-size:14px;flex-shrink:0;transition:color .15s;width:28px;height:28px;border-radius:8px;display:flex;align-items:center;justify-content:center;}

/* cores dos ícones do menu */
#menu-simulador .nav-icon { color: var(--green);  background: var(--green-faint);  }
#menu-crf       .nav-icon { color: var(--teal);   background: var(--teal-faint);   }
#menu-reserva   .nav-icon { color: var(--blue);   background: var(--blue-faint);   }
#menu-acoes     .nav-icon { color: var(--violet);  background: var(--violet-faint); }
#menu-rebalance .nav-icon { color: var(--blue);   background: var(--blue-faint);   }
#menu-meta      .nav-icon { color: var(--red);    background: var(--red-faint);    }
#menu-preco     .nav-icon { color: var(--yellow);  background: var(--yellow-faint); }
#menu-divs      .nav-icon { color: var(--green);  background: var(--green-faint);  }
#menu-fire      .nav-icon { color: var(--orange);  background: var(--orange-faint); }
.nav-dropdown-item .nav-item-text{display:flex;flex-direction:column;gap:2px;}
.nav-dropdown-item .nav-item-label{font-size:12px;font-weight:500;}
.nav-dropdown-item .nav-item-desc{font-size:10px;color:var(--muted);letter-spacing:0;}
.nav-dropdown-item.active .nav-item-desc{color:var(--green);opacity:.7;}

.nav-right{display:flex;align-items:center;gap:10px;}
.theme-btn {
  background:var(--card);border:1px solid var(--border);color:var(--muted);
  font-family:'Inter',sans-serif;font-size:10px;font-weight:500;padding:6px 13px;cursor:pointer;
  letter-spacing:0;display:flex;align-items:center;gap:6px;transition:all .2s;border-radius:var(--radius-sm);
}
.theme-btn:hover{border-color:var(--border2);color:var(--text);}

/* --- SHARED: HEADER --- */
.header{padding:36px 40px 24px;border-bottom:1px solid var(--border);position:relative;overflow:hidden;}
.header::before{content:'';position:absolute;top:-40px;right:-40px;width:280px;height:280px;
  background:radial-gradient(circle,rgba(61,214,140,.05) 0%,transparent 70%);pointer-events:none;}
.header-eyebrow{font-family:'Inter',sans-serif;font-size:9px;letter-spacing:1px;text-transform:uppercase;font-weight:700;color:var(--green);margin-bottom:10px;}
.header h1{font-family:'Fraunces',serif;font-size:clamp(24px,4vw,46px);font-weight:900;line-height:1.05;max-width:700px;}
.header h1 em{font-style:italic;color:var(--green);}
.header-sub{font-family:'Inter',sans-serif;margin-top:10px;font-size:13px;color:var(--muted);max-width:600px;line-height:1.7;}

/* inputs */
.inputs-section-label{width:100%;padding:7px 24px;font-family:'Inter',sans-serif;font-size:9px;letter-spacing:.4px;font-weight:600;
  color:var(--muted);background:var(--panel);border-bottom:1px solid var(--border);border-top:1px solid var(--border);}
.inputs-bar{display:flex;flex-wrap:wrap;border-bottom:1px solid var(--border);}
.input-group{display:flex;flex-direction:column;gap:5px;padding:14px 22px;border-right:1px solid var(--border);flex:1;min-width:120px;}
.input-group label{font-family:'Inter',sans-serif;font-size:9px;letter-spacing:.5px;text-transform:uppercase;font-weight:600;color:var(--muted);}
.input-group input[type=number]{background:transparent;border:none;color:var(--text);padding:4px 0;
  font-family:'Fraunces',serif;font-size:20px;font-weight:600;width:100%;outline:none;cursor:pointer;
  -moz-appearance:textfield;}
.input-group input[type=number]::-webkit-inner-spin-button,
.input-group input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;}
.input-group input[type=number]:focus{color:var(--green);}
.input-note{font-family:'Inter',sans-serif;font-size:10px;color:var(--muted);line-height:1.5;}

/* MODE PILLS */
.mode-pill{font-family:'Inter',sans-serif;font-size:8px;font-weight:500;padding:3px 9px;border:1px solid var(--border);background:var(--card);
  color:var(--muted);cursor:pointer;transition:all .15s;white-space:nowrap;border-radius:20px;}
.mode-pill:hover{border-color:var(--border2);color:var(--text);}
.mode-pill.active{background:var(--blue-faint);border-color:var(--blue);color:var(--blue);}
.rate-result{color:var(--blue)!important;font-size:10px!important;}

/* IR PILLS */
.ir-pills{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px;}
.ir-pill{font-size:9px;padding:3px 7px;border:1px solid var(--border);background:var(--card);
  color:var(--muted);cursor:pointer;transition:all .15s;font-family:'DM Mono',monospace;white-space:nowrap;}
.ir-pill:hover{border-color:var(--border2);color:var(--text);}
.ir-pill.active{background:var(--teal-faint);border-color:var(--teal);color:var(--teal);}

/* TOGGLE BAR */
.div-toggle-bar{padding:12px 40px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:20px;flex-wrap:wrap;background:var(--panel);}
.div-toggle-label{font-family:'Inter',sans-serif;font-size:9px;letter-spacing:.5px;font-weight:600;text-transform:uppercase;color:var(--muted);flex-shrink:0;}
.toggle-wrap{display:flex;align-items:center;gap:10px;}
.toggle-switch{position:relative;width:44px;height:22px;cursor:pointer;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;position:absolute;}
.toggle-track{position:absolute;inset:0;background:var(--border2);border-radius:11px;transition:background .25s;}
.toggle-switch input:checked+.toggle-track{background:var(--green);}
.toggle-thumb{position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .25s;pointer-events:none;}
.toggle-switch input:checked~.toggle-thumb{transform:translateX(22px);}
.toggle-label-text{font-family:'Inter',sans-serif;font-size:11px;font-weight:500;color:var(--muted);transition:color .2s;}
.toggle-label-text.on{color:var(--green);}
.div-description{font-family:'Inter',sans-serif;font-size:10px;color:var(--muted);margin-left:auto;border-left:1px solid var(--border);padding-left:16px;max-width:400px;line-height:1.6;}
.div-description .tag-on{color:var(--green);}
.div-description .tag-off{color:var(--orange);}

/* --- MAIN GRID (chart + sidebar) --- */
.main{display:flex;flex-direction:column;align-items:center;padding:24px 40px 0;border-bottom:1px solid var(--border);}
.chart-area{width:100%;max-width:820px;padding:0;}
.section-label{font-family:'Inter',sans-serif;font-size:9px;letter-spacing:.5px;font-weight:700;text-transform:uppercase;color:var(--muted);
  margin-bottom:18px;display:flex;align-items:center;gap:12px;}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.chart-wrap{position:relative;height:190px;width:100%;overflow:hidden;}
.chart-wrap canvas{max-width:100%;}
.chart-note{font-family:'Inter',sans-serif;font-size:9px;color:var(--muted);margin-top:10px;line-height:1.7;}

/* LEGEND */
.legend-grid{display:flex;flex-wrap:wrap;gap:5px 18px;margin-top:18px;}
.legend-item{display:flex;align-items:center;gap:7px;font-size:10px;color:var(--muted);cursor:pointer;transition:color .2s;user-select:none;}
.legend-item:hover{color:var(--text);}
.legend-item.dimmed{opacity:.3;}
.legend-line{width:20px;height:2px;border-radius:1px;flex-shrink:0;}

/* SIDEBAR */
.sidebar{width:100%;padding:12px 0 24px;}
.ranking-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;padding:0 0 0 2px;}
.ranking-header .section-label{margin-bottom:0;}
.milestone-tabs{display:flex;gap:3px;flex-wrap:wrap;}
.tab-btn{flex:1;min-width:28px;background:var(--card);border:1px solid var(--border);color:var(--muted);
  font-family:'Inter',sans-serif;font-size:10px;font-weight:500;padding:6px 4px;cursor:pointer;transition:all .2s;text-align:center;border-radius:var(--radius-sm);}
.tab-btn.active{background:var(--green-faint);border-color:var(--green);color:var(--green);}
.tab-btn:hover:not(.active){border-color:var(--border2);color:var(--text);}
.ranking{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:6px;}

/* RANK CARDS */
.rank-card{background:var(--card);border:1px solid var(--border);padding:10px 12px;position:relative;transition:all .2s;border-radius:var(--radius-sm);}
.rank-card:hover{border-color:var(--border2);box-shadow:var(--shadow-sm);transform:translateY(-1px);}
.rank-card.rank-1{border-color:rgba(61,214,140,.3);background:var(--green-faint);}
.rank-card.rank-2{border-color:rgba(91,156,246,.2);}
.rank-pos{position:absolute;top:5px;right:7px;font-family:'Fraunces',serif;font-size:18px;font-weight:900;color:var(--border2);line-height:1;}
.rank-card.rank-1 .rank-pos{color:rgba(61,214,140,.15);}
.rank-name{font-family:'Inter',sans-serif;font-size:11px;font-weight:500;color:var(--text);margin-bottom:2px;display:flex;align-items:center;gap:5px;padding-right:22px;}
.rank-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.rank-rate{font-family:'Inter',sans-serif;font-size:9px;color:var(--muted);margin-bottom:4px;}
.rank-fv{font-family:'Fraunces',serif;font-size:17px;font-weight:600;line-height:1;}
.rank-fv small{font-size:10px;font-weight:300;margin-right:1px;}
.rank-net{display:flex;flex-direction:column;gap:1px;margin-top:3px;padding-top:4px;border-top:1px solid var(--border);}
.rank-net-val{font-size:10px;color:var(--muted);}
.rank-net-label{font-size:7px;color:var(--border2);letter-spacing:.5px;}
.rank-detail{display:flex;gap:8px;margin-top:4px;flex-wrap:wrap;}
.rank-stat{display:flex;flex-direction:column;gap:1px;}
.rank-stat-label{font-family:'Inter',sans-serif;font-size:7px;letter-spacing:.5px;font-weight:600;text-transform:uppercase;color:var(--muted);}
.rank-stat-val{font-size:9px;color:var(--text);}
.rank-stat-val.pos{color:var(--green);}
.rank-stat-val.warn{color:var(--yellow);}
.rank-stat-val.risk{color:var(--orange);}

/* caveats */
.caveats{padding:28px 40px;border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;}
.caveat-card{padding:18px 20px;border:1px solid var(--border);background:var(--panel);border-radius:var(--radius);transition:box-shadow .2s;}
.caveat-badge{font-family:'Inter',sans-serif;display:inline-flex;align-items:center;gap:5px;font-size:8px;letter-spacing:.5px;font-weight:700;text-transform:uppercase;margin-bottom:8px;padding:3px 8px;border-radius:6px;}
.caveat-badge.green{background:var(--green-faint);color:var(--green);border:1px solid rgba(61,214,140,.2);}
.caveat-badge.yellow{background:var(--yellow-faint);color:var(--yellow);border:1px solid rgba(245,197,24,.2);}
.caveat-badge.blue{background:var(--blue-faint);color:var(--blue);border:1px solid rgba(91,156,246,.2);}
.caveat-badge.red{background:var(--red-faint);color:var(--red);border:1px solid rgba(242,96,101,.2);}
.caveat-badge.teal{background:var(--teal-faint);color:var(--teal);border:1px solid rgba(45,212,191,.2);}
.caveat-title{font-family:'Inter',sans-serif;font-size:12px;font-weight:600;color:var(--text);margin-bottom:6px;}
.caveat-body{font-family:'Inter',sans-serif;font-size:10px;color:var(--muted);line-height:1.8;}

/* --- RESERVA DE EMERGÊNCIA --- */
#tab-reserva .header::before{
  background:radial-gradient(circle,rgba(91,156,246,.06) 0%,transparent 70%);
}
.res-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;border-bottom:1px solid var(--border);}
.res-inputs{padding:32px 40px;border-right:1px solid var(--border);}
.res-charts{padding:32px 40px;}

.res-section-title{font-family:'Inter',sans-serif;font-size:9px;letter-spacing:.5px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:20px;display:flex;align-items:center;gap:12px;}
.res-section-title::after{content:'';flex:1;height:1px;background:var(--border);}

.res-input-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;}
.res-input-group{display:flex;flex-direction:column;gap:5px;}
.res-input-group label{font-family:'Inter',sans-serif;font-size:9px;letter-spacing:.5px;font-weight:600;text-transform:uppercase;color:var(--muted);}
.res-input-group input[type=number]{background:var(--card);border:1px solid var(--border);color:var(--text);
  font-family:'Fraunces',serif;font-size:20px;font-weight:600;padding:10px 14px;outline:none;width:100%;
  -moz-appearance:textfield;transition:border-color .2s;border-radius:var(--radius-sm);}
.res-input-group input[type=number]::-webkit-inner-spin-button,
.res-input-group input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;}
.res-input-group input[type=number]:focus{border-color:var(--blue);}
.res-input-group .input-note{font-family:'Inter',sans-serif;font-size:10px;color:var(--muted);line-height:1.5;}

/* Filhos toggle */
.filhos-toggle-row{display:flex;align-items:center;gap:14px;margin-bottom:20px;padding:12px 16px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);}
.filhos-toggle-label{font-size:11px;color:var(--text);flex:1;}
.filhos-toggle-sub{font-size:9px;color:var(--muted);}

/* Result box */
.res-result-box{background:var(--card);border:1px solid var(--border);padding:20px;margin-top:20px;border-radius:var(--radius);}
.res-result-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;}
.res-result-item{padding:12px 16px;border-right:1px solid var(--border);}
.res-result-item:last-child{border-right:none;}
.res-result-label{font-family:'Inter',sans-serif;font-size:8px;letter-spacing:.5px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.res-result-value{font-family:'Fraunces',serif;font-size:22px;font-weight:700;line-height:1.1;}
.res-result-value.highlight{color:var(--blue);}
.res-result-value.ok{color:var(--green);}
.res-result-value.warn{color:var(--orange);}
.res-result-sub{font-size:9px;color:var(--muted);margin-top:3px;}

/* Progress bar */
.res-progress-wrap{margin-top:16px;}
.res-progress-label{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:6px;}
.res-progress-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.res-progress-fill{height:100%;border-radius:3px;transition:width .6s ease;background:var(--blue);}
.res-progress-fill.done{background:var(--green);}

/* Chart containers */
.res-donut-wrap{position:relative;height:220px;margin-bottom:24px;width:100%;overflow:hidden;}
.res-donut-wrap canvas{max-width:100%;}
.res-line-wrap{position:relative;height:200px;width:100%;overflow:hidden;}
.res-line-wrap canvas{max-width:100%;}
.res-chart-title{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}

/* Expert tips */
.expert-tips{padding:24px 40px;border-top:1px solid var(--border);background:var(--panel);}
.expert-tips-title{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.expert-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;}
.expert-card{padding:16px 18px;border:1px solid var(--border);background:var(--card);border-radius:var(--radius-sm);}
.expert-name{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--blue);margin-bottom:4px;}
.expert-text{font-family:'Inter',sans-serif;font-size:10px;color:var(--muted);line-height:1.8;}


.ac-main{display:flex;flex-direction:column;border-bottom:1px solid var(--border);}
.ac-chart-area{padding:20px 0 16px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;align-items:center;}
.ac-chart-wrap{position:relative;height:190px;width:min(820px,100%);overflow:hidden;}
.ac-chart-wrap canvas{max-width:100%;}
.ac-scenarios{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;}

.ac-scenario-card{background:var(--card);border-right:1px solid var(--border);padding:16px 20px;transition:background .2s;}
.ac-scenario-card:last-of-type{border-right:none;}
.ac-scenario-card:hover{background:var(--panel);}
.ac-scenario-card.rank-1{background:var(--green-faint);}

.ac-sc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.ac-sc-badge{font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;border:1px solid;font-family:'DM Mono',monospace;}
.ac-sc-growth{font-size:10px;color:var(--muted);}

.ac-sc-body{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:1px solid var(--border);padding-top:10px;}
.ac-sc-col{padding-right:12px;}
.ac-sc-col:last-child{padding-right:0;border-left:1px solid var(--border);padding-left:12px;}
.ac-sc-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.ac-sc-val{font-family:'Fraunces',serif;font-size:22px;font-weight:700;line-height:1.1;}
.ac-sc-val-net{font-family:'Fraunces',serif;font-size:18px;font-weight:600;color:var(--muted);line-height:1.1;}
.ac-sc-detail{font-size:9px;color:var(--muted);margin-top:8px;line-height:1.6;border-top:1px solid var(--border);padding-top:7px;}

/* Dividend projection row */
.ac-dividends-section{border-top:1px solid var(--border);}
.ac-div-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:0;border-top:1px solid var(--border);margin-top:14px;}
.ac-div-cell{padding:12px 16px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.ac-div-cell:last-child{border-right:none;}
.ac-div-year{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.ac-div-val{font-family:'Fraunces',serif;font-size:16px;font-weight:600;color:var(--violet);}
.ac-div-monthly{font-size:9px;color:var(--muted);margin-top:2px;}

@media(max-width:900px){
  .ac-scenarios{grid-template-columns:1fr;}
}

/* --- REBALANCEAMENTO DE CARTEIRA --- */
.rb-options-bar{padding:8px 40px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
.rb-opt-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;}
.rb-opt-toggle input{display:none;}
.rb-opt-box{display:flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--border);background:var(--card);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.5px;color:var(--text);transition:all .2s;}
.rb-opt-toggle input:checked ~ .rb-opt-box{border-color:var(--green);color:var(--green);background:var(--green-faint);}
.rb-opt-dot{display:inline-block;width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.rb-opt-sub{font-size:9px;color:var(--muted);}

.rb-profiles-bar{padding:0 40px;border-bottom:1px solid var(--border);}
.rb-profile-header{display:grid;grid-template-columns:180px 1fr 1fr 1fr;gap:0;padding:8px 0 6px;border-bottom:1px solid var(--border);}
.rb-ph-empty{}
.rb-ph-label{font-family:'Inter',sans-serif;font-size:10px;letter-spacing:.3px;font-weight:600;text-transform:uppercase;padding:0 12px;}
.rb-ph-label.cons{color:var(--blue);}
.rb-ph-label.mod{color:var(--violet);}
.rb-ph-label.arr{color:var(--green);}

.rb-row{display:grid;grid-template-columns:180px 1fr 1fr 1fr;gap:0;border-bottom:1px solid var(--border);align-items:center;}
.rb-row:last-of-type{border-bottom:none;}
.rb-row-label{padding:8px 0;display:flex;flex-direction:column;gap:1px;}
.rb-dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:5px;flex-shrink:0;}
.rb-row-label>span:first-child{display:flex;align-items:center;font-size:11px;color:var(--text);}
.rb-row-sub{font-size:8px;color:var(--muted);margin-left:12px;margin-top:0;}

.rb-row-bar{padding:8px 12px;display:flex;align-items:center;gap:8px;border-left:1px solid var(--border);}
.rb-bar-fill{height:6px;border-radius:3px;min-width:3px;transition:width .5s ease;}
.rb-row-bar span{font-family:'Fraunces',serif;font-size:13px;font-weight:700;color:var(--text);white-space:nowrap;}

.rb-dalio-note{padding:8px 0 10px;font-size:9px;color:var(--muted);line-height:1.6;border-top:1px solid var(--border);}

/* Compact header for rebalance tab */
#tab-rebalance .header{padding:16px 40px 14px;}
#tab-rebalance .header h1{font-size:28px;margin:4px 0;}
#tab-rebalance .header-sub{margin-top:4px;font-size:10px;}

/* Profile selector buttons */
.rb-profile-btn{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;padding:6px 14px;border:1px solid var(--border);background:var(--card);color:var(--muted);cursor:pointer;transition:all .2s;}
.rb-profile-btn:hover{border-color:var(--border2);color:var(--text);}
.rb-profile-btn.active{border-color:var(--green);color:var(--green);background:var(--green-faint);}

/* Diagnosis grid */
.rb-diag-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0;border-top:1px solid var(--border);border-left:1px solid var(--border);margin:0 40px 24px;}
.rb-diag-cell{padding:16px 18px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.rb-diag-label{font-family:'Inter',sans-serif;font-size:8px;letter-spacing:.5px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.rb-diag-current{font-family:'Fraunces',serif;font-size:18px;font-weight:600;color:var(--text);}
.rb-diag-target{font-size:10px;color:var(--muted);margin-top:2px;}
.rb-diag-delta{font-size:11px;font-weight:600;margin-top:8px;padding:4px 8px;display:inline-block;}
.rb-diag-delta.buy{background:var(--green-faint);color:var(--green);}
.rb-diag-delta.ok{background:var(--card);color:var(--muted);}
.rb-diag-delta.over{background:rgba(251,146,60,.1);color:var(--orange);}
.rb-diag-amount{font-size:10px;color:var(--muted);margin-top:4px;}

/* Charts row */
.rb-charts-row{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin:0 40px 0;}
.rb-donut-area{padding:24px;border-right:1px solid var(--border);}
.rb-donut-area:last-child{border-right:none;}
.rb-chart-title{font-family:'Inter',sans-serif;font-size:9px;letter-spacing:.5px;font-weight:700;text-transform:uppercase;color:var(--muted);margin-bottom:16px;}
.rb-donut-wrap{position:relative;height:220px;width:100%;overflow:hidden;}
.rb-donut-wrap canvas{max-width:100%;}

@media(max-width:900px){
  .rb-profile-header,.rb-row{grid-template-columns:1fr 1fr;}
  .rb-ph-empty,.rb-ph-label:not(.cons){display:none;}
  .rb-row-bar.mod,.rb-row-bar.arr{display:none;}
  .rb-diag-grid{grid-template-columns:1fr 1fr;}
  .rb-charts-row{grid-template-columns:1fr;}
}

/* --- INDEPENDÊNCIA FINANCEIRA (FIRE) --- */
#tab-fire .header{padding:20px 40px 16px;}

/* Methods explanation bar */
.fi-methods-bar{display:grid;grid-template-columns:1fr 1fr;gap:0;border-bottom:1px solid var(--border);border-top:1px solid var(--border);}
.fi-method-card{padding:16px 40px;border-right:1px solid var(--border);}
.fi-method-card:last-child{border-right:none;}
.fi-method-title{font-size:11px;font-weight:600;letter-spacing:.5px;margin-bottom:6px;}
.fi-method-desc{font-family:'Inter',sans-serif;font-size:10px;color:var(--muted);line-height:1.8;}
.fi-method-desc code{font-family:'DM Mono',monospace;background:var(--card);padding:1px 5px;border:1px solid var(--border);border-radius:2px;font-size:9px;}

/* FIRE meta cards */
.fi-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;border-bottom:1px solid var(--border);}
.fi-meta-card{padding:24px 40px;border-right:1px solid var(--border);}
.fi-meta-card:last-child{border-right:none;}
.fi-meta-badge{display:inline-block;font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:3px 10px;border:1px solid;margin-bottom:14px;font-family:'DM Mono',monospace;}
.fi-meta-label{font-family:'Inter',sans-serif;font-size:8px;letter-spacing:.5px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.fi-meta-val{font-family:'Fraunces',serif;font-size:36px;font-weight:900;line-height:1;margin-bottom:4px;}
.fi-meta-sub{font-family:'Inter',sans-serif;font-size:10px;color:var(--muted);margin-bottom:16px;}
.fi-meta-falta-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.fi-meta-falta{font-family:'Fraunces',serif;font-size:20px;font-weight:600;color:var(--text);margin-bottom:14px;}

/* Tempo cards inside meta card */
.fi-tempos{display:flex;flex-direction:column;gap:6px;border-top:1px solid var(--border);padding-top:12px;}
.fi-tempo-row{display:flex;justify-content:space-between;align-items:center;padding:7px 12px;background:var(--card);border:1px solid var(--border);border-radius:var(--radius-sm);}
.fi-tempo-cenario{font-family:'Inter',sans-serif;font-size:9px;letter-spacing:.3px;font-weight:600;text-transform:uppercase;color:var(--muted);}
.fi-tempo-val{font-family:'Fraunces',serif;font-size:14px;font-weight:600;}
.fi-tempo-val.cons{color:var(--blue);}
.fi-tempo-val.mod{color:var(--violet);}
.fi-tempo-val.arr{color:var(--green);}
.fi-tempo-val.inf{color:var(--orange);font-size:11px;}

/* Nota metodológica */
.fi-nota{font-family:'Inter',sans-serif;padding:16px 40px;background:var(--panel);border-bottom:1px solid var(--border);font-size:10px;color:var(--muted);line-height:1.8;}

/* Chart area */
.fi-chart-area{padding:20px 40px;border-bottom:1px solid var(--border);}
.fi-chart-controls{display:flex;align-items:center;gap:16px;margin-bottom:10px;flex-wrap:wrap;}
.fi-toggle-inflation{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px;color:var(--text);}
.fi-toggle-inflation input{accent-color:var(--green);width:14px;height:14px;}
.fi-ctrl-note{font-size:9px;color:var(--muted);}
.fi-crossing-badges{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;min-height:22px;}
.fi-crossing-badge{font-family:'DM Mono',monospace;font-size:10px;padding:4px 12px;border:1px solid;}
.fi-main-chart-wrap{position:relative;height:260px;width:100%;overflow:hidden;}
.fi-main-chart-wrap canvas{max-width:100%;}

/* Evolution table */
.fi-evolution-section{border-top:1px solid var(--border);}
.fi-evo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0;border-top:1px solid var(--border);}
.fi-evo-cell{padding:14px 18px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.fi-evo-year{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.fi-evo-portfolio{font-family:'Fraunces',serif;font-size:14px;font-weight:600;color:var(--text);}
.fi-evo-renda{font-size:11px;color:var(--violet);margin-top:2px;}
.fi-evo-monthly{font-size:9px;color:var(--muted);margin-top:1px;}
.fi-evo-mark{font-size:8px;font-weight:700;letter-spacing:1px;color:var(--green);margin-top:4px;}

/* FIRE IR banner */
.fi-ir-banner{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border);}
.fi-ir-item{display:flex;gap:14px;padding:16px 40px;align-items:flex-start;}
.fi-ir-item:first-child{border-right:1px solid var(--border);}
.fi-ir-icon{font-size:20px;flex-shrink:0;margin-top:2px;}
.fi-ir-title{font-size:10px;color:var(--text);margin-bottom:5px;letter-spacing:.2px;}
.fi-ir-title strong{font-weight:700;}
.fi-ir-desc{font-size:9px;color:var(--muted);line-height:1.7;}
.fi-ir-green{background:rgba(61,214,140,.04);}
.fi-ir-orange{background:rgba(251,146,60,.04);}
.fi-ir-green .fi-ir-title strong{color:var(--green);}
.fi-ir-orange .fi-ir-title strong{color:var(--orange);}
@media(max-width:700px){.fi-ir-banner{grid-template-columns:1fr;}.fi-ir-item:first-child{border-right:none;border-bottom:1px solid var(--border);}}
.fi-trap-intro{padding:14px 40px 16px;font-size:11px;color:var(--muted);line-height:1.8;
  border-bottom:1px solid var(--border);background:var(--panel);}
.fi-trap-intro strong{color:var(--text);}
.fi-trap-rf-input-wrap{display:inline-flex;align-items:center;gap:6px;margin-left:16px;
  font-size:10px;color:var(--muted);border:1px solid var(--border);
  padding:3px 10px;background:var(--card);}
.fi-trap-rf-input-wrap input{background:transparent;border:none;outline:none;
  color:var(--text);font-family:'Fraunces',serif;font-size:15px;font-weight:600;
  width:44px;text-align:center;}

.fi-trap-grid{display:grid;grid-template-columns:1fr 1fr 1fr;border-bottom:1px solid var(--border);}

.fi-trap-blank{background:var(--panel);}
.fi-trap-head{display:flex;flex-direction:column;align-items:center;gap:4px;
  padding:12px 16px;border-left:1px solid var(--border);border-bottom:1px solid var(--border);
  font-size:10px;font-weight:600;text-align:center;background:var(--card);}
.fi-trap-head span{font-size:8px;font-weight:400;color:var(--muted);letter-spacing:.3px;}
.fi-trap-head-rv{color:#3dd68c;}
.fi-trap-head-rf{color:#a78bfa;}

.fi-trap-row-label{padding:10px 40px;font-size:9px;color:var(--muted);letter-spacing:.5px;
  display:flex;align-items:center;gap:6px;border-bottom:1px solid var(--border);background:var(--panel);}
.fi-trap-row-label em{color:var(--text);font-style:normal;font-weight:600;}
.fi-trap-row-label small{font-size:8px;color:var(--muted);opacity:.7;}
.fi-trap-cell{padding:10px 24px;border-left:1px solid var(--border);border-bottom:1px solid var(--border);
  font-family:'Fraunces',serif;font-size:16px;font-weight:600;color:var(--text);
  display:flex;align-items:center;justify-content:center;text-align:center;}
.fi-trap-cell-rv{color:#3dd68c;}
.fi-trap-cell-rf{color:#a78bfa;}
.fi-trap-highlight{font-size:20px;}
.fi-trap-danger{color:var(--orange)!important;}
.fi-trap-span{grid-column:2/-1;color:var(--orange);font-size:15px;}
.fi-trap-verdict{font-size:13px;letter-spacing:.5px;}
.fi-trap-verdict-label{font-weight:700;color:var(--text);}

.fi-trap-footnote{padding:12px 40px;font-size:10px;color:var(--muted);
  line-height:1.8;border-bottom:1px solid var(--border);background:var(--panel);}

@media(max-width:700px){
  .fi-trap-grid{grid-template-columns:1fr;}
  .fi-trap-head,.fi-trap-cell,.fi-trap-span{border-left:none;}
  .fi-trap-blank{display:none;}
}

@media(max-width:900px){
  .fi-methods-bar,.fi-meta-grid{grid-template-columns:1fr;}
  .fi-method-card,.fi-meta-card{border-right:none;border-bottom:1px solid var(--border);}
}

/* footer legal */
.footer-legal{border-top:2px solid var(--border);background:var(--panel);}
.footer-legal-main{padding:24px 40px;display:grid;grid-template-columns:1fr 1fr;gap:32px;border-bottom:1px solid var(--border);}
.footer-legal-block h4{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.footer-legal-block p{font-size:10px;color:var(--muted);line-height:1.7;}
.footer-bottom{padding:14px 40px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;}
.footer-copy{font-size:10px;color:var(--footer-text);}
.footer-copy strong{color:var(--muted);}

/* --- RESPONSIVE --- */
@media(max-width:900px){
  .main{padding:16px 20px 0;}
  .chart-area,.sidebar{max-width:100%;}
  .ranking{grid-template-columns:1fr 1fr;}
  .ac-scenarios{grid-template-columns:1fr;}
  .res-grid{grid-template-columns:1fr;}
  .res-inputs{border-right:none;border-bottom:1px solid var(--border);}
  .footer-legal-main{grid-template-columns:1fr;}
}
@media(max-width:768px){
  .page-nav{padding:0 20px;}
  .header,.chart-area,.caveats,.res-inputs,.res-charts,.expert-tips,.footer-legal-main,.footer-bottom{padding-left:20px;padding-right:20px;}
  .div-toggle-bar{padding-left:20px;padding-right:20px;}
  .input-group{padding:12px 14px;min-width:100px;}
  .sidebar{padding:20px;}
  .div-description{margin-left:0;border-left:none;padding-left:0;border-top:1px solid var(--border);padding-top:8px;width:100%;max-width:100%;}
  .res-input-row{grid-template-columns:1fr;}
  .res-result-grid{grid-template-columns:1fr;}
  .res-result-item{border-right:none;border-bottom:1px solid var(--border);}
}
/* aportes sazonais */
.sazonal-month{display:flex;flex-direction:column;gap:4px;}
.sazonal-month label{font-size:8px;color:var(--muted);letter-spacing:.5px;text-transform:uppercase;}
.sazonal-month input{background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:14px;width:90px;padding:2px 0 4px;}
.sazonal-month input:focus{outline:none;border-color:var(--green);color:var(--green);}
.sazonal-month.destaque label{color:var(--yellow);}
.sazonal-month.destaque input{border-color:var(--yellow);}

/* renda de dividendos */
.dv-metas-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));border-top:1px solid var(--border);border-left:1px solid var(--border);}
.dv-meta-card{padding:16px 20px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.dv-meta-renda{font-size:10px;color:var(--muted);margin-bottom:4px;}
.dv-meta-patrim{font-family:'Fraunces',serif;font-size:17px;font-weight:600;color:var(--text);}
.dv-meta-anos{font-size:9px;color:var(--green);margin-top:4px;}
.dv-meta-anos.longe{color:var(--orange);}

/* comparador renda fixa */
.crf-options-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:0;border-top:1px solid var(--border);border-left:1px solid var(--border);}
.crf-option{padding:20px 24px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);position:relative;}
.crf-option-header{display:flex;align-items:center;gap:8px;margin-bottom:12px;}
.crf-option-color{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
.crf-option-title{font-size:11px;font-weight:600;letter-spacing:.5px;flex:1;}
.crf-remove-btn{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0 4px;line-height:1;}
.crf-remove-btn:hover{color:var(--orange);}
.crf-option select,.crf-option input[type=number]{background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;width:100%;padding:3px 0 5px;margin-bottom:8px;}
.crf-option select{cursor:pointer;}
.crf-option select:focus,.crf-option input[type=number]:focus{outline:none;border-color:var(--green);color:var(--green);}
.crf-option-label{font-size:9px;color:var(--muted);margin-bottom:2px;display:block;}
.crf-table-wrap{overflow-x:auto;padding:0 40px 8px;}
.crf-table{width:100%;border-collapse:collapse;font-size:10px;font-family:'DM Mono',monospace;}
.crf-table th{text-align:left;padding:8px 12px;border-bottom:2px solid var(--border);color:var(--muted);letter-spacing:.5px;font-size:9px;white-space:nowrap;}
.crf-table td{padding:10px 12px;border-bottom:1px solid var(--border);vertical-align:middle;}
.crf-table tr:hover td{background:var(--panel);}
.crf-table .crf-winner{background:var(--green-faint);}
.crf-table .crf-winner td:first-child{border-left:3px solid var(--green);}
.crf-val-pos{color:var(--green);font-weight:600;}
.crf-val-neg{color:var(--orange);}
.crf-badge{font-size:8px;padding:2px 7px;border-radius:8px;font-weight:700;letter-spacing:.3px;}
.crf-badge.melhor{background:var(--green-faint);color:var(--green);border:1px solid var(--green);}
.crf-badge.ok{background:var(--panel);color:var(--muted);border:1px solid var(--border);}
@media(max-width:768px){.crf-table-wrap{padding:0 12px 8px;}.crf-options-grid{grid-template-columns:1fr;}}

.pj-print-bar{display:flex;align-items:center;gap:16px;padding:16px 28px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);}
.pj-print-btn{background:var(--green-faint);color:var(--green);border:1px solid var(--green);padding:9px 20px;font-family:'Inter',sans-serif;font-size:11px;font-weight:600;cursor:pointer;transition:all .2s;border-radius:var(--radius-sm);}
.pj-print-btn:hover{background:var(--green);color:var(--bg);transform:translateY(-1px);box-shadow:var(--shadow-sm);}
.pj-print-hint{font-size:9px;color:var(--muted);}
@media print{
  .page-nav,.nav-right,.theme-btn,.pj-print-bar,.div-toggle-bar,.inputs-bar,.inputs-section-label,.fi-nota,#tab-simulador,#tab-reserva,#tab-acoes,#tab-rebalance,#tab-fire,#tab-meta,#tab-divs,#tab-crf,footer{display:none!important;}
  #tab-preco{display:block!important;}
  .pj-methods-grid,.pj-consenso-bar,.pj-indicators-grid{break-inside:avoid;}
  body{background:#fff;color:#111;}
  .pj-method-card,.pj-consenso-block,.pj-indicator{border-color:#ddd;}
}
.pj-sector-warning{padding:12px 28px;border-bottom:1px solid var(--border);background:var(--orange-faint);}
.pj-sector-warning-inner{display:flex;align-items:flex-start;gap:10px;max-width:900px;}
.pj-sector-warning-icon{font-size:16px;flex-shrink:0;margin-top:1px;}
.pj-sector-warning-text{font-size:10px;color:var(--text);line-height:1.7;}
.pj-sector-warning-text strong{color:var(--orange);}
.pj-dpa-tip{font-size:9px;color:var(--muted);line-height:1.7;margin-top:8px;padding:10px 12px;background:var(--panel);border:1px solid var(--border);border-left:2px solid var(--yellow);}
.pj-dpa-tip strong{color:var(--text);}

/* meta patrimonial */
#tab-meta .header::before{background:radial-gradient(circle,rgba(61,214,140,.05) 0%,transparent 70%);}
#tab-preco .header::before{background:radial-gradient(circle,rgba(168,139,250,.06) 0%,transparent 70%);}

.meta-results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));border-bottom:1px solid var(--border);}
.meta-result-card{padding:22px 28px;border-right:1px solid var(--border);}
.meta-result-card:last-child{border-right:none;}
.meta-card-primary{background:var(--green-faint);}
.meta-result-eyebrow{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.meta-result-val{font-family:'Fraunces',serif;font-size:26px;font-weight:900;line-height:1;margin-bottom:5px;}
.meta-result-sub{font-size:9px;color:var(--muted);line-height:1.6;}

.meta-scenarios-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));border-bottom:1px solid var(--border);}
.meta-scenario-card{padding:18px 24px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.meta-sc-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.meta-sc-rate{font-size:10px;margin-bottom:8px;}
.meta-sc-val{font-family:'Fraunces',serif;font-size:20px;font-weight:700;line-height:1;margin-bottom:3px;}
.meta-sc-sub{font-size:9px;color:var(--muted);}

.meta-chart-section{display:flex;flex-direction:column;align-items:center;padding:24px 40px 16px;border-bottom:1px solid var(--border);}
.meta-chart-wrap{position:relative;height:200px;width:100%;max-width:820px;overflow:hidden;}

.meta-milestones{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));border-bottom:1px solid var(--border);}
.meta-milestone{padding:14px 18px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.meta-ms-year{font-family:'Inter',sans-serif;font-size:8px;letter-spacing:.5px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.meta-ms-val{font-family:'Fraunces',serif;font-size:17px;font-weight:700;line-height:1;margin-bottom:2px;}
.meta-ms-pct{font-size:9px;color:var(--muted);}
.meta-ms-mark{font-size:8px;font-weight:700;letter-spacing:1px;color:var(--green);margin-top:3px;}


.pj-methods-grid{display:grid;grid-template-columns:repeat(2,1fr);border-bottom:1px solid var(--border);}
.pj-method-card{padding:24px 28px;border-right:1px solid var(--border);border-radius:0;}
.pj-method-card:last-child{border-right:none;}
.pj-method-header{margin-bottom:10px;}
.pj-method-title{font-family:'Fraunces',serif;font-size:16px;font-weight:600;margin-bottom:3px;}
.pj-method-formula-tag{font-size:9px;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:.3px;padding:3px 7px;background:var(--panel);border:1px solid var(--border);display:inline-block;}
.pj-method-desc{font-family:'Inter',sans-serif;font-size:10px;color:var(--muted);line-height:1.8;margin:12px 0 16px;}
.pj-result-row{display:flex;gap:20px;flex-wrap:wrap;padding-top:14px;border-top:1px solid var(--border);}
.pj-result-block{display:flex;flex-direction:column;gap:3px;}
.pj-result-label{font-family:'Inter',sans-serif;font-size:8px;letter-spacing:.4px;font-weight:600;text-transform:uppercase;color:var(--muted);}
.pj-result-val{font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--text);}
.pj-margem{font-family:'Fraunces',serif;font-size:18px;font-weight:600;}
.pj-margem.positiva{color:var(--green);}
.pj-margem.negativa{color:var(--orange);}
.pj-veredicto{font-size:10px;font-weight:700;letter-spacing:.4px;padding:3px 9px;border-radius:10px;display:inline-block;margin-top:3px;}
.pj-veredicto.compra{background:var(--green-faint);color:var(--green);border:1px solid var(--green);}
.pj-veredicto.cara{background:var(--orange-faint);color:var(--orange);border:1px solid var(--orange);}
.pj-veredicto.neutra{background:var(--yellow-faint);color:var(--yellow);border:1px solid var(--yellow);}

.pj-consenso-bar{background:var(--card);border-bottom:1px solid var(--border);}
.pj-consenso-inner{display:flex;justify-content:center;}
.pj-consenso-block{padding:20px 40px;border-right:1px solid var(--border);text-align:center;}
.pj-consenso-block:last-child{border-right:none;}
.pj-consenso-label{font-family:'Inter',sans-serif;font-size:8px;letter-spacing:.4px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.pj-consenso-val{font-family:'Fraunces',serif;font-size:22px;font-weight:700;}

.pj-indicators-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));border-bottom:1px solid var(--border);}
.pj-indicator{padding:14px 20px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.pj-ind-label{font-family:'Inter',sans-serif;font-size:8px;letter-spacing:.4px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.pj-ind-val{font-family:'Fraunces',serif;font-size:20px;font-weight:700;line-height:1;margin-bottom:2px;}
.pj-ind-ref{font-size:8px;color:var(--muted);}
.pj-ind-ok{color:var(--green);}
.pj-ind-warn{color:var(--yellow);}
.pj-ind-bad{color:var(--orange);}

@media(max-width:900px){
  .pj-methods-grid{grid-template-columns:1fr;}
  .pj-method-card{border-right:none;border-bottom:1px solid var(--border);}
  .pj-consenso-inner{flex-wrap:wrap;}
  .pj-consenso-block{flex:1;min-width:130px;}
  .meta-result-card{border-right:none;border-bottom:1px solid var(--border);}
}
/* brapi autocomplete */
.pj-autocomplete{position:fixed;z-index:9999;background:var(--card);border:1px solid var(--border2);max-height:240px;overflow-y:auto;display:none;box-shadow:var(--shadow);border-radius:var(--radius-sm);}
.pj-autocomplete.open{display:block;}
.pj-ac-item{padding:8px 12px;cursor:pointer;display:flex;align-items:center;justify-content:space-between;gap:8px;border-bottom:1px solid var(--border);transition:background .15s;}
.pj-ac-item:last-child{border-bottom:none;}
.pj-ac-item:hover,.pj-ac-item.active{background:var(--panel);}
.pj-ac-ticker{font-family:'DM Mono',monospace;font-size:11px;font-weight:600;color:var(--text);}
.pj-ac-price{font-family:'Fraunces',serif;font-size:10px;color:var(--green);margin-left:auto;flex-shrink:0;}
.pj-ac-name{font-size:9px;color:var(--muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:160px;}
.pj-ac-loading{padding:10px 12px;font-size:10px;color:var(--muted);text-align:center;}
.pj-ac-empty{padding:10px 12px;font-size:10px;color:var(--muted);text-align:center;}
.pj-api-badge{font-size:8px;letter-spacing:.5px;background:var(--green-faint);color:var(--green);border:1px solid var(--green);padding:1px 5px;border-radius:6px;vertical-align:middle;margin-left:4px;}
.pj-fetch-status{font-size:9px;margin-top:3px;}
.pj-fetch-status.ok{color:var(--green);}
.pj-fetch-status.err{color:var(--orange);}

/* --- APORTES SAZONAIS --- */
.sazonal-summary{padding:6px 40px 10px;font-size:10px;color:var(--muted);display:flex;gap:24px;flex-wrap:wrap;}
.sazonal-summary strong{color:var(--text);}

/* foco rápido de séries */
.focus-bar{display:flex;align-items:center;gap:6px;padding:8px 40px;border-bottom:1px solid var(--border);background:var(--panel);flex-wrap:wrap;}
.focus-bar-label{font-family:'Inter',sans-serif;font-size:9px;font-weight:600;text-transform:uppercase;letter-spacing:.5px;color:var(--muted);margin-right:4px;flex-shrink:0;}
.focus-btn{font-family:'Inter',sans-serif;font-size:10px;font-weight:500;padding:4px 12px;border:1px solid var(--border);background:var(--card);color:var(--muted);cursor:pointer;border-radius:20px;transition:all .15s;white-space:nowrap;}
.focus-btn:hover{border-color:var(--border2);color:var(--text);}
.focus-btn.active{background:var(--blue-faint);border-color:var(--blue);color:var(--blue);}
.focus-btn[data-focus="todos"].active{background:var(--green-faint);border-color:var(--green);color:var(--green);}

/* --- RENDA DE DIVIDENDOS --- */
.dv-result-card{padding:20px 24px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.dv-result-card:last-child{border-right:none;}
.dv-result-label{font-family:'Inter',sans-serif;font-size:8px;letter-spacing:.4px;font-weight:600;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.dv-result-val{font-family:'Fraunces',serif;font-size:26px;font-weight:700;color:var(--text);line-height:1;}
.dv-result-sub{font-size:9px;color:var(--muted);margin-top:4px;}
.dv-meta-card{padding:16px 20px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:4px;}
.dv-meta-card:last-child{border-right:none;}
.dv-meta-renda{font-size:10px;letter-spacing:.5px;color:var(--muted);}
.dv-meta-patrimonio{font-family:'Fraunces',serif;font-size:18px;font-weight:700;color:var(--green);}
.dv-meta-anos{font-size:9px;color:var(--muted);}
.dv-progress-wrap{padding:20px 40px 8px;}
.dv-progress-bar-bg{height:6px;background:var(--border);border-radius:3px;overflow:hidden;max-width:820px;}
.dv-progress-bar-fill{height:100%;background:var(--green);border-radius:3px;transition:width .5s;}

/* --- COMPARADOR RENDA FIXA --- */
.crf-option-card{padding:20px 24px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:8px;}
.crf-opt-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px;}
.crf-opt-label{font-family:'Inter',sans-serif;font-size:8px;letter-spacing:.4px;font-weight:600;text-transform:uppercase;color:var(--muted);}
.crf-opt-remove{background:none;border:none;color:var(--muted);cursor:pointer;font-size:16px;padding:0 4px;line-height:1;}
.crf-opt-remove:hover{color:var(--orange);}
.crf-opt-row{display:flex;flex-direction:column;gap:3px;}
.crf-opt-row label{font-size:8px;color:var(--muted);letter-spacing:.5px;}
.crf-opt-row input[type=text],.crf-opt-row input[type=number]{background:transparent;border:none;border-bottom:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:15px;width:100%;padding:2px 0 4px;}
.crf-opt-row input:focus{outline:none;border-color:var(--green);color:var(--green);}
.crf-opt-row select{background:var(--panel);border:1px solid var(--border);color:var(--text);font-family:'DM Mono',monospace;font-size:11px;padding:4px 8px;width:100%;}
.crf-opt-pills{display:flex;gap:4px;margin-top:2px;}
.crf-pill{font-size:9px;padding:2px 8px;border:1px solid var(--border);background:none;color:var(--muted);cursor:pointer;font-family:'DM Mono',monospace;border-radius:3px;}
.crf-pill.active{background:var(--green-faint);color:var(--green);border-color:var(--green);}
.crf-isento-badge{font-size:8px;padding:2px 6px;background:var(--green-faint);color:var(--green);border:1px solid var(--green);border-radius:4px;align-self:flex-start;}
.crf-winner-badge{display:inline-block;background:var(--green-faint);color:var(--green);border:1px solid var(--green);font-size:9px;padding:2px 8px;border-radius:10px;}
.crf-table .rank-1{color:var(--green);font-weight:700;}
.crf-table .rank-2{color:var(--yellow);}
.crf-table .rank-3{color:var(--muted);}

/* --- TOP ACCENT BAR --- */
.top-accent-bar {
  height: 3px;
  background: linear-gradient(90deg, var(--green) 0%, var(--teal) 40%, var(--blue) 100%);
  position: sticky;
  top: 0;
  z-index: 201;
  flex-shrink: 0;
}

/* --- NAV UPGRADES --- */
.page-nav {
  transition: box-shadow .25s, background .25s;
}
.page-nav.scrolled {
  background: color-mix(in srgb, var(--panel) 85%, transparent);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  box-shadow: var(--shadow-sm);
}
.nav-logomark { display:flex; align-items:center; flex-shrink:0; }
.nav-brand-name {
  font-family: 'Inter', sans-serif;
  font-size: 14px;
  font-weight: 700;
  color: var(--text);
  letter-spacing: -.4px;
}
.nav-brand-name span { color: var(--green); margin: 0 1px; }
.nav-separator {
  width: 1px; height: 16px;
  background: var(--border);
  margin: 0 4px;
  flex-shrink: 0;
}

/* Active nav item: left accent */
.nav-dropdown-item.active {
  color: var(--green);
  background: var(--green-faint);
  border-left: 3px solid var(--green);
  padding-left: 17px;
}
.nav-dropdown-item { border-left: 3px solid transparent; }


@keyframes tabFadeIn {
  from { opacity: 0; transform: translateY(6px); }
  to   { opacity: 1; transform: translateY(0); }
}
.tab-enter {
  animation: tabFadeIn .22s cubic-bezier(.25,.46,.45,.94) both;
}


@keyframes numPop {
  0%   { transform: scale(.95); opacity: .6; }
  60%  { transform: scale(1.02); }
  100% { transform: scale(1);   opacity: 1; }
}
.num-updated {
  animation: numPop .35s cubic-bezier(.34,1.56,.64,1) both;
}


.header {
  padding: 40px 40px 28px;
  background: linear-gradient(135deg, var(--panel) 0%, var(--bg) 100%);
}
.header::after {
  content: '';
  position: absolute;
  bottom: 0; left: 40px; right: 40px;
  height: 1px;
  background: linear-gradient(90deg, var(--green) 0%, transparent 60%);
}


.ranking { gap: 8px; }
.rank-card.rank-1 {
  border-color: var(--green);
  border-width: 1px;
  background: linear-gradient(135deg, var(--green-faint) 0%, var(--card) 70%);
}

/* --- CAVEATS UPGRADE --- */
.caveats {
  padding: 32px 40px;
  background: linear-gradient(to bottom, var(--panel), var(--bg));
  gap: 12px;
}
.caveat-card:hover {
  box-shadow: var(--shadow-sm);
  transform: translateY(-1px);
}

/* --- FOOTER UPGRADE --- */
.footer-legal {
  border-top: none;
  position: relative;
}
.footer-legal::before {
  content: '';
  display: block;
  height: 2px;
  background: linear-gradient(90deg, var(--green), var(--teal), var(--blue));
  opacity: .35;
}
.footer-legal-block h4 {
  font-family: 'Inter', sans-serif;
  font-size: 9px;
  letter-spacing: .5px;
  font-weight: 700;
  text-transform: uppercase;
  color: var(--muted);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}
.footer-legal-block p {
  font-family: 'Inter', sans-serif;
  font-size: 10px;
  color: var(--muted);
  line-height: 1.8;
}
.footer-copy {
  font-family: 'Inter', sans-serif;
  font-size: 10px;
  color: var(--footer-text);
}
.footer-copy strong { color: var(--muted); }

/* --- INPUT FOCUS RING (fintech style) --- */
.res-input-group input[type=number]:focus {
  border-color: var(--green);
  box-shadow: 0 0 0 3px var(--green-faint);
}

/* --- RESULT VALUE HIGHLIGHT (pulse on update) --- */
.fi-meta-val, .meta-result-val, .res-result-value, .rank-fv {
  transition: color .3s;
}


.meta-chart-section {
  background: linear-gradient(to bottom, var(--panel), var(--bg));
}


::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--panel); }
::-webkit-scrollbar-thumb { background: var(--border2); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--muted); }


/* Monte Carlo */
.mc-toggle-bar {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 8px 40px;
  border-bottom: 1px solid var(--border);
  background: var(--bg);
  flex-wrap: wrap;
}
.mc-btn {
  font-family: 'Inter', sans-serif;
  font-size: 10px;
  font-weight: 600;
  padding: 5px 14px;
  border: 1px solid var(--border);
  background: var(--card);
  color: var(--muted);
  cursor: pointer;
  border-radius: 20px;
  transition: all .2s;
  display: flex;
  align-items: center;
  gap: 6px;
}
.mc-btn:hover { border-color: var(--violet); color: var(--violet); }
.mc-btn.active {
  background: var(--violet-faint);
  border-color: var(--violet);
  color: var(--violet);
}
.mc-btn .mc-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: currentColor;
  opacity: .6;
}
.mc-info {
  font-family: 'Inter', sans-serif;
  font-size: 9px;
  color: var(--muted);
  line-height: 1.6;
}
.mc-info strong { color: var(--violet); }
.mc-spinner {
  font-size: 9px;
  color: var(--violet);
  display: none;
  font-family: 'DM Mono', monospace;
}
.mc-spinner.running { display: inline; }

</style>
</head>
<body>

<!-- PAGE NAV — HAMBURGER -->
<div class="top-accent-bar"></div>
<nav class="page-nav">
  <div class="nav-left">
    <div style="position:relative;">
      <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
        <div class="hamburger-icon">
          <span></span><span></span><span></span>
        </div>
        Menu
      </button>
      <div class="nav-dropdown" id="navDropdown">
        <button class="nav-dropdown-item active" id="menu-simulador" onclick="showTab('simulador')">
          <span class="nav-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/><polyline points="17 6 23 6 23 12"/></svg></span>
          <div class="nav-item-text">
            <span class="nav-item-label">Simulador de Investimentos</span>
            <span class="nav-item-desc">Ações, Tesouro, CDB, LCI/LCA</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-crf" onclick="showTab('crf')">
          <span class="nav-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="18" y="3" width="4" height="18"/><rect x="10" y="8" width="4" height="13"/><rect x="2" y="13" width="4" height="8"/></svg></span>
          <div class="nav-item-text">
            <span class="nav-item-label">Comparador de Renda Fixa</span>
            <span class="nav-item-desc">CDB · LCI/LCA · Tesouro lado a lado</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-reserva" onclick="showTab('reserva')">
          <span class="nav-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg></span>
          <div class="nav-item-text">
            <span class="nav-item-label">Reserva de Emergência</span>
            <span class="nav-item-desc">Meta, prazo e progresso</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-acoes" onclick="showTab('acoes')">
          <span class="nav-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="18" y="3" width="4" height="18"/><rect x="10" y="8" width="4" height="13"/><rect x="2" y="13" width="4" height="8"/></svg></span>
          <div class="nav-item-text">
            <span class="nav-item-label">Calculadora de Ações</span>
            <span class="nav-item-desc">DY, cenários e imposto</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-rebalance" onclick="showTab('rebalance')">
          <span class="nav-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="3" x2="12" y2="21"/><path d="M3 9l4-4 5 4 5-4 4 4"/><line x1="3" y1="18" x2="21" y2="18"/></svg></span>
          <div class="nav-item-text">
            <span class="nav-item-label">Rebalanceamento de Carteira</span>
            <span class="nav-item-desc">3 perfis · o que comprar agora</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-meta" onclick="showTab('meta')">
          <span class="nav-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg></span>
          <div class="nav-item-text">
            <span class="nav-item-label">Meta Patrimonial</span>
            <span class="nav-item-desc">Quanto aportar para chegar lá</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-preco" onclick="showTab('preco')">
          <span class="nav-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="1" x2="12" y2="23"/><path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></span>
          <div class="nav-item-text">
            <span class="nav-item-label">Preço Justo</span>
            <span class="nav-item-desc">Bazin e Graham</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-divs" onclick="showTab('divs')">
          <span class="nav-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a10 10 0 0 1 10 10c0 5.52-4.48 10-10 10"/><path d="M12 12c0-5.52 4.48-10 10-10"/><line x1="2" y1="22" x2="12" y2="12"/></svg></span>
          <div class="nav-item-text">
            <span class="nav-item-label">Renda de Dividendos</span>
            <span class="nav-item-desc">Quanto sua carteira paga por mês</span>
          </div>
        </button>

        <button class="nav-dropdown-item" id="menu-fire" onclick="showTab('fire')">
          <span class="nav-icon"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 22 22 22"/><line x1="12" y1="2" x2="12" y2="22"/></svg></span>
          <div class="nav-item-text">
            <span class="nav-item-label">Independência Financeira</span>
            <span class="nav-item-desc">Seu número FIRE · Curva da Liberdade</span>
          </div>
        </button>
      </div>
    </div>
    <div class="nav-logomark"><svg width="28" height="28" viewBox="0 0 28 28" fill="none" xmlns="http://www.w3.org/2000/svg">
  <rect width="28" height="28" rx="7" fill="var(--green)" fill-opacity="0.12"/>
  <polyline points="5,20 10,13 15,16 20,8 23,11" stroke="var(--green)" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
</svg></div>
    <span class="nav-brand-name">RQ<span>·</span>Finanças</span>
    <div class="nav-separator"></div>
    <span class="nav-active-label" id="navActiveLabel">Simulador de Investimentos</span>
  </div>
  <div class="nav-right">
    <button class="theme-btn" onclick="toggleTheme()">
      <span id="themeIcon">☾</span>
      <span id="themeLabel">Tema escuro</span>
    </button>
  </div>
</nav>

<!-- TAB 1: SIMULADOR -->
<div id="tab-simulador">

  <div class="header">
    <div class="header-eyebrow">Simulador de Patrimônio · Ações e renda fixa</div>
    <h1><span id="h1Inicial">R$ 10k</span> inicial + <span id="h1Aporte">R$ 1k</span>/<em>mês</em></h1>
    <p class="header-sub">
      Tesouro IPCA+ · LCI/LCA · CDB · Ações (ITUB3, PETR4…)<br>
      Todos os parâmetros configuráveis. Clique na legenda para ocultar séries.
    </p>
  </div>

  <div class="div-toggle-bar" style="border-bottom:none;">
    <span class="div-toggle-label">Aportes Sazonais</span>
    <div class="toggle-wrap">
      <label class="toggle-switch">
        <input type="checkbox" id="sazonalToggle">
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
      <span class="toggle-label-text" id="sazonalText" style="color:var(--muted);">Desativado</span>
    </div>
    <div class="div-description" id="sazonalDesc" style="color:var(--muted);font-size:9px;">
      Ative para definir aportes diferentes em cada mês do ano — ideal para incluir 13º salário, bônus e variações sazonais.
    </div>
  </div>

  <div class="inputs-section-label">Parâmetros Gerais</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Capital Inicial</label>
      <input type="number" id="inicial" value="10000" min="0" step="1000">
      <span class="input-note">saldo atual</span>
    </div>
    <div class="input-group" id="aporte-fixo-group">
      <label>Aporte Mensal</label>
      <input type="number" id="aporte" value="1000" min="0" step="100">
      <span class="input-note" id="aporteNote">100% reinvestido</span>
    </div>
    <div class="input-group">
      <label>Selic % a.a.</label>
      <input type="number" id="selic" value="15.0" min="0" max="30" step="0.25">
      <span class="input-note">atual: 15% · base do CDI</span>
    </div>
    <div class="input-group">
      <label>Tesouro IPCA+ real %</label>
      <input type="number" id="tesouRoReal" value="7.21" min="0" max="20" step="0.01">
      <span class="input-note">ex: 7,21% (2045+) · 7,18% (2040+)</span>
    </div>
    <div class="input-group">
      <label>IPCA % a.a.</label>
      <input type="number" id="ipca" value="4.0" min="0" max="30" step="0.5">
      <span class="input-note">projeção anual</span>
    </div>
    <div class="input-group">
      <label>DY das Ações %</label>
      <input type="number" id="dy" value="6" min="0" max="20" step="0.5">
      <span class="input-note">dividend yield anual</span>
    </div>
  </div>

  <div id="sazonal-grid" style="display:none;">
    <div class="inputs-section-label" style="display:flex;align-items:center;justify-content:space-between;padding-right:40px;">
      <span>Aporte em cada mês do ano</span>
      <button onclick="resetSazonal()" style="font-size:9px;background:none;border:1px solid var(--border);color:var(--muted);padding:2px 8px;cursor:pointer;font-family:'DM Mono',monospace;">↺ Resetar pelo aporte acima</button>
    </div>
    <div class="inputs-bar" id="sazonal-inputs-bar" style="flex-wrap:wrap;"></div>
    <div style="padding:8px 40px 4px;font-size:9px;color:var(--muted);">
      Média mensal: <strong id="sazonal-media">R$ 0</strong> · Total anual: <strong id="sazonal-total">R$ 0</strong>
    </div>
  </div>

  <div class="inputs-section-label">Renda Fixa · Taxas e Impostos</div>
  <div class="inputs-bar">
    <div class="input-group" style="min-width:180px;">
      <label style="display:flex;align-items:center;justify-content:space-between;">
        <span>LCI/LCA</span>
        <span style="display:flex;gap:3px;">
          <button class="mode-pill active" id="lciModePre" onclick="setMode('lci','pre')">Pré</button>
          <button class="mode-pill" id="lciModePos" onclick="setMode('lci','pos')">Pós · %CDI</button>
        </span>
      </label>
      <input type="number" id="lciRate" value="14.0" min="0" max="200" step="0.5">
      <span class="input-note" id="lciRateNote">bruto prefixado a.a.</span>
      <span class="input-note rate-result" id="lciResult" style="display:none;"></span>
    </div>
    <div class="input-group" style="min-width:130px;">
      <label>IR LCI/LCA %</label>
      <input type="number" id="lciIR" value="0" min="0" max="25" step="2.5">
      <span class="input-note">0% isento · mude se tributar</span>
    </div>
    <div class="input-group" style="min-width:180px;">
      <label style="display:flex;align-items:center;justify-content:space-between;">
        <span>CDB</span>
        <span style="display:flex;gap:3px;">
          <button class="mode-pill active" id="cdbModePre" onclick="setMode('cdb','pre')">Pré</button>
          <button class="mode-pill" id="cdbModePos" onclick="setMode('cdb','pos')">Pós · %CDI</button>
        </span>
      </label>
      <input type="number" id="cdbRate" value="13.5" min="0" max="200" step="0.5">
      <span class="input-note" id="cdbRateNote">bruto prefixado a.a.</span>
      <span class="input-note rate-result" id="cdbResult" style="display:none;"></span>
    </div>
    <div class="input-group" style="min-width:220px;flex:2;">
      <label>IR CDB: automático pelo horizonte</label>
      <div style="margin-top:4px;display:flex;flex-direction:column;gap:4px;">
        <span id="cdbIrAutoLabel" style="font-family:'Fraunces',serif;font-size:18px;font-weight:600;color:var(--teal);">15%</span>
        <span class="input-note" id="cdbIrAutoDesc">acima de 720 dias · ajusta conforme o prazo selecionado no ranking</span>
      </div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
        <span style="font-size:9px;color:var(--muted);">6m→22,5%</span>
        <span style="font-size:9px;color:var(--muted);">·</span>
        <span style="font-size:9px;color:var(--muted);">1a→20%</span>
        <span style="font-size:9px;color:var(--muted);">·</span>
        <span style="font-size:9px;color:var(--muted);">2a→17,5%</span>
        <span style="font-size:9px;color:var(--muted);">·</span>
        <span style="font-size:9px;color:var(--muted);">5a+→15%</span>
      </div>
    </div>
  </div>

  <div class="div-toggle-bar">
    <span class="div-toggle-label">Ações · Dividendos</span>
    <div class="toggle-wrap">
      <label class="toggle-switch">
        <input type="checkbox" id="reinvestToggle" checked>
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
      <span class="toggle-label-text on" id="toggleText">Reinvestindo dividendos</span>
    </div>
    <div class="div-description" id="divDescription">
      <span class="tag-on">✦ Ativado:</span> dividendos compram mais ações → portfólio cresce pelo total return (preço + DY).
    </div>
  </div>

  <div class="focus-bar">
    <span class="focus-bar-label">Visualizar</span>
    <button class="focus-btn active" data-focus="todos"    onclick="setFocus('todos')">Todos</button>
    <button class="focus-btn"        data-focus="rf"       onclick="setFocus('rf')">Só Renda Fixa</button>
    <button class="focus-btn"        data-focus="acoes"    onclick="setFocus('acoes')">Só Ações</button>
    <button class="focus-btn"        data-focus="tes-lci"  onclick="setFocus('tes-lci')">Tesouro vs LCI</button>
    <button class="focus-btn"        data-focus="rf-mod"   onclick="setFocus('rf-mod')">RF vs Ações Moder.</button>
  </div>

  <div class="mc-toggle-bar">
    <button class="mc-btn" id="mcBtn" onclick="toggleMC()">
      <span class="mc-dot"></span>
      Faixa de Incerteza · Monte Carlo
    </button>
    <span class="mc-spinner" id="mcSpinner">calculando 300 cenários…</span>
    <span class="mc-info" id="mcInfo" style="display:none;">
      Banda <strong>P10–P90</strong>: em 80% dos cenários históricos possíveis, o resultado ficaria nessa faixa.
      Parâmetros variados: Selic ±2,5% · IPCA ±1,5% · Ações ±5% a.a. · 300 simulações.
    </span>
  </div>

  <div class="main">
    <div class="chart-area">
      <div class="section-label">Crescimento do Patrimônio · valor bruto acumulado</div>
      <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
      <p class="chart-note">* Renda fixa: curvas mostram o valor bruto que rende juros compostos. IR incide apenas no resgate (sem come-cotas). "No bolso" no ranking desconta o IR automaticamente pelo prazo. Ações: gráfico em valor total (bruto); o IR no ranking é uma estimativa simplificada — alíquota fixa de 15% sobre o ganho de preço, sem considerar isenção de R$20k/mês nem compensação de perdas. Dividendos tratados como isentos (Lei 9.249/95). Retornos em termos nominais, sem ajuste pela inflação.</p>
      <p class="chart-note" id="chart-context-note" style="display:none;color:var(--yellow);"></p>
      <div class="legend-grid" id="legendGrid"></div>
    </div>
    <div class="sidebar">
      <div class="ranking-header">
        <div class="section-label" style="margin-bottom:0;">Ranking no horizonte</div>
        <div class="milestone-tabs">
          <button class="tab-btn" data-months="6">6m</button>
          <button class="tab-btn" data-months="12">1a</button>
          <button class="tab-btn" data-months="24">2a</button>
          <button class="tab-btn" data-months="60">5a</button>
          <button class="tab-btn active" data-months="120">10a</button>
          <button class="tab-btn" data-months="180">15a</button>
          <button class="tab-btn" data-months="240">20a</button>
        </div>
      </div>
      <div class="ranking" id="rankingList"></div>
    </div>
  </div>

  <div class="caveats">
    <div class="caveat-card">
      <div class="caveat-badge green">✦ Tesouro IPCA+ <span id="caveatTesRate">7,21%</span></div>
      <div class="caveat-title">Âncora de longo prazo</div>
      <div class="caveat-body">Taxa real configurável acima. Ex: 2045+ ≈ 7,21% · 2040+ ≈ 7,18%. Garantia soberana. IR 15% só no resgate, sem come-cotas. No vencimento, retorno garantido.</div>
    </div>
    <div class="caveat-card">
      <div class="caveat-badge yellow">⚠ LCI/LCA</div>
      <div class="caveat-title">Bom hoje, incerto amanhã</div>
      <div class="caveat-body">Prazo típico ~3 anos; impossível travar por 20 anos. Renova às taxas futuras. Com Selic em 15%, LCI a 14% isentos é excepcionalmente atrativo — mas é improvável que renove nesses níveis por 15–20 anos. Mude IR para 7,5% para simular eventual tributação.</div>
    </div>
    <div class="caveat-card">
      <div class="caveat-badge teal">◈ CDB</div>
      <div class="caveat-title">IR regressivo · FGC R$250k</div>
      <div class="caveat-body">IR cai de 22,5% (≤180d) a 15% (720d+). Rende pela taxa bruta; IR incide só no resgate. Atenção ao limite FGC por CPF por instituição.</div>
    </div>
    <div class="caveat-card">
      <div class="caveat-badge blue">◈ Ações · 3 cenários de preço</div>
      <div class="caveat-title">Valorização de preço já incluída</div>
      <div class="caveat-body">Cada cenário combina a valorização do preço (3% / 7% / 11% ao ano) com o DY configurado acima. O total return está explícito no ranking. Cenário Moderado 7% + DY 6% = ~13,4% a.a. — próximo de LCI 14%, por isso podem aparecer em posições similares quando a Selic está alta.</div>
    </div>
    <div class="caveat-card">
      <div class="caveat-badge blue">◈ Ações com Reinvestimento</div>
      <div class="caveat-title">Bola de neve via dividendos</div>
      <div class="caveat-body">Dividendos compram mais cotas → mais dividendos → efeito exponencial. O retorno real depende muito de qual ciclo de mercado se realiza — os cenários conservador (3%), moderado (7%) e otimista (11%) representam diferentes possibilidades históricas para ações de dividendos.</div>
    </div>
    <div class="caveat-card">
      <div class="caveat-badge red">◈ Ações sem Reinvestimento</div>
      <div class="caveat-title">Dividendos como renda corrente</div>
      <div class="caveat-body">Portfólio cresce só pela valorização de preço. Dividendos acumulam como caixa separado. A diferença vs. reinvestimento se torna enorme em 15–20 anos.</div>
    </div>
  </div>

</div><!-- /tab-simulador -->

<!-- TAB 2: RESERVA DE EMERGÊNCIA -->
<div id="tab-reserva" style="display:none;">

  <div class="header">
    <div class="header-eyebrow">Reserva de Emergência · Planejamento</div>
    <h1>Quanto você<br>precisa <em>guardar?</em></h1>
    <p class="header-sub">
      Calcule sua meta ideal, o tempo necessário para atingi-la e onde investir.
    </p>
  </div>

  <div class="res-grid">
    <!-- INPUTS -->
    <div class="res-inputs">
      <div class="res-section-title">Sua situação</div>

      <div class="res-input-row">
        <div class="res-input-group">
          <label>Pessoas na casa</label>
          <input type="number" id="res-pessoas" value="2" min="1" max="20" step="1">
          <span class="input-note" id="res-per-capita">≈ R$ 2.500/pessoa</span>
        </div>
        <div class="res-input-group">
          <label>Gasto fixo mensal</label>
          <input type="number" id="res-gasto" value="5000" min="0" step="500">
          <span class="input-note">R$: aluguel, comida, contas...</span>
        </div>
      </div>

      <div class="filhos-toggle-row">
        <div>
          <div class="filhos-toggle-label">Tem filhos menores de 18 anos?</div>
          <div class="filhos-toggle-sub">Afeta o prazo recomendado: 6 → 8 meses</div>
        </div>
        <div class="toggle-wrap">
          <label class="toggle-switch">
            <input type="checkbox" id="res-filhos">
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </label>
          <span class="toggle-label-text" id="filhosLabel">Não</span>
        </div>
      </div>

      <div class="res-input-row">
        <div class="res-input-group">
          <label>Já tenho guardado</label>
          <input type="number" id="res-atual" value="0" min="0" step="500">
          <span class="input-note">R$: reserva atual</span>
        </div>
        <div class="res-input-group">
          <label>Posso guardar/mês</label>
          <input type="number" id="res-poupar" value="500" min="0" step="100">
          <span class="input-note">R$: valor disponível</span>
        </div>
      </div>

      <div class="res-input-row">
        <div class="res-input-group">
          <label>Renda variável?</label>
          <select id="res-renda" style="background:var(--card);border:1px solid var(--border);color:var(--text);
            font-family:'DM Mono',monospace;font-size:13px;padding:10px 14px;outline:none;width:100%;">
            <option value="0">Emprego CLT estável</option>
            <option value="1">Renda variável / freelancer</option>
            <option value="2">Empresário / autônomo</option>
          </select>
          <span class="input-note">impacta meses recomendados</span>
        </div>
        <div class="res-input-group">
          <label>Rendimento da reserva</label>
          <input type="number" id="res-rendimento" value="13.5" min="0" max="30" step="0.5">
          <span class="input-note">% a.a. bruto (CDB liquidez diária)</span>
        </div>
      </div>

      <!-- RESULTADO -->
      <div class="res-result-box">
        <div class="res-result-grid">
          <div class="res-result-item">
            <div class="res-result-label">Meta ideal</div>
            <div class="res-result-value highlight" id="res-meta">R$ 30.000</div>
            <div class="res-result-sub" id="res-meta-sub">6 meses × R$ 5.000</div>
          </div>
          <div class="res-result-item">
            <div class="res-result-label">Falta acumular</div>
            <div class="res-result-value warn" id="res-falta">R$ 30.000</div>
            <div class="res-result-sub" id="res-falta-sub">100% da meta</div>
          </div>
          <div class="res-result-item">
            <div class="res-result-label">Tempo estimado</div>
            <div class="res-result-value ok" id="res-tempo">—</div>
            <div class="res-result-sub" id="res-tempo-sub">com rendimento da reserva</div>
          </div>
        </div>
        <div class="res-progress-wrap">
          <div class="res-progress-label">
            <span>Progresso atual</span>
            <span id="res-pct">0%</span>
          </div>
          <div class="res-progress-bar"><div class="res-progress-fill" id="res-fill" style="width:0%"></div></div>
        </div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="res-charts">
      <div class="res-chart-title">Distribuição da sua meta</div>
      <div class="res-donut-wrap"><canvas id="resDonut"></canvas></div>
      <div class="res-chart-title">Evolução até atingir a reserva</div>
      <div class="res-line-wrap"><canvas id="resLine"></canvas></div>
    </div>
  </div>

  <!-- EXPERT TIPS -->
  <div class="expert-tips">
    <div class="expert-tips-title">O que dizem os especialistas</div>
    <div class="expert-grid">
      <div class="expert-card">
        <div class="expert-name">Gustavo Cerbasi</div>
        <div class="expert-text">Recomenda de 6 a 12 meses de despesas, investida em ativos de liquidez diária. Para profissionais liberais e autônomos, prefere o teto de 12 meses.</div>
      </div>
      <div class="expert-card">
        <div class="expert-name">Nathalia Arcuri (Me Poupe!)</div>
        <div class="expert-text">Mínimo de 6 meses de gastos fixos. Para quem tem dependentes ou renda instável, eleva para 8–12 meses. A reserva deve ficar no Tesouro Selic ou CDB com liquidez diária.</div>
      </div>
      <div class="expert-card">
        <div class="expert-name">Dave Ramsey</div>
        <div class="expert-text">Baby Step 1: reserve R$ 1.000 de emergência rapidamente. Baby Step 3: complete com 3–6 meses de despesas. Prioridade antes de qualquer investimento.</div>
      </div>
      <div class="expert-card">
        <div class="expert-name">Onde investir a reserva</div>
        <div class="expert-text">Tesouro Selic (resgate D+1) · CDB liquidez diária de banco grande · Fundo DI taxa zero. Nunca em renda variável ou CDB sem liquidez; a reserva precisa estar disponível imediatamente.</div>
      </div>
    </div>
  </div>

</div><!-- /tab-reserva -->

<!-- TAB 3: CALCULADORA DE AÇÕES -->
<div id="tab-acoes" style="display:none;">

  <div class="header">
    <div class="header-eyebrow">Calculadora de Ações · Dividendos e Valorização</div>
    <h1>Quanto rende <em>sua ação?</em></h1>
    <p class="header-sub">
      Insira o ticker, DY histórico e capital. Veja os três cenários de crescimento e o valor líquido após IR.
    </p>
  </div>

  <!-- INPUTS -->
  <div class="inputs-section-label">Dados da Ação</div>
  <div class="inputs-bar">
    <div class="input-group" style="min-width:140px;">
      <label>Ticker</label>
      <input type="text" id="ac-ticker" value="ITUB4" maxlength="8"
        style="background:transparent;border:none;color:var(--text);font-family:'Fraunces',serif;
               font-size:28px;font-weight:900;width:100%;outline:none;text-transform:uppercase;">
      <span class="input-note">código da ação (ex: PETR4)</span>
    </div>
    <div class="input-group" style="min-width:180px;flex:2;">
      <label>DY Histórico % a.a.</label>
      <input type="number" id="ac-dy" value="7.0" min="0" max="50" step="0.5">
      <span class="input-note">média dos últimos 5–10 anos excluindo anos atípicos</span>
    </div>
    <div class="input-group">
      <label>Capital Inicial</label>
      <input type="number" id="ac-inicial" value="10000" min="0" step="1000">
      <span class="input-note">R$ investido hoje</span>
    </div>
    <div class="input-group">
      <label>Aporte Mensal</label>
      <input type="number" id="ac-aporte" value="1000" min="0" step="100">
      <span class="input-note">R$ por mês</span>
    </div>
    <div class="input-group">
      <label>Horizonte (anos)</label>
      <input type="number" id="ac-anos" value="20" min="1" max="40" step="1">
      <span class="input-note">período de acumulação</span>
    </div>
    <div class="input-group">
      <label>Reinvestir dividendos?</label>
      <div class="toggle-wrap" style="margin-top:4px;">
        <label class="toggle-switch">
          <input type="checkbox" id="ac-reinvest" checked>
          <div class="toggle-track"></div>
          <div class="toggle-thumb"></div>
        </label>
        <span class="toggle-label-text on" id="ac-reinvest-label">Sim</span>
      </div>
      <span class="input-note" id="ac-reinvest-note">dividendos compram mais ações</span>
    </div>
  </div>

  <!-- DY GUIDE -->
  <div style="padding:10px 40px;background:var(--panel);border-bottom:1px solid var(--border);font-size:10px;color:var(--muted);display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
    <span style="color:var(--blue);font-weight:500;">💡 Como calcular seu DY histórico:</span>
    <span>Some os dividendos pagos por ação em cada ano e divida pelo preço médio do ano · tire a média dos últimos 5 ou 10 anos.</span>
    <span style="color:var(--orange);">· Exclua anos com DY atípico (ex: distribuições extras em ano pós-pandemia) para uma base mais conservadora</span>
  </div>

  <!-- CARDS DE CENÁRIO + GRÁFICO -->
  <div class="ac-main">
    <!-- GRÁFICO — topo, largura total -->
    <div class="ac-chart-area">
      <div class="section-label" style="width:min(820px,100%);">Evolução Patrimonial · <span id="ac-ticker-label">PETR4</span> · <span id="ac-anos-label">20</span> anos</div>
      <div class="ac-chart-wrap"><canvas id="acChart"></canvas></div>
      <div class="legend-grid" id="ac-legend" style="width:min(820px,100%);"></div>
    </div>

    <!-- 3 CENÁRIOS em linha -->
    <div class="ac-scenarios">
      <div class="ac-scenario-card" id="ac-card-cons">
        <div class="ac-sc-header">
          <span class="ac-sc-badge" style="background:var(--blue-faint);color:var(--blue);border-color:var(--blue);">Conservador</span>
          <span class="ac-sc-growth" id="ac-growth-cons">+3% preço/ano</span>
        </div>
        <div class="ac-sc-body">
          <div class="ac-sc-col">
            <div class="ac-sc-label">Patrimônio bruto</div>
            <div class="ac-sc-val" id="ac-fv-cons" style="color:var(--blue);">—</div>
          </div>
          <div class="ac-sc-col">
            <div class="ac-sc-label">No bolso (após IR)</div>
            <div class="ac-sc-val-net" id="ac-net-cons">—</div>
          </div>
        </div>
        <div class="ac-sc-detail" id="ac-detail-cons"></div>
      </div>

      <div class="ac-scenario-card" id="ac-card-mod">
        <div class="ac-sc-header">
          <span class="ac-sc-badge" style="background:var(--violet-faint);color:var(--violet);border-color:var(--violet);">Moderado</span>
          <span class="ac-sc-growth" id="ac-growth-mod">+7% preço/ano</span>
        </div>
        <div class="ac-sc-body">
          <div class="ac-sc-col">
            <div class="ac-sc-label">Patrimônio bruto</div>
            <div class="ac-sc-val" id="ac-fv-mod" style="color:var(--violet);">—</div>
          </div>
          <div class="ac-sc-col">
            <div class="ac-sc-label">No bolso (após IR)</div>
            <div class="ac-sc-val-net" id="ac-net-mod">—</div>
          </div>
        </div>
        <div class="ac-sc-detail" id="ac-detail-mod"></div>
      </div>

      <div class="ac-scenario-card rank-1" id="ac-card-otm">
        <div class="ac-sc-header">
          <span class="ac-sc-badge" style="background:var(--green-faint);color:var(--green);border-color:var(--green);">Otimista</span>
          <span class="ac-sc-growth" id="ac-growth-otm">+11% preço/ano</span>
        </div>
        <div class="ac-sc-body">
          <div class="ac-sc-col">
            <div class="ac-sc-label">Patrimônio bruto</div>
            <div class="ac-sc-val" id="ac-fv-otm" style="color:var(--green);">—</div>
          </div>
          <div class="ac-sc-col">
            <div class="ac-sc-label">No bolso (após IR)</div>
            <div class="ac-sc-val-net" id="ac-net-otm">—</div>
          </div>
        </div>
        <div class="ac-sc-detail" id="ac-detail-otm"></div>
      </div>
    </div>

    <!-- IR note — full width below cards -->
    <div style="font-size:9px;color:var(--muted);line-height:1.7;padding:10px 20px;border-top:1px solid var(--border);background:var(--panel);">
      <strong style="color:var(--text);">IR sobre ações:</strong>
      Dividendos são isentos de IR. Ganho de capital na venda: 15% para operações comuns (até R$20k/mês isentos),
      20% para day-trade. O cálculo aqui aplica 15% apenas sobre o ganho de preço (valorização).
    </div>
  </div>

  <!-- DIVIDENDOS PROJETADOS -->
  <div class="ac-dividends-section">
    <div class="section-label" style="padding:0 40px;margin-bottom:0;padding-top:20px;">Renda de Dividendos Projetada (cenário moderado)</div>
    <div class="ac-div-grid" id="ac-div-grid"></div>
  </div>

</div><!-- /tab-acoes -->

<!-- TAB 4: REBALANCEAMENTO DE CARTEIRA -->
<div id="tab-rebalance" style="display:none;">

  <div class="header">
    <div class="header-eyebrow">Rebalanceamento de Carteira · Alocação por Perfil</div>
    <h1>Como está sua <em>carteira?</em></h1>
    <p class="header-sub">
      Veja os três perfis de alocação lado a lado. Informe quanto você tem em cada classe e descubra o que comprar para rebalancear. Opinião pessoal: Se preocupe com isso quando tiver mais de 50 mil,
       antes disso não vai valer a pena a dor de cabeça de diversificar tanto, desde que esteja investindo em empresas seguras.
    </p>
  </div>

  <!-- OPÇÕES DE CLASSES -->
  <div class="rb-options-bar">
    <span style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);">Incluir na carteira:</span>
    <label class="rb-opt-toggle">
      <input type="checkbox" id="rb-use-fii" checked onchange="rebuildProfiles()">
      <span class="rb-opt-box">
        <span class="rb-opt-dot" style="background:#f59e0b"></span>
        Fundos Imobiliários
      </span>
      <span class="rb-opt-sub">desativado → % vai para Ações</span>
    </label>
    <label class="rb-opt-toggle">
      <input type="checkbox" id="rb-use-prot" checked onchange="rebuildProfiles()">
      <span class="rb-opt-box">
        <span class="rb-opt-dot" style="background:#f87171"></span>
        Proteção (Ouro/Dólar)
      </span>
      <span class="rb-opt-sub">desativado → % vai para Renda Fixa</span>
    </label>
  </div>

  <!-- PERFIS SIDE BY SIDE -->
  <div class="rb-profiles-bar">
    <div class="rb-profile-header">
      <div class="rb-ph-empty"></div>
      <div class="rb-ph-label cons">🛡️ Conservador</div>
      <div class="rb-ph-label mod">⚖️ Moderado</div>
      <div class="rb-ph-label arr">🚀 Arrojado</div>
    </div>

    <!-- Renda Fixa -->
    <div class="rb-row" id="rbrow-rf">
      <div class="rb-row-label">
        <span class="rb-dot" style="background:#a78bfa"></span>
        Renda Fixa
        <span class="rb-row-sub">Tesouro, CDB, LCI/LCA</span>
      </div>
      <div class="rb-row-bar cons"><div class="rb-bar-fill" id="rbbar-rf-cons" style="background:#a78bfa"></div><span id="rbpct-rf-cons">75%</span></div>
      <div class="rb-row-bar mod"><div class="rb-bar-fill" id="rbbar-rf-mod" style="background:#a78bfa"></div><span id="rbpct-rf-mod">50%</span></div>
      <div class="rb-row-bar arr"><div class="rb-bar-fill" id="rbbar-rf-arr" style="background:#a78bfa"></div><span id="rbpct-rf-arr">20%</span></div>
    </div>

    <!-- Ações -->
    <div class="rb-row" id="rbrow-ac">
      <div class="rb-row-label">
        <span class="rb-dot" style="background:#3dd68c"></span>
        Ações
        <span class="rb-row-sub">Ações BR, BDRs, ETFs</span>
      </div>
      <div class="rb-row-bar cons"><div class="rb-bar-fill" id="rbbar-ac-cons" style="background:#3dd68c"></div><span id="rbpct-ac-cons">10%</span></div>
      <div class="rb-row-bar mod"><div class="rb-bar-fill" id="rbbar-ac-mod" style="background:#3dd68c"></div><span id="rbpct-ac-mod">30%</span></div>
      <div class="rb-row-bar arr"><div class="rb-bar-fill" id="rbbar-ac-arr" style="background:#3dd68c"></div><span id="rbpct-ac-arr">55%</span></div>
    </div>

    <!-- FIIs (ocultável) -->
    <div class="rb-row" id="rbrow-fii">
      <div class="rb-row-label">
        <span class="rb-dot" style="background:#f59e0b"></span>
        Fundos Imobiliários
        <span class="rb-row-sub">FIIs listados em bolsa</span>
      </div>
      <div class="rb-row-bar cons"><div class="rb-bar-fill" id="rbbar-fii-cons" style="background:#f59e0b"></div><span id="rbpct-fii-cons">10%</span></div>
      <div class="rb-row-bar mod"><div class="rb-bar-fill" id="rbbar-fii-mod" style="background:#f59e0b"></div><span id="rbpct-fii-mod">15%</span></div>
      <div class="rb-row-bar arr"><div class="rb-bar-fill" id="rbbar-fii-arr" style="background:#f59e0b"></div><span id="rbpct-fii-arr">20%</span></div>
    </div>

    <!-- Proteção (ocultável) -->
    <div class="rb-row" id="rbrow-prot">
      <div class="rb-row-label">
        <span class="rb-dot" style="background:#f87171"></span>
        Proteção
        <span class="rb-row-sub">Ouro (GOLD11), Dólar/BDR</span>
      </div>
      <div class="rb-row-bar cons"><div class="rb-bar-fill" id="rbbar-prot-cons" style="background:#f87171"></div><span id="rbpct-prot-cons">5%</span></div>
      <div class="rb-row-bar mod"><div class="rb-bar-fill" id="rbbar-prot-mod" style="background:#f87171"></div><span id="rbpct-prot-mod">5%</span></div>
      <div class="rb-row-bar arr"><div class="rb-bar-fill" id="rbbar-prot-arr" style="background:#f87171"></div><span id="rbpct-prot-arr">5%</span></div>
    </div>

    <!-- Referência Ray Dalio -->
    <div class="rb-dalio-note">
      <strong>Referência internacional: Ray Dalio (All Weather):</strong>
      30% Ações · 55% Renda Fixa · 7,5% Ouro · 7,5% Commodities.
      Estratégia de "risco balanceado" voltada para preservação com crescimento moderado.
      <a href="https://www.bridgewater.com" target="_blank" rel="noopener" style="color:var(--blue);text-decoration:none;">Bridgewater Associates ↗</a>
    </div>
  </div>

  <!-- MINHA CARTEIRA ATUAL -->
  <div class="inputs-section-label">Minha Carteira Atual</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Renda Fixa</label>
      <input type="number" id="rb-rf" value="0" min="0" step="100" oninput="calcRebalance()">
      <span class="input-note">R$ em Tesouro, CDB, LCI…</span>
    </div>
    <div class="input-group">
      <label>Ações</label>
      <input type="number" id="rb-ac" value="0" min="0" step="100" oninput="calcRebalance()">
      <span class="input-note">R$ em ações e ETFs</span>
    </div>
    <div id="rb-fii-input-wrap" class="input-group">
      <label>Fundos Imobiliários</label>
      <input type="number" id="rb-fii" value="0" min="0" step="100" oninput="calcRebalance()">
      <span class="input-note">R$ em FIIs</span>
    </div>
    <div id="rb-prot-input-wrap" class="input-group">
      <label>Proteção (Ouro/Dólar)</label>
      <input type="number" id="rb-prot" value="0" min="0" step="100" oninput="calcRebalance()">
      <span class="input-note">R$ em ouro, dólar, BDR</span>
    </div>
    <div class="input-group" style="background:var(--green-faint);border:1px solid var(--green);padding:12px 16px;">
      <label style="color:var(--green);">Total da Carteira</label>
      <div id="rb-total" style="font-family:'Fraunces',serif;font-size:26px;font-weight:700;color:var(--green);">R$ 0</div>
      <span class="input-note">soma automática</span>
    </div>
  </div>

  <!-- RESULTADO DO REBALANCEAMENTO -->
  <div id="rb-result-section" style="display:none;">
    <div class="inputs-section-label">Diagnóstico · o que comprar para rebalancear</div>

    <!-- SELECTOR DE PERFIL -->
    <div style="padding:0 40px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <span style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);">Perfil alvo:</span>
      <button class="rb-profile-btn active" id="rbp-cons" onclick="setRbProfile('cons')">🛡️ Conservador</button>
      <button class="rb-profile-btn" id="rbp-mod" onclick="setRbProfile('mod')">⚖️ Moderado</button>
      <button class="rb-profile-btn" id="rbp-arr" onclick="setRbProfile('arr')">🚀 Arrojado</button>
    </div>

    <div class="rb-diag-grid" id="rb-diag-grid"></div>

    <!-- DONUT -->
    <div class="rb-charts-row">
      <div class="rb-donut-area">
        <div class="rb-chart-title">SUA CARTEIRA ATUAL</div>
        <div class="rb-donut-wrap"><canvas id="rbCurrentDonut"></canvas></div>
      </div>
      <div class="rb-donut-area">
        <div class="rb-chart-title" id="rb-target-title">CARTEIRA ALVO: CONSERVADOR</div>
        <div class="rb-donut-wrap"><canvas id="rbTargetDonut"></canvas></div>
      </div>
    </div>
  </div>

  <!-- NOTA SOBRE RESERVA DE EMERGÊNCIA -->
  <div style="padding:20px 40px;border-top:1px solid var(--border);font-size:10px;color:var(--muted);line-height:1.7;background:var(--panel);">
    <strong style="color:var(--text);">⚠ Atenção:</strong>
    Os valores acima são a sua <em>carteira de investimentos</em>; não inclua a reserva de emergência nesse cálculo.
    A reserva de emergência (6–12 meses de gastos, em CDB ou Tesouro Selic com liquidez diária) deve estar separada e
    não é considerada parte da carteira de longo prazo. Use a aba <strong>Reserva de Emergência</strong> para calculá-la.
    · <strong>Proteção (Ouro/Dólar)</strong> é diferente de reserva de emergência: é uma camada de proteção patrimonial contra crises e desvalorização cambial,
    com correlação negativa à bolsa. Recomendação: ouro via ETF <strong>GOLD11</strong> ou fundos referenciados em ouro/dólar. Atenção à inflação norte-americana atual,
     ouro talvez deva ser considerado mais interessante.
  </div>

</div><!-- /tab-rebalance -->

<div id="tab-fire" style="display:none;">

  <div class="header">
    <div class="header-eyebrow">Independência Financeira · FIRE</div>
    <h1>Quando você pode <em>parar de trabalhar?</em></h1>
    <p class="header-sub">
      Calcule seu número FIRE: o patrimônio necessário para viver de renda. Veja a curva de dividendos cruzando seus gastos.
    </p>
  </div>

  <!-- INPUTS -->
  <div class="inputs-section-label">Seus Dados</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Patrimônio Atual</label>
      <input type="number" id="fi-patrimonio" value="10000" min="0" step="1000">
      <span class="input-note">R$ investido hoje</span>
    </div>
    <div class="input-group">
      <label>Aporte Mensal</label>
      <input type="number" id="fi-aporte" value="1000" min="0" step="100">
      <span class="input-note">R$ por mês</span>
    </div>
    <div class="input-group">
      <label>Gasto Mensal Desejado</label>
      <input type="number" id="fi-gasto" value="2000" min="0" step="500">
      <span class="input-note">R$ de hoje (será corrigido pela inflação)</span>
    </div>
    <div class="input-group">
      <label>DY Esperado da Carteira %</label>
      <input type="number" id="fi-dy" value="6.0" min="1" max="20" step="0.5">
      <span class="input-note">dividend yield anual médio esperado</span>
    </div>
    <div class="input-group">
      <label>Inflação Anual % (IPCA)</label>
      <input type="number" id="fi-inflacao" value="4.4" min="0" max="20" step="0.5">
      <span class="input-note">para corrigir o gasto futuro. Considere os 12 últimos meses</span>
    </div>
    <div class="input-group">
      <label>Aporte cresce com inflação?</label>
      <div class="toggle-wrap" style="margin-top:4px;">
        <label class="toggle-switch">
          <input type="checkbox" id="fi-aporte-inflacao" onchange="calcFire()">
          <div class="toggle-track"></div>
          <div class="toggle-thumb"></div>
        </label>
        <span class="toggle-label-text" id="fi-aporte-inflacao-label">Não</span>
      </div>
      <span class="input-note">ativado → salário sobe com inflação e aporte acompanha</span>
    </div>
  </div>

  <!-- IR BANNER -->
  <div class="fi-ir-banner">
    <div class="fi-ir-item fi-ir-green">
      <span class="fi-ir-icon">📈</span>
      <div>
        <div class="fi-ir-title">Dividendos de Ações e FIIs · <strong>Isentos de IR</strong></div>
        <div class="fi-ir-desc">Pela Lei 9.249/95, dividendos distribuídos por empresas brasileiras não sofrem tributação, independentemente do valor. R$ 10 mil ou R$ 200 mil por mês: zero imposto. O campo "DY" já representa o valor líquido que entra na sua conta.</div>
      </div>
    </div>
    <div class="fi-ir-item fi-ir-orange">
      <span class="fi-ir-icon">🏦</span>
      <div>
        <div class="fi-ir-title">Juros de Renda Fixa · <strong>IR retido na fonte</strong></div>
        <div class="fi-ir-desc">CDB, Tesouro Direto e similares têm IR regressivo: 22,5% (até 180 dias), 20% (até 360 dias), 17,5% (até 720 dias) e 15% (acima de 720 dias). A tabela comparativa usa a taxa que você informar como líquida, certifique-se de descontar o IR antes de digitar. Ex: CDB a 13% bruto por mais de 2 anos ≈ 11% líquido.</div>
      </div>
    </div>
  </div>

  <!-- ARMADILHA DA INFLAÇÃO — PRIMEIRO, PARA NÃO PASSAR DESPERCEBIDO -->
  <div class="inputs-section-label">A Armadilha da Inflação · Por que ações precisam de mais capital mas são melhores no longo prazo</div>

  <div class="fi-trap-intro">
    Renda fixa a <strong id="trap-rf-rate-label">11%</strong> parece precisar de menos patrimônio que ações com DY de <strong id="trap-dy-label">7%</strong>.
    Mas essa comparação é uma <strong style="color:var(--orange);">foto de hoje</strong>, não um filme de 20 anos.
    <br><br>
    A tabela abaixo simula a <strong>fase de aposentadoria</strong>: você já chegou na meta, parou de aportar e vive da renda. Na perpetuidade, você retira 100% dos juros/dividendo todo mês para cobrir seus gastos,
     então nada é reinvestido e o principal da Renda Fixa fica estagnado. Nas ações, o preço das empresas cresce independentemente dos dividendos retirados, fazendo o patrimônio aumentar.
    <span class="fi-trap-rf-input-wrap">
      Renda Fixa comparativa: <input type="number" id="trap-rf-taxa" value="11.0" min="1" max="25" step="0.5" oninput="calcFire()"> % líquido
    </span>
  </div>

  <div class="fi-trap-grid">
    <div class="fi-trap-head fi-trap-blank"></div>
    <div class="fi-trap-head fi-trap-head-rv">📈 Ações e FIIs<span>DY <span id="trap-head-dy">7%</span> + valorização</span></div>
    <div class="fi-trap-head fi-trap-head-rf">🏦 Renda Fixa<span>Taxa líquida <span id="trap-head-rf">11%</span></span></div>

    <div class="fi-trap-row-label">Patrimônio necessário <em>hoje</em></div>
    <div class="fi-trap-cell fi-trap-cell-rv" id="trap-pat-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf" id="trap-pat-rf">...</div>

    <div class="fi-trap-row-label">Renda mensal <em>hoje</em></div>
    <div class="fi-trap-cell fi-trap-cell-rv" id="trap-renda-hoje-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf" id="trap-renda-hoje-rf">...</div>

    <div class="fi-trap-row-label">Patrimônio em <em>20 anos</em> <small>(cenário moderado)</small></div>
    <div class="fi-trap-cell fi-trap-cell-rv fi-trap-highlight" id="trap-pat20-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf" id="trap-pat20-rf">...</div>

    <div class="fi-trap-row-label">Renda mensal em <em>20 anos</em> <small>(nominal)</small></div>
    <div class="fi-trap-cell fi-trap-cell-rv fi-trap-highlight" id="trap-renda20-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf" id="trap-renda20-rf">...</div>

    <div class="fi-trap-row-label">Poder de compra em <em>20 anos</em> <small>(em R$ de hoje)</small></div>
    <div class="fi-trap-cell fi-trap-cell-rv fi-trap-highlight" id="trap-real20-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf fi-trap-danger" id="trap-real20-rf">...</div>

    <div class="fi-trap-row-label">Seu gasto em <em>20 anos</em> <small>(corrigido pelo IPCA)</small></div>
    <div class="fi-trap-cell fi-trap-span fi-trap-gasto20" id="trap-gasto20">...</div>
    <div class="fi-trap-cell" style="display:none;"></div>

    <div class="fi-trap-row-label fi-trap-verdict-label">Cobre seus gastos em 20 anos?</div>
    <div class="fi-trap-cell fi-trap-cell-rv fi-trap-verdict" id="trap-verdict-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf fi-trap-verdict" id="trap-verdict-rf">...</div>
  </div>

  <div class="fi-trap-footnote" id="fi-trap-footnote"></div>

  <!-- SEÇÃO 1: NÚMERO FIRE -->
  <div class="inputs-section-label">Seção 1 · Quanto preciso acumular?</div>

  <div class="fi-methods-bar">
    <div class="fi-method-card">
      <div class="fi-method-title" style="color:var(--green);">🌱 Pelo DY (Perpetuidade)</div>
      <div class="fi-method-desc">
        Vive <strong>só dos dividendos</strong> sem tocar no principal.<br>
        Fórmula: <code>Meta = Gasto anual ÷ DY</code><br>
        Mais conservador e adequado ao modelo brasileiro. O patrimônio é preservado para sempre.
      </div>
    </div>
    <div class="fi-method-card">
      <div class="fi-method-title" style="color:var(--blue);">📐 Regra dos 4% (Estudo Trinity)</div>
      <div class="fi-method-desc">
        Retira 4% do patrimônio por ano, inclui <strong>venda parcial de ativos</strong>.<br>
        Fórmula: <code>Meta = Gasto anual ÷ 0,04 = Gasto × 300</code><br>
        Modelo americano. Estatisticamente sustentável por 30 anos ou mais.
      </div>
    </div>
  </div>

  <div class="fi-meta-grid">
    <div class="fi-meta-card" id="fi-card-dy">
      <div class="fi-meta-badge" style="color:var(--green);border-color:var(--green);background:var(--green-faint);">Pelo DY · Perpetuidade</div>
      <div class="fi-meta-label">Meta patrimonial</div>
      <div class="fi-meta-val" id="fi-meta-dy" style="color:var(--green);">...</div>
      <div class="fi-meta-sub" id="fi-meta-dy-sub"></div>
      <div class="fi-meta-falta-label">Falta acumular</div>
      <div class="fi-meta-falta" id="fi-falta-dy">...</div>
      <div class="fi-tempos" id="fi-tempos-dy"></div>
    </div>
    <div class="fi-meta-card" id="fi-card-4pct">
      <div class="fi-meta-badge" style="color:var(--blue);border-color:var(--blue);background:var(--blue-faint);">Regra dos 4%</div>
      <div class="fi-meta-label">Meta patrimonial</div>
      <div class="fi-meta-val" id="fi-meta-4pct" style="color:var(--blue);">...</div>
      <div class="fi-meta-sub" id="fi-meta-4pct-sub"></div>
      <div class="fi-meta-falta-label">Falta acumular</div>
      <div class="fi-meta-falta" id="fi-falta-4pct">...</div>
      <div class="fi-tempos" id="fi-tempos-4pct"></div>
    </div>
  </div>

  <div class="fi-nota">
    <strong>Fase de acumulação vs fase de retirada:</strong>
    O portfólio cresce pelo <em>total return</em> (valorização de preço + DY reinvestido) durante a acumulação.
    Na aposentadoria pelo método do DY, você vive apenas dos dividendos sem vender ações, preservando o principal.
    Pelo método dos 4%, você retira 4% ao ano do patrimônio, o que inclui venda gradual de ativos.
    Os três cenários (conservador, moderado, otimista) refletem taxas de valorização de preço de +3%, +7% e +11% ao ano.
    <strong>Sobre IR:</strong> dividendos de ações e FIIs são isentos de IR. O DY informado já é o valor líquido. Para a Renda Fixa comparativa, informe sempre a taxa já descontado o imposto.
  </div>

  <!-- SEÇÃO 2: CURVA DA LIBERDADE -->
  <div class="inputs-section-label" style="margin-top:0;">Seção 2 · Curva da Liberdade · Quando os dividendos cobrem seus gastos?</div>

  <div class="fi-chart-area">
    <div class="fi-chart-controls">
      <label class="fi-toggle-inflation">
        <input type="checkbox" id="fi-ajusta-inflacao" checked onchange="calcFire()">
        <span>Gasto corrigido pela inflação</span>
      </label>
      <span class="fi-ctrl-note">quando ativado, a linha de gastos cresce <span id="fi-inflacao-label">4%</span>/ano</span>
    </div>
    <div class="fi-crossing-badges" id="fi-crossing-badges"></div>
    <div class="fi-main-chart-wrap"><canvas id="fireChart"></canvas></div>
    <div class="legend-grid" id="fi-legend"></div>
  </div>

  <div class="fi-evolution-section">
    <div class="section-label" style="padding:20px 40px 14px;">Evolução da Renda de Dividendos · Cenário Moderado</div>
    <div class="fi-evo-grid" id="fi-evo-grid"></div>
  </div>

</div><!-- /tab-fire -->

<!-- TAB: META PATRIMONIAL -->
<div id="tab-meta" style="display:none;">

  <div class="header" id="tab-meta-header">
    <div class="header-eyebrow">Planejamento · Meta Patrimonial</div>
    <h1>Quanto preciso <em>aportar?</em></h1>
    <p class="header-sub">Defina sua meta e descubra o aporte mensal necessário, ou quanto tempo levará com o que você já contribui.</p>
  </div>

  <div class="inputs-section-label">Seus Dados</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Meta (valor alvo)</label>
      <input type="number" id="meta-alvo" value="1000000" min="1000" step="50000" oninput="calcMeta()">
      <span class="input-note">R$ que deseja acumular</span>
    </div>
    <div class="input-group">
      <label>Patrimônio Atual</label>
      <input type="number" id="meta-atual" value="10000" min="0" step="1000" oninput="calcMeta()">
      <span class="input-note">R$ já investido hoje</span>
    </div>
    <div class="input-group">
      <label>Prazo (anos)</label>
      <input type="number" id="meta-prazo" value="15" min="1" max="50" step="1" oninput="calcMeta()">
      <span class="input-note">horizonte de tempo desejado</span>
    </div>
    <div class="input-group">
      <label>Rentabilidade % a.a.</label>
      <input type="number" id="meta-taxa" value="11.0" min="0.1" max="30" step="0.5" oninput="calcMeta()">
      <span class="input-note">retorno anual já líquido de IR</span>
    </div>
    <div class="input-group">
      <label>Inflação % a.a. (IPCA)</label>
      <input type="number" id="meta-inflacao" value="4.4" min="0" max="20" step="0.5" oninput="calcMeta()">
      <span class="input-note">para mostrar o valor real futuro</span>
    </div>
    <div class="input-group">
      <label>Aporte atual /mês</label>
      <input type="number" id="meta-aporte-input" value="1000" min="0" step="100" oninput="calcMeta()">
      <span class="input-note">para calcular prazo alternativo</span>
    </div>
  </div>

  <!-- RESULTADOS PRINCIPAIS -->
  <div class="meta-results-grid">
    <div class="meta-result-card meta-card-primary">
      <div class="meta-result-eyebrow">Aporte mensal necessário</div>
      <div class="meta-result-val" id="meta-aporte-necessario" style="color:var(--green);">...</div>
      <div class="meta-result-sub" id="meta-aporte-sub">para atingir a meta no prazo</div>
    </div>
    <div class="meta-result-card">
      <div class="meta-result-eyebrow">Prazo com aporte atual</div>
      <div class="meta-result-val" id="meta-prazo-atual" style="color:var(--blue);">...</div>
      <div class="meta-result-sub" id="meta-prazo-sub">com o aporte informado</div>
    </div>
    <div class="meta-result-card">
      <div class="meta-result-eyebrow">Total que você vai aportar</div>
      <div class="meta-result-val" id="meta-total-aportado" style="color:var(--muted);">...</div>
      <div class="meta-result-sub" id="meta-total-sub">capital investido no período</div>
    </div>
    <div class="meta-result-card">
      <div class="meta-result-eyebrow">Gerado pelos juros compostos</div>
      <div class="meta-result-val" id="meta-juros" style="color:var(--yellow);">...</div>
      <div class="meta-result-sub" id="meta-juros-pct">o dinheiro trabalhando por você</div>
    </div>
    <div class="meta-result-card">
      <div class="meta-result-eyebrow">Valor real em poder de compra</div>
      <div class="meta-result-val" id="meta-valor-real" style="color:var(--muted);">...</div>
      <div class="meta-result-sub" id="meta-real-sub">equivalente em R$ de hoje</div>
    </div>
  </div>

  <div class="fi-nota" style="border-top:1px solid var(--border);">
    <strong>Como interpretar:</strong>
    O aporte necessário usa juros compostos mensais para atingir exatamente a meta no prazo.
    A rentabilidade deve ser informada já líquida de impostos. Para CDB e Tesouro Direto, desconte o IR antes de informar.
    Dividendos de ações e FIIs são isentos de IR e podem ser usados diretamente.
    O valor real desconta a inflação acumulada no período, mostrando o poder de compra equivalente em reais de hoje.
  </div>

  <!-- CENÁRIOS COMPARATIVOS -->
  <div class="inputs-section-label">Comparativo de Taxas de Retorno</div>
  <div class="meta-scenarios-grid" id="meta-scenarios-grid"></div>

  <!-- GRÁFICO CENTRALIZADO -->
  <div class="meta-chart-section">
    <div class="section-label" style="width:100%;max-width:820px;">Evolução Patrimonial ao longo do prazo</div>
    <div class="meta-chart-wrap"><canvas id="metaChart"></canvas></div>
    <div class="legend-grid" id="meta-legend" style="width:100%;max-width:820px;margin-top:10px;"></div>
  </div>

  <!-- MARCOS DE PROGRESSO -->
  <div class="inputs-section-label" style="margin-top:0;">Marcos ao longo do caminho</div>
  <div class="meta-milestones" id="meta-milestones"></div>

</div><!-- /tab-meta -->

<!-- TAB: PREÇO JUSTO -->
<div id="tab-preco" style="display:none;">

  <div class="header" id="tab-preco-header">
    <div class="header-eyebrow">Análise Fundamentalista · Preço Justo</div>
    <h1>A ação está <em>cara ou barata?</em></h1>
    <p class="header-sub">Três métodos clássicos para estimar o valor intrínseco de uma ação. Insira os dados e compare com o preço atual.</p>
  </div>

  <div class="inputs-section-label">Dados da Empresa</div>
  <div class="inputs-bar">
    <div class="input-group" id="pj-ticker-group">
      <label>Ticker</label>
      <input type="text" id="pj-ticker" value="" maxlength="8" autocomplete="off"
        oninput="this.value=this.value.toUpperCase();onTickerInput(this.value)"
        onkeydown="onTickerKeydown(event)"
        placeholder="Ex: ITUB4, PETR4...">
      <span class="input-note" id="pj-ticker-note">digite o ticker para buscar automaticamente</span>
    </div>
    <div class="input-group">
      <label>Preço Atual (R$) <span id="pj-preco-badge" class="pj-api-badge" style="display:none;">via Brapi</span></label>
      <input type="number" id="pj-preco" value="26.93" min="0.01" step="0.01" oninput="calcPreco()">
      <span class="input-note" id="pj-preco-note">cotação atual</span>
    </div>
    <div class="input-group">
      <label>LPA (R$)</label>
      <input type="number" id="pj-lpa" value="2.24" min="0" step="0.01" oninput="calcPreco()">
      <span class="input-note">Lucro por Ação dos últimos 12 meses</span>
    </div>
    <div class="input-group">
      <label>VPA (R$)</label>
      <input type="number" id="pj-vpa" value="31.78" min="0" step="0.01" oninput="calcPreco()">
      <span class="input-note">Valor Patrimonial por Ação</span>
    </div>
    <div class="input-group" style="min-width:340px;">
      <label>DPA · Dividendo Por Ação (R$)</label>
      <input type="number" id="pj-dpa" value="1.20" min="0" step="0.01" oninput="calcPreco()">
      <span class="input-note">soma dos dividendos pagos por ação no último exercício fiscal já publicado (em R$, não em %)</span>
      <div class="pj-dpa-tip">
        <strong>Qual exercício usar?</strong> Empresas brasileiras entregam o balanço anual à CVM até março ou abril do ano seguinte.
        Antes disso, o ano mais recente ainda não está auditado e publicado.
        <br>Exemplo: em fevereiro de 2026, use o DPA de 2024 (não o de 2025, que ainda não foi publicado).
        <br>Como conferir: acesse o site de RI da empresa, o <strong>Investidor10</strong> ou o <strong>Status Invest</strong> e veja qual é o último ano com dados completos de dividendos.
        O DPA aparece como "Proventos por Ação" ou "Dividendos por Ação" no histórico anual.
      </div>
    </div>
  </div>

  <!-- AVISO SETORIAL -->
  <div class="pj-sector-warning" id="pj-sector-warning" style="display:none;"></div>

  <!-- 3 MÉTODOS -->
  <div class="pj-methods-grid">

    <div class="pj-method-card" id="pj-card-bazin">
      <div class="pj-method-header">
        <div class="pj-method-title">🌿 Décio Bazin</div>
        <div class="pj-method-formula-tag">Dividendo anual ÷ 0,06</div>
      </div>
      <div class="pj-method-desc">Bazin definia que uma ação só é barata se o DY for de pelo menos 6% ao ano. O preço justo é calculado dividindo o dividendo real pago por ação (DPA, em R$) por 0,06. O DPA é independente do preço de mercado, evitando referência circular.</div>
      <div class="pj-result-row">
        <div class="pj-result-block">
          <div class="pj-result-label">Preço justo</div>
          <div class="pj-result-val" id="pj-bazin-val">...</div>
        </div>
        <div class="pj-result-block">
          <div class="pj-result-label">Margem</div>
          <div class="pj-margem" id="pj-bazin-margem">...</div>
        </div>
        <div class="pj-result-block">
          <div class="pj-result-label">Veredito</div>
          <div class="pj-veredicto" id="pj-bazin-veredicto">...</div>
        </div>
      </div>
    </div>

    <div class="pj-method-card" id="pj-card-graham">
      <div class="pj-method-header">
        <div class="pj-method-title">📐 Benjamin Graham</div>
        <div class="pj-method-formula-tag">√(22,5 × LPA × VPA)</div>
      </div>
      <div class="pj-method-desc">Graham combinava P/L máximo de 15 com P/VP máximo de 1,5. O produto 15 × 1,5 = 22,5 dá origem à fórmula. Funciona melhor para empresas maduras com lucros estáveis.</div>
      <div class="pj-result-row">
        <div class="pj-result-block">
          <div class="pj-result-label">Preço justo</div>
          <div class="pj-result-val" id="pj-graham-val">...</div>
        </div>
        <div class="pj-result-block">
          <div class="pj-result-label">Margem</div>
          <div class="pj-margem" id="pj-graham-margem">...</div>
        </div>
        <div class="pj-result-block">
          <div class="pj-result-label">Veredito</div>
          <div class="pj-veredicto" id="pj-graham-veredicto">...</div>
        </div>
      </div>
    </div>

  </div>

  <!-- CONSENSO -->
  <div class="pj-consenso-bar">
    <div class="pj-consenso-inner">
      <div class="pj-consenso-block">
        <div class="pj-consenso-label">Média dos 2 métodos</div>
        <div class="pj-consenso-val" id="pj-media">...</div>
      </div>
      <div class="pj-consenso-block">
        <div class="pj-consenso-label">Preço atual</div>
        <div class="pj-consenso-val" id="pj-preco-atual-display">...</div>
      </div>
      <div class="pj-consenso-block">
        <div class="pj-consenso-label">Upside potencial</div>
        <div class="pj-consenso-val" id="pj-upside">...</div>
      </div>
      <div class="pj-consenso-block">
        <div class="pj-consenso-label">Consenso geral</div>
        <div class="pj-consenso-val" id="pj-consenso-geral">...</div>
      </div>
    </div>
  </div>

  <!-- INDICADORES CALCULADOS -->
  <div class="inputs-section-label" style="margin-top:0;">Indicadores calculados</div>
  <div class="pj-indicators-grid" id="pj-indicators"></div>

  <div class="fi-nota">
    <strong>Limitações importantes:</strong>
    Cada método tem premissas diferentes. Bazin é ideal para pagadoras consistentes de dividendos.
    Graham funciona melhor para empresas com lucros previsíveis e lucros positivos.
    Nenhum modelo substitui uma análise completa. Use como ponto de partida e não como decisão de investimento.
    <strong>Este conteúdo não é recomendação de compra ou venda de ativos.</strong>
  </div>

  <div class="pj-print-bar">
    <button class="pj-print-btn" onclick="printPreco()">⬇ Salvar relatório como PDF</button>
    <span class="pj-print-hint">Abre a janela de impressão do navegador. Escolha "Salvar como PDF" no destino.</span>
  </div>

</div><!-- /tab-preco -->

<!-- FOOTER LEGAL (compartilhado) -->
<!-- TAB: RENDA DE DIVIDENDOS -->
<div id="tab-divs" style="display:none;">
  <div class="header" id="tab-divs-header">
    <div class="header-eyebrow">Planejamento · Renda de Dividendos</div>
    <h1>Quanto sua carteira<br><em>paga por mês?</em></h1>
    <p class="header-sub">Calcule a renda passiva da sua carteira atual e descubra quanto patrimônio você precisa para atingir uma meta de renda mensal via dividendos.</p>
  </div>

  <div class="inputs-section-label">Sua Carteira Atual</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Patrimônio investido (R$)</label>
      <input type="number" id="dv-patrimonio" value="100000" min="0" step="5000" oninput="calcDivs()">
      <span class="input-note">valor total aplicado hoje</span>
    </div>
    <div class="input-group">
      <label>DY médio da carteira % a.a.</label>
      <input type="number" id="dv-dy" value="8" min="0" max="30" step="0.5" oninput="calcDivs()">
      <span class="input-note">dividend yield médio ponderado</span>
    </div>
    <div class="input-group">
      <label>Aporte mensal (R$)</label>
      <input type="number" id="dv-aporte" value="1000" min="0" step="100" oninput="calcDivs()">
      <span class="input-note">quanto você investe por mês</span>
    </div>
    <div class="input-group">
      <label>Valorização anual da carteira % a.a.</label>
      <input type="number" id="dv-crescimento" value="10" min="0" max="30" step="0.5" oninput="calcDivs()">
      <span class="input-note">quanto o valor das suas cotas cresce por ano (preço). Referências: FIIs ≈ 5–8% · Ações de dividendos ≈ 8–12% · Use 0% para cenário conservador.</span>
    </div>
    <div class="input-group">
      <label>IPCA % a.a.</label>
      <input type="number" id="dv-ipca" value="4.0" min="0" max="20" step="0.5" oninput="calcDivs()">
      <span class="input-note">para calcular poder de compra real</span>
    </div>
  </div>

  <div class="inputs-section-label">Sua Meta de Renda Passiva</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Meta de renda mensal (R$)</label>
      <input type="number" id="dv-meta" value="5000" min="0" step="500" oninput="calcDivs()">
      <span class="input-note">quanto você quer receber por mês em dividendos</span>
    </div>
    <div class="input-group">
      <label>IR sobre dividendos %</label>
      <input type="number" id="dv-ir" value="0" min="0" max="30" step="2.5" oninput="calcDivs()">
      <span class="input-note">0% = isenção atual (Lei 9.249/95) · altere se mudar a legislação</span>
    </div>
  </div>

  <!-- Resultados principais -->
  <div class="meta-results-grid" id="dv-results-grid" style="border-bottom:1px solid var(--border);"></div>

  <!-- Gráfico projeção -->
  <div class="meta-chart-section">
    <div class="section-label" style="width:100%;max-width:820px;">Projeção de renda mensal ao longo do tempo</div>
    <div class="meta-chart-wrap"><canvas id="divChart"></canvas></div>
    <p class="chart-note" style="width:100%;max-width:820px;">* Projeção assume DY constante sobre patrimônio crescendo pelo crescimento informado mais aportes mensais. Dividendos não reinvestidos. Estimativa educacional.</p>
  </div>

  <!-- Patrimônio necessário para renda alvo -->
  <div class="inputs-section-label">Quanto patrimônio você precisa para cada meta de renda?</div>
  <div class="dv-metas-grid" id="dv-metas-grid"></div>

  <div class="fi-nota">
    <strong>Premissas:</strong> DY constante ao longo do tempo (simplificação). Na prática o DY oscila com o preço da ação e a política de dividendos da empresa.
    Dividendos atualmente isentos de IR para pessoa física no Brasil (Lei 9.249/95), mas a legislação pode mudar — use o campo de IR para simular diferentes cenários.
    <strong>Não é recomendação de investimento.</strong>
  </div>
</div><!-- /tab-divs -->
<!-- TAB: COMPARADOR DE RENDA FIXA -->
<div id="tab-crf" style="display:none;">
  <div class="header" id="tab-crf-header">
    <div class="header-eyebrow">Renda Fixa · Comparador Detalhado</div>
    <h1>CDB, LCI/LCA ou Tesouro direto, <em>quem ganha?</em></h1>
    <p class="header-sub">Compare até 6 aplicações lado a lado. IR pelo prazo (tabela regressiva), isenção de LCI/LCA e inflação já considerados. Resultado líquido real.</p>
  </div>

  <div class="inputs-section-label">Parâmetros da Comparação</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Capital inicial (R$)</label>
      <input type="number" id="crf-capital" value="50000" min="1000" step="5000" oninput="calcCRF()">
      <span class="input-note">valor que você vai aplicar</span>
    </div>
    <div class="input-group">
      <label>Prazo (meses)</label>
      <input type="number" id="crf-prazo" value="24" min="1" max="360" step="6" oninput="calcCRF()">
      <span class="input-note">período da aplicação</span>
    </div>
    <div class="input-group">
      <label>CDI % a.a.</label>
      <input type="number" id="crf-cdi" value="14.75" min="0" max="30" step="0.25" oninput="calcCRF()">
      <span class="input-note">base para cálculos pós-fixados</span>
    </div>
    <div class="input-group">
      <label>IPCA % a.a.</label>
      <input type="number" id="crf-ipca" value="4.0" min="0" max="20" step="0.5" oninput="calcCRF()">
      <span class="input-note">para calcular retorno real</span>
    </div>
  </div>

  <div class="inputs-section-label">Opções para Comparar</div>
  <div class="crf-options-grid" id="crf-options-grid"></div>
  <div style="padding:8px 40px;display:flex;align-items:center;gap:12px;">
    <button class="pj-print-btn" id="crf-add-btn" onclick="addCRFOption()" style="background:var(--panel);color:var(--text);border-color:var(--border2);">+ Adicionar opção</button>
    <span class="input-note" id="crf-count-label"></span>
  </div>

  <!-- Tabela comparativa -->
  <div class="inputs-section-label">Resultado Comparativo</div>
  <div class="crf-table-wrap">
    <table class="crf-table" id="crf-table">
      <thead>
        <tr>
          <th>Investimento</th>
          <th>Taxa efetiva</th>
          <th>Bruto final</th>
          <th>IR</th>
          <th>Líquido</th>
          <th>Ganho líquido</th>
          <th>Retorno real</th>
          <th>Melhor?</th>
        </tr>
      </thead>
      <tbody id="crf-tbody"></tbody>
    </table>
  </div>

  <!-- Gráfico -->
  <div class="meta-chart-section">
    <div class="section-label" style="width:100%;max-width:900px;">Crescimento do patrimônio mês a mês</div>
    <div style="height:220px;width:100%;max-width:900px;"><canvas id="crfChart"></canvas></div>
  </div>

  <div class="fi-nota">
    <strong>IR Tabela Regressiva (CDB e Tesouro Direto):</strong> até 180 dias = 22,5% · 181–360 dias = 20% · 361–720 dias = 17,5% · acima de 720 dias = 15%.
    LCI, LCA, CRI e CRA isentos de IR (pessoas físicas). Tesouro Direto segue a mesma tabela regressiva do CDB — não há come-cotas desde 2023.
    Retorno real = líquido descontado pelo IPCA do período. <strong>Não é recomendação de investimento.</strong>
  </div>
</div><!-- /tab-crf -->
<footer class="footer-legal">
  <div class="footer-legal-main">
    <div class="footer-legal-block">
      <h4>Isenção de Responsabilidade</h4>
      <p>As simulações apresentadas neste site têm caráter exclusivamente educacional e informativo. Os resultados são estimativas baseadas em premissas matemáticas e não constituem recomendação de investimento, consultoria financeira ou garantia de rentabilidade. Rentabilidade passada não é garantia de rentabilidade futura. O autor não se responsabiliza por decisões financeiras tomadas com base nas informações aqui apresentadas. Consulte sempre um profissional certificado (CFP® / CNPI) antes de investir.</p>
    </div>
    <div class="footer-legal-block">
      <h4>Direitos Autorais</h4>
      <p>Todo o conteúdo deste site (incluindo código-fonte, design, interface, textos e lógica de cálculo) é de propriedade exclusiva de <strong>Raoni Queiroz</strong> e está protegido pela Lei nº 9.610/1998 (Lei de Direitos Autorais) e pela legislação de propriedade intelectual brasileira. É expressamente proibida a cópia, reprodução, distribuição ou uso comercial de qualquer parte deste material sem autorização prévia e por escrito. Violações estão sujeitas às penalidades civis e criminais previstas em lei.</p>
    </div>
  </div>
  <div class="footer-bottom">
    <span class="footer-copy">© 2026 <strong>Raoni Queiroz</strong> · Todos os direitos reservados.</span>
    <span class="footer-copy">Simulação educacional, não é recomendação de investimento · fev/2026</span>
  </div>
</footer>

<script>

// -- SCROLL-AWARE NAV --
const navEl = document.querySelector('.page-nav');
window.addEventListener('scroll', () => {
  navEl.classList.toggle('scrolled', window.scrollY > 10);
}, { passive: true });


function animateCounter(el, targetVal, duration, formatter) {
  if (!el) return;
  el.classList.remove('num-updated');
  void el.offsetWidth;
  el.classList.add('num-updated');
  const start = performance.now();
  const startVal = 0;
  function step(now) {
    const progress = Math.min((now - start) / duration, 1);
    const ease = 1 - Math.pow(1 - progress, 3); // ease-out cubic
    const current = startVal + (targetVal - startVal) * ease;
    el.textContent = formatter(current);
    if (progress < 1) requestAnimationFrame(step);
    else el.textContent = formatter(targetVal);
  }
  requestAnimationFrame(step);
}
// estado global
let activeMonths = 120;
let chart = null;
let resDonutChart = null;
let resLineChart = null;
let hiddenSeries = new Set();
let reinvestDivs = true;
let cdbIRpct = 15;
let lciMode = 'pre';
let cdbMode = 'pre';


const TABS = {
  simulador:  { label: 'Simulador de Investimentos' },
  reserva:    { label: 'Reserva de Emergência' },
  acoes:      { label: 'Calculadora de Ações' },
  rebalance:  { label: 'Rebalanceamento de Carteira' },
  fire:       { label: 'Independência Financeira' },
  divs:       { label: 'Renda de Dividendos' },
  crf:        { label: 'Comparador de Renda Fixa' },
  meta:       { label: 'Meta Patrimonial' },
  preco:      { label: 'Preço Justo' }
};

function toggleMenu() {
  const btn      = document.getElementById('hamburgerBtn');
  const dropdown = document.getElementById('navDropdown');
  const isOpen   = dropdown.classList.contains('open');
  dropdown.classList.toggle('open', !isOpen);
  btn.classList.toggle('open', !isOpen);
}

// fechar ao clicar fora
document.addEventListener('click', e => {
  if (!e.target.closest('#hamburgerBtn') && !e.target.closest('#navDropdown')) {
    document.getElementById('navDropdown').classList.remove('open');
    document.getElementById('hamburgerBtn').classList.remove('open');
  }
});

// -- TAB NAVIGATION --
function showTab(tab) {
  const allTabs = ['simulador','reserva','acoes','rebalance','fire','divs','crf','meta','preco'];
  allTabs.forEach(t => {
    const el = document.getElementById('tab-' + t);
    el.style.display = 'none';
    el.classList.remove('tab-enter');
  });
  const activeEl = document.getElementById('tab-' + tab);
  activeEl.style.display = '';
  
  void activeEl.offsetWidth;
  activeEl.classList.add('tab-enter');

  Object.keys(TABS).forEach(key => {
    document.getElementById('menu-'+key).classList.toggle('active', key === tab);
  });

  document.getElementById('navActiveLabel').textContent = TABS[tab]?.label || '';
  document.getElementById('navDropdown').classList.remove('open');
  document.getElementById('hamburgerBtn').classList.remove('open');

  if (tab === 'reserva')   calcReserva();
  if (tab === 'simulador') buildAll();
  if (tab === 'acoes')     calcAcoes();
  if (tab === 'rebalance') calcRebalance();
  if (tab === 'fire')      calcFire();
  if (tab === 'meta')      calcMeta();
  if (tab === 'preco')     calcPreco();
  if (tab === 'divs')      calcDivs();
  if (tab === 'crf')       { renderCRFOptions(); calcCRF(); }
}

// -- THEME --
let currentTheme = 'light';
function applyTheme(theme) {
  currentTheme = theme;
  document.documentElement.setAttribute('data-theme', theme);
  document.getElementById('themeIcon').textContent  = theme === 'light' ? '☾' : '☀︎';
  document.getElementById('themeLabel').textContent = theme === 'light' ? 'Tema escuro' : 'Tema claro';
  buildAll();
  calcReserva();
}
function toggleTheme() { applyTheme(currentTheme === 'dark' ? 'light' : 'dark'); }

// investimentos
const INVESTMENTS = [
  { id:'tesouro', name:'Tesouro IPCA+ (configurável)', shortName:'Tesouro IPCA+', type:'tesouro',
    color:'#3dd68c', risk:'Muito Baixo', riskClass:'pos', note:'Garantia soberana · IR 15% só no resgate · trava 20+ anos' },
  { id:'lci', name:'LCI/LCA (configurável)', shortName:'LCI/LCA', type:'lci',
    color:'#f5c518', risk:'Baixo*', riskClass:'warn', note:'taxa e IR ajustáveis · renovação periódica · sem come-cotas' },
  { id:'cdb', name:'CDB (configurável)', shortName:'CDB', type:'cdb',
    color:'#2dd4bf', risk:'Baixo', riskClass:'pos', note:'IR regressivo · rende bruto até resgate · FGC R$250k/inst.' },
  { id:'acoes_cons', name:'Ações Conservador', shortName:'Ações Conserv.', type:'stock', priceGrowth:0.03,
    color:'#5b9cf6', risk:'Médio-Alto', riskClass:'risk', note:'DY + valoriz. 3%/ano (ciclo fraco)' },
  { id:'acoes_mod', name:'Ações Moderado (ITUB4)', shortName:'Ações Moder.', type:'stock', priceGrowth:0.07,
    color:'#a88bfa', risk:'Alto', riskClass:'risk', note:'DY + valoriz. 7%/ano (histórico médio)' },
  { id:'acoes_otm', name:'Ações Otimista (ITUB4 bull)', shortName:'Ações Otim.', type:'stock', priceGrowth:0.11,
    color:'#f26065', risk:'Alto', riskClass:'risk', note:'DY + valoriz. 11%/ano (melhor histórico)' }
];


function getParams() {
  const selic   = parseFloat(document.getElementById('selic').value)       || 15.0;
  const cdi     = Math.max(selic - 0.10, 0); // CDI ≈ Selic - 0.10%
  const tesReal = parseFloat(document.getElementById('tesouRoReal').value) || 7.21;
  const lciRaw  = parseFloat(document.getElementById('lciRate').value)     || 14.0;
  const cdbRaw  = parseFloat(document.getElementById('cdbRate').value)     || 13.5;
  const lciGross = lciMode === 'pos' ? (lciRaw / 100) * cdi : lciRaw;
  const cdbGross = cdbMode === 'pos' ? (cdbRaw / 100) * cdi : cdbRaw;
  return {
    inicial: parseFloat(document.getElementById('inicial').value) || 10000,
    aporte:  parseFloat(document.getElementById('aporte').value)  || 1000,
    selic, cdi, tesReal,
    ipca:    parseFloat(document.getElementById('ipca').value)    || 4.0,
    dy:      parseFloat(document.getElementById('dy').value)      || 6.0,
    lciGross, lciIR: parseFloat(document.getElementById('lciIR').value) || 0,
    lciRaw, lciMode,
    cdbGross, cdbIR: cdbIRpct,
    cdbRaw, cdbMode,
  };
}

// rates

// gross rate (IR só no resgate)
function grossRate(inv, p) {
  switch(inv.type) {
    case 'tesouro': return (1 + p.tesReal/100) * (1 + p.ipca/100) - 1;  // nominal bruto
    case 'lci':     return p.lciGross / 100;
    case 'cdb':     return p.cdbGross / 100;
    case 'stock':
      if (reinvestDivs) return (1 + p.dy/100) * (1 + inv.priceGrowth) - 1;
      return inv.priceGrowth;
    default: return 0;
  }
}


function irRate(inv, p) {
  switch(inv.type) {
    case 'tesouro': return 0.15;
    case 'lci':     return p.lciIR / 100;
    case 'cdb':     return p.cdbIR / 100;
    case 'stock':   return 0.15;   // ganho de capital (aproximado sobre parcela de preço)
    default: return 0;
  }
}


function displayRate(inv, p) {
  return grossRate(inv, p) * 100;  // always gross, IR shown separately in "no bolso"
}

// simulação

// compõe pelo bruto; IR só no resgate
function simFixed(annualRate, inicial, aporteParam, months) {
  const r = Math.pow(1 + annualRate, 1/12) - 1;
  const isArr = Array.isArray(aporteParam);
  const out = [];
  let bal = inicial;
  for (let m = 1; m <= months; m++) {
    const ap = isArr ? aporteParam[(m-1) % 12] : aporteParam;
    bal = bal * (1 + r) + ap;
    if (m % 12 === 0) out.push(bal);
  }
  if (months % 12 !== 0) out.push(bal);
  return out;
}


function simStockNoReinvest(dyRate, priceGrowth, inicial, aporteParam, months) {
  const rPrice = Math.pow(1 + priceGrowth, 1/12) - 1;
  const rDY    = Math.pow(1 + dyRate, 1/12) - 1;
  const isArr  = Array.isArray(aporteParam);
  const out = [];
  let stock = inicial, cashDivs = 0;
  for (let m = 1; m <= months; m++) {
    const ap = isArr ? aporteParam[(m-1) % 12] : aporteParam;
    cashDivs += stock * rDY;
    stock = stock * (1 + rPrice) + ap;
    if (m % 12 === 0) out.push(stock + cashDivs);
  }
  if (months % 12 !== 0) out.push(stock + cashDivs);
  return out;
}


function getSeriesData(inv, p, months) {
  const saz = getSazonalAportes();
  if (saz) {
    if (inv.type === 'stock') {
      if (reinvestDivs) return simFixedSazonal((1+p.dy/100)*(1+inv.priceGrowth)-1, p.inicial, saz, months);
      return simStockNoReinvestSazonal(p.dy/100, inv.priceGrowth, p.inicial, saz, months);
    }
    return simFixedSazonal(grossRate(inv, p), p.inicial, saz, months);
  }
  if (inv.type === 'stock') {
    if (reinvestDivs) return simFixed((1+p.dy/100)*(1+inv.priceGrowth)-1, p.inicial, p.aporte, months);
    return simStockNoReinvest(p.dy/100, inv.priceGrowth, p.inicial, p.aporte, months);
  }
  return simFixed(grossRate(inv, p), p.inicial, p.aporte, months);
}


function fmtBRL(v) {
  if (v >= 1e6) return 'R$ '+(v/1e6).toFixed(2).replace('.',',')+' mi';
  if (v >= 1e3) return 'R$ '+(v/1e3).toFixed(0)+' mil';
  return 'R$ '+Math.round(v);
}
function fmtFV(v) {
  if (v >= 1e6) return (v/1e6).toFixed(2).replace('.',',')+' mi';
  return (v/1e3).toFixed(0)+'k';
}

// -- UPDATE HINTS & HEADER --
function updateRateHints() {
  const selic   = parseFloat(document.getElementById('selic').value)   || 15.0;
  const cdi     = Math.max(selic - 0.10, 0);
  const tesReal = parseFloat(document.getElementById('tesouRoReal').value) || 7.21;
  const lciRaw  = parseFloat(document.getElementById('lciRate').value)  || 14.0;
  const cdbRaw  = parseFloat(document.getElementById('cdbRate').value)  || 13.5;
  const el = document.getElementById('caveatTesRate');
  if (el) el.textContent = tesReal.toFixed(2).replace('.',',')+'%';
  const lciNote = document.getElementById('lciRateNote');
  const lciRes  = document.getElementById('lciResult');
  if (lciMode === 'pos') {
    lciNote.textContent = '% do CDI';
    lciRes.style.display = 'block';
    lciRes.textContent = `= ${((lciRaw/100)*cdi).toFixed(2)}% bruto a.a. (CDI ${cdi.toFixed(2)}% · Selic ${selic}% - 0,10%)`;
  } else { lciNote.textContent = 'bruto prefixado a.a.'; lciRes.style.display = 'none'; }
  const cdbNote = document.getElementById('cdbRateNote');
  const cdbRes  = document.getElementById('cdbResult');
  if (cdbMode === 'pos') {
    cdbNote.textContent = '% do CDI';
    cdbRes.style.display = 'block';
    cdbRes.textContent = `= ${((cdbRaw/100)*cdi).toFixed(2)}% bruto a.a. (CDI ${cdi.toFixed(2)}% · Selic ${selic}% - 0,10%)`;
  } else { cdbNote.textContent = 'bruto prefixado a.a.'; cdbRes.style.display = 'none'; }
}

function updateHeader() {
  const p = getParams();
  const fmt = v => {
    if (v >= 1e6) return 'R$ '+(v/1e6).toFixed(1).replace('.',',')+'M';
    if (v >= 1e3) return 'R$ '+(v/1e3%1===0?(v/1e3).toFixed(0):(v/1e3).toFixed(1).replace('.',','))+'k';
    return 'R$ '+v.toFixed(0);
  };
  document.getElementById('h1Inicial').textContent = fmt(p.inicial);
  if (sazonalAtivo) {
    const saz = getSazonalAportes();
    const media = saz ? saz.reduce((a,b)=>a+b,0)/12 : p.aporte;
    document.getElementById('h1Aporte').textContent = fmt(media) + ' médio';
  } else {
    document.getElementById('h1Aporte').textContent = fmt(p.aporte);
  }
}

function setMode(instrument, mode) {
  if (instrument === 'lci') {
    lciMode = mode;
    document.getElementById('lciModePre').classList.toggle('active', mode==='pre');
    document.getElementById('lciModePos').classList.toggle('active', mode==='pos');
    document.getElementById('lciRate').value = mode==='pos' ? '93' : '14.0';
  } else {
    cdbMode = mode;
    document.getElementById('cdbModePre').classList.toggle('active', mode==='pre');
    document.getElementById('cdbModePos').classList.toggle('active', mode==='pos');
    document.getElementById('cdbRate').value = mode==='pos' ? '90' : '13.5';
  }
  buildAll();
}


// Monte Carlo
let monteCarloActive = false;

// Box-Muller — normal(mean, std)
function randn(mean, std) {
  let u = 0, v = 0;
  while(u === 0) u = Math.random();
  while(v === 0) v = Math.random();
  return mean + std * Math.sqrt(-2 * Math.log(u)) * Math.cos(2 * Math.PI * v);
}

function clamp(v, lo, hi) { return Math.max(lo, Math.min(hi, v)); }

// simula um único caminho com parâmetros perturbados
function simOnePath(inv, p, months, selicVar, ipcaVar, stockVar) {
  const selicI  = clamp(selicVar, 0.5, 30) / 100;
  const ipcaI   = clamp(ipcaVar,  0.5, 20) / 100;
  const cdiI    = Math.max(selicI - 0.001, 0);

  // taxa efetiva para RF
  let rate;
  if (inv.type === 'tesouro') {
    rate = (1 + p.tesReal/100) * (1 + ipcaI) - 1;
  } else if (inv.type === 'lci') {
    rate = p.lciMode === 'pos' ? (p.lciRaw/100) * cdiI : p.lciGross/100;
    rate = clamp(rate, 0, 0.40);
  } else if (inv.type === 'cdb') {
    rate = p.cdbMode === 'pos' ? (p.cdbRaw/100) * cdiI : p.cdbGross/100;
    rate = clamp(rate, 0, 0.40);
  } else {
    // ações
    const pg = clamp(inv.priceGrowth + stockVar, -0.20, 0.40);
    const dy = p.dy / 100;
    if (reinvestDivs) {
      rate = (1 + dy) * (1 + pg) - 1;
    } else {
      // simStockNoReinvest simplificado
      const rP = Math.pow(1 + pg, 1/12) - 1;
      const rD = Math.pow(1 + dy, 1/12) - 1;
      let stock = p.inicial, divs = 0;
      const out = [];
      for (let m = 1; m <= months; m++) {
        divs  += stock * rD;
        stock  = stock * (1 + rP) + p.aporte;
        if (m % 12 === 0) out.push(stock + divs);
      }
      if (months % 12 !== 0) out.push(stock + divs);
      return out;
    }
  }
  return simFixed(rate, p.inicial, p.aporte, months);
}

// roda N simulações e retorna { p10, median, p90 } arrays (por ano)
function runMonteCarlo(inv, p, months, N) {
  const years = Math.ceil(months / 12);
  const paths = [];

  for (let i = 0; i < N; i++) {
    // correlação negativa simples: quando juros sobem, ações sofrem
    const regimeFactor = randn(0, 1);
    const selicVar = randn(p.selic, 2.5) + regimeFactor * 0.5;
    const ipcaVar  = randn(p.ipca,  1.5);
    const stockVar = randn(0, 0.05) - regimeFactor * 0.02; // juros altos → ações pressionadas

    const path = simOnePath(inv, p, months, selicVar, ipcaVar, stockVar);
    paths.push(path);
  }

  // percentis por ponto no tempo
  const p10 = [], p50 = [], p90 = [];
  for (let yr = 0; yr < years; yr++) {
    const vals = paths.map(path => path[yr] ?? path[path.length-1]).sort((a,b) => a-b);
    const lo = Math.floor(vals.length * 0.10);
    const hi = Math.floor(vals.length * 0.90);
    const md = Math.floor(vals.length * 0.50);
    p10.push(vals[lo]);
    p50.push(vals[md]);
    p90.push(vals[hi]);
  }
  return { p10, p50, p90 };
}

function toggleMC() {
  monteCarloActive = !monteCarloActive;
  const btn  = document.getElementById('mcBtn');
  const info = document.getElementById('mcInfo');
  btn.classList.toggle('active', monteCarloActive);
  info.style.display = monteCarloActive ? '' : 'none';
  buildAll();
}

// gráfico principal
function buildChart() {
  const p = getParams();
  const maxYears = 20;
  const labels = Array.from({length:maxYears},(_,i)=>`${i+1}a`);
  const cs = getComputedStyle(document.documentElement);
  const cGrid=cs.getPropertyValue('--chart-grid').trim(), cTick=cs.getPropertyValue('--chart-tick').trim(),
        cBorder=cs.getPropertyValue('--border').trim(), cTooltip=cs.getPropertyValue('--tooltip-bg').trim(),
        cMuted=cs.getPropertyValue('--muted').trim(), cText=cs.getPropertyValue('--text').trim();

  const N_SIM = 300;
  const datasets = [];

  INVESTMENTS.forEach(inv => {
    const data    = getSeriesData(inv, p, maxYears*12);
    const noReinv = inv.type==='stock' && !reinvestDivs;
    const hidden  = hiddenSeries.has(inv.id);
    const color   = inv.color;

    if (monteCarloActive && !hidden) {
      const mc = runMonteCarlo(inv, p, maxYears*12, N_SIM);
      const bandIdx = datasets.length; // índice do p10

      // p10 — limite inferior (sem borda visível, só serve de âncora para o fill)
      datasets.push({
        label: inv.id + '_p10',
        data: mc.p10,
        borderColor: 'transparent',
        backgroundColor: 'transparent',
        pointRadius: 0, tension: 0.4, hidden,
        fill: false,
      });
      // p90 — limite superior, preenche até p10
      datasets.push({
        label: inv.id + '_p90',
        data: mc.p90,
        borderColor: 'transparent',
        backgroundColor: color + '22', // ~13% opacidade
        pointRadius: 0, tension: 0.4, hidden,
        fill: { target: bandIdx, above: color + '22', below: 'transparent' },
      });
    }

    // linha principal (sempre)
    datasets.push({
      label: inv.name, data,
      borderColor: color, backgroundColor: color + '10',
      borderWidth: noReinv ? 1.5 : 2, borderDash: noReinv ? [5,4] : [],
      pointRadius: 2, pointHoverRadius: 5, tension: 0.4, hidden,
      invId: inv.id, // para o tooltip filtrar bandas
    });
  });

  const ctx = document.getElementById('mainChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line', data:{labels,datasets},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1,
          titleColor:cMuted, bodyColor:cText,
          titleFont:{family:'DM Mono',size:10}, bodyFont:{family:'DM Mono',size:11}, padding:12,
          callbacks:{
            title:items=>`Ano ${items[0].dataIndex+1} (valor bruto acumulado)`,
            label:item=>{
              if(item.dataset.hidden) return null;
              // ignora as bandas MC
              if(item.dataset.label && (item.dataset.label.endsWith('_p10') || item.dataset.label.endsWith('_p90'))) return null;
              const inv = INVESTMENTS.find(i => i.name === item.dataset.label);
              if (!inv) return null;
              const noReinv = inv.type==='stock'&&!reinvestDivs?' (s/reinv)':'';
              const name = inv.type==='tesouro'?`Tesouro IPCA+${p.tesReal.toFixed(2).replace('.',',')}%`:inv.shortName;
              return `  ${name}${noReinv}: ${fmtBRL(item.raw)}`;
            }
          }
        }
      },
      scales:{
        x:{grid:{color:cGrid},ticks:{color:cTick,font:{family:'DM Mono',size:9},maxTicksLimit:10},border:{color:cBorder}},
        y:{grid:{color:cGrid},ticks:{color:cTick,font:{family:'DM Mono',size:9},
            callback:v=>v>=1e6?(v/1e6).toFixed(1)+' mi':v>=1e3?(v/1e3).toFixed(0)+'k':v},border:{color:cBorder}}
      }
    }
  });
}

// legenda
function buildLegend() {
  const grid = document.getElementById('legendGrid');
  grid.innerHTML = '';
  INVESTMENTS.forEach(inv => {
    const hidden = hiddenSeries.has(inv.id);
    const noReinv = inv.type==='stock'&&!reinvestDivs;
    const item = document.createElement('div');
    item.className = 'legend-item'+(hidden?' dimmed':'');
    const lineStyle = noReinv
      ? `background:repeating-linear-gradient(90deg,${inv.color} 0,${inv.color} 5px,transparent 5px,transparent 9px);`
      : `background:${inv.color};`;
    item.innerHTML = `<div class="legend-line" style="${lineStyle}"></div><span>${inv.shortName}${noReinv?' ↗ só preço':''}</span>`;
    item.addEventListener('click',()=>{
      if(hiddenSeries.has(inv.id)) hiddenSeries.delete(inv.id); else hiddenSeries.add(inv.id);
      // clique manual → nenhum preset está ativo
      document.querySelectorAll('.focus-btn').forEach(b => b.classList.remove('active'));
      buildAll();
    });
    grid.appendChild(item);
  });
}

// -- BUILD RANKING --
function buildRanking() {
  const p = getParams();
  const months = activeMonths;
  const totalInvested = getTotalInvested(p.inicial, months, getSazonalAportes());

  const results = INVESTMENTS.map(inv => {
    
    const data = getSeriesData(inv, p, months);
    const fvGross = data[data.length - 1];
    const grossGain = fvGross - totalInvested;

    const ir = irRate(inv, p);
    let netPocket, irLabel;

    if (inv.type === 'stock') {
      if (!reinvestDivs) {
        // separa preço (tributável) de DY (isento)
        const stockOnlyData = simFixed(inv.priceGrowth, p.inicial, p.aporte, months);
        const stockFinal = stockOnlyData[stockOnlyData.length - 1];
        const priceGain  = Math.max(stockFinal - totalInvested, 0);
        netPocket = fvGross - ir * priceGain;
        irLabel = `IR 15% s/ ganho de preço (${fmtBRL(priceGain)}) · dividendos (caixa) isentos · estimativa simplificada`;
      } else {
        
        const priceOnlyData = simFixed(inv.priceGrowth, p.inicial, p.aporte, months);
        const stockFinal    = priceOnlyData[priceOnlyData.length - 1];
        const priceGain     = Math.max(stockFinal - totalInvested, 0);
        netPocket = fvGross - ir * priceGain;
        irLabel = `IR 15% s/ ganho de preço (${fmtBRL(priceGain)}) · DY reinvestido isento · estimativa simplificada`;
      }
    } else {
      const taxableGain = Math.max(grossGain, 0);
      netPocket = fvGross - ir * taxableGain;
      irLabel = ir === 0 ? 'isento de IR' : `IR ${(ir*100).toFixed(1)}% s/ ganho no resgate`;
    }

    const rate = displayRate(inv, p);
    return { inv, fvGross, grossGain, netPocket, irLabel, rate };
  });

  
  const lciResult  = results.find(r => r.inv.type === 'lci');
  const modResult  = results.find(r => r.inv.id === 'acoes_mod');
  const noteEl     = document.getElementById('chart-context-note');
  if (noteEl && lciResult && modResult) {
    const lciWins = lciResult.fvGross > modResult.fvGross;
    if (lciWins) {
      const modTotal = ((1 + p.dy/100) * 1.07 - 1) * 100;
      noteEl.style.display = '';
      noteEl.textContent = `⚠ Contexto: LCI ${p.lciGross.toFixed(1)}% isento supera Ações Moderado neste cenário. Isso é matematicamente correto: ${p.lciGross.toFixed(1)}% líquido > ${modTotal.toFixed(1)}% total return das ações (7% preço + ${p.dy.toFixed(1)}% DY). Com Selic em ${p.selic}%, renda fixa está excepcionalmente atrativa — porém LCI renova a cada ~3 anos, não garante essa taxa por 20 anos.`;
    } else {
      noteEl.style.display = 'none';
      noteEl.textContent = '';
    }
  }

  const list = document.getElementById('rankingList');
  list.innerHTML = '';

  results.forEach((r, i) => {
    const pos = i+1;
    const card = document.createElement('div');
    card.className = 'rank-card rank-'+Math.min(pos,3);
    const gainX = (r.fvGross / totalInvested).toFixed(1);
    const noReinv = r.inv.type==='stock'&&!reinvestDivs;
    
    let rateLabel;
    if (noReinv) {
      rateLabel = `${(r.inv.priceGrowth*100).toFixed(0)}% preço a.a. (bruto) · DY ${p.dy.toFixed(1)}% em caixa`;
    } else if (r.inv.type === 'stock') {
      const totalReturn = ((1 + p.dy/100) * (1 + r.inv.priceGrowth) - 1) * 100;
      rateLabel = `${(r.inv.priceGrowth*100).toFixed(0)}% preço + ${p.dy.toFixed(1)}% DY = ${totalReturn.toFixed(1)}% total (bruto)`;
    } else {
      const ir = irRate(r.inv, p);
      if (ir === 0) {
        rateLabel = `${r.rate.toFixed(1)}% a.a. bruto = líquido (isento)`;
      } else {
        // Net is not simply rate*(1-ir): only gains are taxed, not principal.
        // Show bruto and note IR at redemption.
        rateLabel = `${r.rate.toFixed(1)}% a.a. bruto · IR ${(ir*100).toFixed(1)}% no resgate`;
      }
    }
    const displayName = r.inv.type==='tesouro'
      ? `Tesouro IPCA+${p.tesReal.toFixed(2).replace('.',',')}%` : r.inv.shortName;

    card.innerHTML = `
      <div class="rank-pos">${pos}</div>
      <div class="rank-name">
        <div class="rank-dot" style="background:${r.inv.color}"></div>
        ${displayName}${noReinv?'<span style="color:var(--orange);font-size:8px;margin-left:4px">s/reinv.</span>':''}
      </div>
      <div class="rank-rate">${rateLabel}</div>
      <div class="rank-fv" style="color:${r.inv.color}"><small>R$</small>${fmtFV(r.fvGross)}</div>
      <div class="rank-net">
        <span class="rank-net-val">no bolso: ${fmtBRL(r.netPocket)}</span>
        <span class="rank-net-label">${r.irLabel}</span>
      </div>
      <div class="rank-detail">
        <div class="rank-stat">
          <span class="rank-stat-label">Ganho bruto</span>
          <span class="rank-stat-val pos">+${fmtBRL(r.grossGain)}</span>
        </div>
        <div class="rank-stat">
          <span class="rank-stat-label">Múltiplo</span>
          <span class="rank-stat-val">${gainX}×</span>
        </div>
        <div class="rank-stat">
          <span class="rank-stat-label">Risco</span>
          <span class="rank-stat-val ${r.inv.riskClass}">${r.inv.risk}</span>
        </div>
      </div>
    `;
    if (pos <= 2 || r.inv.type === 'stock') {
      const note = document.createElement('div');
      note.style.cssText = 'font-size:9px;color:var(--muted);margin-top:7px;border-top:1px solid var(--border);padding-top:7px;';
      note.textContent = r.inv.note;
      card.appendChild(note);
    }
    list.appendChild(card);
  });
}

// -- BUILD ALL (simulador) --
// foco rápido — oculta/revela grupos de séries
const FOCUS_PRESETS = {
  todos:   [],  // nenhuma oculta = todas visíveis
  rf:      ['acoes_cons', 'acoes_mod', 'acoes_otm'],
  acoes:   ['tesouro', 'lci', 'cdb'],
  'tes-lci': ['cdb', 'acoes_cons', 'acoes_mod', 'acoes_otm'],
  'rf-mod':  ['acoes_cons', 'acoes_otm'],
};

function setFocus(preset) {
  const hidden = FOCUS_PRESETS[preset] || [];
  hiddenSeries = new Set(hidden);
  // atualiza botões ativos
  document.querySelectorAll('.focus-btn').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.focus === preset);
  });
  buildAll();
}

function buildAll() {
  updateRateHints();
  updateHeader();
  // mostra média mensal no header
  if (sazonalAtivo) {
    const saz = getSazonalAportes();
    if (saz) {
      const media = saz.reduce((a,b)=>a+b,0) / 12;
      const fmt = v => v >= 1000 ? 'R$ '+(v/1000).toFixed(1).replace('.',',')+'k' : 'R$ '+v.toFixed(0);
      document.getElementById('h1Aporte').textContent = fmt(media)+'/mês médio';
    }
  }
  buildChart();
  buildLegend();
  buildRanking();
}


function calcReserva() {
  const pessoas   = parseInt(document.getElementById('res-pessoas').value)  || 2;
  const gasto     = parseFloat(document.getElementById('res-gasto').value)  || 5000;
  const filhos    = document.getElementById('res-filhos').checked;
  const atual     = parseFloat(document.getElementById('res-atual').value)  || 0;
  const poupar    = parseFloat(document.getElementById('res-poupar').value) || 500;
  const renda     = parseInt(document.getElementById('res-renda').value);
  const rendPct   = parseFloat(document.getElementById('res-rendimento').value) || 13.5;

  // meses sugeridos
  let mesesBase = 6;
  if (filhos) mesesBase = 8;
  if (renda === 1) mesesBase = Math.max(mesesBase, 9);   // renda variável
  if (renda === 2) mesesBase = Math.max(mesesBase, 12);  // empresário

  const meta = gasto * mesesBase;
  const falta = Math.max(meta - atual, 0);
  const pct = Math.min(atual / meta, 1);

  // tempo para atingir a meta
  const rMes = Math.pow(1 + rendPct/100, 1/12) - 1;
  let meses = 0;
  if (falta <= 0) {
    meses = 0;
  } else if (poupar <= 0) {
    meses = Infinity;
  } else {
    // mês a mês
    let acum = atual;
    for (let m = 1; m <= 600; m++) {
      acum = acum * (1+rMes) + poupar;
      if (acum >= meta) { meses = m; break; }
      if (m === 600) meses = Infinity;
    }
  }

  // atualiza dica per capita
  const gastoPerCapita = pessoas > 0 ? gasto / pessoas : gasto;
  const pessoasHint = document.getElementById('res-per-capita');
  if (pessoasHint) pessoasHint.textContent = `≈ ${fmtBRL(gastoPerCapita)}/pessoa`;
  document.getElementById('res-meta').textContent = fmtBRL(meta);
  document.getElementById('res-meta-sub').textContent = `${mesesBase} meses × ${fmtBRL(gasto)}`;
  document.getElementById('res-falta').textContent = fmtBRL(falta);
  document.getElementById('res-falta-sub').textContent = `${(pct*100).toFixed(0)}% da meta atingida`;

  const tempoEl = document.getElementById('res-tempo');
  const tempoSub = document.getElementById('res-tempo-sub');
  if (falta <= 0) {
    tempoEl.textContent = '✓ Meta atingida!';
    tempoEl.className = 'res-result-value ok';
    tempoSub.textContent = 'parabéns, mantenha a reserva';
  } else if (meses === Infinity) {
    tempoEl.textContent = '—';
    tempoEl.className = 'res-result-value warn';
    tempoSub.textContent = 'aumento no valor guardado necessário';
  } else {
    const anos = Math.floor(meses/12);
    const mesesR = meses % 12;
    const label = anos > 0 ? `${anos}a ${mesesR}m` : `${meses} meses`;
    tempoEl.textContent = label;
    tempoEl.className = 'res-result-value ok';
    tempoSub.textContent = `rendendo ${rendPct}% a.a. bruto`;
  }

  // barra de progresso
  const fill = document.getElementById('res-fill');
  fill.style.width = (pct*100).toFixed(1)+'%';
  fill.className = 'res-progress-fill'+(pct>=1?' done':'');
  document.getElementById('res-pct').textContent = (pct*100).toFixed(1)+'%';

  // gráficos
  buildResDonut(atual, falta, meta, mesesBase);
  buildResLine(atual, poupar, meta, rMes, meses);
}

function buildResDonut(atual, falta, meta, meses) {
  const cs = getComputedStyle(document.documentElement);
  const cGreen = cs.getPropertyValue('--green').trim();
  const cBlue  = cs.getPropertyValue('--blue').trim();
  const cBorder= cs.getPropertyValue('--border').trim();
  const cTooltip = cs.getPropertyValue('--tooltip-bg').trim();
  const cText  = cs.getPropertyValue('--text').trim();

  const ctx = document.getElementById('resDonut').getContext('2d');
  if (resDonutChart) resDonutChart.destroy();

  const atingido = Math.min(atual, meta);
  const restante = Math.max(meta - atual, 0);

  resDonutChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['Já guardado', `Falta (meta: ${meses} meses)`],
      datasets:[{
        data: atingido > 0 ? [atingido, restante] : [0.001, meta],
        backgroundColor: [cGreen+'cc', cBorder],
        borderColor: [cGreen, cBorder],
        borderWidth: 1, hoverOffset: 4
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false, cutout:'70%',
      plugins:{
        legend:{display:true, position:'bottom',
          labels:{color:cs.getPropertyValue('--muted').trim(), font:{family:'DM Mono',size:10}, boxWidth:12, padding:12}},
        tooltip:{backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1, bodyColor:cText,
          titleColor:cs.getPropertyValue('--muted').trim(), titleFont:{family:'DM Mono',size:10},
          bodyFont:{family:'DM Mono',size:11},
          callbacks:{label:item=>`  ${item.label}: ${fmtBRL(item.raw)}`}}
      }
    }
  });
}

function buildResLine(atual, poupar, meta, rMes, totalMeses) {
  if (poupar <= 0 || totalMeses === Infinity || totalMeses === 0) {
    const cs2 = getComputedStyle(document.documentElement);
    const ctx2 = document.getElementById('resLine').getContext('2d');
    if (resLineChart) resLineChart.destroy();
    resLineChart = null;
    return;
  }
  const maxM = Math.min(totalMeses + 3, 120);
  const labels = [];
  const data = [];
  let acum = atual;
  for (let m = 1; m <= maxM; m++) {
    acum = acum * (1+rMes) + poupar;
    if (m % 3 === 0 || m === maxM || m === totalMeses) {
      labels.push(m >= 12 ? `${Math.floor(m/12)}a${m%12?m%12+'m':''}` : `${m}m`);
      data.push(Math.round(acum));
    }
  }

  const cs = getComputedStyle(document.documentElement);
  const cBlue  = cs.getPropertyValue('--blue').trim();
  const cGreen = cs.getPropertyValue('--green').trim();
  const cGrid  = cs.getPropertyValue('--chart-grid').trim();
  const cTick  = cs.getPropertyValue('--chart-tick').trim();
  const cBorder= cs.getPropertyValue('--border').trim();
  const cTooltip = cs.getPropertyValue('--tooltip-bg').trim();
  const cText  = cs.getPropertyValue('--text').trim();
  const cMuted = cs.getPropertyValue('--muted').trim();

  const ctx = document.getElementById('resLine').getContext('2d');
  if (resLineChart) resLineChart.destroy();

  resLineChart = new Chart(ctx, {
    type:'line',
    data:{labels, datasets:[
      { label:'Reserva acumulada', data, borderColor:cBlue, backgroundColor:cBlue+'18',
        borderWidth:2, pointRadius:2, tension:0.4, fill:true },
      { label:'Meta', data:Array(data.length).fill(meta), borderColor:cGreen,
        borderDash:[6,4], borderWidth:1.5, pointRadius:0, fill:false }
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{display:true, position:'bottom',
          labels:{color:cMuted, font:{family:'DM Mono',size:10}, boxWidth:12, padding:10}},
        tooltip:{backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1, bodyColor:cText,
          titleColor:cMuted, titleFont:{family:'DM Mono',size:10}, bodyFont:{family:'DM Mono',size:11},
          callbacks:{label:item=>`  ${item.dataset.label}: ${fmtBRL(item.raw)}`}}
      },
      scales:{
        x:{grid:{color:cGrid}, ticks:{color:cTick, font:{family:'DM Mono',size:9}}, border:{color:cBorder}},
        y:{grid:{color:cGrid}, ticks:{color:cTick, font:{family:'DM Mono',size:9},
            callback:v=>v>=1e3?(v/1e3).toFixed(0)+'k':v}, border:{color:cBorder}}
      }
    }
  });
}

// -- CALCULADORA DE AÇÕES --
let acChart = null;

const AC_SCENARIOS = [
  { id:'cons', label:'Conservador', priceGrowth:0.03, color:'#5b9cf6' },
  { id:'mod',  label:'Moderado',    priceGrowth:0.07, color:'#a88bfa' },
  { id:'otm',  label:'Otimista',    priceGrowth:0.11, color:'#3dd68c' }
];

function calcAcoes() {
  const ticker   = (document.getElementById('ac-ticker').value  || 'AÇÃO').toUpperCase();
  const dy       = parseFloat(document.getElementById('ac-dy').value)      || 7.0;
  const inicial  = parseFloat(document.getElementById('ac-inicial').value) || 10000;
  const aporte   = parseFloat(document.getElementById('ac-aporte').value)  || 1000;
  const anos     = parseInt(document.getElementById('ac-anos').value)      || 20;
  const reinvest = document.getElementById('ac-reinvest').checked;
  const months   = anos * 12;
  const totalInv = inicial + aporte * months;

  document.getElementById('ac-ticker-label').textContent = ticker;
  document.getElementById('ac-anos-label').textContent   = anos;

  // simula cada cenário
  AC_SCENARIOS.forEach(sc => {
    let fvGross, stockFinalForIR;

    if (reinvest) {
      const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
      const data = simFixed(totalRate, inicial, aporte, months);
      fvGross = data[data.length - 1];
      // Explicit price-only sim to isolate taxable capital gain from exempt DY
      const priceOnlyData = simFixed(sc.priceGrowth, inicial, aporte, months);
      const stockFinal    = priceOnlyData[priceOnlyData.length - 1];
      stockFinalForIR     = Math.max(stockFinal - totalInv, 0);
    } else {
      const stockData = simFixed(sc.priceGrowth, inicial, aporte, months);
      const stockFinal = stockData[stockData.length - 1];
      const priceGain  = Math.max(stockFinal - totalInv, 0);
      // Dividends accumulate as separate exempt cash
      const rPrice = Math.pow(1 + sc.priceGrowth, 1/12) - 1;
      const rDY    = Math.pow(1 + dy/100, 1/12) - 1;
      let stock2 = inicial, cashDivs = 0;
      for (let m = 1; m <= months; m++) {
        cashDivs += stock2 * rDY;
        stock2    = stock2 * (1+rPrice) + aporte;
      }
      fvGross = Math.round(stock2 + cashDivs);
      stockFinalForIR = priceGain;
    }

    const irAmount = 0.15 * Math.max(stockFinalForIR, 0);
    const netPocket = fvGross - irAmount;
    const gain = fvGross - totalInv;
    const gainX = (fvGross / totalInv).toFixed(1);
    const totalReturnRate = reinvest
      ? ((1 + dy/100) * (1 + sc.priceGrowth) - 1) * 100
      : sc.priceGrowth * 100;

    // Projected annual dividends at end (based on portfolio value × DY)
    const annualDivs = fvGross * (dy / 100);
    const monthlyDivs = annualDivs / 12;

    document.getElementById(`ac-fv-${sc.id}`).textContent  = fmtBRL(fvGross);
    document.getElementById(`ac-net-${sc.id}`).textContent = fmtBRL(netPocket);
    document.getElementById(`ac-growth-${sc.id}`).textContent =
      `+${(sc.priceGrowth*100).toFixed(0)}% preço/ano · ${totalReturnRate.toFixed(1)}% total return`;
    document.getElementById(`ac-detail-${sc.id}`).innerHTML =
      `Ganho bruto: <strong>+${fmtBRL(gain)}</strong> &nbsp;·&nbsp; Múltiplo: <strong>${gainX}×</strong><br>` +
      `IR 15% s/ ganho de preço: −${fmtBRL(irAmount)} (dividendos isentos)<br>` +
      `Dividendos projetados (ano ${anos}): <strong style="color:var(--violet)">${fmtBRL(annualDivs)}/ano = ${fmtBRL(monthlyDivs)}/mês</strong>`;
  });

  buildAcChart(dy, inicial, aporte, months, reinvest);
  buildAcDivGrid(dy, inicial, aporte, anos, reinvest);
}

function buildAcChart(dy, inicial, aporte, months, reinvest) {
  const cs = getComputedStyle(document.documentElement);
  const cGrid=cs.getPropertyValue('--chart-grid').trim(), cTick=cs.getPropertyValue('--chart-tick').trim(),
        cBorder=cs.getPropertyValue('--border').trim(), cTooltip=cs.getPropertyValue('--tooltip-bg').trim(),
        cMuted=cs.getPropertyValue('--muted').trim(), cText=cs.getPropertyValue('--text').trim();

  const labels = Array.from({length: months/12}, (_,i) => `${i+1}a`);

  const datasets = AC_SCENARIOS.map(sc => {
    let data;
    if (reinvest) {
      const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
      data = simFixed(totalRate, inicial, aporte, months);
    } else {
      // stock + cumulative divs month by month
      const rPrice = Math.pow(1 + sc.priceGrowth, 1/12) - 1;
      const rDY    = Math.pow(1 + dy/100, 1/12) - 1;
      const out = [];
      let stock = inicial, cashDivs = 0;
      for (let m = 1; m <= months; m++) {
        cashDivs += stock * rDY;
        stock     = stock * (1+rPrice) + aporte;
        if (m % 12 === 0) out.push(Math.round(stock + cashDivs));
      }
      data = out;
    }
    return {
      label: sc.label,
      data,
      borderColor: sc.color,
      backgroundColor: sc.color+'15',
      borderWidth: sc.id==='otm' ? 2.5 : 2,
      pointRadius: 2, pointHoverRadius: 5,
      tension: 0.4, fill: sc.id==='cons'
    };
  });

  // linha do capital investido
  const invested = Array.from({length: months/12}, (_,i) => inicial + aporte * (i+1)*12);
  datasets.unshift({
    label: 'Total investido',
    data: invested,
    borderColor: cs.getPropertyValue('--border2').trim(),
    backgroundColor: 'transparent',
    borderWidth: 1.5,
    borderDash: [4,4],
    pointRadius: 0,
    tension: 0, fill: false
  });

  const ctx = document.getElementById('acChart').getContext('2d');
  if (acChart) acChart.destroy();
  acChart = new Chart(ctx, {
    type:'line', data:{labels, datasets},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index', intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1,
          titleColor:cMuted, bodyColor:cText,
          titleFont:{family:'DM Mono',size:10}, bodyFont:{family:'DM Mono',size:11}, padding:12,
          callbacks:{
            title: items => `Ano ${items[0].dataIndex+1}`,
            label: item => `  ${item.dataset.label}: ${fmtBRL(item.raw)}`
          }
        }
      },
      scales:{
        x:{grid:{color:cGrid},ticks:{color:cTick,font:{family:'DM Mono',size:9},maxTicksLimit:12},border:{color:cBorder}},
        y:{grid:{color:cGrid},ticks:{color:cTick,font:{family:'DM Mono',size:9},
            callback:v=>v>=1e6?(v/1e6).toFixed(1)+' mi':v>=1e3?(v/1e3).toFixed(0)+'k':v},border:{color:cBorder}}
      }
    }
  });

  // legenda
  const lgd = document.getElementById('ac-legend');
  lgd.innerHTML = '';
  [...AC_SCENARIOS].reverse().forEach(sc => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<div class="legend-line" style="background:${sc.color}"></div><span>${sc.label}</span>`;
    lgd.appendChild(item);
  });
  const inv = document.createElement('div');
  inv.className = 'legend-item';
  inv.innerHTML = `<div class="legend-line" style="background:repeating-linear-gradient(90deg,var(--border2) 0,var(--border2) 4px,transparent 4px,transparent 8px)"></div><span>Capital investido</span>`;
  lgd.appendChild(inv);
}

function buildAcDivGrid(dy, inicial, aporte, anos, reinvest) {
  const grid = document.getElementById('ac-div-grid');
  grid.innerHTML = '';
  // projeção de dividendos do cenário moderado
  const milestones = [1,2,3,5,10,15,20,25,30].filter(y => y <= anos);
  const priceGrowth = 0.07; // moderado

  milestones.forEach(y => {
    const m = y * 12;
    let portfolioVal;
    if (reinvest) {
      const totalRate = (1 + dy/100) * (1 + priceGrowth) - 1;
      const data = simFixed(totalRate, inicial, aporte, m);
      portfolioVal = data[data.length - 1];
    } else {
      const rPrice = Math.pow(1 + priceGrowth, 1/12) - 1;
      let stock = inicial;
      for (let mm = 1; mm <= m; mm++) stock = stock*(1+rPrice) + aporte;
      portfolioVal = stock;
    }
    const annualDivs  = portfolioVal * (dy/100);
    const monthlyDivs = annualDivs / 12;

    const cell = document.createElement('div');
    cell.className = 'ac-div-cell';
    cell.innerHTML = `
      <div class="ac-div-year">Ano ${y}</div>
      <div class="ac-div-val">${fmtBRL(annualDivs)}</div>
      <div class="ac-div-monthly">${fmtBRL(monthlyDivs)}/mês</div>
    `;
    grid.appendChild(cell);
  });
}

// REBALANCEAMENTO DE CARTEIRA
let rbCurrentDonut = null;
let rbTargetDonut  = null;
let rbProfile = 'cons';

// alocações base (com FIIs e proteção)
const RB_BASE = {
  cons: { rf:75, ac:10, fii:10, prot:5 },
  mod:  { rf:50, ac:30, fii:15, prot:5 },
  arr:  { rf:20, ac:55, fii:20, prot:5 }
};

function getRbTargets() {
  const useFii  = document.getElementById('rb-use-fii').checked;
  const useProt = document.getElementById('rb-use-prot').checked;
  const out = {};
  ['cons','mod','arr'].forEach(p => {
    const b = RB_BASE[p];
    let rf = b.rf, ac = b.ac, fii = b.fii, prot = b.prot;
    if (!useFii)  { ac   += fii;  fii  = 0; }
    if (!useProt) { rf   += prot; prot = 0; }
    out[p] = { rf, ac, fii, prot };
  });
  return out;
}

const RB_TARGETS_LABELS = {
  cons: 'Conservador',
  mod:  'Moderado',
  arr:  'Arrojado'
};

function rebuildProfiles() {
  const useFii  = document.getElementById('rb-use-fii').checked;
  const useProt = document.getElementById('rb-use-prot').checked;

  // mostra/oculta linhas e inputs
  document.getElementById('rbrow-fii').style.display         = useFii  ? '' : 'none';
  document.getElementById('rbrow-prot').style.display        = useProt ? '' : 'none';
  document.getElementById('rb-fii-input-wrap').style.display  = useFii  ? '' : 'none';
  document.getElementById('rb-prot-input-wrap').style.display = useProt ? '' : 'none';
  if (!useFii)  document.getElementById('rb-fii').value  = 0;
  if (!useProt) document.getElementById('rb-prot').value = 0;

  // atualiza barras e labels
  const targets = getRbTargets();
  ['cons','mod','arr'].forEach(p => {
    const t = targets[p];
    ['rf','ac','fii','prot'].forEach(cls => {
      const bar = document.getElementById(`rbbar-${cls}-${p}`);
      const lbl = document.getElementById(`rbpct-${cls}-${p}`);
      if (bar) bar.style.width = t[cls] + '%';
      if (lbl) lbl.textContent = t[cls] + '%';
    });
  });

  // atualiza classes para diagnóstico e donuts
  calcRebalance();
}

function getRbClasses() {
  const useFii  = document.getElementById('rb-use-fii').checked;
  const useProt = document.getElementById('rb-use-prot').checked;
  return [
    { id:'rf',   label:'Renda Fixa',          color:'#a78bfa' },
    { id:'ac',   label:'Ações',               color:'#3dd68c' },
    ...(useFii  ? [{ id:'fii',  label:'Fundos Imobiliários', color:'#f59e0b' }] : []),
    ...(useProt ? [{ id:'prot', label:'Proteção',            color:'#f87171' }] : [])
  ];
}

function setRbProfile(p) {
  rbProfile = p;
  ['cons','mod','arr'].forEach(k => {
    document.getElementById('rbp-'+k).classList.toggle('active', k === p);
  });
  document.getElementById('rb-target-title').textContent = `CARTEIRA ALVO: ${RB_TARGETS_LABELS[p].toUpperCase()}`;
  buildRbDiag();
  buildRbDonuts();
}

function calcRebalance() {
  const rf   = parseFloat(document.getElementById('rb-rf').value)   || 0;
  const ac   = parseFloat(document.getElementById('rb-ac').value)   || 0;
  const fii  = parseFloat(document.getElementById('rb-fii').value)  || 0;
  const prot = parseFloat(document.getElementById('rb-prot').value) || 0;
  const total = rf + ac + fii + prot;

  // total da carteira
  const totalEl = document.getElementById('rb-total');
  totalEl.textContent = fmtBRL(total);

  const section = document.getElementById('rb-result-section');
  if (total <= 0) { section.style.display = 'none'; return; }
  section.style.display = '';

  buildRbDiag();
  buildRbDonuts();
}

function buildRbDiag() {
  const rf   = parseFloat(document.getElementById('rb-rf').value)   || 0;
  const ac   = parseFloat(document.getElementById('rb-ac').value)   || 0;
  const fii  = parseFloat(document.getElementById('rb-fii').value)  || 0;
  const prot = parseFloat(document.getElementById('rb-prot').value) || 0;
  const total = rf + ac + fii + prot;
  if (total <= 0) return;

  const tgt     = getRbTargets()[rbProfile];
  const rbCls   = getRbClasses();
  const current = { rf, ac, fii, prot };
  const grid    = document.getElementById('rb-diag-grid');
  grid.innerHTML = '';

  rbCls.forEach(cls => {
    const currentVal = current[cls.id];
    const currentPct = (currentVal / total) * 100;
    const targetPct  = tgt[cls.id];
    const diff       = targetPct - currentPct;
    const diffVal    = (diff / 100) * total;

    let deltaClass, deltaText, amountText;
    if (Math.abs(diff) < 1.5) {
      deltaClass = 'ok'; deltaText = '✓ Balanceado';
      amountText = 'Diferença < 1,5%; sem necessidade de ação';
    } else if (diff > 0) {
      deltaClass = 'buy'; deltaText = `+${diff.toFixed(1)}% a comprar`;
      amountText = `Comprar ~${fmtBRL(diffVal)}`;
    } else {
      deltaClass = 'over'; deltaText = `${diff.toFixed(1)}% acima do alvo`;
      amountText = `Alocar novos aportes em outras classes`;
    }

    const cell = document.createElement('div');
    cell.className = 'rb-diag-cell';
    cell.innerHTML = `
      <div class="rb-diag-label" style="color:${cls.color}">${cls.label.toUpperCase()}</div>
      <div class="rb-diag-current">${currentPct.toFixed(1)}%</div>
      <div class="rb-diag-target">Alvo: ${targetPct}% · ${fmtBRL(currentVal)}</div>
      <div class="rb-diag-delta ${deltaClass}">${deltaText}</div>
      <div class="rb-diag-amount">${amountText}</div>
    `;
    grid.appendChild(cell);
  });
}

function buildRbDonuts() {
  const rf   = parseFloat(document.getElementById('rb-rf').value)   || 0;
  const ac   = parseFloat(document.getElementById('rb-ac').value)   || 0;
  const fii  = parseFloat(document.getElementById('rb-fii').value)  || 0;
  const prot = parseFloat(document.getElementById('rb-prot').value) || 0;
  const total = rf + ac + fii + prot;
  const tgt     = getRbTargets()[rbProfile];
  const rbCls   = getRbClasses();

  const cs = getComputedStyle(document.documentElement);
  const cTooltip = cs.getPropertyValue('--tooltip-bg').trim();
  const cBorder  = cs.getPropertyValue('--border').trim();
  const cText    = cs.getPropertyValue('--text').trim();
  const cMuted   = cs.getPropertyValue('--muted').trim();
  const colors   = rbCls.map(c => c.color);
  const labels   = rbCls.map(c => c.label);

  const currentPcts = total > 0
    ? rbCls.map(c => ({ rf, ac, fii, prot })[c.id] / total * 100)
    : rbCls.map(() => 100 / rbCls.length);
  const targetPcts = rbCls.map(c => tgt[c.id]);

  const donutOpts = (lbs, data, cols) => ({
    type: 'doughnut',
    data: {
      labels: lbs,
      datasets:[{ data, backgroundColor: cols.map(c => c+'cc'),
        borderColor: cols, borderWidth:1, hoverOffset:4 }]
    },
    options:{
      responsive:true, maintainAspectRatio:false, cutout:'65%',
      plugins:{
        legend:{ display:true, position:'bottom',
          labels:{color:cMuted, font:{family:'DM Mono',size:9}, boxWidth:10, padding:10}},
        tooltip:{ backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1,
          bodyColor:cText, titleColor:cMuted,
          titleFont:{family:'DM Mono',size:9}, bodyFont:{family:'DM Mono',size:10},
          callbacks:{ label: item => `  ${item.label}: ${item.raw.toFixed(1)}%` }}
      }
    }
  });

  const ctx1 = document.getElementById('rbCurrentDonut').getContext('2d');
  if (rbCurrentDonut) rbCurrentDonut.destroy();
  rbCurrentDonut = new Chart(ctx1, donutOpts(labels, currentPcts, colors));

  const ctx2 = document.getElementById('rbTargetDonut').getContext('2d');
  if (rbTargetDonut) rbTargetDonut.destroy();
  rbTargetDonut = new Chart(ctx2, donutOpts(labels, targetPcts, colors));
}


let fireChart = null;

// Acumulação scenarios: price growth rates (DY is user input, added on top)
const FIRE_SCENARIOS = [
  { id:'cons', label:'Conservador', priceGrowth:0.03, color:'#5b9cf6' },
  { id:'mod',  label:'Moderado',    priceGrowth:0.07, color:'#a88bfa' },
  { id:'arr',  label:'Otimista',    priceGrowth:0.11, color:'#3dd68c' }
];

function calcFire() {
  const patrimonio     = parseFloat(document.getElementById('fi-patrimonio').value) || 50000;
  const aporte         = parseFloat(document.getElementById('fi-aporte').value)     || 2000;
  const gasto          = parseFloat(document.getElementById('fi-gasto').value)      || 10000;
  const dy             = parseFloat(document.getElementById('fi-dy').value)         || 7.0;
  const inflacao       = parseFloat(document.getElementById('fi-inflacao').value)   || 4.0;
  const ajustaInfl     = document.getElementById('fi-ajusta-inflacao').checked;
  const aporteInflacao = document.getElementById('fi-aporte-inflacao').checked;

  // label do toggle
  const aporteInflLbl = document.getElementById('fi-aporte-inflacao-label');
  if (aporteInflLbl) {
    aporteInflLbl.textContent = aporteInflacao ? 'Sim' : 'Não';
    aporteInflLbl.classList.toggle('on', aporteInflacao);
  }

  document.getElementById('fi-inflacao-label').textContent = inflacao.toFixed(1) + '%';

  const gastoAnual = gasto * 12;

  // ── FIRE targets ──────────────────────────────
  // Method 1: By DY (perpetuity), live only on dividends
  const metaDY   = gastoAnual / (dy / 100);
  // regra dos 4% (estudo Trinity)
  const meta4pct = gastoAnual / 0.04;

  // ── Time to reach each target (simulation) ────
  // Accumulation uses TOTAL return: price appreciation + DY reinvested
  // limite: 50 anos
  function timeToReach(meta) {
    const times = {};
    FIRE_SCENARIOS.forEach(sc => {
      const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
      const rMensal   = Math.pow(1 + totalRate, 1/12) - 1;
      const rInflMes  = Math.pow(1 + inflacao/100, 1/12) - 1;
      let acum = patrimonio;
      let found = false;
      for (let m = 1; m <= 600; m++) {
        const aporteM = aporteInflacao ? aporte * Math.pow(1 + rInflMes, m) : aporte;
        acum = acum * (1 + rMensal) + aporteM;
        if (acum >= meta) { times[sc.id] = m; found = true; break; }
      }
      if (!found) times[sc.id] = Infinity;
    });
    return times;
  }

  const timesDY   = timeToReach(metaDY);
  const times4pct = timeToReach(meta4pct);

  // ── Update card DY ────────────────────────────
  document.getElementById('fi-meta-dy').textContent     = fmtBRL(metaDY);
  document.getElementById('fi-meta-dy-sub').textContent =
    `Gasto anual R$ ${fmtBRL(gastoAnual).replace('R$ ','')} ÷ DY ${dy}%`;
  const faltaDY = Math.max(metaDY - patrimonio, 0);
  document.getElementById('fi-falta-dy').textContent = fmtBRL(faltaDY);
  renderTempos('fi-tempos-dy', timesDY);

  // ── Update card 4% ────────────────────────────
  document.getElementById('fi-meta-4pct').textContent     = fmtBRL(meta4pct);
  document.getElementById('fi-meta-4pct-sub').textContent =
    `Gasto anual R$ ${fmtBRL(gastoAnual).replace('R$ ','')} ÷ 4% (= × 300)`;
  const falta4pct = Math.max(meta4pct - patrimonio, 0);
  document.getElementById('fi-falta-4pct').textContent = fmtBRL(falta4pct);
  renderTempos('fi-tempos-4pct', times4pct);

  // ── Build freedom curve chart ─────────────────
  buildFireChart(patrimonio, aporte, dy, inflacao, gasto, ajustaInfl, aporteInflacao);

  // ── Build evolution table (moderado) ──────────
  buildFireEvoTable(patrimonio, aporte, dy, inflacao, gasto, aporteInflacao);

  // ── Armadilha da Inflação ─────────────────────
  buildInflationTrap(dy, inflacao, gasto);
}

function renderTempos(containerId, times) {
  const el = document.getElementById(containerId);
  el.innerHTML = '<div style="font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;">Tempo para chegar lá</div>';
  FIRE_SCENARIOS.forEach(sc => {
    const m = times[sc.id];
    let valText;
    if (m === Infinity) {
      valText = `<span class="fi-tempo-val inf">Não alcança em 50a</span>`;
    } else {
      const anos = Math.floor(m / 12);
      const mesesR = m % 12;
      const label = anos > 0 ? `${anos}a ${mesesR > 0 ? mesesR+'m' : ''}` : `${m} meses`;
      valText = `<span class="fi-tempo-val ${sc.id}">${label}</span>`;
    }
    el.innerHTML += `
      <div class="fi-tempo-row">
        <span class="fi-tempo-cenario">${sc.label}</span>
        ${valText}
      </div>`;
  });
}

function buildFireChart(patrimonio, aporte, dy, inflacao, gasto, ajustaInfl, aporteInflacao) {
  const cs = getComputedStyle(document.documentElement);
  const cGrid    = cs.getPropertyValue('--chart-grid').trim();
  const cTick    = cs.getPropertyValue('--chart-tick').trim();
  const cBorder  = cs.getPropertyValue('--border').trim();
  const cTooltip = cs.getPropertyValue('--tooltip-bg').trim();
  const cMuted   = cs.getPropertyValue('--muted').trim();
  const cText    = cs.getPropertyValue('--text').trim();
  const cOrange  = cs.getPropertyValue('--orange').trim();

  const MAX_YEARS = 40;
  const labels = Array.from({length: MAX_YEARS}, (_, i) => `${i+1}a`);

  // curva de renda mensal por cenário
  const scenarioDatasets = [];
  const crossingBadges = [];

  FIRE_SCENARIOS.forEach(sc => {
    const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
    const rMensal   = Math.pow(1 + totalRate, 1/12) - 1;
    const rInflMes  = Math.pow(1 + inflacao/100, 1/12) - 1;

    const rendaData = [];
    let acum = patrimonio;
    let crossYear = null;

    for (let y = 1; y <= MAX_YEARS; y++) {
      // Simulate 12 months, optionally growing aporte with inflation
      for (let mm = 0; mm < 12; mm++) {
        const monthAbsolute = (y - 1) * 12 + mm + 1;
        const aporteM = aporteInflacao
          ? aporte * Math.pow(1 + rInflMes, monthAbsolute)
          : aporte;
        acum = acum * (1 + rMensal) + aporteM;
      }
      // Monthly dividend income at year y
      const rendaMensal = acum * (dy/100) / 12;
      // Expense at year y (nominal or inflation-adjusted)
      // Monthly expense at year y (nominal or inflation-adjusted), named clearly as monthly
      const gastoMesCorrigido = ajustaInfl ? gasto * Math.pow(1 + inflacao/100, y) : gasto;

      rendaData.push(rendaMensal); // keep as float; fmtBRL rounds for display

      // Detect crossing: renda mensal >= gasto mensal corrigido
      if (crossYear === null && rendaMensal >= gastoMesCorrigido) {
        crossYear = y;
      }
    }

    scenarioDatasets.push({
      label: `Renda ${sc.label}`,
      data: rendaData,
      borderColor: sc.color,
      backgroundColor: sc.color + '12',
      borderWidth: sc.id === 'arr' ? 2.5 : 2,
      pointRadius: 2, pointHoverRadius: 5,
      tension: 0.4, fill: false
    });

    if (crossYear !== null) {
      const anoAtual = new Date().getFullYear();
      crossingBadges.push({ label: sc.label, year: crossYear, color: sc.color, calYear: anoAtual + crossYear });
    } else {
      crossingBadges.push({ label: sc.label, year: null, color: sc.color });
    }
  });

  // linha de despesas
  const expenseData = Array.from({length: MAX_YEARS}, (_, i) => {
    return ajustaInfl ? Math.round(gasto * Math.pow(1 + inflacao/100, i+1)) : gasto;
  });

  scenarioDatasets.push({
    label: ajustaInfl ? `Gasto corrigido (+${inflacao}%/ano)` : 'Gasto mensal (nominal)',
    data: expenseData,
    borderColor: cOrange,
    backgroundColor: 'transparent',
    borderWidth: 1.5,
    borderDash: [6, 4],
    pointRadius: 0,
    tension: 0, fill: false
  });

  // badges de cruzamento
  const badgesEl = document.getElementById('fi-crossing-badges');
  badgesEl.innerHTML = '';
  crossingBadges.forEach(b => {
    const badge = document.createElement('div');
    badge.className = 'fi-crossing-badge';
    badge.style.borderColor = b.color;
    badge.style.color = b.color;
    badge.style.background = b.color + '15';
    badge.textContent = b.year
      ? `${b.label}: IF em ${b.year}a (${b.calYear})`
      : `${b.label}: não atinge em 40a`;
    badgesEl.appendChild(badge);
  });

  const ctx = document.getElementById('fireChart').getContext('2d');
  if (fireChart) fireChart.destroy();
  fireChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: scenarioDatasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: cTooltip, borderColor: cBorder, borderWidth: 1,
          titleColor: cMuted, bodyColor: cText,
          titleFont: { family: 'DM Mono', size: 10 },
          bodyFont: { family: 'DM Mono', size: 11 }, padding: 12,
          callbacks: {
            title: items => `Ano ${items[0].dataIndex + 1}`,
            label: item => `  ${item.dataset.label}: ${fmtBRL(item.raw)}/mês`
          }
        }
      },
      scales: {
        x: { grid:{color:cGrid}, ticks:{color:cTick, font:{family:'DM Mono',size:9}, maxTicksLimit:12}, border:{color:cBorder} },
        y: {
          grid:{color:cGrid}, border:{color:cBorder},
          ticks:{
            color:cTick, font:{family:'DM Mono',size:9},
            callback: v => v >= 1e6 ? (v/1e6).toFixed(1)+' mi' : v >= 1e3 ? (v/1e3).toFixed(0)+'k' : v
          },
          title:{display:true, text:'R$/mês', color:cMuted, font:{family:'DM Mono',size:9}}
        }
      }
    }
  });

  // legenda
  const lgd = document.getElementById('fi-legend');
  lgd.innerHTML = '';
  FIRE_SCENARIOS.forEach(sc => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<div class="legend-line" style="background:${sc.color}"></div><span>Renda ${sc.label}</span>`;
    lgd.appendChild(item);
  });
  const expItem = document.createElement('div');
  expItem.className = 'legend-item';
  expItem.innerHTML = `<div class="legend-line" style="background:repeating-linear-gradient(90deg,${cOrange} 0,${cOrange} 6px,transparent 6px,transparent 10px)"></div><span>${ajustaInfl ? 'Gasto c/ inflação' : 'Gasto nominal'}</span>`;
  lgd.appendChild(expItem);
}

function buildFireEvoTable(patrimonio, aporte, dy, inflacao, gasto, aporteInflacao) {
  const grid = document.getElementById('fi-evo-grid');
  grid.innerHTML = '';

  const sc = FIRE_SCENARIOS.find(s => s.id === 'mod');
  const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
  const rMensal   = Math.pow(1 + totalRate, 1/12) - 1;
  const rInflMes  = Math.pow(1 + inflacao/100, 1/12) - 1;

  const milestones = [1, 2, 3, 5, 7, 10, 15, 20, 25, 30];
  let acum = patrimonio;
  let lastYear = 0;
  let monthCount = 0;

  milestones.forEach(y => {
    const monthsToAdvance = (y - lastYear) * 12;
    for (let mm = 0; mm < monthsToAdvance; mm++) {
      monthCount++;
      const aporteM = aporteInflacao
        ? aporte * Math.pow(1 + rInflMes, monthCount)
        : aporte;
      acum = acum * (1 + rMensal) + aporteM;
    }
    lastYear = y;

    const rendaAnual  = acum * (dy / 100);
    const rendaMensal = rendaAnual / 12;
    const gastoCorr   = gasto * Math.pow(1 + inflacao/100, y);
    const isIndep     = rendaMensal >= gastoCorr;

    const cell = document.createElement('div');
    cell.className = 'fi-evo-cell';
    cell.innerHTML = `
      <div class="fi-evo-year">Ano ${y}</div>
      <div class="fi-evo-portfolio">${fmtBRL(acum)}</div>
      <div class="fi-evo-renda">${fmtBRL(rendaAnual)}/ano</div>
      <div class="fi-evo-monthly">${fmtBRL(rendaMensal)}/mês</div>
      ${isIndep ? '<div class="fi-evo-mark">✓ INDEPENDÊNCIA</div>' : ''}
    `;
    grid.appendChild(cell);
  });
}

// ─────────────────────────────────────────────
// ARMADILHA DA INFLAÇÃO
// ─────────────────────────────────────────────
function buildInflationTrap(dy, inflacao, gasto) {
  const rfTaxa   = parseFloat(document.getElementById('trap-rf-taxa').value) || 11.0;
  const gastoAnual = gasto * 12;
  const ANOS = 20;

  // Patrimônios necessários hoje (perpetuidade pelo DY/taxa)
  const patRV = gastoAnual / (dy / 100);
  const patRF = gastoAnual / (rfTaxa / 100);

  // Renda mensal hoje
  const rendaHojeRV = patRV * (dy / 100) / 12;   // = gasto (por definição)
  const rendaHojeRF = patRF * (rfTaxa / 100) / 12; // = gasto (por definição)

  // Em 20 anos: cenário moderado RV (+7% preço + DY reinvestido = total return ~14,49%)
  const rvTotalReturn = (1 + dy/100) * (1 + 0.07) - 1;
  const rVMes = Math.pow(1 + rvTotalReturn, 1/12) - 1;
  // Simula 20 anos sem aportes (simulamos o patrimônio já acumulado)
  const patRV20 = patRV * Math.pow(1 + rvTotalReturn, ANOS);
  const rendaRV20 = patRV20 * (dy / 100) / 12;

  // Em 20 anos: RF — sem price growth, só juros sobre o mesmo montante
  // Patrimônio nominal cresce pelos juros reinvestidos (mas dono retira tudo os juros na perpetuidade)
  // Na perpetuidade pura, o patrimônio principal não cresce — o dono gasta tudo que rende
  // Então patRF em 20 anos = patRF (nominal, sem crescimento real)
  const rendaRF20 = patRF * (rfTaxa / 100) / 12; // mesma renda nominal (perpétua)

  // Poder de compra real em 20 anos (deflacionado pela inflação)
  const fatorInfla = Math.pow(1 + inflacao/100, ANOS);
  const realRV20 = rendaRV20 / fatorInfla;  // em R$ de hoje
  const realRF20 = rendaRF20 / fatorInfla;  // em R$ de hoje

  // Gasto desejado daqui a 20 anos (nominal, corrigido pelo IPCA)
  const gasto20nominal = gasto * fatorInfla;

  // Preenche a grid
  document.getElementById('trap-rf-rate-label').textContent = rfTaxa.toFixed(1) + '%';
  document.getElementById('trap-dy-label').textContent      = dy.toFixed(1) + '%';
  document.getElementById('trap-head-dy').textContent       = dy.toFixed(1) + '%';
  document.getElementById('trap-head-rf').textContent       = rfTaxa.toFixed(1) + '%';

  document.getElementById('trap-pat-rv').textContent       = fmtBRL(patRV);
  document.getElementById('trap-pat-rf').textContent       = fmtBRL(patRF);
  document.getElementById('trap-renda-hoje-rv').textContent = fmtBRL(rendaHojeRV) + '/mês';
  document.getElementById('trap-renda-hoje-rf').textContent = fmtBRL(rendaHojeRF) + '/mês';

  document.getElementById('trap-pat20-rv').textContent  = fmtBRL(patRV20);
  document.getElementById('trap-pat20-rf').textContent  = fmtBRL(patRF) + ' (sem crescimento)';

  document.getElementById('trap-renda20-rv').textContent = fmtBRL(rendaRV20) + '/mês';
  document.getElementById('trap-renda20-rf').textContent = fmtBRL(rendaRF20) + '/mês';

  document.getElementById('trap-real20-rv').textContent = fmtBRL(realRV20) + '/mês';
  document.getElementById('trap-real20-rf').textContent = fmtBRL(realRF20) + '/mês';

  document.getElementById('trap-gasto20').textContent = fmtBRL(gasto20nominal) + '/mês';

  // Vereditos
  const cobriuRV = rendaRV20 >= gasto20nominal;
  const cobriuRF = rendaRF20 >= gasto20nominal;

  const vRV = document.getElementById('trap-verdict-rv');
  const vRF = document.getElementById('trap-verdict-rf');
  vRV.textContent   = cobriuRV ? '✓ Sim' : '✗ Não';
  vRV.style.color   = cobriuRV ? 'var(--green)' : 'var(--red)';
  vRF.textContent   = cobriuRF ? '✓ Sim' : '✗ Não';
  vRF.style.color   = cobriuRF ? 'var(--green)' : 'var(--orange)';

  // Nota de rodapé dinâmica
  const perda = ((1 - realRF20/gasto) * 100).toFixed(0);
  const ganho = ((realRV20/gasto - 1) * 100).toFixed(0);
  document.getElementById('fi-trap-footnote').innerHTML =
    `<strong>Em resumo:</strong> Com Renda Fixa a ${rfTaxa}% líquido e inflação a ${inflacao}%, sua renda de ${fmtBRL(gasto)}/mês perde <strong style="color:var(--orange);">${perda}% do poder de compra</strong> em ${ANOS} anos, porque você consome todos os juros sem reinvestir nada. ` +
    `Com ações e DY de ${dy}%, o patrimônio cresce e sua renda real <strong style="color:var(--green);">ganha ${ganho}% de poder de compra</strong> no mesmo período. ` +
    `O maior patrimônio inicial exigido pelas ações é o <em>preço da proteção contra a inflação</em>.`;
}

// meta patrimonial
let metaChart = null;

function calcMeta() {
  const alvo     = parseFloat(document.getElementById('meta-alvo').value)       || 1000000;
  const atual    = parseFloat(document.getElementById('meta-atual').value)      || 0;
  const prazo    = parseInt(document.getElementById('meta-prazo').value)        || 15;
  const taxa     = parseFloat(document.getElementById('meta-taxa').value)       || 11.0;
  const inflacao = parseFloat(document.getElementById('meta-inflacao').value)   || 4.4;
  const aporteJa = parseFloat(document.getElementById('meta-aporte-input').value) || 0;

  const rMes = Math.pow(1 + taxa / 100, 1 / 12) - 1;
  const n    = prazo * 12;

  // Aporte necessário (PMT para atingir FV)
  const fvAtual  = atual * Math.pow(1 + rMes, n);
  const faltaFV  = Math.max(alvo - fvAtual, 0);
  const aporteNec = faltaFV === 0 ? 0
    : rMes === 0 ? faltaFV / n
    : faltaFV * rMes / (Math.pow(1 + rMes, n) - 1);

  // Prazo com o aporte já praticado
  let prazoMeses = Infinity;
  if (aporteJa > 0 || atual > 0) {
    let acum = atual;
    for (let m = 1; m <= 1200; m++) {
      acum = acum * (1 + rMes) + aporteJa;
      if (acum >= alvo) { prazoMeses = m; break; }
    }
  }

  // Totais
  const totalAportado = atual + aporteNec * n;
  const juros  = alvo - totalAportado;
  const jurosPct = totalAportado > 0 ? (juros / totalAportado * 100).toFixed(0) : 0;

  // Valor real (poder de compra de hoje)
  const fatorInfl = Math.pow(1 + inflacao / 100, prazo);
  const alvoReal  = alvo / fatorInfl;

  // Render resultados
  document.getElementById('meta-aporte-necessario').textContent = fmtBRL(aporteNec) + '/mês';
  document.getElementById('meta-aporte-sub').textContent = `para acumular ${fmtBRL(alvo)} em ${prazo} anos`;

  if (prazoMeses === Infinity) {
    const el = document.getElementById('meta-prazo-atual');
    el.textContent = 'Não alcança'; el.style.color = 'var(--orange)';
    document.getElementById('meta-prazo-sub').textContent = 'aumente o aporte ou o prazo';
  } else {
    const a = Math.floor(prazoMeses / 12), mo = prazoMeses % 12;
    const el = document.getElementById('meta-prazo-atual');
    el.textContent = `${a}a${mo > 0 ? ' ' + mo + 'm' : ''}`;
    el.style.color = prazoMeses <= n * 12 ? 'var(--green)' : 'var(--blue)';
    document.getElementById('meta-prazo-sub').textContent = `aportando ${fmtBRL(aporteJa)}/mês`;
  }

  document.getElementById('meta-total-aportado').textContent = fmtBRL(totalAportado);
  document.getElementById('meta-total-sub').textContent = `${fmtBRL(atual)} inicial + ${fmtBRL(aporteNec)}/mês × ${prazo} anos`;
  document.getElementById('meta-juros').textContent = fmtBRL(Math.max(juros, 0));
  document.getElementById('meta-juros-pct').textContent = `${jurosPct}% do total veio dos juros compostos`;
  document.getElementById('meta-valor-real').textContent = fmtBRL(alvoReal);
  document.getElementById('meta-real-sub').textContent = `${fmtBRL(alvo)} corrigido por ${inflacao}% de inflação`;

  buildMetaScenarios(alvo, atual, prazo);
  buildMetaChart(alvo, atual, aporteNec, rMes, n);
  buildMetaMilestones(alvo, atual, aporteNec, rMes, n);
}

function buildMetaScenarios(alvo, atual, prazo) {
  const scenarios = [
    { label: 'Conservador', taxa: 7.0,  cor: 'var(--blue)' },
    { label: 'Moderado',    taxa: 11.0, cor: 'var(--violet)' },
    { label: 'Otimista',    taxa: 14.0, cor: 'var(--green)' },
    { label: 'Selic atual', taxa: 15.0, cor: 'var(--yellow)' },
  ];
  const grid = document.getElementById('meta-scenarios-grid');
  grid.innerHTML = '';
  const n = prazo * 12;

  scenarios.forEach(sc => {
    const r = Math.pow(1 + sc.taxa / 100, 1 / 12) - 1;
    const fvA = atual * Math.pow(1 + r, n);
    const falta = Math.max(alvo - fvA, 0);
    const ap = falta === 0 ? 0 : r === 0 ? falta / n : falta * r / (Math.pow(1 + r, n) - 1);
    const total = atual + ap * n;
    const div = document.createElement('div');
    div.className = 'meta-scenario-card';
    div.innerHTML = `
      <div class="meta-sc-label">${sc.label}</div>
      <div class="meta-sc-rate" style="color:${sc.cor};">${sc.taxa}% a.a.</div>
      <div class="meta-sc-val" style="color:${sc.cor};">${fmtBRL(ap)}<span style="font-size:11px;">/mês</span></div>
      <div class="meta-sc-sub">total investido: ${fmtBRL(total)}</div>`;
    grid.appendChild(div);
  });
}

function buildMetaChart(alvo, atual, aporteNec, rMes, n) {
  const cs = getComputedStyle(document.documentElement);
  const cGrid = cs.getPropertyValue('--chart-grid').trim();
  const cTick = cs.getPropertyValue('--chart-tick').trim();
  const cBorder = cs.getPropertyValue('--border').trim();
  const cTip = cs.getPropertyValue('--tooltip-bg').trim();
  const cMuted = cs.getPropertyValue('--muted').trim();
  const cText = cs.getPropertyValue('--text').trim();

  const labels = [], patrimData = [], aportadoData = [];
  const step = Math.max(1, Math.ceil(n / 40));
  for (let m = 0; m <= n; m += step) {
    labels.push((m / 12).toFixed(m % 12 === 0 ? 0 : 1) + 'a');
    const pat = atual * Math.pow(1 + rMes, m) +
      (rMes === 0 ? aporteNec * m : aporteNec * (Math.pow(1 + rMes, m) - 1) / rMes);
    patrimData.push(pat);
    aportadoData.push(atual + aporteNec * m);
  }

  const ctx = document.getElementById('metaChart').getContext('2d');
  if (metaChart) metaChart.destroy();
  metaChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Patrimônio acumulado', data: patrimData,
          borderColor: '#3dd68c', backgroundColor: 'rgba(61,214,140,.1)',
          borderWidth: 2.5, pointRadius: 2, tension: 0.4, fill: true },
        { label: 'Total aportado', data: aportadoData,
          borderColor: '#556070', backgroundColor: 'transparent',
          borderWidth: 1.5, borderDash: [5, 4], pointRadius: 0 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { backgroundColor: cTip, borderColor: cBorder, borderWidth: 1,
          titleColor: cMuted, bodyColor: cText, padding: 12,
          titleFont: { family: 'DM Mono', size: 10 }, bodyFont: { family: 'DM Mono', size: 11 },
          callbacks: { label: i => `  ${i.dataset.label}: ${fmtBRL(i.raw)}` } }
      },
      scales: {
        x: { grid: { color: cGrid }, ticks: { color: cTick, font: { family: 'DM Mono', size: 9 }, maxTicksLimit: 10 }, border: { color: cBorder } },
        y: { grid: { color: cGrid }, border: { color: cBorder },
          ticks: { color: cTick, font: { family: 'DM Mono', size: 9 },
            callback: v => v >= 1e6 ? (v / 1e6).toFixed(1) + ' mi' : v >= 1e3 ? (v / 1e3).toFixed(0) + 'k' : v } }
      }
    }
  });

  const lgd = document.getElementById('meta-legend');
  lgd.innerHTML = '';
  [['#3dd68c', 'Patrimônio acumulado'], ['#556070', 'Total aportado']].forEach(([cor, label]) => {
    const d = document.createElement('div'); d.className = 'legend-item';
    d.innerHTML = `<div class="legend-line" style="background:${cor}"></div><span>${label}</span>`;
    lgd.appendChild(d);
  });
}

function buildMetaMilestones(alvo, atual, aporte, rMes, n) {
  const container = document.getElementById('meta-milestones');
  container.innerHTML = '';
  [10, 25, 50, 75, 90, 100].forEach(pct => {
    const meta = alvo * pct / 100;
    let acum = atual, meses = 0;
    while (acum < meta && meses < n + 1) {
      acum = acum * (1 + rMes) + aporte; meses++;
    }
    const div = document.createElement('div');
    div.className = 'meta-milestone';
    if (meses <= n) {
      const a = Math.floor(meses / 12), mo = meses % 12;
      div.innerHTML = `
        <div class="meta-ms-year">${pct}% da meta</div>
        <div class="meta-ms-val">${a}a${mo > 0 ? ' ' + mo + 'm' : ''}</div>
        <div class="meta-ms-pct">${fmtBRL(meta)}</div>
        ${pct === 100 ? '<div class="meta-ms-mark">META ATINGIDA</div>' : ''}`;
    } else {
      div.innerHTML = `<div class="meta-ms-year">${pct}% da meta</div>
        <div class="meta-ms-val" style="color:var(--muted);">Além do prazo</div>
        <div class="meta-ms-pct">${fmtBRL(meta)}</div>`;
    }
    container.appendChild(div);
  });
}

// -- PREÇO JUSTO --
function calcPreco() {
  const preco      = parseFloat(document.getElementById('pj-preco').value)       || 0;
  const lpa        = parseFloat(document.getElementById('pj-lpa').value)         || 0;
  const vpa        = parseFloat(document.getElementById('pj-vpa').value)         || 0;
  const dpa = parseFloat(document.getElementById('pj-dpa').value) || 0;

  // Bazin: DPA (R$) ÷ 0,06  — usa dividendo real, não derivado do preço atual
  const bazin = dpa > 0 ? dpa / 0.06 : 0;

  // Graham: √(22,5 × LPA × VPA)
  const prod = 22.5 * lpa * vpa;
  const graham = prod > 0 ? Math.sqrt(prod) : 0;

  function margem(justo) {
    if (!justo || !preco) return { txt: 'N/A', cls: '' };
    const pct = (justo - preco) / preco * 100;
    return { txt: (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%', cls: pct >= 0 ? 'positiva' : 'negativa' };
  }
  function veredito(justo) {
    if (!justo || !preco) return { txt: 'Sem dados', cls: '' };
    const pct = (justo - preco) / preco * 100;
    if (pct >= 25)  return { txt: 'Grande oportunidade', cls: 'compra' };
    if (pct >= 5)   return { txt: 'Barata', cls: 'compra' };
    if (pct >= -5)  return { txt: 'Preço justo', cls: 'neutra' };
    if (pct >= -25) return { txt: 'Cara', cls: 'cara' };
    return { txt: 'Muito cara', cls: 'cara' };
  }

  function renderMethod(prefix, justo, naAplic) {
    const valEl = document.getElementById(`pj-${prefix}-val`);
    const mel   = document.getElementById(`pj-${prefix}-margem`);
    const vel   = document.getElementById(`pj-${prefix}-veredicto`);
    if (naAplic) {
      valEl.textContent = 'Não aplicável'; valEl.style.color = 'var(--muted)';
      mel.textContent = ''; mel.className = 'pj-margem';
      vel.textContent = 'Sem dados'; vel.className = 'pj-veredicto';
      return;
    }
    valEl.style.color = '';
    valEl.textContent = justo > 0 ? `R$ ${justo.toFixed(2)}` : 'N/A';
    const m = margem(justo);
    mel.textContent = m.txt; mel.className = `pj-margem ${m.cls}`;
    const v = veredito(justo);
    vel.textContent = v.txt; vel.className = `pj-veredicto ${v.cls}`;
  }

  renderMethod('bazin',  bazin,  dpa <= 0);
  renderMethod('graham', graham, lpa <= 0 || vpa <= 0);

  // avisos de setor
  const warnings = [];
  const pvpCalc = vpa > 0 ? preco / vpa : 0;
  if (pvpCalc > 0 && pvpCalc < 0.7) warnings.push({ title: 'Possível banco ou financeira', msg: 'P/VP muito baixo (abaixo de 0,7) é comum em bancos e financeiras, onde a alavancagem distorce o patrimônio líquido. O modelo de Graham pode subestimar o valor real nesse setor.' });
  if (dpa <= 0) warnings.push({ title: 'Empresa sem dividendos', msg: 'Bazin não se aplica a empresas que não distribuem proventos. Comum em techs, startups e empresas farmacêuticas em expansão que reinvestem todo o lucro. Considere usar P/L e crescimento de receita como guia.' });
  const plCalc = lpa > 0 ? preco / lpa : 0;
  if (lpa <= 0) warnings.push({ title: 'LPA negativo ou zero', msg: 'Empresa com prejuízo. Graham não se aplica. Verifique se é uma situação pontual (despesa não recorrente) ou tendência. Setores como energia renovável e farmacêutico em P&D costumam ter LPA negativo temporário.' });
  if (plCalc > 0 && plCalc > 40) warnings.push({ title: 'P/L muito elevado', msg: 'P/L acima de 40 pode indicar empresa de crescimento (tech, farmácia) onde o mercado paga prêmio por expectativa futura. Bazin e Graham são modelos de valor e podem sinalizar "cara" mesmo que o crescimento justifique o preço.' });

  const wb = document.getElementById('pj-sector-warning');
  if (warnings.length > 0) {
    wb.style.display = '';
    wb.innerHTML = warnings.map(w => `<div class="pj-sector-warning-inner"><div class="pj-sector-warning-icon">⚠️</div><div class="pj-sector-warning-text"><strong>${w.title}:</strong> ${w.msg}</div></div>`).join('');
  } else {
    wb.style.display = 'none';
    wb.innerHTML = '';
  }

  // Consenso — detecta divergência quando métodos apontam em direções opostas
  const validos = [bazin, graham].filter(v => v > 0);
  const media = validos.length > 0 ? validos.reduce((a, b) => a + b, 0) / validos.length : 0;

  document.getElementById('pj-media').textContent = media > 0 ? `R$ ${media.toFixed(2)}` : 'N/A';
  document.getElementById('pj-preco-atual-display').textContent = preco > 0 ? `R$ ${preco.toFixed(2)}` : 'N/A';

  const uEl = document.getElementById('pj-upside');
  if (media > 0 && preco > 0) {
    const up = ((media - preco) / preco * 100).toFixed(1);
    uEl.textContent = (parseFloat(up) >= 0 ? '+' : '') + up + '%';
    uEl.style.color = parseFloat(up) >= 0 ? 'var(--green)' : 'var(--orange)';
  } else { uEl.textContent = 'N/A'; uEl.style.color = ''; }

  const cEl = document.getElementById('pj-consenso-geral');
  // Divergência: ambos válidos mas um acima e outro abaixo do preço atual,
  // e a diferença entre eles é maior que 30% do preço
  const ambosValidos = bazin > 0 && graham > 0;
  const diverge = ambosValidos && Math.abs(bazin - graham) / preco > 0.3
    && ((bazin > preco && graham < preco) || (bazin < preco && graham > preco));

  if (diverge) {
    cEl.textContent = 'Métodos divergem';
    cEl.className = 'pj-consenso-val pj-veredicto neutra';
    // add divergence to warnings banner
    const divWarn = document.getElementById('pj-diverge-warn');
    if (!divWarn) {
      const dw = document.createElement('div');
      dw.id = 'pj-diverge-warn';
      dw.className = 'pj-sector-warning-inner';
      dw.innerHTML = `<div class="pj-sector-warning-icon">🔀</div><div class="pj-sector-warning-text"><strong>Métodos divergem:</strong> Bazin e Graham chegaram a conclusões opostas sobre o preço atual. Isso costuma ocorrer quando a empresa tem perfil de crescimento (Graham valoriza ativos, Bazin valoriza dividendos). Não há consenso com os dados atuais. Analise cada método separadamente.</div>`;
      wb.style.display = '';
      wb.appendChild(dw);
    }
  } else {
    document.getElementById('pj-diverge-warn')?.remove();
    const cv = veredito(media);
    cEl.textContent = cv.txt;
    cEl.className = `pj-consenso-val pj-veredicto ${cv.cls}`;
  }

  // Indicadores
  const pl  = lpa  > 0 ? preco / lpa  : 0;
  const pvp = vpa  > 0 ? preco / vpa  : 0;
  const indicators = [
    { label: 'P/L',           val: pl   > 0 ? pl.toFixed(2)  : 'N/A', ref: 'Ideal abaixo de 15',  cls: pl > 0 && pl <= 15 ? 'pj-ind-ok' : pl > 0 && pl <= 25 ? 'pj-ind-warn' : 'pj-ind-bad' },
    { label: 'P/VP',          val: pvp  > 0 ? pvp.toFixed(2) : 'N/A', ref: 'Ideal abaixo de 1,5', cls: pvp > 0 && pvp <= 1.5 ? 'pj-ind-ok' : pvp > 0 && pvp <= 3 ? 'pj-ind-warn' : 'pj-ind-bad' },
    { label: 'DPA (R$)',       val: dpa > 0 ? 'R$ ' + dpa.toFixed(2) : 'N/A', ref: 'Dividendo real anual por ação', cls: dpa > 0 ? 'pj-ind-ok' : 'pj-ind-bad' },
    { label: 'DY implícito',  val: preco > 0 && dpa > 0 ? (dpa/preco*100).toFixed(2)+'%' : 'N/A', ref: 'DPA ÷ preço atual', cls: preco > 0 && dpa > 0 && (dpa/preco*100) >= 6 ? 'pj-ind-ok' : preco > 0 && dpa > 0 && (dpa/preco*100) >= 3 ? 'pj-ind-warn' : 'pj-ind-bad' },
    { label: 'vs Bazin',      val: bazin > 0 ? (preco / bazin).toFixed(2) + 'x' : 'N/A', ref: 'Abaixo de 1x = barata', cls: bazin > 0 && preco <= bazin ? 'pj-ind-ok' : 'pj-ind-bad' },
    { label: 'vs Graham',     val: graham > 0 ? (preco / graham).toFixed(2) + 'x' : 'N/A', ref: 'Abaixo de 1x = barata', cls: graham > 0 && preco <= graham ? 'pj-ind-ok' : 'pj-ind-bad' },
  ];
  const igrid = document.getElementById('pj-indicators');
  igrid.innerHTML = '';
  indicators.forEach(ind => {
    const d = document.createElement('div'); d.className = 'pj-indicator';
    d.innerHTML = `<div class="pj-ind-label">${ind.label}</div>
      <div class="pj-ind-val ${ind.cls}">${ind.val}</div>
      <div class="pj-ind-ref">${ind.ref}</div>`;
    igrid.appendChild(d);
  });
}

// print / pdf
function printPreco() {
  // garante que a aba está visível antes de imprimir
  showTab('preco');
  setTimeout(() => window.print(), 150);
}


const BRAPI_TOKEN = 'kSsTDFRo9nP5Uiez2nT7yk'; // mover pra variável de ambiente se publicar
const BRAPI_BASE  = 'https://brapi.dev/api';
let acDebounce    = null;
let acIndex       = -1;
let acResults     = [];

// tickers populares — base do autocomplete
// (evita dependência do endpoint /v2/stocks que tem CORS restrito)
const TICKERS_BR = [
  // Ibovespa e blue chips
  'ABCB3','ABCB4','ABEV3','AERI3','AGRO3','ALPA4','ALUP11','AMBP3','ANIM3',
  'ARML3','ARZZ3','ASAI3','AURE3','AZUL4','B3SA3','BBAS3','BBDC3','BBDC4',
  'BBSE3','BPAC11','BPAN4','BRAP4','BRFS3','BRKM5','BRSR6','CAJU3','CAML3',
  'CASH3','CBAV3','CCRO3','CEAB3','CIEL3','CLSA3','CMIG3','CMIG4','COGN3',
  'CPFE3','CPLE3','CPLE6','CRFB3','CSAN3','CSMG3','CSNA3','CURY3','CVCB3',
  'CXSE3','CYRE3','DIRR3','DXCO3','ECOR3','EGIE3','ELET3','ELET6','EMBR3',
  'ENBR3','ENEV3','ENGI11','EQTL3','ESPA3','EVEN3','EZTC3','FESA4','FLRY3',
  'FRAS3','GFSA3','GGBR3','GGBR4','GMAT3','GOAU3','GOAU4','GOLL4','GRND3',
  'GUAR3','HAPV3','HBOR3','HBSA3','HJBR3','HYPE3','IGTI11','INTB3','IRBR3',
  'ISAE3','ISAE4','ITSA3','ITSA4','ITUB3','ITUB4','JBSS3','JHSF3','JSLG3',
  'KEPL3','KLBN11','KLBN3','KLBN4','LAVV3','LEVE3','LIGT3','LJQQ3','LREN3',
  'LUPA3','LWSA3','MATD3','MBLY3','MDIA3','MELK3','MGLU3','MILS3','MOVI3',
  'MRFG3','MRVE3','MULT3','MYPK3','NATU3','NTCO3','NUBANK','ODPV3','ONCO3',
  'ORVR3','PCAR3','PDTC3','PETR3','PETR4','PETZ3','PLPL3','PNVL3','POMO3',
  'POMO4','PORT3','PRIO3','PTBL3','PTBR3','QUAL3','RAIZ4','RADL3','RAIL3',
  'RAPT3','RAPT4','RDOR3','RECV3','RENT3','ROMI3','RRRP3','RSID3','SANB11',
  'SANB3','SANB4','SAPR11','SAPR3','SAPR4','SBFG3','SBSP3','SEER3','SEQL3',
  'SIMH3','SLCE3','SMFT3','SMTO3','SOMA3','SQIA3','SRNA3','STBP3','STTE3',
  'SULA11','SULA3','SUZB3','TAEE11','TAEE3','TAEE4','TASA3','TASA4','TEND3',
  'TGMA3','TIMS3','TOTS3','TRAD3','TRIS3','TRPL3','TRPL4','TTEN3','UGPA3',
  'UNIP3','UNIP6','USIM3','USIM5','VALE3','VAMO3','VBBR3','VITT3','VIVT3',
  'VLID3','VULC3','WEGE3','WEST3','WIZC3','YDUQ3','ZAMP3',
  // FIIs
  'AFHI11','AIEC11','ALZR11','ARCT11','ARRI11','ATSA11','BCIA11','BCFF11',
  'BCRI11','BLMG11','BNFS11','BPFF11','BRCO11','BRCR11','BRIP11','BTRA11',
  'BTCI11','BTLG11','CARE11','CPTS11','CPTI11','CRFF11','CVBI11','CXAG11',
  'CXCE11','DEVA11','DEVO11','DONE11','EDGA11','ELDO11','FAMB11B','FCFL11',
  'FEXC11','FIIB11','FIIP11B','FINF11','FISC11','FIVN11','FLMA11','FMOF11',
  'FOFT11','FONE11','FORT11','FVPQ11','GALG11','GARE11','GCRI11','GLOG11',
  'GTWR11','HABT11','HCTR11','HFOF11','HGBS11','HGCR11','HGLG11','HGPO11',
  'HGRE11','HGRU11','HOSI11','HPDP11','HRDF11','HSAF11','HSML11','HUSC11',
  'IRDM11','ITIP11','JFLL11','JPPA11','JREC11','JSAF11','JSRE11','KFOF11',
  'KINP11','KNHF11','KNIP11','KNRE11','KORE11','LGCP11','LPLP11','LVBI11',
  'MALL11','MAPT11','MCCI11','MCHF11','MFAI11','MFII11','MGFF11','MORC11',
  'MORE11','MXRF11','NBII11','NEWL11','NSLU11','NTNS11','NUSC11','NVHO11',
  'OUJP11','OVVI11','PATC11','PATL11','PEBB11','PLRI11','PMIS11','PORD11',
  'PVBI11','RBCO11','RBED11','RBFF11','RBHG11','RBLG11','RBRD11','RBRP11',
  'RBRY11','RBVA11','RCFA11','RCRI11','RECR11','REIT11','RELG11','RNDP11',
  'RNGO11','ROOF11','RPRI11','RSPD11','RZAK11','RZTR11','SARE11','SADI11',
  'SDIL11','SEQR11','SIOS11','SNCI11','SNFF11','SPTW11','STRX11','SVYS11',
  'TGAR11','THRA11','TICO11','TRBL11','TRXF11','TVRI11','URPR11','VCRR11',
  'VGIP11','VGIR11','VGHF11','VIDR11','VILG11','VISC11','VINO11','VOTS11',
  'VRTA11','VSLH11','VTLT11','VUFI11','WPLZ11','XPCA11','XPCI11','XPML11',
  'XPLG11','XPPR11','XPSF11','YCHY11'
];

function onTickerInput(val) {
  calcPreco();
  clearTimeout(acDebounce);
  const drop = document.getElementById('pj-autocomplete');
  if (val.length < 2) { closeDrop(); return; }

  
  const matches = TICKERS_BR.filter(t => t.startsWith(val)).slice(0, 8);
  acResults = matches.map(t => ({ stock: t }));
  acIndex   = -1;

  if (!matches.length) { closeDrop(); return; }

  drop.innerHTML = matches.map((t, i) => `
    <div class="pj-ac-item" data-i="${i}" onmousedown="selectTicker(${i})">
      <span class="pj-ac-ticker">${t}</span>
    </div>`).join('');
  positionDrop();
  drop.classList.add('open');

  // enriquece lista com cotação em tempo real
  acDebounce = setTimeout(() => enrichWithQuotes(matches, val), 600);
}

async function enrichWithQuotes(tickers, query) {
  if (window.location.protocol === 'file:') return; // sem fetch em file://
  // busca em lote — nomes e preços
  const sample = tickers.slice(0, 5).join(',');
  try {
    const res  = await fetch(`${BRAPI_BASE}/quote/${encodeURIComponent(sample)}?token=${BRAPI_TOKEN}`);
    const data = await res.json();
    const map  = {};
    (data.results || []).forEach(r => { map[r.symbol] = r; });

    const drop = document.getElementById('pj-autocomplete');
    if (!drop.classList.contains('open')) return;

    drop.innerHTML = tickers.map((t, i) => {
      const info  = map[t];
      const name  = info?.shortName || info?.longName || '';
      const price = info?.regularMarketPrice ? `R$ ${info.regularMarketPrice.toFixed(2)}` : '';
      return `<div class="pj-ac-item" data-i="${i}" onmousedown="selectTicker(${i})">
        <span class="pj-ac-ticker">${t}</span>
        <span class="pj-ac-name">${name}</span>
        <span class="pj-ac-price">${price}</span>
      </div>`;
    }).join('');
  } catch(e) {
    // silently keep the basic list already shown
  }
}

function onTickerKeydown(e) {
  const drop  = document.getElementById('pj-autocomplete');
  const items = drop.querySelectorAll('.pj-ac-item');
  if (!drop.classList.contains('open') || !items.length) return;
  if (e.key === 'ArrowDown') {
    e.preventDefault();
    acIndex = Math.min(acIndex + 1, items.length - 1);
    items.forEach((el, i) => el.classList.toggle('active', i === acIndex));
  } else if (e.key === 'ArrowUp') {
    e.preventDefault();
    acIndex = Math.max(acIndex - 1, 0);
    items.forEach((el, i) => el.classList.toggle('active', i === acIndex));
  } else if (e.key === 'Enter') {
    e.preventDefault();
    if (acIndex >= 0) selectTicker(acIndex);
    else fetchQuoteForTicker(document.getElementById('pj-ticker').value);
  } else if (e.key === 'Escape') {
    closeDrop();
  }
}

function positionDrop() {
  const input = document.getElementById('pj-ticker');
  const rect  = input.getBoundingClientRect();
  const drop  = document.getElementById('pj-autocomplete');
  drop.style.top   = (rect.bottom + 2) + 'px';
  drop.style.left  = rect.left + 'px';
  drop.style.width = rect.width + 'px';
}

function closeDrop() {
  const drop = document.getElementById('pj-autocomplete');
  drop.classList.remove('open');
  drop.innerHTML = '';
  acResults = [];
  acIndex   = -1;
}

async function selectTicker(i) {
  const stock = acResults[i];
  if (!stock) return;
  document.getElementById('pj-ticker').value = stock.stock;
  closeDrop();
  await fetchQuoteForTicker(stock.stock);
}

async function fetchQuoteForTicker(ticker) {
  if (!ticker || ticker.length < 3) return;
  const note  = document.getElementById('pj-ticker-note');
  const pNote = document.getElementById('pj-preco-note');
  const badge = document.getElementById('pj-preco-badge');

  // fetch só funciona em HTTP/HTTPS, não em file://
  if (window.location.protocol === 'file:') {
    note.textContent = '⚠ Cotação automática não funciona ao abrir o arquivo diretamente. Use GitHub Pages, Live Server ou python3 -m http.server.';
    note.className   = 'input-note pj-fetch-status err';
    return;
  }

  note.textContent = 'Buscando cotação...';
  note.className   = 'input-note pj-fetch-status';
  badge.style.display = 'none';

  try {
    const url = `${BRAPI_BASE}/quote/${encodeURIComponent(ticker.toUpperCase())}?token=${BRAPI_TOKEN}`;
    const res  = await fetch(url);
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    const r    = data?.results?.[0];
    if (!r?.regularMarketPrice) throw new Error('sem preço');

    document.getElementById('pj-preco').value = r.regularMarketPrice.toFixed(2);
    badge.style.display = '';
    note.textContent = `${r.symbol} · ${r.shortName || r.longName || ''}`;
    note.className   = 'input-note pj-fetch-status ok';
    pNote.textContent = `Cotação automática · ${new Date().toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'})}`;
    calcPreco();
  } catch(e) {
    note.textContent = `Ticker não encontrado ou erro na busca (${e.message}). Insira o preço manualmente.`;
    note.className   = 'input-note pj-fetch-status err';
    calcPreco();
  }
}

// reposiciona o dropdown
window.addEventListener('scroll', () => { if(document.getElementById('pj-autocomplete').classList.contains('open')) positionDrop(); }, true);
window.addEventListener('resize', () => { if(document.getElementById('pj-autocomplete').classList.contains('open')) positionDrop(); });

// fecha autocomplete
document.addEventListener('click', e => {
  if (!e.target.closest('#pj-ticker') && !e.target.closest('#pj-autocomplete')) {
    closeDrop();
  }
});


// aportes sazonais
let sazonalAtivo = false;
const MESES = ['Jan','Fev','Mar','Abr','Mai','Jun','Jul','Ago','Set','Out','Nov','Dez'];
const MESES_DESTAQUE = [6, 11]; // Julho (férias) e Dezembro (13°) — índices 0-based

// TODO: talvez salvar os valores no localStorage pra não perder ao recarregar
function buildSazonalGrid(force) {
  const bar = document.getElementById('sazonal-inputs-bar');
  if (bar.children.length > 0 && !force) return; 
  const base = parseFloat(document.getElementById('aporte').value) || 1000;
  bar.innerHTML = '';
  MESES.forEach((m, i) => {
    const wrap = document.createElement('div');
    wrap.className = 'input-group sazonal-month' + (MESES_DESTAQUE.includes(i) ? ' destaque' : '');
    const suggested = MESES_DESTAQUE.includes(i) ? base * 2 : base;
    wrap.innerHTML = `<label>${m}${MESES_DESTAQUE.includes(i) ? ' ★' : ''}</label>
      <input type="number" id="saz-${i}" value="${suggested}" min="0" step="100" oninput="updateSazonalStats();buildAll()">`;
    bar.appendChild(wrap);
  });
  updateSazonalStats();
}

function resetSazonal() {
  document.getElementById('sazonal-inputs-bar').innerHTML = '';
  buildSazonalGrid(true);
  buildAll();
}

function updateSazonalStats() {
  const vals = getSazonalAportes();
  const total = vals.reduce((a, b) => a + b, 0);
  const media = total / 12;
  document.getElementById('sazonal-media').textContent = 'R$ ' + Math.round(media).toLocaleString('pt-BR');
  document.getElementById('sazonal-total').textContent = 'R$ ' + Math.round(total).toLocaleString('pt-BR');
}

function getSazonalAportes() {
  if (!sazonalAtivo) return null;
  return MESES.map((_, i) => parseFloat(document.getElementById('saz-' + i)?.value) || 0);
}


function simFixedSazonal(annualRate, inicial, aporteArray, months) {
  const r = Math.pow(1 + annualRate, 1/12) - 1;
  const out = [];
  let bal = inicial;
  for (let m = 1; m <= months; m++) {
    const ap = aporteArray[(m - 1) % 12];
    bal = bal * (1 + r) + ap;
    if (m % 12 === 0) out.push(bal);
  }
  if (months % 12 !== 0) out.push(bal);
  return out;
}

function simStockNoReinvestSazonal(dyRate, priceGrowth, inicial, aporteArray, months) {
  const rPrice = Math.pow(1 + priceGrowth, 1/12) - 1;
  const rDY    = Math.pow(1 + dyRate, 1/12) - 1;
  const out = [];
  let stock = inicial, cashDivs = 0;
  for (let m = 1; m <= months; m++) {
    const ap = aporteArray[(m - 1) % 12];
    cashDivs += stock * rDY;
    stock = stock * (1 + rPrice) + ap;
    if (m % 12 === 0) out.push(stock + cashDivs);
  }
  if (months % 12 !== 0) out.push(stock + cashDivs);
  return out;
}

// total investido considerando aportes sazonais
function getTotalInvested(inicial, months, sazonalArr) {
  if (!sazonalArr) {
    const aporte = parseFloat(document.getElementById('aporte').value) || 1000;
    return inicial + aporte * months;
  }
  let total = inicial;
  for (let m = 0; m < months; m++) {
    total += sazonalArr[m % 12];
  }
  return total;
}

document.getElementById('sazonalToggle').addEventListener('change', function() {
  sazonalAtivo = this.checked;
  const grid      = document.getElementById('sazonal-grid');
  const label     = document.getElementById('sazonalText');
  const aporteGrp = document.getElementById('aporte-fixo-group');
  if (sazonalAtivo) {
    buildSazonalGrid(false); // preserves values if already built; builds fresh on first use
    grid.style.display      = '';
    aporteGrp.style.display = 'none';   // hide fixed aporte — sazonal takes over
    label.textContent  = 'Ativado · aportes personalizados por mês';
    label.style.color  = 'var(--yellow)';
  } else {
    grid.style.display      = 'none';
    aporteGrp.style.display = '';       // restore fixed aporte
    label.textContent  = 'Desativado';
    label.style.color  = 'var(--muted)';
  }
  buildAll();
});

// renda de dividendos
let divChart = null;

function calcDivs() {
  const patrimonio  = parseFloat(document.getElementById('dv-patrimonio').value)  || 0;
  const dy          = parseFloat(document.getElementById('dv-dy').value)           || 0;
  const aporte      = parseFloat(document.getElementById('dv-aporte').value)       || 0;
  const crescAnual  = parseFloat(document.getElementById('dv-crescimento').value)  || 0;
  const ipca        = parseFloat(document.getElementById('dv-ipca').value)         || 4;
  const meta        = parseFloat(document.getElementById('dv-meta').value)         || 5000;
  const irPct       = parseFloat(document.getElementById('dv-ir').value)           || 0;

  const rMensal     = Math.pow(1 + crescAnual / 100, 1/12) - 1;
  const fatorIR     = 1 - irPct / 100;
  const dyMensal    = dy / 100 / 12; // DY mensal simples (distribuição linear)

  // renda atual
  const rendaBruta  = patrimonio * dyMensal;
  const rendaLiq    = rendaBruta * fatorIR;

  // patrimônio necessário
  const patrimNecBruto = meta / fatorIR / dyMensal; // P × DY/12 × (1-IR) = meta => P = meta / fatorIR / dyMensal
  const distancia = patrimNecBruto - patrimonio;

  // prazo para atingir a meta
  let mesesParaMeta = null;
  if (patrimonio >= patrimNecBruto) {
    mesesParaMeta = 0;
  } else if (rMensal > 0 || aporte > 0) {
    let p = patrimonio;
    for (let m = 1; m <= 600; m++) {
      p = p * (1 + rMensal) + aporte;
      if (p * dyMensal * fatorIR >= meta) { mesesParaMeta = m; break; }
    }
  }

  // projeção de 20 anos
  const meses   = 240;
  const labels  = [];
  const seriesRenda = [];
  const seriesRendaReal = [];
  const inflMensal = Math.pow(1 + ipca / 100, 1/12) - 1;
  let p = patrimonio;
  for (let m = 1; m <= meses; m++) {
    p = p * (1 + rMensal) + aporte;
    const rMes = p * dyMensal * fatorIR;
    const rReal = rMes / Math.pow(1 + inflMensal, m); // poder de compra de hoje
    if (m % 12 === 0) {
      labels.push(`${m/12}a`);
      seriesRenda.push(parseFloat(rMes.toFixed(2)));
      seriesRendaReal.push(parseFloat(rReal.toFixed(2)));
    }
  }

  // grid de resultados
  const grid = document.getElementById('dv-results-grid');
  const anos = mesesParaMeta !== null ? (mesesParaMeta === 0 ? 'Já atingida!' : `${(mesesParaMeta/12).toFixed(1)} anos`) : 'Mais de 50 anos';
  const fmt = v => v >= 1e6 ? 'R$ '+(v/1e6).toFixed(2).replace('.',',')+' mi' : v >= 1e3 ? 'R$ '+(v/1e3).toFixed(0)+' mil' : 'R$ '+Math.round(v);
  const fmtM = v => 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits:0, maximumFractionDigits:0});

  grid.innerHTML = `
    <div class="meta-result-card"><div class="meta-result-eyebrow">Renda mensal atual</div>
      <div class="meta-result-val" style="color:var(--green);">${fmtM(Math.round(rendaLiq))}</div>
      <div class="meta-result-sub">líquido${irPct>0?' após IR de '+irPct+'%':' (isento)'}</div></div>
    <div class="meta-result-card"><div class="meta-result-eyebrow">Renda anual atual</div>
      <div class="meta-result-val">${fmt(rendaLiq * 12)}</div>
      <div class="meta-result-sub">dividendos anuais esperados</div></div>
    <div class="meta-result-card"><div class="meta-result-eyebrow">Patrimônio para meta</div>
      <div class="meta-result-val">${fmt(patrimNecBruto)}</div>
      <div class="meta-result-sub">para receber R$ ${meta.toLocaleString('pt-BR')}/mês</div></div>
    <div class="meta-result-card"><div class="meta-result-eyebrow">Falta acumular</div>
      <div class="meta-result-val" style="color:${distancia <= 0 ? 'var(--green)':'var(--orange)'};">${distancia <= 0 ? '✓ Meta atingida' : fmt(distancia)}</div>
      <div class="meta-result-sub">diferença para o patrimônio alvo</div></div>
    <div class="meta-result-card"><div class="meta-result-eyebrow">Prazo para meta</div>
      <div class="meta-result-val">${anos}</div>
      <div class="meta-result-sub">com aporte de R$ ${aporte.toLocaleString('pt-BR')}/mês</div></div>`;

  // gráfico
  const cs = getComputedStyle(document.documentElement);
  const cGrid = cs.getPropertyValue('--chart-grid').trim();
  const cText = cs.getPropertyValue('--text').trim();
  if (divChart) divChart.destroy();
  const ctx = document.getElementById('divChart')?.getContext('2d');
  if (!ctx) return;
  divChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'Renda mensal líquida', data: seriesRenda, borderColor: '#4caf7d', backgroundColor: '#4caf7d15', tension: 0.3, fill: true, pointRadius: 0 },
        { label: 'Renda real (poder de compra hoje)', data: seriesRendaReal, borderColor: '#f0c040', backgroundColor: 'transparent', tension: 0.3, borderDash: [5,4], pointRadius: 0 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: cText, font: { family: 'DM Mono', size: 10 } } },
        tooltip: { callbacks: { label: ctx => ' R$ ' + Math.round(ctx.raw).toLocaleString('pt-BR') } } },
      scales: {
        x: { grid: { color: cGrid }, ticks: { color: cText, font: { size: 9 } } },
        y: { grid: { color: cGrid }, ticks: { color: cText, font: { size: 9 },
          callback: v => 'R$ ' + (v >= 1000 ? (v/1000).toFixed(0)+'k' : v) } }
      }
    }
  });

  // grade de metas de renda
  const metasAlvo = [1000, 2000, 3000, 5000, 8000, 10000, 15000, 20000, 30000];
  const mgrid = document.getElementById('dv-metas-grid');
  mgrid.innerHTML = metasAlvo.map(alvo => {
    const pNec = alvo / fatorIR / dyMensal;
    let mPrazo = null;
    if (patrimonio >= pNec) { mPrazo = 0; }
    else if (rMensal > 0 || aporte > 0) {
      let pp = patrimonio;
      for (let m = 1; m <= 600; m++) {
        pp = pp * (1 + rMensal) + aporte;
        if (pp * dyMensal * fatorIR >= alvo) { mPrazo = m; break; }
      }
    }
    const prazoTxt = mPrazo === null ? '>50a' : mPrazo === 0 ? '✓ Agora' : (mPrazo/12).toFixed(1)+'a';
    const longe = mPrazo === null || mPrazo > 300;
    return `<div class="dv-meta-card">
      <div class="dv-meta-renda">Renda de R$ ${alvo.toLocaleString('pt-BR')}/mês</div>
      <div class="dv-meta-patrim">${fmt(pNec)}</div>
      <div class="dv-meta-anos ${longe?'longe':''}">${prazoTxt} com aportes atuais</div>
    </div>`;
  }).join('');
}


let crfChart = null;
const CRF_COLORS = ['#4caf7d','#5ec8e0','#f0c040','#e07050','#9b8ee0','#e05090'];
const CRF_TIPOS = [
  { val: 'cdb-pre',     label: 'CDB Prefixado',          irTab: true,  isento: false },
  { val: 'cdb-cdi',     label: 'CDB % do CDI',           irTab: true,  isento: false },
  { val: 'lci-pre',     label: 'LCI Prefixada',           irTab: false, isento: true  },
  { val: 'lci-cdi',     label: 'LCI % do CDI',            irTab: false, isento: true  },
  { val: 'lca-pre',     label: 'LCA Prefixada',           irTab: false, isento: true  },
  { val: 'lca-cdi',     label: 'LCA % do CDI',            irTab: false, isento: true  },
  { val: 'tes-selic',   label: 'Tesouro Selic',           irTab: true,  isento: false },
  { val: 'tes-ipca',    label: 'Tesouro IPCA+',           irTab: true,  isento: false },
  { val: 'tes-pre',     label: 'Tesouro Prefixado',       irTab: true,  isento: false },
];


function crfIR(meses, tipo) {
  const t = CRF_TIPOS.find(x => x.val === tipo);
  if (!t) return 0.15;
  if (t.isento) return 0;
  if (t.irFixo !== undefined) return t.irFixo;
  
  if (meses <= 6)  return 0.225;
  if (meses <= 12) return 0.20;
  if (meses <= 24) return 0.175;
  return 0.15;
}


function crfTaxaEfetiva(tipo, valor, cdi, ipca) {
  switch(tipo) {
    case 'cdb-pre':   return valor / 100;
    case 'cdb-cdi':   return cdi * valor / 100 / 100;
    case 'lci-pre':   return valor / 100;
    case 'lci-cdi':   return cdi * valor / 100 / 100;
    case 'lca-pre':   return valor / 100;
    case 'lca-cdi':   return cdi * valor / 100 / 100;
    case 'tes-selic':  return cdi / 100; // Selic ≈ CDI
    case 'tes-ipca':   return (1 + ipca/100) * (1 + valor/100) - 1; // IPCA + spread real
    case 'tes-pre':    return valor / 100;
    default: return valor / 100;
  }
}

let crfOptions = [
  { tipo: 'cdb-pre',  valor: 13.5, nome: 'CDB Prefixado' },
  { tipo: 'lci-cdi',  valor: 93,   nome: 'LCI 93% CDI'   },
  { tipo: 'tes-ipca', valor: 7.21, nome: 'Tesouro IPCA+' },
];

function renderCRFOptions() {
  const grid = document.getElementById('crf-options-grid');
  grid.innerHTML = '';
  crfOptions.forEach((opt, i) => {
    const tipos = CRF_TIPOS.map(t => `<option value="${t.val}" ${t.val===opt.tipo?'selected':''}>${t.label}</option>`).join('');
    const cor = CRF_COLORS[i % CRF_COLORS.length];
    const tipoObj = CRF_TIPOS.find(t => t.val === opt.tipo) || CRF_TIPOS[0];
    const placeholder = opt.tipo.includes('cdi') ? '% do CDI (ex: 93)' :
                        opt.tipo === 'tes-ipca'  ? '% real a.a. (ex: 7.21)' : '% a.a. (ex: 13.5)';
    const canRemove = crfOptions.length > 2;
    const div = document.createElement('div');
    div.className = 'crf-option';
    div.innerHTML = `
      <div class="crf-option-header">
        <div class="crf-option-color" style="background:${cor};"></div>
        <span class="crf-option-title">Opção ${i+1}</span>
        ${canRemove ? `<button class="crf-remove-btn" onclick="removeCRFOption(${i})" title="Remover">✕</button>` : ''}
      </div>
      <span class="crf-option-label">Tipo de investimento</span>
      <select onchange="crfOptions[${i}].tipo=this.value;crfOptions[${i}].nome=this.options[this.selectedIndex].text;renderCRFOptions();calcCRF();">${tipos}</select>
      <span class="crf-option-label">${placeholder}</span>
      <input type="number" value="${opt.valor}" min="0" step="0.25"
        oninput="crfOptions[${i}].valor=parseFloat(this.value)||0;calcCRF();" placeholder="${placeholder}">`;
    grid.appendChild(div);
  });
  updateCRFAddBtn();
}

function updateCRFAddBtn() {
  const btn   = document.getElementById('crf-add-btn');
  const label = document.getElementById('crf-count-label');
  const MAX   = 6;
  if (!btn) return;
  const atMax = crfOptions.length >= MAX;
  btn.style.display   = atMax ? 'none' : '';
  if (label) label.textContent = `${crfOptions.length} de ${MAX} opções`;
}

function addCRFOption() {
  if (crfOptions.length >= 6) return;
  crfOptions.push({ tipo: 'cdb-pre', valor: 13.0, nome: 'CDB Prefixado' });
  renderCRFOptions();
  calcCRF();
}

function removeCRFOption(i) {
  crfOptions.splice(i, 1);
  renderCRFOptions();
  calcCRF();
}

function calcCRF() {
  // reconstrói toda a tabela a cada mudança — ok pra esse volume de dados
  const capital = parseFloat(document.getElementById('crf-capital').value) || 50000;
  const meses   = parseInt(document.getElementById('crf-prazo').value)     || 24;
  const cdi     = parseFloat(document.getElementById('crf-cdi').value)     || 14.75;
  const ipca    = parseFloat(document.getElementById('crf-ipca').value)     || 4.0;

  const fmtBR  = v => 'R$ ' + v.toLocaleString('pt-BR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
  const fmtPct = v => v.toFixed(2).replace('.', ',') + '%';
  const inflAcum = Math.pow(1 + ipca / 100, meses / 12) - 1; // inflação acumulada no período

  const results = crfOptions.map((opt, i) => {
    const taxaAnual    = crfTaxaEfetiva(opt.tipo, opt.valor, cdi, ipca);
    const taxaMensal   = Math.pow(1 + taxaAnual, 1/12) - 1;

    // aplicação única, sem aportes
    let bal = capital;
    const serie = [capital];
    for (let m = 1; m <= meses; m++) {
      bal = bal * (1 + taxaMensal);
      serie.push(bal);
    }
    const bruto     = bal;
    const ganho     = bruto - capital;
    const irAliq    = crfIR(meses, opt.tipo);
    const irValor   = ganho * irAliq;
    const liquido   = bruto - irValor;
    const ganhoLiq  = liquido - capital;
    // retorno real descontado pelo IPCA
    const liquidoReal = liquido / (1 + inflAcum);
    const ganhoReal   = liquidoReal - capital;

    return {
      opt, i, taxaAnual, bruto, ganho, irAliq, irValor, liquido,
      ganhoLiq, liquidoReal, ganhoReal, serie,
      cor: CRF_COLORS[i % CRF_COLORS.length]
    };
  });

  
  const melhorLiq = Math.max(...results.map(r => r.liquido));

  // tabela
  const tbody = document.getElementById('crf-tbody');
  tbody.innerHTML = results.map(r => {
    const isWinner = r.liquido === melhorLiq;
    const isento  = CRF_TIPOS.find(t => t.val === r.opt.tipo)?.isento;
    return `<tr class="${isWinner ? 'crf-winner' : ''}">
      <td style="display:flex;align-items:center;gap:8px;">
        <span style="width:8px;height:8px;border-radius:50%;background:${r.cor};display:inline-block;flex-shrink:0;"></span>
        <strong>${r.opt.nome}</strong>
      </td>
      <td>${fmtPct(r.taxaAnual * 100)} a.a. nominal</td>
      <td>${fmtBR(r.bruto)}</td>
      <td class="crf-val-neg">${isento ? '—' : '−' + fmtBR(r.irValor) + ' (' + fmtPct(r.irAliq * 100) + ')'}</td>
      <td><strong class="crf-val-pos">${fmtBR(r.liquido)}</strong></td>
      <td class="crf-val-pos">+${fmtBR(r.ganhoLiq)}</td>
      <td>${fmtBR(r.liquidoReal)} <span style="font-size:8px;color:var(--muted);">(hoje)</span></td>
      <td><span class="crf-badge ${isWinner ? 'melhor' : 'ok'}">${isWinner ? '★ Melhor' : '—'}</span></td>
    </tr>`;
  }).join('');

  // gráfico
  const cs = getComputedStyle(document.documentElement);
  const cGrid = cs.getPropertyValue('--chart-grid').trim();
  const cText = cs.getPropertyValue('--text').trim();
  if (crfChart) crfChart.destroy();
  const ctx2 = document.getElementById('crfChart')?.getContext('2d');
  if (!ctx2) return;
  
  const step = meses > 36 ? 6 : meses > 12 ? 3 : 1;
  const labels2 = results[0].serie.map((_, m) => m % step === 0 ? (m === 0 ? 'Hoje' : m + 'm') : '').map((l, m) => m % step === 0 ? l : null).filter((l, m) => m % step === 0);
  const filteredSeries = results.map(r => r.serie.filter((_, m) => m % step === 0));

  crfChart = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: labels2,
      datasets: results.map((r, i) => ({
        label: r.opt.nome,
        data: filteredSeries[i],
        borderColor: r.cor,
        backgroundColor: 'transparent',
        tension: 0.3,
        pointRadius: 0,
        borderWidth: 2
      }))
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { labels: { color: cText, font: { family: 'DM Mono', size: 10 } } },
        tooltip: { callbacks: { label: ctx => ' ' + ctx.dataset.label + ': R$ ' + Math.round(ctx.raw).toLocaleString('pt-BR') } } },
      scales: {
        x: { grid: { color: cGrid }, ticks: { color: cText, font: { size: 9 } } },
        y: { grid: { color: cGrid }, ticks: { color: cText, font: { size: 9 },
          callback: v => 'R$ ' + (v >= 1000 ? (v/1000).toFixed(0)+'k' : v) },
          min: capital * 0.99 }
      }
    }
  });
}

// inputs do simulador
document.querySelectorAll('#tab-simulador input[type=number]').forEach(el=>{
  el.addEventListener('input', buildAll);
});

// ── CDB IR auto-mapping from horizon ──
const CDB_IR_MAP = { 6: 22.5, 12: 20, 24: 17.5, 60: 15, 120: 15, 180: 15, 240: 15 };
const CDB_IR_DESC = {
  6:   '≤ 180 dias · alíquota máxima',
  12:  '181–360 dias',
  24:  '361–720 dias',
  60:  'acima de 720 dias',
  120: 'acima de 720 dias',
  180: 'acima de 720 dias',
  240: 'acima de 720 dias'
};

function updateCdbIrFromMonths(months) {
  cdbIRpct = CDB_IR_MAP[months] ?? 15;
  const lbl  = document.getElementById('cdbIrAutoLabel');
  const desc = document.getElementById('cdbIrAutoDesc');
  if (lbl)  lbl.textContent  = cdbIRpct.toString().replace('.', ',') + '%';
  if (desc) desc.textContent = (CDB_IR_DESC[months] ?? 'acima de 720 dias') + ' · ajusta conforme o prazo selecionado no ranking';
}

// toggle de dividendos
const toggleInput = document.getElementById('reinvestToggle');
toggleInput.addEventListener('change',()=>{
  reinvestDivs = toggleInput.checked;
  const aporteNote = document.getElementById('aporteNote');
  const toggleText = document.getElementById('toggleText');
  const divDesc    = document.getElementById('divDescription');
  if (reinvestDivs) {
    toggleText.textContent = 'Reinvestindo dividendos';
    toggleText.classList.add('on');
    divDesc.innerHTML = '<span class="tag-on">✦ Ativado:</span> dividendos compram mais ações → portfólio cresce pelo total return (preço + DY). DY distribuído de forma linear mensal (aproximação padrão de simuladores de longo prazo).';
    aporteNote.textContent = '100% reinvestido';
  } else {
    toggleText.textContent = 'Sacando dividendos';
    toggleText.classList.remove('on');
    divDesc.innerHTML = '<span class="tag-off">✦ Desativado:</span> portfólio cresce pela valorização do preço. Dividendos acumulam como caixa separado. <em>Estimativa simplificada:</em> IR de 15% só sobre ganho de preço na venda, sem isenção de R$20k/mês nem compensação de perdas. Dividendos tratados como isentos.';
    aporteNote.textContent = 'dividendos não reinvestidos';
  }
  buildAll();
});

// abas do ranking
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    activeMonths = parseInt(btn.dataset.months);
    updateCdbIrFromMonths(activeMonths);
    buildRanking();
  });
});

// inputs reserva
document.querySelectorAll('#tab-reserva input, #tab-reserva select').forEach(el=>{
  el.addEventListener('input', calcReserva);
  el.addEventListener('change', calcReserva);
});

// inputs ações
document.querySelectorAll('#tab-acoes input[type=number], #tab-acoes input[type=text]').forEach(el=>{
  el.addEventListener('input', calcAcoes);
});
document.getElementById('ac-reinvest').addEventListener('change', function() {
  const lbl  = document.getElementById('ac-reinvest-label');
  const note = document.getElementById('ac-reinvest-note');
  lbl.textContent  = this.checked ? 'Sim' : 'Não';
  lbl.classList.toggle('on', this.checked);
  note.textContent = this.checked ? 'dividendos compram mais ações' : 'dividendos acumulam como caixa';
  calcAcoes();
});

// FIRE inputs
document.querySelectorAll('#tab-fire input[type=number]').forEach(el=>{
  el.addEventListener('input', calcFire);
});

// toggle filhos
document.getElementById('res-filhos').addEventListener('change', function() {
  document.getElementById('filhosLabel').textContent = this.checked ? 'Sim' : 'Não';
  document.getElementById('filhosLabel').classList.toggle('on', this.checked);
  calcReserva();
});

// inicialização
applyTheme('light');
updateCdbIrFromMonths(activeMonths);
buildAll();
rebuildProfiles();

// rebuild do gráfico ao redimensionar
let resizeTimer = null;
function onResize() {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    // reseta canvas principal
    const canvas = document.getElementById('mainChart');
    if (canvas) { canvas.style.width = '0'; canvas.style.height = '0'; }
    buildChart();
    buildLegend();

    // reseta canvases da reserva
    const donut = document.getElementById('resDonut');
    const line  = document.getElementById('resLine');
    const acCv  = document.getElementById('acChart');
    if (donut) { donut.style.width = '0'; donut.style.height = '0'; }
    if (line)  { line.style.width  = '0'; line.style.height  = '0'; }
    if (acCv)  { acCv.style.width  = '0'; acCv.style.height  = '0'; }
    const fireCv = document.getElementById('fireChart');
    if (fireCv) { fireCv.style.width = '0'; fireCv.style.height = '0'; }
    if (resDonutChart) resDonutChart.resize();
    if (resLineChart)  resLineChart.resize();
    if (acChart)       acChart.resize();
    if (fireChart)     fireChart.resize();
  }, 120);
}
if (window.ResizeObserver) {
  new ResizeObserver(onResize).observe(document.querySelector('.chart-wrap'));
  const resCharts = document.querySelector('.res-charts');
  if (resCharts) new ResizeObserver(onResize).observe(resCharts);
}
window.addEventListener('resize', onResize);
</script>
<div class="pj-autocomplete" id="pj-autocomplete"></div>


</body>
</html>
