<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Simulador de PatrimÃ´nio Â· AÃ§Ãµes e renda fixa</title>
<link href="https://fonts.googleapis.com/css2?family=Fraunces:ital,opsz,wght@0,9..144,300;0,9..144,600;0,9..144,900;1,9..144,300&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   THEMES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg:#070809;--panel:#0d0f12;--card:#111418;--border:#1c2028;--border2:#252a33;
  --text:#dde2ea;--muted:#7a8b9e;--footer-text:#252e3a;
  --chart-grid:#0c1016;--chart-tick:#2a3545;--tooltip-bg:#111418;
  --green:#3dd68c;--green-faint:rgba(61,214,140,.08);
  --yellow:#f5c518;--yellow-faint:rgba(245,197,24,.08);
  --orange:#f07b3a;--orange-faint:rgba(240,123,58,.08);
  --blue:#5b9cf6;--blue-faint:rgba(91,156,246,.08);
  --violet:#a88bfa;--violet-faint:rgba(168,139,250,.08);
  --red:#f26065;--red-faint:rgba(242,96,101,.08);
  --teal:#2dd4bf;--teal-faint:rgba(45,212,191,.08);
}
:root[data-theme="light"] {
  --bg:#f8f9fb;--panel:#f0f2f5;--card:#fff;--border:#dde1e8;--border2:#c8cdd7;
  --text:#1a1e26;--muted:#7a8597;--footer-text:#b0b8c8;
  --chart-grid:#edf0f4;--chart-tick:#b0b8c8;--tooltip-bg:#fff;
  --green:#179e5f;--green-faint:rgba(23,158,95,.07);
  --yellow:#c49800;--yellow-faint:rgba(196,152,0,.08);
  --orange:#c45a15;--orange-faint:rgba(196,90,21,.08);
  --blue:#2c6fd4;--blue-faint:rgba(44,111,212,.08);
  --violet:#6d4fc7;--violet-faint:rgba(109,79,199,.08);
  --red:#c4383c;--red-faint:rgba(196,56,60,.08);
  --teal:#0e9488;--teal-faint:rgba(14,148,136,.08);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;font-size:13px;line-height:1.5;min-height:100vh;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PAGE NAV â€” HAMBURGER MENU
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.page-nav {
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--border);background:var(--panel);
  padding:0 40px;height:52px;position:sticky;top:0;z-index:200;
}
.nav-left{display:flex;align-items:center;gap:14px;}
.nav-brand{font-family:'Fraunces',serif;font-size:15px;font-weight:600;color:var(--text);letter-spacing:-.2px;}
.nav-brand span{color:var(--green);}
.nav-active-label{font-size:10px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}

/* Hamburger button */
.hamburger-btn {
  background:var(--card);border:1px solid var(--border);color:var(--muted);
  font-family:'DM Mono',monospace;font-size:11px;padding:6px 12px;
  cursor:pointer;display:flex;align-items:center;gap:8px;transition:all .2s;
  position:relative;
}
.hamburger-btn:hover{border-color:var(--border2);color:var(--text);}
.hamburger-btn.open{border-color:var(--green);color:var(--green);}
.hamburger-icon{display:flex;flex-direction:column;gap:4px;width:16px;}
.hamburger-icon span{display:block;height:1.5px;background:currentColor;transition:all .25s;border-radius:1px;}
.hamburger-btn.open .hamburger-icon span:nth-child(1){transform:translateY(5.5px) rotate(45deg);}
.hamburger-btn.open .hamburger-icon span:nth-child(2){opacity:0;transform:scaleX(0);}
.hamburger-btn.open .hamburger-icon span:nth-child(3){transform:translateY(-5.5px) rotate(-45deg);}

/* Dropdown */
.nav-dropdown {
  position:absolute;top:52px;left:0;
  background:var(--panel);border:1px solid var(--border);border-top:none;
  min-width:260px;display:none;flex-direction:column;
  box-shadow:0 8px 24px rgba(0,0,0,.12);
  z-index:300;
}
.nav-dropdown.open{display:flex;}
.nav-dropdown-item {
  display:flex;align-items:center;gap:12px;
  padding:14px 20px;border:none;background:transparent;
  color:var(--muted);font-family:'DM Mono',monospace;font-size:11px;
  cursor:pointer;text-align:left;transition:all .15s;border-bottom:1px solid var(--border);
  letter-spacing:.5px;
}
.nav-dropdown-item:last-child{border-bottom:none;}
.nav-dropdown-item:hover{background:var(--card);color:var(--text);}
.nav-dropdown-item.active{color:var(--green);background:var(--green-faint);}
.nav-dropdown-item .nav-icon{font-size:14px;flex-shrink:0;}
.nav-dropdown-item .nav-item-text{display:flex;flex-direction:column;gap:2px;}
.nav-dropdown-item .nav-item-label{font-size:11px;}
.nav-dropdown-item .nav-item-desc{font-size:9px;color:var(--muted);letter-spacing:.3px;}
.nav-dropdown-item.active .nav-item-desc{color:var(--green);opacity:.7;}

.nav-right{display:flex;align-items:center;gap:10px;}
.theme-btn {
  background:var(--card);border:1px solid var(--border);color:var(--muted);
  font-family:'DM Mono',monospace;font-size:10px;padding:5px 12px;cursor:pointer;
  letter-spacing:1px;display:flex;align-items:center;gap:6px;transition:all .2s;
}
.theme-btn:hover{border-color:var(--border2);color:var(--text);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SHARED: HEADER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.header{padding:36px 40px 24px;border-bottom:1px solid var(--border);position:relative;overflow:hidden;}
.header::before{content:'';position:absolute;top:-40px;right:-40px;width:280px;height:280px;
  background:radial-gradient(circle,rgba(61,214,140,.05) 0%,transparent 70%);pointer-events:none;}
.header-eyebrow{font-size:10px;letter-spacing:3px;text-transform:uppercase;color:var(--green);margin-bottom:10px;}
.header h1{font-family:'Fraunces',serif;font-size:clamp(24px,4vw,46px);font-weight:900;line-height:1.05;max-width:700px;}
.header h1 em{font-style:italic;color:var(--green);}
.header-sub{margin-top:8px;font-size:11px;color:var(--muted);max-width:600px;line-height:1.7;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INPUTS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.inputs-section-label{width:100%;padding:5px 22px;font-size:8px;letter-spacing:2px;text-transform:uppercase;
  color:var(--border2);background:var(--panel);border-bottom:1px solid var(--border);border-top:1px solid var(--border);}
.inputs-bar{display:flex;flex-wrap:wrap;border-bottom:1px solid var(--border);}
.input-group{display:flex;flex-direction:column;gap:5px;padding:14px 22px;border-right:1px solid var(--border);flex:1;min-width:120px;}
.input-group label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);}
.input-group input[type=number]{background:transparent;border:none;color:var(--text);padding:4px 0;
  font-family:'Fraunces',serif;font-size:20px;font-weight:600;width:100%;outline:none;cursor:pointer;
  -moz-appearance:textfield;}
.input-group input[type=number]::-webkit-inner-spin-button,
.input-group input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;}
.input-group input[type=number]:focus{color:var(--green);}
.input-note{font-size:10px;color:var(--muted);line-height:1.4;}

/* MODE PILLS */
.mode-pill{font-size:8px;padding:2px 6px;border:1px solid var(--border);background:var(--card);
  color:var(--muted);cursor:pointer;transition:all .15s;font-family:'DM Mono',monospace;white-space:nowrap;}
.mode-pill:hover{border-color:var(--border2);color:var(--text);}
.mode-pill.active{background:var(--blue-faint);border-color:var(--blue);color:var(--blue);}
.rate-result{color:var(--blue)!important;font-size:10px!important;}

/* IR PILLS */
.ir-pills{display:flex;gap:4px;flex-wrap:wrap;margin-top:3px;}
.ir-pill{font-size:9px;padding:3px 7px;border:1px solid var(--border);background:var(--card);
  color:var(--muted);cursor:pointer;transition:all .15s;font-family:'DM Mono',monospace;white-space:nowrap;}
.ir-pill:hover{border-color:var(--border2);color:var(--text);}
.ir-pill.active{background:var(--teal-faint);border-color:var(--teal);color:var(--teal);}

/* TOGGLE BAR */
.div-toggle-bar{padding:12px 40px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:20px;flex-wrap:wrap;background:var(--panel);}
.div-toggle-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);flex-shrink:0;}
.toggle-wrap{display:flex;align-items:center;gap:10px;}
.toggle-switch{position:relative;width:44px;height:22px;cursor:pointer;flex-shrink:0;}
.toggle-switch input{opacity:0;width:0;height:0;position:absolute;}
.toggle-track{position:absolute;inset:0;background:var(--border2);border-radius:11px;transition:background .25s;}
.toggle-switch input:checked+.toggle-track{background:var(--green);}
.toggle-thumb{position:absolute;top:3px;left:3px;width:16px;height:16px;border-radius:50%;background:#fff;transition:transform .25s;pointer-events:none;}
.toggle-switch input:checked~.toggle-thumb{transform:translateX(22px);}
.toggle-label-text{font-size:11px;color:var(--muted);transition:color .2s;}
.toggle-label-text.on{color:var(--green);}
.div-description{font-size:10px;color:var(--muted);margin-left:auto;border-left:1px solid var(--border);padding-left:16px;max-width:400px;line-height:1.5;}
.div-description .tag-on{color:var(--green);}
.div-description .tag-off{color:var(--orange);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAIN GRID (chart + sidebar)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.main{display:flex;flex-direction:column;align-items:center;padding:24px 40px 0;border-bottom:1px solid var(--border);}
.chart-area{width:100%;max-width:820px;padding:0;}
.section-label{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);
  margin-bottom:18px;display:flex;align-items:center;gap:12px;}
.section-label::after{content:'';flex:1;height:1px;background:var(--border);}
.chart-wrap{position:relative;height:190px;width:100%;overflow:hidden;}
.chart-wrap canvas{max-width:100%;}
.chart-note{font-size:9px;color:var(--muted);margin-top:8px;font-style:italic;}

/* LEGEND */
.legend-grid{display:flex;flex-wrap:wrap;gap:5px 18px;margin-top:18px;}
.legend-item{display:flex;align-items:center;gap:7px;font-size:10px;color:var(--muted);cursor:pointer;transition:color .2s;user-select:none;}
.legend-item:hover{color:var(--text);}
.legend-item.dimmed{opacity:.3;}
.legend-line{width:20px;height:2px;border-radius:1px;flex-shrink:0;}

/* SIDEBAR */
.sidebar{width:100%;padding:12px 0 24px;}
.ranking-header{display:flex;align-items:center;justify-content:space-between;gap:8px;margin-bottom:10px;padding:0 0 0 2px;}
.ranking-header .section-label{margin-bottom:0;}
.milestone-tabs{display:flex;gap:3px;flex-wrap:wrap;}
.tab-btn{flex:1;min-width:28px;background:var(--card);border:1px solid var(--border);color:var(--muted);
  font-family:'DM Mono',monospace;font-size:10px;padding:5px 3px;cursor:pointer;transition:all .2s;text-align:center;}
.tab-btn.active{background:var(--green-faint);border-color:var(--green);color:var(--green);}
.tab-btn:hover:not(.active){border-color:var(--border2);color:var(--text);}
.ranking{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:6px;}

/* RANK CARDS */
.rank-card{background:var(--card);border:1px solid var(--border);padding:8px 10px;position:relative;transition:border-color .2s;}
.rank-card:hover{border-color:var(--border2);}
.rank-card.rank-1{border-color:rgba(61,214,140,.3);background:var(--green-faint);}
.rank-card.rank-2{border-color:rgba(91,156,246,.2);}
.rank-pos{position:absolute;top:5px;right:7px;font-family:'Fraunces',serif;font-size:18px;font-weight:900;color:var(--border2);line-height:1;}
.rank-card.rank-1 .rank-pos{color:rgba(61,214,140,.15);}
.rank-name{font-size:10px;color:var(--text);margin-bottom:1px;display:flex;align-items:center;gap:5px;padding-right:22px;}
.rank-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0;}
.rank-rate{font-size:9px;color:var(--muted);margin-bottom:4px;}
.rank-fv{font-family:'Fraunces',serif;font-size:17px;font-weight:600;line-height:1;}
.rank-fv small{font-size:10px;font-weight:300;margin-right:1px;}
.rank-net{display:flex;flex-direction:column;gap:1px;margin-top:3px;padding-top:4px;border-top:1px solid var(--border);}
.rank-net-val{font-size:10px;color:var(--muted);}
.rank-net-label{font-size:7px;color:var(--border2);letter-spacing:.5px;}
.rank-detail{display:flex;gap:8px;margin-top:4px;flex-wrap:wrap;}
.rank-stat{display:flex;flex-direction:column;gap:1px;}
.rank-stat-label{font-size:7px;letter-spacing:.8px;text-transform:uppercase;color:var(--muted);}
.rank-stat-val{font-size:9px;color:var(--text);}
.rank-stat-val.pos{color:var(--green);}
.rank-stat-val.warn{color:var(--yellow);}
.rank-stat-val.risk{color:var(--orange);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CAVEATS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.caveats{padding:28px 40px;border-top:1px solid var(--border);display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;}
.caveat-card{padding:16px 18px;border:1px solid var(--border);background:var(--panel);}
.caveat-badge{display:inline-flex;align-items:center;gap:5px;font-size:9px;letter-spacing:1px;text-transform:uppercase;margin-bottom:8px;padding:3px 7px;}
.caveat-badge.green{background:var(--green-faint);color:var(--green);border:1px solid rgba(61,214,140,.2);}
.caveat-badge.yellow{background:var(--yellow-faint);color:var(--yellow);border:1px solid rgba(245,197,24,.2);}
.caveat-badge.blue{background:var(--blue-faint);color:var(--blue);border:1px solid rgba(91,156,246,.2);}
.caveat-badge.red{background:var(--red-faint);color:var(--red);border:1px solid rgba(242,96,101,.2);}
.caveat-badge.teal{background:var(--teal-faint);color:var(--teal);border:1px solid rgba(45,212,191,.2);}
.caveat-title{font-size:11px;font-weight:500;color:var(--text);margin-bottom:6px;}
.caveat-body{font-size:10px;color:var(--muted);line-height:1.7;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESERVA DE EMERGÃŠNCIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#tab-reserva .header::before{
  background:radial-gradient(circle,rgba(91,156,246,.06) 0%,transparent 70%);
}
.res-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;border-bottom:1px solid var(--border);}
.res-inputs{padding:32px 40px;border-right:1px solid var(--border);}
.res-charts{padding:32px 40px;}

.res-section-title{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:20px;display:flex;align-items:center;gap:12px;}
.res-section-title::after{content:'';flex:1;height:1px;background:var(--border);}

.res-input-row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:16px;}
.res-input-group{display:flex;flex-direction:column;gap:5px;}
.res-input-group label{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);}
.res-input-group input[type=number]{background:var(--card);border:1px solid var(--border);color:var(--text);
  font-family:'Fraunces',serif;font-size:20px;font-weight:600;padding:10px 14px;outline:none;width:100%;
  -moz-appearance:textfield;transition:border-color .2s;}
.res-input-group input[type=number]::-webkit-inner-spin-button,
.res-input-group input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;}
.res-input-group input[type=number]:focus{border-color:var(--blue);}
.res-input-group .input-note{font-size:10px;color:var(--muted);line-height:1.4;}

/* Filhos toggle */
.filhos-toggle-row{display:flex;align-items:center;gap:14px;margin-bottom:20px;padding:12px 16px;background:var(--card);border:1px solid var(--border);}
.filhos-toggle-label{font-size:11px;color:var(--text);flex:1;}
.filhos-toggle-sub{font-size:9px;color:var(--muted);}

/* Result box */
.res-result-box{background:var(--card);border:1px solid var(--border);padding:20px;margin-top:20px;}
.res-result-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;}
.res-result-item{padding:12px 16px;border-right:1px solid var(--border);}
.res-result-item:last-child{border-right:none;}
.res-result-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.res-result-value{font-family:'Fraunces',serif;font-size:22px;font-weight:700;line-height:1.1;}
.res-result-value.highlight{color:var(--blue);}
.res-result-value.ok{color:var(--green);}
.res-result-value.warn{color:var(--orange);}
.res-result-sub{font-size:9px;color:var(--muted);margin-top:3px;}

/* Progress bar */
.res-progress-wrap{margin-top:16px;}
.res-progress-label{display:flex;justify-content:space-between;font-size:10px;color:var(--muted);margin-bottom:6px;}
.res-progress-bar{height:6px;background:var(--border);border-radius:3px;overflow:hidden;}
.res-progress-fill{height:100%;border-radius:3px;transition:width .6s ease;background:var(--blue);}
.res-progress-fill.done{background:var(--green);}

/* Chart containers */
.res-donut-wrap{position:relative;height:220px;margin-bottom:24px;width:100%;overflow:hidden;}
.res-donut-wrap canvas{max-width:100%;}
.res-line-wrap{position:relative;height:200px;width:100%;overflow:hidden;}
.res-line-wrap canvas{max-width:100%;}
.res-chart-title{font-size:9px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:12px;}

/* Expert tips */
.expert-tips{padding:24px 40px;border-top:1px solid var(--border);background:var(--panel);}
.expert-tips-title{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:14px;}
.expert-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;}
.expert-card{padding:14px 16px;border:1px solid var(--border);background:var(--card);}
.expert-name{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--blue);margin-bottom:4px;}
.expert-text{font-size:10px;color:var(--muted);line-height:1.7;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   CALCULADORA DE AÃ‡Ã•ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.ac-main{display:flex;flex-direction:column;border-bottom:1px solid var(--border);}
.ac-chart-area{padding:20px 0 16px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;align-items:center;}
.ac-chart-wrap{position:relative;height:190px;width:min(820px,100%);overflow:hidden;}
.ac-chart-wrap canvas{max-width:100%;}
.ac-scenarios{display:grid;grid-template-columns:1fr 1fr 1fr;gap:0;}

.ac-scenario-card{background:var(--card);border-right:1px solid var(--border);padding:16px 20px;transition:background .2s;}
.ac-scenario-card:last-of-type{border-right:none;}
.ac-scenario-card:hover{background:var(--panel);}
.ac-scenario-card.rank-1{background:var(--green-faint);}

.ac-sc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px;}
.ac-sc-badge{font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:3px 8px;border:1px solid;font-family:'DM Mono',monospace;}
.ac-sc-growth{font-size:10px;color:var(--muted);}

.ac-sc-body{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:1px solid var(--border);padding-top:10px;}
.ac-sc-col{padding-right:12px;}
.ac-sc-col:last-child{padding-right:0;border-left:1px solid var(--border);padding-left:12px;}
.ac-sc-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.ac-sc-val{font-family:'Fraunces',serif;font-size:22px;font-weight:700;line-height:1.1;}
.ac-sc-val-net{font-family:'Fraunces',serif;font-size:18px;font-weight:600;color:var(--muted);line-height:1.1;}
.ac-sc-detail{font-size:9px;color:var(--muted);margin-top:8px;line-height:1.6;border-top:1px solid var(--border);padding-top:7px;}

/* Dividend projection row */
.ac-dividends-section{border-top:1px solid var(--border);}
.ac-div-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(130px,1fr));gap:0;border-top:1px solid var(--border);margin-top:14px;}
.ac-div-cell{padding:12px 16px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.ac-div-cell:last-child{border-right:none;}
.ac-div-year{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.ac-div-val{font-family:'Fraunces',serif;font-size:16px;font-weight:600;color:var(--violet);}
.ac-div-monthly{font-size:9px;color:var(--muted);margin-top:2px;}

@media(max-width:900px){
  .ac-scenarios{grid-template-columns:1fr;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REBALANCEAMENTO DE CARTEIRA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.rb-options-bar{padding:8px 40px;border-bottom:1px solid var(--border);background:var(--panel);display:flex;align-items:center;gap:16px;flex-wrap:wrap;}
.rb-opt-toggle{display:flex;align-items:center;gap:8px;cursor:pointer;user-select:none;}
.rb-opt-toggle input{display:none;}
.rb-opt-box{display:flex;align-items:center;gap:6px;padding:4px 10px;border:1px solid var(--border);background:var(--card);font-family:'DM Mono',monospace;font-size:10px;letter-spacing:.5px;color:var(--text);transition:all .2s;}
.rb-opt-toggle input:checked ~ .rb-opt-box{border-color:var(--green);color:var(--green);background:var(--green-faint);}
.rb-opt-dot{display:inline-block;width:7px;height:7px;border-radius:50%;flex-shrink:0;}
.rb-opt-sub{font-size:9px;color:var(--muted);}

.rb-profiles-bar{padding:0 40px;border-bottom:1px solid var(--border);}
.rb-profile-header{display:grid;grid-template-columns:180px 1fr 1fr 1fr;gap:0;padding:8px 0 6px;border-bottom:1px solid var(--border);}
.rb-ph-empty{}
.rb-ph-label{font-size:10px;letter-spacing:1px;text-transform:uppercase;padding:0 12px;font-family:'DM Mono',monospace;}
.rb-ph-label.cons{color:var(--blue);}
.rb-ph-label.mod{color:var(--violet);}
.rb-ph-label.arr{color:var(--green);}

.rb-row{display:grid;grid-template-columns:180px 1fr 1fr 1fr;gap:0;border-bottom:1px solid var(--border);align-items:center;}
.rb-row:last-of-type{border-bottom:none;}
.rb-row-label{padding:8px 0;display:flex;flex-direction:column;gap:1px;}
.rb-dot{display:inline-block;width:7px;height:7px;border-radius:50%;margin-right:5px;flex-shrink:0;}
.rb-row-label>span:first-child{display:flex;align-items:center;font-size:11px;color:var(--text);}
.rb-row-sub{font-size:8px;color:var(--muted);margin-left:12px;margin-top:0;}

.rb-row-bar{padding:8px 12px;display:flex;align-items:center;gap:8px;border-left:1px solid var(--border);}
.rb-bar-fill{height:6px;border-radius:3px;min-width:3px;transition:width .5s ease;}
.rb-row-bar span{font-family:'Fraunces',serif;font-size:13px;font-weight:700;color:var(--text);white-space:nowrap;}

.rb-dalio-note{padding:8px 0 10px;font-size:9px;color:var(--muted);line-height:1.6;border-top:1px solid var(--border);}

/* Compact header for rebalance tab */
#tab-rebalance .header{padding:16px 40px 14px;}
#tab-rebalance .header h1{font-size:28px;margin:4px 0;}
#tab-rebalance .header-sub{margin-top:4px;font-size:10px;}

/* Profile selector buttons */
.rb-profile-btn{font-family:'DM Mono',monospace;font-size:10px;letter-spacing:1px;padding:6px 14px;border:1px solid var(--border);background:var(--card);color:var(--muted);cursor:pointer;transition:all .2s;}
.rb-profile-btn:hover{border-color:var(--border2);color:var(--text);}
.rb-profile-btn.active{border-color:var(--green);color:var(--green);background:var(--green-faint);}

/* Diagnosis grid */
.rb-diag-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:0;border-top:1px solid var(--border);border-left:1px solid var(--border);margin:0 40px 24px;}
.rb-diag-cell{padding:16px 18px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.rb-diag-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.rb-diag-current{font-family:'Fraunces',serif;font-size:18px;font-weight:600;color:var(--text);}
.rb-diag-target{font-size:10px;color:var(--muted);margin-top:2px;}
.rb-diag-delta{font-size:11px;font-weight:600;margin-top:8px;padding:4px 8px;display:inline-block;}
.rb-diag-delta.buy{background:var(--green-faint);color:var(--green);}
.rb-diag-delta.ok{background:var(--card);color:var(--muted);}
.rb-diag-delta.over{background:rgba(251,146,60,.1);color:var(--orange);}
.rb-diag-amount{font-size:10px;color:var(--muted);margin-top:4px;}

/* Charts row */
.rb-charts-row{display:grid;grid-template-columns:1fr 1fr;gap:0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin:0 40px 0;}
.rb-donut-area{padding:24px;border-right:1px solid var(--border);}
.rb-donut-area:last-child{border-right:none;}
.rb-chart-title{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:16px;}
.rb-donut-wrap{position:relative;height:220px;width:100%;overflow:hidden;}
.rb-donut-wrap canvas{max-width:100%;}

@media(max-width:900px){
  .rb-profile-header,.rb-row{grid-template-columns:1fr 1fr;}
  .rb-ph-empty,.rb-ph-label:not(.cons){display:none;}
  .rb-row-bar.mod,.rb-row-bar.arr{display:none;}
  .rb-diag-grid{grid-template-columns:1fr 1fr;}
  .rb-charts-row{grid-template-columns:1fr;}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INDEPENDÃŠNCIA FINANCEIRA (FIRE)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#tab-fire .header{padding:20px 40px 16px;}

/* Methods explanation bar */
.fi-methods-bar{display:grid;grid-template-columns:1fr 1fr;gap:0;border-bottom:1px solid var(--border);border-top:1px solid var(--border);}
.fi-method-card{padding:16px 40px;border-right:1px solid var(--border);}
.fi-method-card:last-child{border-right:none;}
.fi-method-title{font-size:11px;font-weight:600;letter-spacing:.5px;margin-bottom:6px;}
.fi-method-desc{font-size:10px;color:var(--muted);line-height:1.7;}
.fi-method-desc code{font-family:'DM Mono',monospace;background:var(--card);padding:1px 5px;border:1px solid var(--border);border-radius:2px;font-size:9px;}

/* FIRE meta cards */
.fi-meta-grid{display:grid;grid-template-columns:1fr 1fr;gap:0;border-bottom:1px solid var(--border);}
.fi-meta-card{padding:24px 40px;border-right:1px solid var(--border);}
.fi-meta-card:last-child{border-right:none;}
.fi-meta-badge{display:inline-block;font-size:9px;letter-spacing:1px;text-transform:uppercase;padding:3px 10px;border:1px solid;margin-bottom:14px;font-family:'DM Mono',monospace;}
.fi-meta-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.fi-meta-val{font-family:'Fraunces',serif;font-size:36px;font-weight:900;line-height:1;margin-bottom:4px;}
.fi-meta-sub{font-size:10px;color:var(--muted);margin-bottom:16px;}
.fi-meta-falta-label{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.fi-meta-falta{font-family:'Fraunces',serif;font-size:20px;font-weight:600;color:var(--text);margin-bottom:14px;}

/* Tempo cards inside meta card */
.fi-tempos{display:flex;flex-direction:column;gap:6px;border-top:1px solid var(--border);padding-top:12px;}
.fi-tempo-row{display:flex;justify-content:space-between;align-items:center;padding:6px 10px;background:var(--card);border:1px solid var(--border);}
.fi-tempo-cenario{font-size:9px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.fi-tempo-val{font-family:'Fraunces',serif;font-size:14px;font-weight:600;}
.fi-tempo-val.cons{color:var(--blue);}
.fi-tempo-val.mod{color:var(--violet);}
.fi-tempo-val.arr{color:var(--green);}
.fi-tempo-val.inf{color:var(--orange);font-size:11px;}

/* Nota metodolÃ³gica */
.fi-nota{padding:14px 40px;background:var(--panel);border-bottom:1px solid var(--border);font-size:10px;color:var(--muted);line-height:1.7;}

/* Chart area */
.fi-chart-area{padding:20px 40px;border-bottom:1px solid var(--border);}
.fi-chart-controls{display:flex;align-items:center;gap:16px;margin-bottom:10px;flex-wrap:wrap;}
.fi-toggle-inflation{display:flex;align-items:center;gap:7px;cursor:pointer;font-size:11px;color:var(--text);}
.fi-toggle-inflation input{accent-color:var(--green);width:14px;height:14px;}
.fi-ctrl-note{font-size:9px;color:var(--muted);}
.fi-crossing-badges{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px;min-height:22px;}
.fi-crossing-badge{font-family:'DM Mono',monospace;font-size:10px;padding:4px 12px;border:1px solid;}
.fi-main-chart-wrap{position:relative;height:260px;width:100%;overflow:hidden;}
.fi-main-chart-wrap canvas{max-width:100%;}

/* Evolution table */
.fi-evolution-section{border-top:1px solid var(--border);}
.fi-evo-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:0;border-top:1px solid var(--border);}
.fi-evo-cell{padding:14px 18px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.fi-evo-year{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.fi-evo-portfolio{font-family:'Fraunces',serif;font-size:14px;font-weight:600;color:var(--text);}
.fi-evo-renda{font-size:11px;color:var(--violet);margin-top:2px;}
.fi-evo-monthly{font-size:9px;color:var(--muted);margin-top:1px;}
.fi-evo-mark{font-size:8px;font-weight:700;letter-spacing:1px;color:var(--green);margin-top:4px;}

/* FIRE IR banner */
.fi-ir-banner{display:grid;grid-template-columns:1fr 1fr;border-bottom:1px solid var(--border);}
.fi-ir-item{display:flex;gap:14px;padding:16px 40px;align-items:flex-start;}
.fi-ir-item:first-child{border-right:1px solid var(--border);}
.fi-ir-icon{font-size:20px;flex-shrink:0;margin-top:2px;}
.fi-ir-title{font-size:10px;color:var(--text);margin-bottom:5px;letter-spacing:.2px;}
.fi-ir-title strong{font-weight:700;}
.fi-ir-desc{font-size:9px;color:var(--muted);line-height:1.7;}
.fi-ir-green{background:rgba(61,214,140,.04);}
.fi-ir-orange{background:rgba(251,146,60,.04);}
.fi-ir-green .fi-ir-title strong{color:var(--green);}
.fi-ir-orange .fi-ir-title strong{color:var(--orange);}
@media(max-width:700px){.fi-ir-banner{grid-template-columns:1fr;}.fi-ir-item:first-child{border-right:none;border-bottom:1px solid var(--border);}}
.fi-trap-intro{padding:14px 40px 16px;font-size:11px;color:var(--muted);line-height:1.8;
  border-bottom:1px solid var(--border);background:var(--panel);}
.fi-trap-intro strong{color:var(--text);}
.fi-trap-rf-input-wrap{display:inline-flex;align-items:center;gap:6px;margin-left:16px;
  font-size:10px;color:var(--muted);border:1px solid var(--border);
  padding:3px 10px;background:var(--card);}
.fi-trap-rf-input-wrap input{background:transparent;border:none;outline:none;
  color:var(--text);font-family:'Fraunces',serif;font-size:15px;font-weight:600;
  width:44px;text-align:center;}

.fi-trap-grid{display:grid;grid-template-columns:1fr 1fr 1fr;border-bottom:1px solid var(--border);}

.fi-trap-blank{background:var(--panel);}
.fi-trap-head{display:flex;flex-direction:column;align-items:center;gap:4px;
  padding:12px 16px;border-left:1px solid var(--border);border-bottom:1px solid var(--border);
  font-size:10px;font-weight:600;text-align:center;background:var(--card);}
.fi-trap-head span{font-size:8px;font-weight:400;color:var(--muted);letter-spacing:.3px;}
.fi-trap-head-rv{color:#3dd68c;}
.fi-trap-head-rf{color:#a78bfa;}

.fi-trap-row-label{padding:10px 40px;font-size:9px;color:var(--muted);letter-spacing:.5px;
  display:flex;align-items:center;gap:6px;border-bottom:1px solid var(--border);background:var(--panel);}
.fi-trap-row-label em{color:var(--text);font-style:normal;font-weight:600;}
.fi-trap-row-label small{font-size:8px;color:var(--muted);opacity:.7;}
.fi-trap-cell{padding:10px 24px;border-left:1px solid var(--border);border-bottom:1px solid var(--border);
  font-family:'Fraunces',serif;font-size:16px;font-weight:600;color:var(--text);
  display:flex;align-items:center;justify-content:center;text-align:center;}
.fi-trap-cell-rv{color:#3dd68c;}
.fi-trap-cell-rf{color:#a78bfa;}
.fi-trap-highlight{font-size:20px;}
.fi-trap-danger{color:var(--orange)!important;}
.fi-trap-span{grid-column:2/-1;color:var(--orange);font-size:15px;}
.fi-trap-verdict{font-size:13px;letter-spacing:.5px;}
.fi-trap-verdict-label{font-weight:700;color:var(--text);}

.fi-trap-footnote{padding:12px 40px;font-size:10px;color:var(--muted);
  line-height:1.8;border-bottom:1px solid var(--border);background:var(--panel);}

@media(max-width:700px){
  .fi-trap-grid{grid-template-columns:1fr;}
  .fi-trap-head,.fi-trap-cell,.fi-trap-span{border-left:none;}
  .fi-trap-blank{display:none;}
}

@media(max-width:900px){
  .fi-methods-bar,.fi-meta-grid{grid-template-columns:1fr;}
  .fi-method-card,.fi-meta-card{border-right:none;border-bottom:1px solid var(--border);}
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FOOTER LEGAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.footer-legal{border-top:2px solid var(--border);background:var(--panel);}
.footer-legal-main{padding:24px 40px;display:grid;grid-template-columns:1fr 1fr;gap:32px;border-bottom:1px solid var(--border);}
.footer-legal-block h4{font-size:9px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.footer-legal-block p{font-size:10px;color:var(--muted);line-height:1.7;}
.footer-bottom{padding:14px 40px;display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;}
.footer-copy{font-size:10px;color:var(--footer-text);}
.footer-copy strong{color:var(--muted);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESPONSIVE
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media(max-width:900px){
  .main{padding:16px 20px 0;}
  .chart-area,.sidebar{max-width:100%;}
  .ranking{grid-template-columns:1fr 1fr;}
  .ac-scenarios{grid-template-columns:1fr;}
  .res-grid{grid-template-columns:1fr;}
  .res-inputs{border-right:none;border-bottom:1px solid var(--border);}
  .footer-legal-main{grid-template-columns:1fr;}
}
@media(max-width:768px){
  .page-nav{padding:0 20px;}
  .header,.chart-area,.caveats,.res-inputs,.res-charts,.expert-tips,.footer-legal-main,.footer-bottom{padding-left:20px;padding-right:20px;}
  .div-toggle-bar{padding-left:20px;padding-right:20px;}
  .input-group{padding:12px 14px;min-width:100px;}
  .sidebar{padding:20px;}
  .div-description{margin-left:0;border-left:none;padding-left:0;border-top:1px solid var(--border);padding-top:8px;width:100%;max-width:100%;}
  .res-input-row{grid-template-columns:1fr;}
  .res-result-grid{grid-template-columns:1fr;}
  .res-result-item{border-right:none;border-bottom:1px solid var(--border);}
}
.pj-print-bar{display:flex;align-items:center;gap:16px;padding:16px 28px;border-top:1px solid var(--border);border-bottom:1px solid var(--border);}
.pj-print-btn{background:var(--green-faint);color:var(--green);border:1px solid var(--green);padding:8px 18px;font-family:'DM Mono',monospace;font-size:11px;font-weight:600;letter-spacing:.5px;cursor:pointer;transition:background .2s;}
.pj-print-btn:hover{background:var(--green);color:var(--bg);}
.pj-print-hint{font-size:9px;color:var(--muted);}
@media print{
  .page-nav,.nav-right,.theme-btn,.pj-print-bar,.div-toggle-bar,.inputs-bar,.inputs-section-label,.fi-nota,#tab-simulador,#tab-reserva,#tab-acoes,#tab-rebalance,#tab-fire,#tab-meta,footer{display:none!important;}
  #tab-preco{display:block!important;}
  .pj-methods-grid,.pj-consenso-bar,.pj-indicators-grid{break-inside:avoid;}
  body{background:#fff;color:#111;}
  .pj-method-card,.pj-consenso-block,.pj-indicator{border-color:#ddd;}
}
.pj-sector-warning{padding:12px 28px;border-bottom:1px solid var(--border);background:var(--orange-faint);}
.pj-sector-warning-inner{display:flex;align-items:flex-start;gap:10px;max-width:900px;}
.pj-sector-warning-icon{font-size:16px;flex-shrink:0;margin-top:1px;}
.pj-sector-warning-text{font-size:10px;color:var(--text);line-height:1.7;}
.pj-sector-warning-text strong{color:var(--orange);}
.pj-dpa-tip{font-size:9px;color:var(--muted);line-height:1.7;margin-top:8px;padding:10px 12px;background:var(--panel);border:1px solid var(--border);border-left:2px solid var(--yellow);}
.pj-dpa-tip strong{color:var(--text);}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   META PATRIMONIAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#tab-meta .header::before{background:radial-gradient(circle,rgba(61,214,140,.05) 0%,transparent 70%);}
#tab-preco .header::before{background:radial-gradient(circle,rgba(168,139,250,.06) 0%,transparent 70%);}

.meta-results-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));border-bottom:1px solid var(--border);}
.meta-result-card{padding:22px 28px;border-right:1px solid var(--border);}
.meta-result-card:last-child{border-right:none;}
.meta-card-primary{background:var(--green-faint);}
.meta-result-eyebrow{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:8px;}
.meta-result-val{font-family:'Fraunces',serif;font-size:26px;font-weight:900;line-height:1;margin-bottom:5px;}
.meta-result-sub{font-size:9px;color:var(--muted);line-height:1.6;}

.meta-scenarios-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));border-bottom:1px solid var(--border);}
.meta-scenario-card{padding:18px 24px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.meta-sc-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:3px;}
.meta-sc-rate{font-size:10px;margin-bottom:8px;}
.meta-sc-val{font-family:'Fraunces',serif;font-size:20px;font-weight:700;line-height:1;margin-bottom:3px;}
.meta-sc-sub{font-size:9px;color:var(--muted);}

.meta-chart-section{display:flex;flex-direction:column;align-items:center;padding:24px 40px 16px;border-bottom:1px solid var(--border);}
.meta-chart-wrap{position:relative;height:200px;width:100%;max-width:820px;overflow:hidden;}

.meta-milestones{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));border-bottom:1px solid var(--border);}
.meta-milestone{padding:14px 18px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.meta-ms-year{font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.meta-ms-val{font-family:'Fraunces',serif;font-size:17px;font-weight:700;line-height:1;margin-bottom:2px;}
.meta-ms-pct{font-size:9px;color:var(--muted);}
.meta-ms-mark{font-size:8px;font-weight:700;letter-spacing:1px;color:var(--green);margin-top:3px;}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PREÃ‡O JUSTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.pj-methods-grid{display:grid;grid-template-columns:repeat(2,1fr);border-bottom:1px solid var(--border);}
.pj-method-card{padding:24px 28px;border-right:1px solid var(--border);}
.pj-method-card:last-child{border-right:none;}
.pj-method-header{margin-bottom:10px;}
.pj-method-title{font-family:'Fraunces',serif;font-size:16px;font-weight:600;margin-bottom:3px;}
.pj-method-formula-tag{font-size:9px;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:.3px;padding:3px 7px;background:var(--panel);border:1px solid var(--border);display:inline-block;}
.pj-method-desc{font-size:9px;color:var(--muted);line-height:1.7;margin:12px 0 16px;}
.pj-result-row{display:flex;gap:20px;flex-wrap:wrap;padding-top:14px;border-top:1px solid var(--border);}
.pj-result-block{display:flex;flex-direction:column;gap:3px;}
.pj-result-label{font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);}
.pj-result-val{font-family:'Fraunces',serif;font-size:22px;font-weight:700;color:var(--text);}
.pj-margem{font-family:'Fraunces',serif;font-size:18px;font-weight:600;}
.pj-margem.positiva{color:var(--green);}
.pj-margem.negativa{color:var(--orange);}
.pj-veredicto{font-size:10px;font-weight:700;letter-spacing:.4px;padding:3px 9px;border-radius:10px;display:inline-block;margin-top:3px;}
.pj-veredicto.compra{background:var(--green-faint);color:var(--green);border:1px solid var(--green);}
.pj-veredicto.cara{background:var(--orange-faint);color:var(--orange);border:1px solid var(--orange);}
.pj-veredicto.neutra{background:var(--yellow-faint);color:var(--yellow);border:1px solid var(--yellow);}

.pj-consenso-bar{background:var(--card);border-bottom:1px solid var(--border);}
.pj-consenso-inner{display:flex;justify-content:center;}
.pj-consenso-block{padding:20px 40px;border-right:1px solid var(--border);text-align:center;}
.pj-consenso-block:last-child{border-right:none;}
.pj-consenso-label{font-size:8px;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;}
.pj-consenso-val{font-family:'Fraunces',serif;font-size:22px;font-weight:700;}

.pj-indicators-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));border-bottom:1px solid var(--border);}
.pj-indicator{padding:14px 20px;border-right:1px solid var(--border);border-bottom:1px solid var(--border);}
.pj-ind-label{font-size:8px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);margin-bottom:4px;}
.pj-ind-val{font-family:'Fraunces',serif;font-size:20px;font-weight:700;line-height:1;margin-bottom:2px;}
.pj-ind-ref{font-size:8px;color:var(--muted);}
.pj-ind-ok{color:var(--green);}
.pj-ind-warn{color:var(--yellow);}
.pj-ind-bad{color:var(--orange);}

@media(max-width:900px){
  .pj-methods-grid{grid-template-columns:1fr;}
  .pj-method-card{border-right:none;border-bottom:1px solid var(--border);}
  .pj-consenso-inner{flex-wrap:wrap;}
  .pj-consenso-block{flex:1;min-width:130px;}
  .meta-result-card{border-right:none;border-bottom:1px solid var(--border);}
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     PAGE NAV â€” HAMBURGER
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<nav class="page-nav">
  <div class="nav-left">
    <div style="position:relative;">
      <button class="hamburger-btn" id="hamburgerBtn" onclick="toggleMenu()">
        <div class="hamburger-icon">
          <span></span><span></span><span></span>
        </div>
        Menu
      </button>
      <div class="nav-dropdown" id="navDropdown">
        <button class="nav-dropdown-item active" id="menu-simulador" onclick="showTab('simulador')">
          <span class="nav-icon">ğŸ“ˆ</span>
          <div class="nav-item-text">
            <span class="nav-item-label">Simulador de Investimentos</span>
            <span class="nav-item-desc">AÃ§Ãµes, Tesouro, CDB, LCI/LCA</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-reserva" onclick="showTab('reserva')">
          <span class="nav-icon">ğŸ›¡ï¸</span>
          <div class="nav-item-text">
            <span class="nav-item-label">Reserva de EmergÃªncia</span>
            <span class="nav-item-desc">Meta, prazo e progresso</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-acoes" onclick="showTab('acoes')">
          <span class="nav-icon">ğŸ“Š</span>
          <div class="nav-item-text">
            <span class="nav-item-label">Calculadora de AÃ§Ãµes</span>
            <span class="nav-item-desc">DY, cenÃ¡rios e imposto</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-rebalance" onclick="showTab('rebalance')">
          <span class="nav-icon">âš–ï¸</span>
          <div class="nav-item-text">
            <span class="nav-item-label">Rebalanceamento de Carteira</span>
            <span class="nav-item-desc">3 perfis Â· o que comprar agora</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-meta" onclick="showTab('meta')">
          <span class="nav-icon">ğŸ¯</span>
          <div class="nav-item-text">
            <span class="nav-item-label">Meta Patrimonial</span>
            <span class="nav-item-desc">Quanto aportar para chegar lÃ¡</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-preco" onclick="showTab('preco')">
          <span class="nav-icon">ğŸ“</span>
          <div class="nav-item-text">
            <span class="nav-item-label">PreÃ§o Justo</span>
            <span class="nav-item-desc">Bazin e Graham</span>
          </div>
        </button>
        <button class="nav-dropdown-item" id="menu-fire" onclick="showTab('fire')">
          <span class="nav-icon">ğŸ”ï¸</span>
          <div class="nav-item-text">
            <span class="nav-item-label">IndependÃªncia Financeira</span>
            <span class="nav-item-desc">Seu nÃºmero FIRE Â· Curva da Liberdade</span>
          </div>
        </button>
      </div>
    </div>
    <span class="nav-active-label" id="navActiveLabel">Simulador de Investimentos</span>
  </div>
  <div class="nav-right">
    <button class="theme-btn" onclick="toggleTheme()">
      <span id="themeIcon">â˜¾</span>
      <span id="themeLabel">Tema escuro</span>
    </button>
  </div>
</nav>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 1: SIMULADOR
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-simulador">

  <div class="header">
    <div class="header-eyebrow">Simulador de PatrimÃ´nio Â· AÃ§Ãµes e renda fixa</div>
    <h1><span id="h1Inicial">R$ 10k</span> inicial + <span id="h1Aporte">R$ 1k</span>/<em>mÃªs</em></h1>
    <p class="header-sub">
      Tesouro IPCA+ Â· LCI/LCA Â· CDB Â· AÃ§Ãµes (ITUB3, PETR4â€¦)<br>
      Todos os parÃ¢metros configurÃ¡veis. Clique na legenda para ocultar sÃ©ries.
    </p>
  </div>

  <div class="inputs-section-label">ParÃ¢metros Gerais</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Capital Inicial</label>
      <input type="number" id="inicial" value="10000" min="0" step="1000">
      <span class="input-note">saldo atual</span>
    </div>
    <div class="input-group">
      <label>Aporte Mensal</label>
      <input type="number" id="aporte" value="1000" min="0" step="100">
      <span class="input-note" id="aporteNote">100% reinvestido</span>
    </div>
    <div class="input-group">
      <label>Selic % a.a.</label>
      <input type="number" id="selic" value="15.0" min="0" max="30" step="0.25">
      <span class="input-note">atual: 15% Â· base do CDI</span>
    </div>
    <div class="input-group">
      <label>Tesouro IPCA+ real %</label>
      <input type="number" id="tesouRoReal" value="7.21" min="0" max="20" step="0.01">
      <span class="input-note">ex: 7,21% (2045+) Â· 7,18% (2040+)</span>
    </div>
    <div class="input-group">
      <label>IPCA % a.a.</label>
      <input type="number" id="ipca" value="4.0" min="0" max="30" step="0.5">
      <span class="input-note">projeÃ§Ã£o anual</span>
    </div>
    <div class="input-group">
      <label>DY das AÃ§Ãµes %</label>
      <input type="number" id="dy" value="6" min="0" max="20" step="0.5">
      <span class="input-note">dividend yield anual</span>
    </div>
  </div>

  <div class="inputs-section-label">Renda Fixa Â· Taxas e Impostos</div>
  <div class="inputs-bar">
    <div class="input-group" style="min-width:180px;">
      <label style="display:flex;align-items:center;justify-content:space-between;">
        <span>LCI/LCA</span>
        <span style="display:flex;gap:3px;">
          <button class="mode-pill active" id="lciModePre" onclick="setMode('lci','pre')">PrÃ©</button>
          <button class="mode-pill" id="lciModePos" onclick="setMode('lci','pos')">PÃ³s Â· %CDI</button>
        </span>
      </label>
      <input type="number" id="lciRate" value="14.0" min="0" max="200" step="0.5">
      <span class="input-note" id="lciRateNote">bruto prefixado a.a.</span>
      <span class="input-note rate-result" id="lciResult" style="display:none;"></span>
    </div>
    <div class="input-group" style="min-width:130px;">
      <label>IR LCI/LCA %</label>
      <input type="number" id="lciIR" value="0" min="0" max="25" step="2.5">
      <span class="input-note">0% isento Â· mude se tributar</span>
    </div>
    <div class="input-group" style="min-width:180px;">
      <label style="display:flex;align-items:center;justify-content:space-between;">
        <span>CDB</span>
        <span style="display:flex;gap:3px;">
          <button class="mode-pill active" id="cdbModePre" onclick="setMode('cdb','pre')">PrÃ©</button>
          <button class="mode-pill" id="cdbModePos" onclick="setMode('cdb','pos')">PÃ³s Â· %CDI</button>
        </span>
      </label>
      <input type="number" id="cdbRate" value="13.5" min="0" max="200" step="0.5">
      <span class="input-note" id="cdbRateNote">bruto prefixado a.a.</span>
      <span class="input-note rate-result" id="cdbResult" style="display:none;"></span>
    </div>
    <div class="input-group" style="min-width:220px;flex:2;">
      <label>IR CDB: automÃ¡tico pelo horizonte</label>
      <div style="margin-top:4px;display:flex;flex-direction:column;gap:4px;">
        <span id="cdbIrAutoLabel" style="font-family:'Fraunces',serif;font-size:18px;font-weight:600;color:var(--teal);">15%</span>
        <span class="input-note" id="cdbIrAutoDesc">acima de 720 dias Â· ajusta conforme o prazo selecionado no ranking</span>
      </div>
      <div style="margin-top:8px;display:flex;gap:6px;flex-wrap:wrap;">
        <span style="font-size:9px;color:var(--muted);">6mâ†’22,5%</span>
        <span style="font-size:9px;color:var(--muted);">Â·</span>
        <span style="font-size:9px;color:var(--muted);">1aâ†’20%</span>
        <span style="font-size:9px;color:var(--muted);">Â·</span>
        <span style="font-size:9px;color:var(--muted);">2aâ†’17,5%</span>
        <span style="font-size:9px;color:var(--muted);">Â·</span>
        <span style="font-size:9px;color:var(--muted);">5a+â†’15%</span>
      </div>
    </div>
  </div>

  <div class="div-toggle-bar">
    <span class="div-toggle-label">AÃ§Ãµes Â· Dividendos</span>
    <div class="toggle-wrap">
      <label class="toggle-switch">
        <input type="checkbox" id="reinvestToggle" checked>
        <div class="toggle-track"></div>
        <div class="toggle-thumb"></div>
      </label>
      <span class="toggle-label-text on" id="toggleText">Reinvestindo dividendos</span>
    </div>
    <div class="div-description" id="divDescription">
      <span class="tag-on">âœ¦ Ativado:</span> dividendos compram mais aÃ§Ãµes â†’ portfÃ³lio cresce pelo total return (preÃ§o + DY).
    </div>
  </div>

  <div class="main">
    <div class="chart-area">
      <div class="section-label">Crescimento do PatrimÃ´nio Â· valor bruto acumulado</div>
      <div class="chart-wrap"><canvas id="mainChart"></canvas></div>
      <p class="chart-note">* Renda fixa: curvas mostram o valor bruto que rende juros compostos. IR incide apenas no resgate (sem come-cotas). "No bolso" no ranking desconta o IR automaticamente pelo prazo. AÃ§Ãµes: grÃ¡fico em valor total (bruto); o IR no ranking Ã© uma estimativa simplificada â€” alÃ­quota fixa de 15% sobre o ganho de preÃ§o, sem considerar isenÃ§Ã£o de R$20k/mÃªs nem compensaÃ§Ã£o de perdas. Dividendos tratados como isentos (Lei 9.249/95). Retornos em termos nominais, sem ajuste pela inflaÃ§Ã£o.</p>
      <div class="legend-grid" id="legendGrid"></div>
    </div>
    <div class="sidebar">
      <div class="ranking-header">
        <div class="section-label" style="margin-bottom:0;">Ranking no horizonte</div>
        <div class="milestone-tabs">
          <button class="tab-btn" data-months="6">6m</button>
          <button class="tab-btn" data-months="12">1a</button>
          <button class="tab-btn" data-months="24">2a</button>
          <button class="tab-btn" data-months="60">5a</button>
          <button class="tab-btn active" data-months="120">10a</button>
          <button class="tab-btn" data-months="180">15a</button>
          <button class="tab-btn" data-months="240">20a</button>
        </div>
      </div>
      <div class="ranking" id="rankingList"></div>
    </div>
  </div>

  <div class="caveats">
    <div class="caveat-card">
      <div class="caveat-badge green">âœ¦ Tesouro IPCA+ <span id="caveatTesRate">7,21%</span></div>
      <div class="caveat-title">Ã‚ncora de longo prazo</div>
      <div class="caveat-body">Taxa real configurÃ¡vel acima. Ex: 2045+ â‰ˆ 7,21% Â· 2040+ â‰ˆ 7,18%. Garantia soberana. IR 15% sÃ³ no resgate, sem come-cotas. No vencimento, retorno garantido.</div>
    </div>
    <div class="caveat-card">
      <div class="caveat-badge yellow">âš  LCI/LCA</div>
      <div class="caveat-title">Bom hoje, incerto amanhÃ£</div>
      <div class="caveat-body">Prazo tÃ­pico ~3 anos; impossÃ­vel travar por 20 anos. Renova Ã s taxas futuras. Mude IR para 7,5% para simular eventual tributaÃ§Ã£o.</div>
    </div>
    <div class="caveat-card">
      <div class="caveat-badge teal">â—ˆ CDB</div>
      <div class="caveat-title">IR regressivo Â· FGC R$250k</div>
      <div class="caveat-body">IR cai de 22,5% (â‰¤180d) a 15% (720d+). Rende pela taxa bruta; IR incide sÃ³ no resgate. AtenÃ§Ã£o ao limite FGC por CPF por instituiÃ§Ã£o.</div>
    </div>
    <div class="caveat-card">
      <div class="caveat-badge blue">â—ˆ AÃ§Ãµes com Reinvestimento</div>
      <div class="caveat-title">Bola de neve via dividendos</div>
      <div class="caveat-body">Dividendos compram mais cotas â†’ mais dividendos â†’ efeito exponencial. ITUB4, ABCB4 historicamente entregam total return 12â€“18% a.a. em bons ciclos.</div>
    </div>
    <div class="caveat-card">
      <div class="caveat-badge red">â—ˆ AÃ§Ãµes sem Reinvestimento</div>
      <div class="caveat-title">Dividendos como renda corrente</div>
      <div class="caveat-body">PortfÃ³lio cresce sÃ³ pela valorizaÃ§Ã£o de preÃ§o. Dividendos acumulam como caixa separado. A diferenÃ§a vs. reinvestimento se torna enorme em 15â€“20 anos.</div>
    </div>
  </div>

</div><!-- /tab-simulador -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 2: RESERVA DE EMERGÃŠNCIA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-reserva" style="display:none;">

  <div class="header">
    <div class="header-eyebrow">Reserva de EmergÃªncia Â· Planejamento</div>
    <h1>Quanto vocÃª<br>precisa <em>guardar?</em></h1>
    <p class="header-sub">
      Calcule sua meta ideal, o tempo necessÃ¡rio para atingi-la e onde investir.
    </p>
  </div>

  <div class="res-grid">
    <!-- INPUTS -->
    <div class="res-inputs">
      <div class="res-section-title">Sua situaÃ§Ã£o</div>

      <div class="res-input-row">
        <div class="res-input-group">
          <label>Pessoas na casa</label>
          <input type="number" id="res-pessoas" value="2" min="1" max="20" step="1">
          <span class="input-note" id="res-per-capita">â‰ˆ R$ 2.500/pessoa</span>
        </div>
        <div class="res-input-group">
          <label>Gasto fixo mensal</label>
          <input type="number" id="res-gasto" value="5000" min="0" step="500">
          <span class="input-note">R$: aluguel, comida, contas...</span>
        </div>
      </div>

      <div class="filhos-toggle-row">
        <div>
          <div class="filhos-toggle-label">Tem filhos menores de 18 anos?</div>
          <div class="filhos-toggle-sub">Afeta o prazo recomendado: 6 â†’ 8 meses</div>
        </div>
        <div class="toggle-wrap">
          <label class="toggle-switch">
            <input type="checkbox" id="res-filhos">
            <div class="toggle-track"></div>
            <div class="toggle-thumb"></div>
          </label>
          <span class="toggle-label-text" id="filhosLabel">NÃ£o</span>
        </div>
      </div>

      <div class="res-input-row">
        <div class="res-input-group">
          <label>JÃ¡ tenho guardado</label>
          <input type="number" id="res-atual" value="0" min="0" step="500">
          <span class="input-note">R$: reserva atual</span>
        </div>
        <div class="res-input-group">
          <label>Posso guardar/mÃªs</label>
          <input type="number" id="res-poupar" value="500" min="0" step="100">
          <span class="input-note">R$: valor disponÃ­vel</span>
        </div>
      </div>

      <div class="res-input-row">
        <div class="res-input-group">
          <label>Renda variÃ¡vel?</label>
          <select id="res-renda" style="background:var(--card);border:1px solid var(--border);color:var(--text);
            font-family:'DM Mono',monospace;font-size:13px;padding:10px 14px;outline:none;width:100%;">
            <option value="0">Emprego CLT estÃ¡vel</option>
            <option value="1">Renda variÃ¡vel / freelancer</option>
            <option value="2">EmpresÃ¡rio / autÃ´nomo</option>
          </select>
          <span class="input-note">impacta meses recomendados</span>
        </div>
        <div class="res-input-group">
          <label>Rendimento da reserva</label>
          <input type="number" id="res-rendimento" value="13.5" min="0" max="30" step="0.5">
          <span class="input-note">% a.a. bruto (CDB liquidez diÃ¡ria)</span>
        </div>
      </div>

      <!-- RESULTADO -->
      <div class="res-result-box">
        <div class="res-result-grid">
          <div class="res-result-item">
            <div class="res-result-label">Meta ideal</div>
            <div class="res-result-value highlight" id="res-meta">R$ 30.000</div>
            <div class="res-result-sub" id="res-meta-sub">6 meses Ã— R$ 5.000</div>
          </div>
          <div class="res-result-item">
            <div class="res-result-label">Falta acumular</div>
            <div class="res-result-value warn" id="res-falta">R$ 30.000</div>
            <div class="res-result-sub" id="res-falta-sub">100% da meta</div>
          </div>
          <div class="res-result-item">
            <div class="res-result-label">Tempo estimado</div>
            <div class="res-result-value ok" id="res-tempo">â€”</div>
            <div class="res-result-sub" id="res-tempo-sub">com rendimento da reserva</div>
          </div>
        </div>
        <div class="res-progress-wrap">
          <div class="res-progress-label">
            <span>Progresso atual</span>
            <span id="res-pct">0%</span>
          </div>
          <div class="res-progress-bar"><div class="res-progress-fill" id="res-fill" style="width:0%"></div></div>
        </div>
      </div>
    </div>

    <!-- CHARTS -->
    <div class="res-charts">
      <div class="res-chart-title">DistribuiÃ§Ã£o da sua meta</div>
      <div class="res-donut-wrap"><canvas id="resDonut"></canvas></div>
      <div class="res-chart-title">EvoluÃ§Ã£o atÃ© atingir a reserva</div>
      <div class="res-line-wrap"><canvas id="resLine"></canvas></div>
    </div>
  </div>

  <!-- EXPERT TIPS -->
  <div class="expert-tips">
    <div class="expert-tips-title">O que dizem os especialistas</div>
    <div class="expert-grid">
      <div class="expert-card">
        <div class="expert-name">Gustavo Cerbasi</div>
        <div class="expert-text">Recomenda de 6 a 12 meses de despesas, investida em ativos de liquidez diÃ¡ria. Para profissionais liberais e autÃ´nomos, prefere o teto de 12 meses.</div>
      </div>
      <div class="expert-card">
        <div class="expert-name">Nathalia Arcuri (Me Poupe!)</div>
        <div class="expert-text">MÃ­nimo de 6 meses de gastos fixos. Para quem tem dependentes ou renda instÃ¡vel, eleva para 8â€“12 meses. A reserva deve ficar no Tesouro Selic ou CDB com liquidez diÃ¡ria.</div>
      </div>
      <div class="expert-card">
        <div class="expert-name">Dave Ramsey</div>
        <div class="expert-text">Baby Step 1: reserve R$ 1.000 de emergÃªncia rapidamente. Baby Step 3: complete com 3â€“6 meses de despesas. Prioridade antes de qualquer investimento.</div>
      </div>
      <div class="expert-card">
        <div class="expert-name">Onde investir a reserva</div>
        <div class="expert-text">Tesouro Selic (resgate D+1) Â· CDB liquidez diÃ¡ria de banco grande Â· Fundo DI taxa zero. Nunca em renda variÃ¡vel ou CDB sem liquidez; a reserva precisa estar disponÃ­vel imediatamente.</div>
      </div>
    </div>
  </div>

</div><!-- /tab-reserva -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 3: CALCULADORA DE AÃ‡Ã•ES
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-acoes" style="display:none;">

  <div class="header">
    <div class="header-eyebrow">Calculadora de AÃ§Ãµes Â· Dividendos e ValorizaÃ§Ã£o</div>
    <h1>Quanto rende <em>sua aÃ§Ã£o?</em></h1>
    <p class="header-sub">
      Insira o ticker, DY histÃ³rico e capital. Veja os trÃªs cenÃ¡rios de crescimento e o valor lÃ­quido apÃ³s IR.
    </p>
  </div>

  <!-- INPUTS -->
  <div class="inputs-section-label">Dados da AÃ§Ã£o</div>
  <div class="inputs-bar">
    <div class="input-group" style="min-width:140px;">
      <label>Ticker</label>
      <input type="text" id="ac-ticker" value="ITUB4" maxlength="8"
        style="background:transparent;border:none;color:var(--text);font-family:'Fraunces',serif;
               font-size:28px;font-weight:900;width:100%;outline:none;text-transform:uppercase;">
      <span class="input-note">cÃ³digo da aÃ§Ã£o (ex: PETR4)</span>
    </div>
    <div class="input-group" style="min-width:180px;flex:2;">
      <label>DY HistÃ³rico % a.a.</label>
      <input type="number" id="ac-dy" value="7.0" min="0" max="50" step="0.5">
      <span class="input-note">mÃ©dia dos Ãºltimos 5â€“10 anos excluindo anos atÃ­picos</span>
    </div>
    <div class="input-group">
      <label>Capital Inicial</label>
      <input type="number" id="ac-inicial" value="10000" min="0" step="1000">
      <span class="input-note">R$ investido hoje</span>
    </div>
    <div class="input-group">
      <label>Aporte Mensal</label>
      <input type="number" id="ac-aporte" value="1000" min="0" step="100">
      <span class="input-note">R$ por mÃªs</span>
    </div>
    <div class="input-group">
      <label>Horizonte (anos)</label>
      <input type="number" id="ac-anos" value="20" min="1" max="40" step="1">
      <span class="input-note">perÃ­odo de acumulaÃ§Ã£o</span>
    </div>
    <div class="input-group">
      <label>Reinvestir dividendos?</label>
      <div class="toggle-wrap" style="margin-top:4px;">
        <label class="toggle-switch">
          <input type="checkbox" id="ac-reinvest" checked>
          <div class="toggle-track"></div>
          <div class="toggle-thumb"></div>
        </label>
        <span class="toggle-label-text on" id="ac-reinvest-label">Sim</span>
      </div>
      <span class="input-note" id="ac-reinvest-note">dividendos compram mais aÃ§Ãµes</span>
    </div>
  </div>

  <!-- DY GUIDE -->
  <div style="padding:10px 40px;background:var(--panel);border-bottom:1px solid var(--border);font-size:10px;color:var(--muted);display:flex;align-items:center;gap:12px;flex-wrap:wrap;">
    <span style="color:var(--blue);font-weight:500;">ğŸ’¡ Como calcular seu DY histÃ³rico:</span>
    <span>Some os dividendos pagos por aÃ§Ã£o em cada ano e divida pelo preÃ§o mÃ©dio do ano Â· tire a mÃ©dia dos Ãºltimos 5 ou 10 anos.</span>
    <span style="color:var(--orange);">Â· Exclua anos com DY atÃ­pico (ex: distribuiÃ§Ãµes extras em ano pÃ³s-pandemia) para uma base mais conservadora</span>
  </div>

  <!-- CARDS DE CENÃRIO + GRÃFICO -->
  <div class="ac-main">
    <!-- GRÃFICO â€” topo, largura total -->
    <div class="ac-chart-area">
      <div class="section-label" style="width:min(820px,100%);">EvoluÃ§Ã£o Patrimonial Â· <span id="ac-ticker-label">PETR4</span> Â· <span id="ac-anos-label">20</span> anos</div>
      <div class="ac-chart-wrap"><canvas id="acChart"></canvas></div>
      <div class="legend-grid" id="ac-legend" style="width:min(820px,100%);"></div>
    </div>

    <!-- 3 CENÃRIOS em linha -->
    <div class="ac-scenarios">
      <div class="ac-scenario-card" id="ac-card-cons">
        <div class="ac-sc-header">
          <span class="ac-sc-badge" style="background:var(--blue-faint);color:var(--blue);border-color:var(--blue);">Conservador</span>
          <span class="ac-sc-growth" id="ac-growth-cons">+3% preÃ§o/ano</span>
        </div>
        <div class="ac-sc-body">
          <div class="ac-sc-col">
            <div class="ac-sc-label">PatrimÃ´nio bruto</div>
            <div class="ac-sc-val" id="ac-fv-cons" style="color:var(--blue);">â€”</div>
          </div>
          <div class="ac-sc-col">
            <div class="ac-sc-label">No bolso (apÃ³s IR)</div>
            <div class="ac-sc-val-net" id="ac-net-cons">â€”</div>
          </div>
        </div>
        <div class="ac-sc-detail" id="ac-detail-cons"></div>
      </div>

      <div class="ac-scenario-card" id="ac-card-mod">
        <div class="ac-sc-header">
          <span class="ac-sc-badge" style="background:var(--violet-faint);color:var(--violet);border-color:var(--violet);">Moderado</span>
          <span class="ac-sc-growth" id="ac-growth-mod">+7% preÃ§o/ano</span>
        </div>
        <div class="ac-sc-body">
          <div class="ac-sc-col">
            <div class="ac-sc-label">PatrimÃ´nio bruto</div>
            <div class="ac-sc-val" id="ac-fv-mod" style="color:var(--violet);">â€”</div>
          </div>
          <div class="ac-sc-col">
            <div class="ac-sc-label">No bolso (apÃ³s IR)</div>
            <div class="ac-sc-val-net" id="ac-net-mod">â€”</div>
          </div>
        </div>
        <div class="ac-sc-detail" id="ac-detail-mod"></div>
      </div>

      <div class="ac-scenario-card rank-1" id="ac-card-otm">
        <div class="ac-sc-header">
          <span class="ac-sc-badge" style="background:var(--green-faint);color:var(--green);border-color:var(--green);">Otimista</span>
          <span class="ac-sc-growth" id="ac-growth-otm">+11% preÃ§o/ano</span>
        </div>
        <div class="ac-sc-body">
          <div class="ac-sc-col">
            <div class="ac-sc-label">PatrimÃ´nio bruto</div>
            <div class="ac-sc-val" id="ac-fv-otm" style="color:var(--green);">â€”</div>
          </div>
          <div class="ac-sc-col">
            <div class="ac-sc-label">No bolso (apÃ³s IR)</div>
            <div class="ac-sc-val-net" id="ac-net-otm">â€”</div>
          </div>
        </div>
        <div class="ac-sc-detail" id="ac-detail-otm"></div>
      </div>
    </div>

    <!-- IR note â€” full width below cards -->
    <div style="font-size:9px;color:var(--muted);line-height:1.7;padding:10px 20px;border-top:1px solid var(--border);background:var(--panel);">
      <strong style="color:var(--text);">IR sobre aÃ§Ãµes:</strong>
      Dividendos sÃ£o isentos de IR. Ganho de capital na venda: 15% para operaÃ§Ãµes comuns (atÃ© R$20k/mÃªs isentos),
      20% para day-trade. O cÃ¡lculo aqui aplica 15% apenas sobre o ganho de preÃ§o (valorizaÃ§Ã£o).
    </div>
  </div>

  <!-- DIVIDENDOS PROJETADOS -->
  <div class="ac-dividends-section">
    <div class="section-label" style="padding:0 40px;margin-bottom:0;padding-top:20px;">Renda de Dividendos Projetada (cenÃ¡rio moderado)</div>
    <div class="ac-div-grid" id="ac-div-grid"></div>
  </div>

</div><!-- /tab-acoes -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 4: REBALANCEAMENTO DE CARTEIRA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-rebalance" style="display:none;">

  <div class="header">
    <div class="header-eyebrow">Rebalanceamento de Carteira Â· AlocaÃ§Ã£o por Perfil</div>
    <h1>Como estÃ¡ sua <em>carteira?</em></h1>
    <p class="header-sub">
      Veja os trÃªs perfis de alocaÃ§Ã£o lado a lado. Informe quanto vocÃª tem em cada classe e descubra o que comprar para rebalancear. OpiniÃ£o pessoal: Se preocupe com isso quando tiver mais de 50 mil,
       antes disso nÃ£o vai valer a pena a dor de cabeÃ§a de diversificar tanto, desde que esteja investindo em empresas seguras.
    </p>
  </div>

  <!-- OPÃ‡Ã•ES DE CLASSES -->
  <div class="rb-options-bar">
    <span style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);">Incluir na carteira:</span>
    <label class="rb-opt-toggle">
      <input type="checkbox" id="rb-use-fii" checked onchange="rebuildProfiles()">
      <span class="rb-opt-box">
        <span class="rb-opt-dot" style="background:#f59e0b"></span>
        Fundos ImobiliÃ¡rios
      </span>
      <span class="rb-opt-sub">desativado â†’ % vai para AÃ§Ãµes</span>
    </label>
    <label class="rb-opt-toggle">
      <input type="checkbox" id="rb-use-prot" checked onchange="rebuildProfiles()">
      <span class="rb-opt-box">
        <span class="rb-opt-dot" style="background:#f87171"></span>
        ProteÃ§Ã£o (Ouro/DÃ³lar)
      </span>
      <span class="rb-opt-sub">desativado â†’ % vai para Renda Fixa</span>
    </label>
  </div>

  <!-- PERFIS SIDE BY SIDE -->
  <div class="rb-profiles-bar">
    <div class="rb-profile-header">
      <div class="rb-ph-empty"></div>
      <div class="rb-ph-label cons">ğŸ›¡ï¸ Conservador</div>
      <div class="rb-ph-label mod">âš–ï¸ Moderado</div>
      <div class="rb-ph-label arr">ğŸš€ Arrojado</div>
    </div>

    <!-- Renda Fixa -->
    <div class="rb-row" id="rbrow-rf">
      <div class="rb-row-label">
        <span class="rb-dot" style="background:#a78bfa"></span>
        Renda Fixa
        <span class="rb-row-sub">Tesouro, CDB, LCI/LCA</span>
      </div>
      <div class="rb-row-bar cons"><div class="rb-bar-fill" id="rbbar-rf-cons" style="background:#a78bfa"></div><span id="rbpct-rf-cons">75%</span></div>
      <div class="rb-row-bar mod"><div class="rb-bar-fill" id="rbbar-rf-mod" style="background:#a78bfa"></div><span id="rbpct-rf-mod">50%</span></div>
      <div class="rb-row-bar arr"><div class="rb-bar-fill" id="rbbar-rf-arr" style="background:#a78bfa"></div><span id="rbpct-rf-arr">20%</span></div>
    </div>

    <!-- AÃ§Ãµes -->
    <div class="rb-row" id="rbrow-ac">
      <div class="rb-row-label">
        <span class="rb-dot" style="background:#3dd68c"></span>
        AÃ§Ãµes
        <span class="rb-row-sub">AÃ§Ãµes BR, BDRs, ETFs</span>
      </div>
      <div class="rb-row-bar cons"><div class="rb-bar-fill" id="rbbar-ac-cons" style="background:#3dd68c"></div><span id="rbpct-ac-cons">10%</span></div>
      <div class="rb-row-bar mod"><div class="rb-bar-fill" id="rbbar-ac-mod" style="background:#3dd68c"></div><span id="rbpct-ac-mod">30%</span></div>
      <div class="rb-row-bar arr"><div class="rb-bar-fill" id="rbbar-ac-arr" style="background:#3dd68c"></div><span id="rbpct-ac-arr">55%</span></div>
    </div>

    <!-- FIIs (ocultÃ¡vel) -->
    <div class="rb-row" id="rbrow-fii">
      <div class="rb-row-label">
        <span class="rb-dot" style="background:#f59e0b"></span>
        Fundos ImobiliÃ¡rios
        <span class="rb-row-sub">FIIs listados em bolsa</span>
      </div>
      <div class="rb-row-bar cons"><div class="rb-bar-fill" id="rbbar-fii-cons" style="background:#f59e0b"></div><span id="rbpct-fii-cons">10%</span></div>
      <div class="rb-row-bar mod"><div class="rb-bar-fill" id="rbbar-fii-mod" style="background:#f59e0b"></div><span id="rbpct-fii-mod">15%</span></div>
      <div class="rb-row-bar arr"><div class="rb-bar-fill" id="rbbar-fii-arr" style="background:#f59e0b"></div><span id="rbpct-fii-arr">20%</span></div>
    </div>

    <!-- ProteÃ§Ã£o (ocultÃ¡vel) -->
    <div class="rb-row" id="rbrow-prot">
      <div class="rb-row-label">
        <span class="rb-dot" style="background:#f87171"></span>
        ProteÃ§Ã£o
        <span class="rb-row-sub">Ouro (GOLD11), DÃ³lar/BDR</span>
      </div>
      <div class="rb-row-bar cons"><div class="rb-bar-fill" id="rbbar-prot-cons" style="background:#f87171"></div><span id="rbpct-prot-cons">5%</span></div>
      <div class="rb-row-bar mod"><div class="rb-bar-fill" id="rbbar-prot-mod" style="background:#f87171"></div><span id="rbpct-prot-mod">5%</span></div>
      <div class="rb-row-bar arr"><div class="rb-bar-fill" id="rbbar-prot-arr" style="background:#f87171"></div><span id="rbpct-prot-arr">5%</span></div>
    </div>

    <!-- ReferÃªncia Ray Dalio -->
    <div class="rb-dalio-note">
      <strong>ReferÃªncia internacional: Ray Dalio (All Weather):</strong>
      30% AÃ§Ãµes Â· 55% Renda Fixa Â· 7,5% Ouro Â· 7,5% Commodities.
      EstratÃ©gia de "risco balanceado" voltada para preservaÃ§Ã£o com crescimento moderado.
      <a href="https://www.bridgewater.com" target="_blank" rel="noopener" style="color:var(--blue);text-decoration:none;">Bridgewater Associates â†—</a>
    </div>
  </div>

  <!-- MINHA CARTEIRA ATUAL -->
  <div class="inputs-section-label">Minha Carteira Atual</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Renda Fixa</label>
      <input type="number" id="rb-rf" value="0" min="0" step="100" oninput="calcRebalance()">
      <span class="input-note">R$ em Tesouro, CDB, LCIâ€¦</span>
    </div>
    <div class="input-group">
      <label>AÃ§Ãµes</label>
      <input type="number" id="rb-ac" value="0" min="0" step="100" oninput="calcRebalance()">
      <span class="input-note">R$ em aÃ§Ãµes e ETFs</span>
    </div>
    <div id="rb-fii-input-wrap" class="input-group">
      <label>Fundos ImobiliÃ¡rios</label>
      <input type="number" id="rb-fii" value="0" min="0" step="100" oninput="calcRebalance()">
      <span class="input-note">R$ em FIIs</span>
    </div>
    <div id="rb-prot-input-wrap" class="input-group">
      <label>ProteÃ§Ã£o (Ouro/DÃ³lar)</label>
      <input type="number" id="rb-prot" value="0" min="0" step="100" oninput="calcRebalance()">
      <span class="input-note">R$ em ouro, dÃ³lar, BDR</span>
    </div>
    <div class="input-group" style="background:var(--green-faint);border:1px solid var(--green);padding:12px 16px;">
      <label style="color:var(--green);">Total da Carteira</label>
      <div id="rb-total" style="font-family:'Fraunces',serif;font-size:26px;font-weight:700;color:var(--green);">R$ 0</div>
      <span class="input-note">soma automÃ¡tica</span>
    </div>
  </div>

  <!-- RESULTADO DO REBALANCEAMENTO -->
  <div id="rb-result-section" style="display:none;">
    <div class="inputs-section-label">DiagnÃ³stico Â· o que comprar para rebalancear</div>

    <!-- SELECTOR DE PERFIL -->
    <div style="padding:0 40px 16px;display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
      <span style="font-size:10px;letter-spacing:1px;text-transform:uppercase;color:var(--muted);">Perfil alvo:</span>
      <button class="rb-profile-btn active" id="rbp-cons" onclick="setRbProfile('cons')">ğŸ›¡ï¸ Conservador</button>
      <button class="rb-profile-btn" id="rbp-mod" onclick="setRbProfile('mod')">âš–ï¸ Moderado</button>
      <button class="rb-profile-btn" id="rbp-arr" onclick="setRbProfile('arr')">ğŸš€ Arrojado</button>
    </div>

    <div class="rb-diag-grid" id="rb-diag-grid"></div>

    <!-- DONUT -->
    <div class="rb-charts-row">
      <div class="rb-donut-area">
        <div class="rb-chart-title">SUA CARTEIRA ATUAL</div>
        <div class="rb-donut-wrap"><canvas id="rbCurrentDonut"></canvas></div>
      </div>
      <div class="rb-donut-area">
        <div class="rb-chart-title" id="rb-target-title">CARTEIRA ALVO: CONSERVADOR</div>
        <div class="rb-donut-wrap"><canvas id="rbTargetDonut"></canvas></div>
      </div>
    </div>
  </div>

  <!-- NOTA SOBRE RESERVA DE EMERGÃŠNCIA -->
  <div style="padding:20px 40px;border-top:1px solid var(--border);font-size:10px;color:var(--muted);line-height:1.7;background:var(--panel);">
    <strong style="color:var(--text);">âš  AtenÃ§Ã£o:</strong>
    Os valores acima sÃ£o a sua <em>carteira de investimentos</em>; nÃ£o inclua a reserva de emergÃªncia nesse cÃ¡lculo.
    A reserva de emergÃªncia (6â€“12 meses de gastos, em CDB ou Tesouro Selic com liquidez diÃ¡ria) deve estar separada e
    nÃ£o Ã© considerada parte da carteira de longo prazo. Use a aba <strong>Reserva de EmergÃªncia</strong> para calculÃ¡-la.
    Â· <strong>ProteÃ§Ã£o (Ouro/DÃ³lar)</strong> Ã© diferente de reserva de emergÃªncia: Ã© uma camada de proteÃ§Ã£o patrimonial contra crises e desvalorizaÃ§Ã£o cambial,
    com correlaÃ§Ã£o negativa Ã  bolsa. RecomendaÃ§Ã£o: ouro via ETF <strong>GOLD11</strong> ou fundos referenciados em ouro/dÃ³lar. AtenÃ§Ã£o Ã  inflaÃ§Ã£o norte-americana atual,
     ouro talvez deva ser considerado mais interessante.
  </div>

</div><!-- /tab-rebalance -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB 5: INDEPENDÃŠNCIA FINANCEIRA
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-fire" style="display:none;">

  <div class="header">
    <div class="header-eyebrow">IndependÃªncia Financeira Â· FIRE</div>
    <h1>Quando vocÃª pode <em>parar de trabalhar?</em></h1>
    <p class="header-sub">
      Calcule seu nÃºmero FIRE: o patrimÃ´nio necessÃ¡rio para viver de renda. Veja a curva de dividendos cruzando seus gastos.
    </p>
  </div>

  <!-- INPUTS -->
  <div class="inputs-section-label">Seus Dados</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>PatrimÃ´nio Atual</label>
      <input type="number" id="fi-patrimonio" value="10000" min="0" step="1000">
      <span class="input-note">R$ investido hoje</span>
    </div>
    <div class="input-group">
      <label>Aporte Mensal</label>
      <input type="number" id="fi-aporte" value="1000" min="0" step="100">
      <span class="input-note">R$ por mÃªs</span>
    </div>
    <div class="input-group">
      <label>Gasto Mensal Desejado</label>
      <input type="number" id="fi-gasto" value="2000" min="0" step="500">
      <span class="input-note">R$ de hoje (serÃ¡ corrigido pela inflaÃ§Ã£o)</span>
    </div>
    <div class="input-group">
      <label>DY Esperado da Carteira %</label>
      <input type="number" id="fi-dy" value="6.0" min="1" max="20" step="0.5">
      <span class="input-note">dividend yield anual mÃ©dio esperado</span>
    </div>
    <div class="input-group">
      <label>InflaÃ§Ã£o Anual % (IPCA)</label>
      <input type="number" id="fi-inflacao" value="4.4" min="0" max="20" step="0.5">
      <span class="input-note">para corrigir o gasto futuro. Considere os 12 Ãºltimos meses</span>
    </div>
    <div class="input-group">
      <label>Aporte cresce com inflaÃ§Ã£o?</label>
      <div class="toggle-wrap" style="margin-top:4px;">
        <label class="toggle-switch">
          <input type="checkbox" id="fi-aporte-inflacao" onchange="calcFire()">
          <div class="toggle-track"></div>
          <div class="toggle-thumb"></div>
        </label>
        <span class="toggle-label-text" id="fi-aporte-inflacao-label">NÃ£o</span>
      </div>
      <span class="input-note">ativado â†’ salÃ¡rio sobe com inflaÃ§Ã£o e aporte acompanha</span>
    </div>
  </div>

  <!-- IR BANNER -->
  <div class="fi-ir-banner">
    <div class="fi-ir-item fi-ir-green">
      <span class="fi-ir-icon">ğŸ“ˆ</span>
      <div>
        <div class="fi-ir-title">Dividendos de AÃ§Ãµes e FIIs Â· <strong>Isentos de IR</strong></div>
        <div class="fi-ir-desc">Pela Lei 9.249/95, dividendos distribuÃ­dos por empresas brasileiras nÃ£o sofrem tributaÃ§Ã£o, independentemente do valor. R$ 10 mil ou R$ 200 mil por mÃªs: zero imposto. O campo "DY" jÃ¡ representa o valor lÃ­quido que entra na sua conta.</div>
      </div>
    </div>
    <div class="fi-ir-item fi-ir-orange">
      <span class="fi-ir-icon">ğŸ¦</span>
      <div>
        <div class="fi-ir-title">Juros de Renda Fixa Â· <strong>IR retido na fonte</strong></div>
        <div class="fi-ir-desc">CDB, Tesouro Direto e similares tÃªm IR regressivo: 22,5% (atÃ© 180 dias), 20% (atÃ© 360 dias), 17,5% (atÃ© 720 dias) e 15% (acima de 720 dias). A tabela comparativa usa a taxa que vocÃª informar como lÃ­quida, certifique-se de descontar o IR antes de digitar. Ex: CDB a 13% bruto por mais de 2 anos â‰ˆ 11% lÃ­quido.</div>
      </div>
    </div>
  </div>

  <!-- ARMADILHA DA INFLAÃ‡ÃƒO â€” PRIMEIRO, PARA NÃƒO PASSAR DESPERCEBIDO -->
  <div class="inputs-section-label">A Armadilha da InflaÃ§Ã£o Â· Por que aÃ§Ãµes precisam de mais capital mas sÃ£o melhores no longo prazo</div>

  <div class="fi-trap-intro">
    Renda fixa a <strong id="trap-rf-rate-label">11%</strong> parece precisar de menos patrimÃ´nio que aÃ§Ãµes com DY de <strong id="trap-dy-label">7%</strong>.
    Mas essa comparaÃ§Ã£o Ã© uma <strong style="color:var(--orange);">foto de hoje</strong>, nÃ£o um filme de 20 anos.
    <br><br>
    A tabela abaixo simula a <strong>fase de aposentadoria</strong>: vocÃª jÃ¡ chegou na meta, parou de aportar e vive da renda. Na perpetuidade, vocÃª retira 100% dos juros/dividendo todo mÃªs para cobrir seus gastos,
     entÃ£o nada Ã© reinvestido e o principal da Renda Fixa fica estagnado. Nas aÃ§Ãµes, o preÃ§o das empresas cresce independentemente dos dividendos retirados, fazendo o patrimÃ´nio aumentar.
    <span class="fi-trap-rf-input-wrap">
      Renda Fixa comparativa: <input type="number" id="trap-rf-taxa" value="11.0" min="1" max="25" step="0.5" oninput="calcFire()"> % lÃ­quido
    </span>
  </div>

  <div class="fi-trap-grid">
    <div class="fi-trap-head fi-trap-blank"></div>
    <div class="fi-trap-head fi-trap-head-rv">ğŸ“ˆ AÃ§Ãµes e FIIs<span>DY <span id="trap-head-dy">7%</span> + valorizaÃ§Ã£o</span></div>
    <div class="fi-trap-head fi-trap-head-rf">ğŸ¦ Renda Fixa<span>Taxa lÃ­quida <span id="trap-head-rf">11%</span></span></div>

    <div class="fi-trap-row-label">PatrimÃ´nio necessÃ¡rio <em>hoje</em></div>
    <div class="fi-trap-cell fi-trap-cell-rv" id="trap-pat-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf" id="trap-pat-rf">...</div>

    <div class="fi-trap-row-label">Renda mensal <em>hoje</em></div>
    <div class="fi-trap-cell fi-trap-cell-rv" id="trap-renda-hoje-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf" id="trap-renda-hoje-rf">...</div>

    <div class="fi-trap-row-label">PatrimÃ´nio em <em>20 anos</em> <small>(cenÃ¡rio moderado)</small></div>
    <div class="fi-trap-cell fi-trap-cell-rv fi-trap-highlight" id="trap-pat20-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf" id="trap-pat20-rf">...</div>

    <div class="fi-trap-row-label">Renda mensal em <em>20 anos</em> <small>(nominal)</small></div>
    <div class="fi-trap-cell fi-trap-cell-rv fi-trap-highlight" id="trap-renda20-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf" id="trap-renda20-rf">...</div>

    <div class="fi-trap-row-label">Poder de compra em <em>20 anos</em> <small>(em R$ de hoje)</small></div>
    <div class="fi-trap-cell fi-trap-cell-rv fi-trap-highlight" id="trap-real20-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf fi-trap-danger" id="trap-real20-rf">...</div>

    <div class="fi-trap-row-label">Seu gasto em <em>20 anos</em> <small>(corrigido pelo IPCA)</small></div>
    <div class="fi-trap-cell fi-trap-span fi-trap-gasto20" id="trap-gasto20">...</div>
    <div class="fi-trap-cell" style="display:none;"></div>

    <div class="fi-trap-row-label fi-trap-verdict-label">Cobre seus gastos em 20 anos?</div>
    <div class="fi-trap-cell fi-trap-cell-rv fi-trap-verdict" id="trap-verdict-rv">...</div>
    <div class="fi-trap-cell fi-trap-cell-rf fi-trap-verdict" id="trap-verdict-rf">...</div>
  </div>

  <div class="fi-trap-footnote" id="fi-trap-footnote"></div>

  <!-- SEÃ‡ÃƒO 1: NÃšMERO FIRE -->
  <div class="inputs-section-label">SeÃ§Ã£o 1 Â· Quanto preciso acumular?</div>

  <div class="fi-methods-bar">
    <div class="fi-method-card">
      <div class="fi-method-title" style="color:var(--green);">ğŸŒ± Pelo DY (Perpetuidade)</div>
      <div class="fi-method-desc">
        Vive <strong>sÃ³ dos dividendos</strong> sem tocar no principal.<br>
        FÃ³rmula: <code>Meta = Gasto anual Ã· DY</code><br>
        Mais conservador e adequado ao modelo brasileiro. O patrimÃ´nio Ã© preservado para sempre.
      </div>
    </div>
    <div class="fi-method-card">
      <div class="fi-method-title" style="color:var(--blue);">ğŸ“ Regra dos 4% (Estudo Trinity)</div>
      <div class="fi-method-desc">
        Retira 4% do patrimÃ´nio por ano, inclui <strong>venda parcial de ativos</strong>.<br>
        FÃ³rmula: <code>Meta = Gasto anual Ã· 0,04 = Gasto Ã— 300</code><br>
        Modelo americano. Estatisticamente sustentÃ¡vel por 30 anos ou mais.
      </div>
    </div>
  </div>

  <div class="fi-meta-grid">
    <div class="fi-meta-card" id="fi-card-dy">
      <div class="fi-meta-badge" style="color:var(--green);border-color:var(--green);background:var(--green-faint);">Pelo DY Â· Perpetuidade</div>
      <div class="fi-meta-label">Meta patrimonial</div>
      <div class="fi-meta-val" id="fi-meta-dy" style="color:var(--green);">...</div>
      <div class="fi-meta-sub" id="fi-meta-dy-sub"></div>
      <div class="fi-meta-falta-label">Falta acumular</div>
      <div class="fi-meta-falta" id="fi-falta-dy">...</div>
      <div class="fi-tempos" id="fi-tempos-dy"></div>
    </div>
    <div class="fi-meta-card" id="fi-card-4pct">
      <div class="fi-meta-badge" style="color:var(--blue);border-color:var(--blue);background:var(--blue-faint);">Regra dos 4%</div>
      <div class="fi-meta-label">Meta patrimonial</div>
      <div class="fi-meta-val" id="fi-meta-4pct" style="color:var(--blue);">...</div>
      <div class="fi-meta-sub" id="fi-meta-4pct-sub"></div>
      <div class="fi-meta-falta-label">Falta acumular</div>
      <div class="fi-meta-falta" id="fi-falta-4pct">...</div>
      <div class="fi-tempos" id="fi-tempos-4pct"></div>
    </div>
  </div>

  <div class="fi-nota">
    <strong>Fase de acumulaÃ§Ã£o vs fase de retirada:</strong>
    O portfÃ³lio cresce pelo <em>total return</em> (valorizaÃ§Ã£o de preÃ§o + DY reinvestido) durante a acumulaÃ§Ã£o.
    Na aposentadoria pelo mÃ©todo do DY, vocÃª vive apenas dos dividendos sem vender aÃ§Ãµes, preservando o principal.
    Pelo mÃ©todo dos 4%, vocÃª retira 4% ao ano do patrimÃ´nio, o que inclui venda gradual de ativos.
    Os trÃªs cenÃ¡rios (conservador, moderado, otimista) refletem taxas de valorizaÃ§Ã£o de preÃ§o de +3%, +7% e +11% ao ano.
    <strong>Sobre IR:</strong> dividendos de aÃ§Ãµes e FIIs sÃ£o isentos de IR. O DY informado jÃ¡ Ã© o valor lÃ­quido. Para a Renda Fixa comparativa, informe sempre a taxa jÃ¡ descontado o imposto.
  </div>

  <!-- SEÃ‡ÃƒO 2: CURVA DA LIBERDADE -->
  <div class="inputs-section-label" style="margin-top:0;">SeÃ§Ã£o 2 Â· Curva da Liberdade Â· Quando os dividendos cobrem seus gastos?</div>

  <div class="fi-chart-area">
    <div class="fi-chart-controls">
      <label class="fi-toggle-inflation">
        <input type="checkbox" id="fi-ajusta-inflacao" checked onchange="calcFire()">
        <span>Gasto corrigido pela inflaÃ§Ã£o</span>
      </label>
      <span class="fi-ctrl-note">quando ativado, a linha de gastos cresce <span id="fi-inflacao-label">4%</span>/ano</span>
    </div>
    <div class="fi-crossing-badges" id="fi-crossing-badges"></div>
    <div class="fi-main-chart-wrap"><canvas id="fireChart"></canvas></div>
    <div class="legend-grid" id="fi-legend"></div>
  </div>

  <div class="fi-evolution-section">
    <div class="section-label" style="padding:20px 40px 14px;">EvoluÃ§Ã£o da Renda de Dividendos Â· CenÃ¡rio Moderado</div>
    <div class="fi-evo-grid" id="fi-evo-grid"></div>
  </div>

</div><!-- /tab-fire -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB: META PATRIMONIAL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-meta" style="display:none;">

  <div class="header" id="tab-meta-header">
    <div class="header-eyebrow">Planejamento Â· Meta Patrimonial</div>
    <h1>Quanto preciso <em>aportar?</em></h1>
    <p class="header-sub">Defina sua meta e descubra o aporte mensal necessÃ¡rio, ou quanto tempo levarÃ¡ com o que vocÃª jÃ¡ contribui.</p>
  </div>

  <div class="inputs-section-label">Seus Dados</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Meta (valor alvo)</label>
      <input type="number" id="meta-alvo" value="1000000" min="1000" step="50000" oninput="calcMeta()">
      <span class="input-note">R$ que deseja acumular</span>
    </div>
    <div class="input-group">
      <label>PatrimÃ´nio Atual</label>
      <input type="number" id="meta-atual" value="10000" min="0" step="1000" oninput="calcMeta()">
      <span class="input-note">R$ jÃ¡ investido hoje</span>
    </div>
    <div class="input-group">
      <label>Prazo (anos)</label>
      <input type="number" id="meta-prazo" value="15" min="1" max="50" step="1" oninput="calcMeta()">
      <span class="input-note">horizonte de tempo desejado</span>
    </div>
    <div class="input-group">
      <label>Rentabilidade % a.a.</label>
      <input type="number" id="meta-taxa" value="11.0" min="0.1" max="30" step="0.5" oninput="calcMeta()">
      <span class="input-note">retorno anual jÃ¡ lÃ­quido de IR</span>
    </div>
    <div class="input-group">
      <label>InflaÃ§Ã£o % a.a. (IPCA)</label>
      <input type="number" id="meta-inflacao" value="4.4" min="0" max="20" step="0.5" oninput="calcMeta()">
      <span class="input-note">para mostrar o valor real futuro</span>
    </div>
    <div class="input-group">
      <label>Aporte atual /mÃªs</label>
      <input type="number" id="meta-aporte-input" value="1000" min="0" step="100" oninput="calcMeta()">
      <span class="input-note">para calcular prazo alternativo</span>
    </div>
  </div>

  <!-- RESULTADOS PRINCIPAIS -->
  <div class="meta-results-grid">
    <div class="meta-result-card meta-card-primary">
      <div class="meta-result-eyebrow">Aporte mensal necessÃ¡rio</div>
      <div class="meta-result-val" id="meta-aporte-necessario" style="color:var(--green);">...</div>
      <div class="meta-result-sub" id="meta-aporte-sub">para atingir a meta no prazo</div>
    </div>
    <div class="meta-result-card">
      <div class="meta-result-eyebrow">Prazo com aporte atual</div>
      <div class="meta-result-val" id="meta-prazo-atual" style="color:var(--blue);">...</div>
      <div class="meta-result-sub" id="meta-prazo-sub">com o aporte informado</div>
    </div>
    <div class="meta-result-card">
      <div class="meta-result-eyebrow">Total que vocÃª vai aportar</div>
      <div class="meta-result-val" id="meta-total-aportado" style="color:var(--muted);">...</div>
      <div class="meta-result-sub" id="meta-total-sub">capital investido no perÃ­odo</div>
    </div>
    <div class="meta-result-card">
      <div class="meta-result-eyebrow">Gerado pelos juros compostos</div>
      <div class="meta-result-val" id="meta-juros" style="color:var(--yellow);">...</div>
      <div class="meta-result-sub" id="meta-juros-pct">o dinheiro trabalhando por vocÃª</div>
    </div>
    <div class="meta-result-card">
      <div class="meta-result-eyebrow">Valor real em poder de compra</div>
      <div class="meta-result-val" id="meta-valor-real" style="color:var(--muted);">...</div>
      <div class="meta-result-sub" id="meta-real-sub">equivalente em R$ de hoje</div>
    </div>
  </div>

  <div class="fi-nota" style="border-top:1px solid var(--border);">
    <strong>Como interpretar:</strong>
    O aporte necessÃ¡rio usa juros compostos mensais para atingir exatamente a meta no prazo.
    A rentabilidade deve ser informada jÃ¡ lÃ­quida de impostos. Para CDB e Tesouro Direto, desconte o IR antes de informar.
    Dividendos de aÃ§Ãµes e FIIs sÃ£o isentos de IR e podem ser usados diretamente.
    O valor real desconta a inflaÃ§Ã£o acumulada no perÃ­odo, mostrando o poder de compra equivalente em reais de hoje.
  </div>

  <!-- CENÃRIOS COMPARATIVOS -->
  <div class="inputs-section-label">Comparativo de Taxas de Retorno</div>
  <div class="meta-scenarios-grid" id="meta-scenarios-grid"></div>

  <!-- GRÃFICO CENTRALIZADO -->
  <div class="meta-chart-section">
    <div class="section-label" style="width:100%;max-width:820px;">EvoluÃ§Ã£o Patrimonial ao longo do prazo</div>
    <div class="meta-chart-wrap"><canvas id="metaChart"></canvas></div>
    <div class="legend-grid" id="meta-legend" style="width:100%;max-width:820px;margin-top:10px;"></div>
  </div>

  <!-- MARCOS DE PROGRESSO -->
  <div class="inputs-section-label" style="margin-top:0;">Marcos ao longo do caminho</div>
  <div class="meta-milestones" id="meta-milestones"></div>

</div><!-- /tab-meta -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     TAB: PREÃ‡O JUSTO
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="tab-preco" style="display:none;">

  <div class="header" id="tab-preco-header">
    <div class="header-eyebrow">AnÃ¡lise Fundamentalista Â· PreÃ§o Justo</div>
    <h1>A aÃ§Ã£o estÃ¡ <em>cara ou barata?</em></h1>
    <p class="header-sub">TrÃªs mÃ©todos clÃ¡ssicos para estimar o valor intrÃ­nseco de uma aÃ§Ã£o. Insira os dados e compare com o preÃ§o atual.</p>
  </div>

  <div class="inputs-section-label">Dados da Empresa</div>
  <div class="inputs-bar">
    <div class="input-group">
      <label>Ticker</label>
      <input type="text" id="pj-ticker" value="ITUB4" maxlength="8" oninput="this.value=this.value.toUpperCase();calcPreco()">
      <span class="input-note">cÃ³digo da aÃ§Ã£o (ex: PETR4)</span>
    </div>
    <div class="input-group">
      <label>PreÃ§o Atual (R$)</label>
      <input type="number" id="pj-preco" value="26.93" min="0.01" step="0.01" oninput="calcPreco()">
      <span class="input-note">cotaÃ§Ã£o atual</span>
    </div>
    <div class="input-group">
      <label>LPA (R$)</label>
      <input type="number" id="pj-lpa" value="2.24" min="0" step="0.01" oninput="calcPreco()">
      <span class="input-note">Lucro por AÃ§Ã£o dos Ãºltimos 12 meses</span>
    </div>
    <div class="input-group">
      <label>VPA (R$)</label>
      <input type="number" id="pj-vpa" value="31.78" min="0" step="0.01" oninput="calcPreco()">
      <span class="input-note">Valor Patrimonial por AÃ§Ã£o</span>
    </div>
    <div class="input-group" style="min-width:340px;">
      <label>DPA Â· Dividendo Por AÃ§Ã£o (R$)</label>
      <input type="number" id="pj-dpa" value="1.20" min="0" step="0.01" oninput="calcPreco()">
      <span class="input-note">soma dos dividendos pagos por aÃ§Ã£o no Ãºltimo exercÃ­cio fiscal jÃ¡ publicado (em R$, nÃ£o em %)</span>
      <div class="pj-dpa-tip">
        <strong>Qual exercÃ­cio usar?</strong> Empresas brasileiras entregam o balanÃ§o anual Ã  CVM atÃ© marÃ§o ou abril do ano seguinte.
        Antes disso, o ano mais recente ainda nÃ£o estÃ¡ auditado e publicado.
        <br>Exemplo: em fevereiro de 2026, use o DPA de 2024 (nÃ£o o de 2025, que ainda nÃ£o foi publicado).
        <br>Como conferir: acesse o site de RI da empresa, o <strong>Investidor10</strong> ou o <strong>Status Invest</strong> e veja qual Ã© o Ãºltimo ano com dados completos de dividendos.
        O DPA aparece como "Proventos por AÃ§Ã£o" ou "Dividendos por AÃ§Ã£o" no histÃ³rico anual.
      </div>
    </div>
  </div>

  <!-- AVISO SETORIAL -->
  <div class="pj-sector-warning" id="pj-sector-warning" style="display:none;"></div>

  <!-- 3 MÃ‰TODOS -->
  <div class="pj-methods-grid">

    <div class="pj-method-card" id="pj-card-bazin">
      <div class="pj-method-header">
        <div class="pj-method-title">ğŸŒ¿ DÃ©cio Bazin</div>
        <div class="pj-method-formula-tag">Dividendo anual Ã· 0,06</div>
      </div>
      <div class="pj-method-desc">Bazin definia que uma aÃ§Ã£o sÃ³ Ã© barata se o DY for de pelo menos 6% ao ano. O preÃ§o justo Ã© calculado dividindo o dividendo real pago por aÃ§Ã£o (DPA, em R$) por 0,06. O DPA Ã© independente do preÃ§o de mercado, evitando referÃªncia circular.</div>
      <div class="pj-result-row">
        <div class="pj-result-block">
          <div class="pj-result-label">PreÃ§o justo</div>
          <div class="pj-result-val" id="pj-bazin-val">...</div>
        </div>
        <div class="pj-result-block">
          <div class="pj-result-label">Margem</div>
          <div class="pj-margem" id="pj-bazin-margem">...</div>
        </div>
        <div class="pj-result-block">
          <div class="pj-result-label">Veredito</div>
          <div class="pj-veredicto" id="pj-bazin-veredicto">...</div>
        </div>
      </div>
    </div>

    <div class="pj-method-card" id="pj-card-graham">
      <div class="pj-method-header">
        <div class="pj-method-title">ğŸ“ Benjamin Graham</div>
        <div class="pj-method-formula-tag">âˆš(22,5 Ã— LPA Ã— VPA)</div>
      </div>
      <div class="pj-method-desc">Graham combinava P/L mÃ¡ximo de 15 com P/VP mÃ¡ximo de 1,5. O produto 15 Ã— 1,5 = 22,5 dÃ¡ origem Ã  fÃ³rmula. Funciona melhor para empresas maduras com lucros estÃ¡veis.</div>
      <div class="pj-result-row">
        <div class="pj-result-block">
          <div class="pj-result-label">PreÃ§o justo</div>
          <div class="pj-result-val" id="pj-graham-val">...</div>
        </div>
        <div class="pj-result-block">
          <div class="pj-result-label">Margem</div>
          <div class="pj-margem" id="pj-graham-margem">...</div>
        </div>
        <div class="pj-result-block">
          <div class="pj-result-label">Veredito</div>
          <div class="pj-veredicto" id="pj-graham-veredicto">...</div>
        </div>
      </div>
    </div>

  </div>

  <!-- CONSENSO -->
  <div class="pj-consenso-bar">
    <div class="pj-consenso-inner">
      <div class="pj-consenso-block">
        <div class="pj-consenso-label">MÃ©dia dos 2 mÃ©todos</div>
        <div class="pj-consenso-val" id="pj-media">...</div>
      </div>
      <div class="pj-consenso-block">
        <div class="pj-consenso-label">PreÃ§o atual</div>
        <div class="pj-consenso-val" id="pj-preco-atual-display">...</div>
      </div>
      <div class="pj-consenso-block">
        <div class="pj-consenso-label">Upside potencial</div>
        <div class="pj-consenso-val" id="pj-upside">...</div>
      </div>
      <div class="pj-consenso-block">
        <div class="pj-consenso-label">Consenso geral</div>
        <div class="pj-consenso-val" id="pj-consenso-geral">...</div>
      </div>
    </div>
  </div>

  <!-- INDICADORES CALCULADOS -->
  <div class="inputs-section-label" style="margin-top:0;">Indicadores calculados</div>
  <div class="pj-indicators-grid" id="pj-indicators"></div>

  <div class="fi-nota">
    <strong>LimitaÃ§Ãµes importantes:</strong>
    Cada mÃ©todo tem premissas diferentes. Bazin Ã© ideal para pagadoras consistentes de dividendos.
    Graham funciona melhor para empresas com lucros previsÃ­veis e lucros positivos.
    Nenhum modelo substitui uma anÃ¡lise completa. Use como ponto de partida e nÃ£o como decisÃ£o de investimento.
    <strong>Este conteÃºdo nÃ£o Ã© recomendaÃ§Ã£o de compra ou venda de ativos.</strong>
  </div>

  <div class="pj-print-bar">
    <button class="pj-print-btn" onclick="printPreco()">â¬‡ Salvar relatÃ³rio como PDF</button>
    <span class="pj-print-hint">Abre a janela de impressÃ£o do navegador. Escolha "Salvar como PDF" no destino.</span>
  </div>

</div><!-- /tab-preco -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     FOOTER LEGAL (compartilhado)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<footer class="footer-legal">
  <div class="footer-legal-main">
    <div class="footer-legal-block">
      <h4>âš  IsenÃ§Ã£o de Responsabilidade</h4>
      <p>As simulaÃ§Ãµes apresentadas neste site tÃªm carÃ¡ter exclusivamente educacional e informativo. Os resultados sÃ£o estimativas baseadas em premissas matemÃ¡ticas e nÃ£o constituem recomendaÃ§Ã£o de investimento, consultoria financeira ou garantia de rentabilidade. Rentabilidade passada nÃ£o Ã© garantia de rentabilidade futura. O autor nÃ£o se responsabiliza por decisÃµes financeiras tomadas com base nas informaÃ§Ãµes aqui apresentadas. Consulte sempre um profissional certificado (CFPÂ® / CNPI) antes de investir.</p>
    </div>
    <div class="footer-legal-block">
      <h4>Â© Direitos Autorais e Propriedade Intelectual</h4>
      <p>Todo o conteÃºdo deste site (incluindo cÃ³digo-fonte, design, interface, textos e lÃ³gica de cÃ¡lculo) Ã© de propriedade exclusiva de <strong>Raoni Queiroz</strong> e estÃ¡ protegido pela Lei nÂº 9.610/1998 (Lei de Direitos Autorais) e pela legislaÃ§Ã£o de propriedade intelectual brasileira. Ã‰ expressamente proibida a cÃ³pia, reproduÃ§Ã£o, distribuiÃ§Ã£o ou uso comercial de qualquer parte deste material sem autorizaÃ§Ã£o prÃ©via e por escrito. ViolaÃ§Ãµes estÃ£o sujeitas Ã s penalidades civis e criminais previstas em lei.</p>
    </div>
  </div>
  <div class="footer-bottom">
    <span class="footer-copy">Â© 2026 <strong>Raoni Queiroz</strong> Â· Todos os direitos reservados.</span>
    <span class="footer-copy">SimulaÃ§Ã£o educacional, nÃ£o Ã© recomendaÃ§Ã£o de investimento Â· fev/2026</span>
  </div>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ESTADO GLOBAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeMonths = 120;
let chart = null;
let resDonutChart = null;
let resLineChart = null;
let hiddenSeries = new Set();
let reinvestDivs = true;
let cdbIRpct = 15;
let lciMode = 'pre';
let cdbMode = 'pre';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// HAMBURGER MENU
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const TABS = {
  simulador:  { label: 'Simulador de Investimentos' },
  reserva:    { label: 'Reserva de EmergÃªncia' },
  acoes:      { label: 'Calculadora de AÃ§Ãµes' },
  rebalance:  { label: 'Rebalanceamento de Carteira' },
  fire:       { label: 'IndependÃªncia Financeira' },
  meta:       { label: 'Meta Patrimonial' },
  preco:      { label: 'PreÃ§o Justo' }
};

function toggleMenu() {
  const btn      = document.getElementById('hamburgerBtn');
  const dropdown = document.getElementById('navDropdown');
  const isOpen   = dropdown.classList.contains('open');
  dropdown.classList.toggle('open', !isOpen);
  btn.classList.toggle('open', !isOpen);
}

// Close menu when clicking outside
document.addEventListener('click', e => {
  if (!e.target.closest('#hamburgerBtn') && !e.target.closest('#navDropdown')) {
    document.getElementById('navDropdown').classList.remove('open');
    document.getElementById('hamburgerBtn').classList.remove('open');
  }
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// TAB NAVIGATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showTab(tab) {
  document.getElementById('tab-simulador').style.display  = tab === 'simulador'  ? '' : 'none';
  document.getElementById('tab-reserva').style.display    = tab === 'reserva'    ? '' : 'none';
  document.getElementById('tab-acoes').style.display      = tab === 'acoes'      ? '' : 'none';
  document.getElementById('tab-rebalance').style.display  = tab === 'rebalance'  ? '' : 'none';
  document.getElementById('tab-fire').style.display       = tab === 'fire'       ? '' : 'none';
  document.getElementById('tab-meta').style.display       = tab === 'meta'       ? '' : 'none';
  document.getElementById('tab-preco').style.display      = tab === 'preco'      ? '' : 'none';

  Object.keys(TABS).forEach(key => {
    document.getElementById('menu-'+key).classList.toggle('active', key === tab);
  });

  document.getElementById('navActiveLabel').textContent = TABS[tab]?.label || '';
  document.getElementById('navDropdown').classList.remove('open');
  document.getElementById('hamburgerBtn').classList.remove('open');

  if (tab === 'reserva')   calcReserva();
  if (tab === 'simulador') buildAll();
  if (tab === 'acoes')     calcAcoes();
  if (tab === 'rebalance') calcRebalance();
  if (tab === 'fire')      calcFire();
  if (tab === 'meta')      calcMeta();
  if (tab === 'preco')     calcPreco();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// THEME
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let currentTheme = 'light';
function applyTheme(theme) {
  currentTheme = theme;
  document.documentElement.setAttribute('data-theme', theme);
  document.getElementById('themeIcon').textContent  = theme === 'light' ? 'â˜¾' : 'â˜€ï¸';
  document.getElementById('themeLabel').textContent = theme === 'light' ? 'Tema escuro' : 'Tema claro';
  buildAll();
  calcReserva();
}
function toggleTheme() { applyTheme(currentTheme === 'dark' ? 'light' : 'dark'); }

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INVESTMENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const INVESTMENTS = [
  { id:'tesouro', name:'Tesouro IPCA+ (configurÃ¡vel)', shortName:'Tesouro IPCA+', type:'tesouro',
    color:'#3dd68c', risk:'Muito Baixo', riskClass:'pos', note:'Garantia soberana Â· IR 15% sÃ³ no resgate Â· trava 20+ anos' },
  { id:'lci', name:'LCI/LCA (configurÃ¡vel)', shortName:'LCI/LCA', type:'lci',
    color:'#f5c518', risk:'Baixo*', riskClass:'warn', note:'taxa e IR ajustÃ¡veis Â· renovaÃ§Ã£o periÃ³dica Â· sem come-cotas' },
  { id:'cdb', name:'CDB (configurÃ¡vel)', shortName:'CDB', type:'cdb',
    color:'#2dd4bf', risk:'Baixo', riskClass:'pos', note:'IR regressivo Â· rende bruto atÃ© resgate Â· FGC R$250k/inst.' },
  { id:'acoes_cons', name:'AÃ§Ãµes Conservador', shortName:'AÃ§Ãµes Conserv.', type:'stock', priceGrowth:0.03,
    color:'#5b9cf6', risk:'MÃ©dio-Alto', riskClass:'risk', note:'DY + valoriz. 3%/ano (ciclo fraco)' },
  { id:'acoes_mod', name:'AÃ§Ãµes Moderado (ITUB4)', shortName:'AÃ§Ãµes Moder.', type:'stock', priceGrowth:0.07,
    color:'#a88bfa', risk:'Alto', riskClass:'risk', note:'DY + valoriz. 7%/ano (histÃ³rico mÃ©dio)' },
  { id:'acoes_otm', name:'AÃ§Ãµes Otimista (ITUB4 bull)', shortName:'AÃ§Ãµes Otim.', type:'stock', priceGrowth:0.11,
    color:'#f26065', risk:'Alto', riskClass:'risk', note:'DY + valoriz. 11%/ano (melhor histÃ³rico)' }
];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PARAMS (simulador)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getParams() {
  const selic   = parseFloat(document.getElementById('selic').value)       || 15.0;
  const cdi     = Math.max(selic - 0.10, 0); // CDI â‰ˆ Selic - 0,10% (spread histÃ³rico interbancÃ¡rio)
  const tesReal = parseFloat(document.getElementById('tesouRoReal').value) || 7.21;
  const lciRaw  = parseFloat(document.getElementById('lciRate').value)     || 14.0;
  const cdbRaw  = parseFloat(document.getElementById('cdbRate').value)     || 13.5;
  const lciGross = lciMode === 'pos' ? (lciRaw / 100) * cdi : lciRaw;
  const cdbGross = cdbMode === 'pos' ? (cdbRaw / 100) * cdi : cdbRaw;
  return {
    inicial: parseFloat(document.getElementById('inicial').value) || 10000,
    aporte:  parseFloat(document.getElementById('aporte').value)  || 1000,
    selic, cdi, tesReal,
    ipca:    parseFloat(document.getElementById('ipca').value)    || 4.0,
    dy:      parseFloat(document.getElementById('dy').value)      || 6.0,
    lciGross, lciIR: parseFloat(document.getElementById('lciIR').value) || 0,
    cdbGross, cdbIR: cdbIRpct
  };
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RATES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Gross rate: what actually compounds in the account (no IR deducted)
function grossRate(inv, p) {
  switch(inv.type) {
    case 'tesouro': return (1 + p.tesReal/100) * (1 + p.ipca/100) - 1;  // nominal bruto
    case 'lci':     return p.lciGross / 100;
    case 'cdb':     return p.cdbGross / 100;
    case 'stock':
      if (reinvestDivs) return (1 + p.dy/100) * (1 + inv.priceGrowth) - 1;
      return inv.priceGrowth;
    default: return 0;
  }
}

// IR rate on gains at redemption
function irRate(inv, p) {
  switch(inv.type) {
    case 'tesouro': return 0.15;
    case 'lci':     return p.lciIR / 100;
    case 'cdb':     return p.cdbIR / 100;
    case 'stock':   return 0.15;   // ganho de capital (aproximado sobre parcela de preÃ§o)
    default: return 0;
  }
}

// Display rate label: always gross, clearly labeled
function displayRate(inv, p) {
  return grossRate(inv, p) * 100;  // always gross, IR shown separately in "no bolso"
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// SIMULATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Compound at GROSS rate (correct: IR only at redemption)
// simFixed: keeps full float precision throughout; rounds only for display
// Push at every complete year (m % 12 === 0), and also at months if not a year boundary
function simFixed(annualRate, inicial, aporte, months) {
  const r = Math.pow(1 + annualRate, 1/12) - 1;
  const out = [];
  let bal = inicial;
  for (let m = 1; m <= months; m++) {
    bal = bal * (1 + r) + aporte;
    if (m % 12 === 0) out.push(bal);
  }
  // If months isn't a multiple of 12, push the partial-year value
  if (months % 12 !== 0) out.push(bal);
  return out;
}

// Stock WITHOUT reinvestment, float precision, round only at display
function simStockNoReinvest(dyRate, priceGrowth, inicial, aporte, months) {
  const rPrice = Math.pow(1 + priceGrowth, 1/12) - 1;
  const rDY    = Math.pow(1 + dyRate, 1/12) - 1;
  const out = [];
  let stock = inicial, cashDivs = 0;
  for (let m = 1; m <= months; m++) {
    cashDivs += stock * rDY;
    stock = stock * (1 + rPrice) + aporte;
    if (m % 12 === 0) out.push(stock + cashDivs);
  }
  if (months % 12 !== 0) out.push(stock + cashDivs);
  return out;
}

// Get series: ALL fixed income uses grossRate now (IR at redemption, not every year)
function getSeriesData(inv, p, months) {
  if (inv.type === 'stock') {
    if (reinvestDivs) return simFixed((1+p.dy/100)*(1+inv.priceGrowth)-1, p.inicial, p.aporte, months);
    return simStockNoReinvest(p.dy/100, inv.priceGrowth, p.inicial, p.aporte, months);
  }
  // Fixed income: always compound at gross rate, IR only at final redemption
  return simFixed(grossRate(inv, p), p.inicial, p.aporte, months);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMAT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function fmtBRL(v) {
  if (v >= 1e6) return 'R$ '+(v/1e6).toFixed(2).replace('.',',')+' mi';
  if (v >= 1e3) return 'R$ '+(v/1e3).toFixed(0)+' mil';
  return 'R$ '+Math.round(v);
}
function fmtFV(v) {
  if (v >= 1e6) return (v/1e6).toFixed(2).replace('.',',')+' mi';
  return (v/1e3).toFixed(0)+'k';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UPDATE HINTS & HEADER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function updateRateHints() {
  const selic   = parseFloat(document.getElementById('selic').value)   || 15.0;
  const cdi     = Math.max(selic - 0.10, 0);
  const tesReal = parseFloat(document.getElementById('tesouRoReal').value) || 7.21;
  const lciRaw  = parseFloat(document.getElementById('lciRate').value)  || 14.0;
  const cdbRaw  = parseFloat(document.getElementById('cdbRate').value)  || 13.5;
  const el = document.getElementById('caveatTesRate');
  if (el) el.textContent = tesReal.toFixed(2).replace('.',',')+'%';
  const lciNote = document.getElementById('lciRateNote');
  const lciRes  = document.getElementById('lciResult');
  if (lciMode === 'pos') {
    lciNote.textContent = '% do CDI';
    lciRes.style.display = 'block';
    lciRes.textContent = `= ${((lciRaw/100)*cdi).toFixed(2)}% bruto a.a. (CDI ${cdi.toFixed(2)}% Â· Selic ${selic}% - 0,10%)`;
  } else { lciNote.textContent = 'bruto prefixado a.a.'; lciRes.style.display = 'none'; }
  const cdbNote = document.getElementById('cdbRateNote');
  const cdbRes  = document.getElementById('cdbResult');
  if (cdbMode === 'pos') {
    cdbNote.textContent = '% do CDI';
    cdbRes.style.display = 'block';
    cdbRes.textContent = `= ${((cdbRaw/100)*cdi).toFixed(2)}% bruto a.a. (CDI ${cdi.toFixed(2)}% Â· Selic ${selic}% - 0,10%)`;
  } else { cdbNote.textContent = 'bruto prefixado a.a.'; cdbRes.style.display = 'none'; }
}

function updateHeader() {
  const p = getParams();
  const fmt = v => {
    if (v >= 1e6) return 'R$ '+(v/1e6).toFixed(1).replace('.',',')+'M';
    if (v >= 1e3) return 'R$ '+(v/1e3%1===0?(v/1e3).toFixed(0):(v/1e3).toFixed(1).replace('.',','))+'k';
    return 'R$ '+v.toFixed(0);
  };
  document.getElementById('h1Inicial').textContent = fmt(p.inicial);
  document.getElementById('h1Aporte').textContent  = fmt(p.aporte);
}

function setMode(instrument, mode) {
  if (instrument === 'lci') {
    lciMode = mode;
    document.getElementById('lciModePre').classList.toggle('active', mode==='pre');
    document.getElementById('lciModePos').classList.toggle('active', mode==='pos');
    document.getElementById('lciRate').value = mode==='pos' ? '93' : '14.0';
  } else {
    cdbMode = mode;
    document.getElementById('cdbModePre').classList.toggle('active', mode==='pre');
    document.getElementById('cdbModePos').classList.toggle('active', mode==='pos');
    document.getElementById('cdbRate').value = mode==='pos' ? '90' : '13.5';
  }
  buildAll();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD CHART
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildChart() {
  const p = getParams();
  const maxYears = 20;
  const labels = Array.from({length:maxYears},(_,i)=>`${i+1}a`);
  const cs = getComputedStyle(document.documentElement);
  const cGrid=cs.getPropertyValue('--chart-grid').trim(), cTick=cs.getPropertyValue('--chart-tick').trim(),
        cBorder=cs.getPropertyValue('--border').trim(), cTooltip=cs.getPropertyValue('--tooltip-bg').trim(),
        cMuted=cs.getPropertyValue('--muted').trim(), cText=cs.getPropertyValue('--text').trim();

  const datasets = INVESTMENTS.map(inv => {
    const data = getSeriesData(inv, p, maxYears*12);
    const noReinv = inv.type==='stock' && !reinvestDivs;
    return { label:inv.name, data,
      borderColor:inv.color, backgroundColor:inv.color+'10',
      borderWidth:noReinv?1.5:2, borderDash:noReinv?[5,4]:[],
      pointRadius:2, pointHoverRadius:5, tension:0.4, hidden:hiddenSeries.has(inv.id) };
  });

  const ctx = document.getElementById('mainChart').getContext('2d');
  if (chart) chart.destroy();
  chart = new Chart(ctx, {
    type:'line', data:{labels,datasets},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index',intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1,
          titleColor:cMuted, bodyColor:cText,
          titleFont:{family:'DM Mono',size:10}, bodyFont:{family:'DM Mono',size:11}, padding:12,
          callbacks:{
            title:items=>`Ano ${items[0].dataIndex+1} (valor bruto acumulado)`,
            label:item=>{
              if(item.dataset.hidden) return null;
              const inv = INVESTMENTS[item.datasetIndex];
              const noReinv = inv.type==='stock'&&!reinvestDivs?' (s/reinv)':'';
              const name = inv.type==='tesouro'?`Tesouro IPCA+${p.tesReal.toFixed(2).replace('.',',')}%`:inv.shortName;
              return `  ${name}${noReinv}: ${fmtBRL(item.raw)}`;
            }
          }
        }
      },
      scales:{
        x:{grid:{color:cGrid},ticks:{color:cTick,font:{family:'DM Mono',size:9},maxTicksLimit:10},border:{color:cBorder}},
        y:{grid:{color:cGrid},ticks:{color:cTick,font:{family:'DM Mono',size:9},
            callback:v=>v>=1e6?(v/1e6).toFixed(1)+' mi':v>=1e3?(v/1e3).toFixed(0)+'k':v},border:{color:cBorder}}
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD LEGEND
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildLegend() {
  const grid = document.getElementById('legendGrid');
  grid.innerHTML = '';
  INVESTMENTS.forEach(inv => {
    const hidden = hiddenSeries.has(inv.id);
    const noReinv = inv.type==='stock'&&!reinvestDivs;
    const item = document.createElement('div');
    item.className = 'legend-item'+(hidden?' dimmed':'');
    const lineStyle = noReinv
      ? `background:repeating-linear-gradient(90deg,${inv.color} 0,${inv.color} 5px,transparent 5px,transparent 9px);`
      : `background:${inv.color};`;
    item.innerHTML = `<div class="legend-line" style="${lineStyle}"></div><span>${inv.shortName}${noReinv?' â†— sÃ³ preÃ§o':''}</span>`;
    item.addEventListener('click',()=>{
      if(hiddenSeries.has(inv.id)) hiddenSeries.delete(inv.id); else hiddenSeries.add(inv.id);
      buildAll();
    });
    grid.appendChild(item);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD RANKING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildRanking() {
  const p = getParams();
  const months = activeMonths;
  const totalInvested = p.inicial + p.aporte * months;

  const results = INVESTMENTS.map(inv => {
    // All series use grossRate, IR only at redemption
    const data = getSeriesData(inv, p, months);
    const fvGross = data[data.length - 1];
    const grossGain = fvGross - totalInvested;

    const ir = irRate(inv, p);
    let netPocket, irLabel;

    if (inv.type === 'stock') {
      if (!reinvestDivs) {
        // BUG FIX: fvGross = stock + cashDivs. Dividends are exempt.
        // Recalculate stock-only (price appreciation) to isolate taxable gain.
        const stockOnlyData = simFixed(inv.priceGrowth, p.inicial, p.aporte, months);
        const stockFinal = stockOnlyData[stockOnlyData.length - 1];
        const priceGain  = Math.max(stockFinal - totalInvested, 0);
        netPocket = fvGross - ir * priceGain;
        irLabel = `IR 15% s/ ganho de preÃ§o (${fmtBRL(priceGain)}) Â· dividendos (caixa) isentos Â· estimativa simplificada`;
      } else {
        // Reinvesting: compute price-only portfolio explicitly (same as no-reinvest path)
        // to isolate the taxable gain from price appreciation vs exempt dividend income
        const priceOnlyData = simFixed(inv.priceGrowth, p.inicial, p.aporte, months);
        const stockFinal    = priceOnlyData[priceOnlyData.length - 1];
        const priceGain     = Math.max(stockFinal - totalInvested, 0);
        netPocket = fvGross - ir * priceGain;
        irLabel = `IR 15% s/ ganho de preÃ§o (${fmtBRL(priceGain)}) Â· DY reinvestido isento Â· estimativa simplificada`;
      }
    } else {
      const taxableGain = Math.max(grossGain, 0);
      netPocket = fvGross - ir * taxableGain;
      irLabel = ir === 0 ? 'isento de IR' : `IR ${(ir*100).toFixed(1)}% s/ ganho no resgate`;
    }

    const rate = displayRate(inv, p);
    return { inv, fvGross, grossGain, netPocket, irLabel, rate };
  });

  results.sort((a,b) => b.fvGross - a.fvGross);

  const list = document.getElementById('rankingList');
  list.innerHTML = '';

  results.forEach((r, i) => {
    const pos = i+1;
    const card = document.createElement('div');
    card.className = 'rank-card rank-'+Math.min(pos,3);
    const gainX = (r.fvGross / totalInvested).toFixed(1);
    const noReinv = r.inv.type==='stock'&&!reinvestDivs;
    // Rate label: always show gross. Add net estimate for fixed income.
    let rateLabel;
    if (noReinv) {
      rateLabel = `${r.rate.toFixed(1)}% preÃ§o (bruto) Â· DY em caixa`;
    } else if (r.inv.type === 'stock') {
      rateLabel = `${r.rate.toFixed(1)}% a.a. total return (bruto)`;
    } else {
      const ir = irRate(r.inv, p);
      if (ir === 0) {
        rateLabel = `${r.rate.toFixed(1)}% a.a. bruto = lÃ­quido (isento)`;
      } else {
        // Net is not simply rate*(1-ir): only gains are taxed, not principal.
        // Show bruto and note IR at redemption.
        rateLabel = `${r.rate.toFixed(1)}% a.a. bruto Â· IR ${(ir*100).toFixed(1)}% no resgate`;
      }
    }
    const displayName = r.inv.type==='tesouro'
      ? `Tesouro IPCA+${p.tesReal.toFixed(2).replace('.',',')}%` : r.inv.shortName;

    card.innerHTML = `
      <div class="rank-pos">${pos}</div>
      <div class="rank-name">
        <div class="rank-dot" style="background:${r.inv.color}"></div>
        ${displayName}${noReinv?'<span style="color:var(--orange);font-size:8px;margin-left:4px">s/reinv.</span>':''}
      </div>
      <div class="rank-rate">${rateLabel}</div>
      <div class="rank-fv" style="color:${r.inv.color}"><small>R$</small>${fmtFV(r.fvGross)}</div>
      <div class="rank-net">
        <span class="rank-net-val">no bolso: ${fmtBRL(r.netPocket)}</span>
        <span class="rank-net-label">${r.irLabel}</span>
      </div>
      <div class="rank-detail">
        <div class="rank-stat">
          <span class="rank-stat-label">Ganho bruto</span>
          <span class="rank-stat-val pos">+${fmtBRL(r.grossGain)}</span>
        </div>
        <div class="rank-stat">
          <span class="rank-stat-label">MÃºltiplo</span>
          <span class="rank-stat-val">${gainX}Ã—</span>
        </div>
        <div class="rank-stat">
          <span class="rank-stat-label">Risco</span>
          <span class="rank-stat-val ${r.inv.riskClass}">${r.inv.risk}</span>
        </div>
      </div>
    `;
    if (pos <= 2 || r.inv.type === 'stock') {
      const note = document.createElement('div');
      note.style.cssText = 'font-size:9px;color:var(--muted);margin-top:7px;border-top:1px solid var(--border);padding-top:7px;';
      note.textContent = r.inv.note;
      card.appendChild(note);
    }
    list.appendChild(card);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BUILD ALL (simulador)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function buildAll() {
  updateRateHints();
  updateHeader();
  buildChart();
  buildLegend();
  buildRanking();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RESERVA DE EMERGÃŠNCIA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcReserva() {
  const pessoas   = parseInt(document.getElementById('res-pessoas').value)  || 2;
  const gasto     = parseFloat(document.getElementById('res-gasto').value)  || 5000;
  const filhos    = document.getElementById('res-filhos').checked;
  const atual     = parseFloat(document.getElementById('res-atual').value)  || 0;
  const poupar    = parseFloat(document.getElementById('res-poupar').value) || 500;
  const renda     = parseInt(document.getElementById('res-renda').value);
  const rendPct   = parseFloat(document.getElementById('res-rendimento').value) || 13.5;

  // Determine meses recomendados
  let mesesBase = 6;
  if (filhos) mesesBase = 8;
  if (renda === 1) mesesBase = Math.max(mesesBase, 9);   // renda variÃ¡vel
  if (renda === 2) mesesBase = Math.max(mesesBase, 12);  // empresÃ¡rio

  const meta = gasto * mesesBase;
  const falta = Math.max(meta - atual, 0);
  const pct = Math.min(atual / meta, 1);

  // Tempo atÃ© atingir com rendimento mensal
  const rMes = Math.pow(1 + rendPct/100, 1/12) - 1;
  let meses = 0;
  if (falta <= 0) {
    meses = 0;
  } else if (poupar <= 0) {
    meses = Infinity;
  } else {
    // Simula mÃªs a mÃªs
    let acum = atual;
    for (let m = 1; m <= 600; m++) {
      acum = acum * (1+rMes) + poupar;
      if (acum >= meta) { meses = m; break; }
      if (m === 600) meses = Infinity;
    }
  }

  // Update per-capita hint (Bug 3 fix: pessoas was read but unused)
  const gastoPerCapita = pessoas > 0 ? gasto / pessoas : gasto;
  const pessoasHint = document.getElementById('res-per-capita');
  if (pessoasHint) pessoasHint.textContent = `â‰ˆ ${fmtBRL(gastoPerCapita)}/pessoa`;
  document.getElementById('res-meta').textContent = fmtBRL(meta);
  document.getElementById('res-meta-sub').textContent = `${mesesBase} meses Ã— ${fmtBRL(gasto)}`;
  document.getElementById('res-falta').textContent = fmtBRL(falta);
  document.getElementById('res-falta-sub').textContent = `${(pct*100).toFixed(0)}% da meta atingida`;

  const tempoEl = document.getElementById('res-tempo');
  const tempoSub = document.getElementById('res-tempo-sub');
  if (falta <= 0) {
    tempoEl.textContent = 'âœ“ Meta atingida!';
    tempoEl.className = 'res-result-value ok';
    tempoSub.textContent = 'parabÃ©ns, mantenha a reserva';
  } else if (meses === Infinity) {
    tempoEl.textContent = 'â€”';
    tempoEl.className = 'res-result-value warn';
    tempoSub.textContent = 'aumento no valor guardado necessÃ¡rio';
  } else {
    const anos = Math.floor(meses/12);
    const mesesR = meses % 12;
    const label = anos > 0 ? `${anos}a ${mesesR}m` : `${meses} meses`;
    tempoEl.textContent = label;
    tempoEl.className = 'res-result-value ok';
    tempoSub.textContent = `rendendo ${rendPct}% a.a. bruto`;
  }

  // Progress bar
  const fill = document.getElementById('res-fill');
  fill.style.width = (pct*100).toFixed(1)+'%';
  fill.className = 'res-progress-fill'+(pct>=1?' done':'');
  document.getElementById('res-pct').textContent = (pct*100).toFixed(1)+'%';

  // Charts
  buildResDonut(atual, falta, meta, mesesBase);
  buildResLine(atual, poupar, meta, rMes, meses);
}

function buildResDonut(atual, falta, meta, meses) {
  const cs = getComputedStyle(document.documentElement);
  const cGreen = cs.getPropertyValue('--green').trim();
  const cBlue  = cs.getPropertyValue('--blue').trim();
  const cBorder= cs.getPropertyValue('--border').trim();
  const cTooltip = cs.getPropertyValue('--tooltip-bg').trim();
  const cText  = cs.getPropertyValue('--text').trim();

  const ctx = document.getElementById('resDonut').getContext('2d');
  if (resDonutChart) resDonutChart.destroy();

  const atingido = Math.min(atual, meta);
  const restante = Math.max(meta - atual, 0);

  resDonutChart = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels: ['JÃ¡ guardado', `Falta (meta: ${meses} meses)`],
      datasets:[{
        data: atingido > 0 ? [atingido, restante] : [0.001, meta],
        backgroundColor: [cGreen+'cc', cBorder],
        borderColor: [cGreen, cBorder],
        borderWidth: 1, hoverOffset: 4
      }]
    },
    options:{
      responsive:true, maintainAspectRatio:false, cutout:'70%',
      plugins:{
        legend:{display:true, position:'bottom',
          labels:{color:cs.getPropertyValue('--muted').trim(), font:{family:'DM Mono',size:10}, boxWidth:12, padding:12}},
        tooltip:{backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1, bodyColor:cText,
          titleColor:cs.getPropertyValue('--muted').trim(), titleFont:{family:'DM Mono',size:10},
          bodyFont:{family:'DM Mono',size:11},
          callbacks:{label:item=>`  ${item.label}: ${fmtBRL(item.raw)}`}}
      }
    }
  });
}

function buildResLine(atual, poupar, meta, rMes, totalMeses) {
  if (poupar <= 0 || totalMeses === Infinity || totalMeses === 0) {
    const cs2 = getComputedStyle(document.documentElement);
    const ctx2 = document.getElementById('resLine').getContext('2d');
    if (resLineChart) resLineChart.destroy();
    resLineChart = null;
    return;
  }
  const maxM = Math.min(totalMeses + 3, 120);
  const labels = [];
  const data = [];
  let acum = atual;
  for (let m = 1; m <= maxM; m++) {
    acum = acum * (1+rMes) + poupar;
    if (m % 3 === 0 || m === maxM || m === totalMeses) {
      labels.push(m >= 12 ? `${Math.floor(m/12)}a${m%12?m%12+'m':''}` : `${m}m`);
      data.push(Math.round(acum));
    }
  }

  const cs = getComputedStyle(document.documentElement);
  const cBlue  = cs.getPropertyValue('--blue').trim();
  const cGreen = cs.getPropertyValue('--green').trim();
  const cGrid  = cs.getPropertyValue('--chart-grid').trim();
  const cTick  = cs.getPropertyValue('--chart-tick').trim();
  const cBorder= cs.getPropertyValue('--border').trim();
  const cTooltip = cs.getPropertyValue('--tooltip-bg').trim();
  const cText  = cs.getPropertyValue('--text').trim();
  const cMuted = cs.getPropertyValue('--muted').trim();

  const ctx = document.getElementById('resLine').getContext('2d');
  if (resLineChart) resLineChart.destroy();

  resLineChart = new Chart(ctx, {
    type:'line',
    data:{labels, datasets:[
      { label:'Reserva acumulada', data, borderColor:cBlue, backgroundColor:cBlue+'18',
        borderWidth:2, pointRadius:2, tension:0.4, fill:true },
      { label:'Meta', data:Array(data.length).fill(meta), borderColor:cGreen,
        borderDash:[6,4], borderWidth:1.5, pointRadius:0, fill:false }
    ]},
    options:{
      responsive:true, maintainAspectRatio:false,
      plugins:{
        legend:{display:true, position:'bottom',
          labels:{color:cMuted, font:{family:'DM Mono',size:10}, boxWidth:12, padding:10}},
        tooltip:{backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1, bodyColor:cText,
          titleColor:cMuted, titleFont:{family:'DM Mono',size:10}, bodyFont:{family:'DM Mono',size:11},
          callbacks:{label:item=>`  ${item.dataset.label}: ${fmtBRL(item.raw)}`}}
      },
      scales:{
        x:{grid:{color:cGrid}, ticks:{color:cTick, font:{family:'DM Mono',size:9}}, border:{color:cBorder}},
        y:{grid:{color:cGrid}, ticks:{color:cTick, font:{family:'DM Mono',size:9},
            callback:v=>v>=1e3?(v/1e3).toFixed(0)+'k':v}, border:{color:cBorder}}
      }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CALCULADORA DE AÃ‡Ã•ES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let acChart = null;

const AC_SCENARIOS = [
  { id:'cons', label:'Conservador', priceGrowth:0.03, color:'#5b9cf6' },
  { id:'mod',  label:'Moderado',    priceGrowth:0.07, color:'#a88bfa' },
  { id:'otm',  label:'Otimista',    priceGrowth:0.11, color:'#3dd68c' }
];

function calcAcoes() {
  const ticker   = (document.getElementById('ac-ticker').value  || 'AÃ‡ÃƒO').toUpperCase();
  const dy       = parseFloat(document.getElementById('ac-dy').value)      || 7.0;
  const inicial  = parseFloat(document.getElementById('ac-inicial').value) || 10000;
  const aporte   = parseFloat(document.getElementById('ac-aporte').value)  || 1000;
  const anos     = parseInt(document.getElementById('ac-anos').value)      || 20;
  const reinvest = document.getElementById('ac-reinvest').checked;
  const months   = anos * 12;
  const totalInv = inicial + aporte * months;

  document.getElementById('ac-ticker-label').textContent = ticker;
  document.getElementById('ac-anos-label').textContent   = anos;

  // Simulate each scenario
  AC_SCENARIOS.forEach(sc => {
    let fvGross, stockFinalForIR;

    if (reinvest) {
      const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
      const data = simFixed(totalRate, inicial, aporte, months);
      fvGross = data[data.length - 1];
      // Explicit price-only sim to isolate taxable capital gain from exempt DY
      const priceOnlyData = simFixed(sc.priceGrowth, inicial, aporte, months);
      const stockFinal    = priceOnlyData[priceOnlyData.length - 1];
      stockFinalForIR     = Math.max(stockFinal - totalInv, 0);
    } else {
      const stockData = simFixed(sc.priceGrowth, inicial, aporte, months);
      const stockFinal = stockData[stockData.length - 1];
      const priceGain  = Math.max(stockFinal - totalInv, 0);
      // Dividends accumulate as separate exempt cash
      const rPrice = Math.pow(1 + sc.priceGrowth, 1/12) - 1;
      const rDY    = Math.pow(1 + dy/100, 1/12) - 1;
      let stock2 = inicial, cashDivs = 0;
      for (let m = 1; m <= months; m++) {
        cashDivs += stock2 * rDY;
        stock2    = stock2 * (1+rPrice) + aporte;
      }
      fvGross = Math.round(stock2 + cashDivs);
      stockFinalForIR = priceGain;
    }

    const irAmount = 0.15 * Math.max(stockFinalForIR, 0);
    const netPocket = fvGross - irAmount;
    const gain = fvGross - totalInv;
    const gainX = (fvGross / totalInv).toFixed(1);
    const totalReturnRate = reinvest
      ? ((1 + dy/100) * (1 + sc.priceGrowth) - 1) * 100
      : sc.priceGrowth * 100;

    // Projected annual dividends at end (based on portfolio value Ã— DY)
    const annualDivs = fvGross * (dy / 100);
    const monthlyDivs = annualDivs / 12;

    document.getElementById(`ac-fv-${sc.id}`).textContent  = fmtBRL(fvGross);
    document.getElementById(`ac-net-${sc.id}`).textContent = fmtBRL(netPocket);
    document.getElementById(`ac-growth-${sc.id}`).textContent =
      `+${(sc.priceGrowth*100).toFixed(0)}% preÃ§o/ano Â· ${totalReturnRate.toFixed(1)}% total return`;
    document.getElementById(`ac-detail-${sc.id}`).innerHTML =
      `Ganho bruto: <strong>+${fmtBRL(gain)}</strong> &nbsp;Â·&nbsp; MÃºltiplo: <strong>${gainX}Ã—</strong><br>` +
      `IR 15% s/ ganho de preÃ§o: âˆ’${fmtBRL(irAmount)} (dividendos isentos)<br>` +
      `Dividendos projetados (ano ${anos}): <strong style="color:var(--violet)">${fmtBRL(annualDivs)}/ano = ${fmtBRL(monthlyDivs)}/mÃªs</strong>`;
  });

  buildAcChart(dy, inicial, aporte, months, reinvest);
  buildAcDivGrid(dy, inicial, aporte, anos, reinvest);
}

function buildAcChart(dy, inicial, aporte, months, reinvest) {
  const cs = getComputedStyle(document.documentElement);
  const cGrid=cs.getPropertyValue('--chart-grid').trim(), cTick=cs.getPropertyValue('--chart-tick').trim(),
        cBorder=cs.getPropertyValue('--border').trim(), cTooltip=cs.getPropertyValue('--tooltip-bg').trim(),
        cMuted=cs.getPropertyValue('--muted').trim(), cText=cs.getPropertyValue('--text').trim();

  const labels = Array.from({length: months/12}, (_,i) => `${i+1}a`);

  const datasets = AC_SCENARIOS.map(sc => {
    let data;
    if (reinvest) {
      const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
      data = simFixed(totalRate, inicial, aporte, months);
    } else {
      // stock + cumulative divs month by month
      const rPrice = Math.pow(1 + sc.priceGrowth, 1/12) - 1;
      const rDY    = Math.pow(1 + dy/100, 1/12) - 1;
      const out = [];
      let stock = inicial, cashDivs = 0;
      for (let m = 1; m <= months; m++) {
        cashDivs += stock * rDY;
        stock     = stock * (1+rPrice) + aporte;
        if (m % 12 === 0) out.push(Math.round(stock + cashDivs));
      }
      data = out;
    }
    return {
      label: sc.label,
      data,
      borderColor: sc.color,
      backgroundColor: sc.color+'15',
      borderWidth: sc.id==='otm' ? 2.5 : 2,
      pointRadius: 2, pointHoverRadius: 5,
      tension: 0.4, fill: sc.id==='cons'
    };
  });

  // Invested capital line
  const invested = Array.from({length: months/12}, (_,i) => inicial + aporte * (i+1)*12);
  datasets.unshift({
    label: 'Total investido',
    data: invested,
    borderColor: cs.getPropertyValue('--border2').trim(),
    backgroundColor: 'transparent',
    borderWidth: 1.5,
    borderDash: [4,4],
    pointRadius: 0,
    tension: 0, fill: false
  });

  const ctx = document.getElementById('acChart').getContext('2d');
  if (acChart) acChart.destroy();
  acChart = new Chart(ctx, {
    type:'line', data:{labels, datasets},
    options:{
      responsive:true, maintainAspectRatio:false,
      interaction:{mode:'index', intersect:false},
      plugins:{
        legend:{display:false},
        tooltip:{
          backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1,
          titleColor:cMuted, bodyColor:cText,
          titleFont:{family:'DM Mono',size:10}, bodyFont:{family:'DM Mono',size:11}, padding:12,
          callbacks:{
            title: items => `Ano ${items[0].dataIndex+1}`,
            label: item => `  ${item.dataset.label}: ${fmtBRL(item.raw)}`
          }
        }
      },
      scales:{
        x:{grid:{color:cGrid},ticks:{color:cTick,font:{family:'DM Mono',size:9},maxTicksLimit:12},border:{color:cBorder}},
        y:{grid:{color:cGrid},ticks:{color:cTick,font:{family:'DM Mono',size:9},
            callback:v=>v>=1e6?(v/1e6).toFixed(1)+' mi':v>=1e3?(v/1e3).toFixed(0)+'k':v},border:{color:cBorder}}
      }
    }
  });

  // Legend
  const lgd = document.getElementById('ac-legend');
  lgd.innerHTML = '';
  [...AC_SCENARIOS].reverse().forEach(sc => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<div class="legend-line" style="background:${sc.color}"></div><span>${sc.label}</span>`;
    lgd.appendChild(item);
  });
  const inv = document.createElement('div');
  inv.className = 'legend-item';
  inv.innerHTML = `<div class="legend-line" style="background:repeating-linear-gradient(90deg,var(--border2) 0,var(--border2) 4px,transparent 4px,transparent 8px)"></div><span>Capital investido</span>`;
  lgd.appendChild(inv);
}

function buildAcDivGrid(dy, inicial, aporte, anos, reinvest) {
  const grid = document.getElementById('ac-div-grid');
  grid.innerHTML = '';
  // Moderado scenario, show dividends at years 1,2,3,5,10,15,20 (up to anos)
  const milestones = [1,2,3,5,10,15,20,25,30].filter(y => y <= anos);
  const priceGrowth = 0.07; // moderado

  milestones.forEach(y => {
    const m = y * 12;
    let portfolioVal;
    if (reinvest) {
      const totalRate = (1 + dy/100) * (1 + priceGrowth) - 1;
      const data = simFixed(totalRate, inicial, aporte, m);
      portfolioVal = data[data.length - 1];
    } else {
      const rPrice = Math.pow(1 + priceGrowth, 1/12) - 1;
      let stock = inicial;
      for (let mm = 1; mm <= m; mm++) stock = stock*(1+rPrice) + aporte;
      portfolioVal = stock;
    }
    const annualDivs  = portfolioVal * (dy/100);
    const monthlyDivs = annualDivs / 12;

    const cell = document.createElement('div');
    cell.className = 'ac-div-cell';
    cell.innerHTML = `
      <div class="ac-div-year">Ano ${y}</div>
      <div class="ac-div-val">${fmtBRL(annualDivs)}</div>
      <div class="ac-div-monthly">${fmtBRL(monthlyDivs)}/mÃªs</div>
    `;
    grid.appendChild(cell);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// REBALANCEAMENTO DE CARTEIRA
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let rbCurrentDonut = null;
let rbTargetDonut  = null;
let rbProfile = 'cons';

// BASE targets (with FIIs and ProteÃ§Ã£o included)
const RB_BASE = {
  cons: { rf:75, ac:10, fii:10, prot:5 },
  mod:  { rf:50, ac:30, fii:15, prot:5 },
  arr:  { rf:20, ac:55, fii:20, prot:5 }
};

function getRbTargets() {
  const useFii  = document.getElementById('rb-use-fii').checked;
  const useProt = document.getElementById('rb-use-prot').checked;
  const out = {};
  ['cons','mod','arr'].forEach(p => {
    const b = RB_BASE[p];
    let rf = b.rf, ac = b.ac, fii = b.fii, prot = b.prot;
    if (!useFii)  { ac   += fii;  fii  = 0; }
    if (!useProt) { rf   += prot; prot = 0; }
    out[p] = { rf, ac, fii, prot };
  });
  return out;
}

const RB_TARGETS_LABELS = {
  cons: 'Conservador',
  mod:  'Moderado',
  arr:  'Arrojado'
};

function rebuildProfiles() {
  const useFii  = document.getElementById('rb-use-fii').checked;
  const useProt = document.getElementById('rb-use-prot').checked;

  // Show/hide table rows and inputs
  document.getElementById('rbrow-fii').style.display         = useFii  ? '' : 'none';
  document.getElementById('rbrow-prot').style.display        = useProt ? '' : 'none';
  document.getElementById('rb-fii-input-wrap').style.display  = useFii  ? '' : 'none';
  document.getElementById('rb-prot-input-wrap').style.display = useProt ? '' : 'none';
  if (!useFii)  document.getElementById('rb-fii').value  = 0;
  if (!useProt) document.getElementById('rb-prot').value = 0;

  // Update bar widths and labels
  const targets = getRbTargets();
  ['cons','mod','arr'].forEach(p => {
    const t = targets[p];
    ['rf','ac','fii','prot'].forEach(cls => {
      const bar = document.getElementById(`rbbar-${cls}-${p}`);
      const lbl = document.getElementById(`rbpct-${cls}-${p}`);
      if (bar) bar.style.width = t[cls] + '%';
      if (lbl) lbl.textContent = t[cls] + '%';
    });
  });

  // Also update the active classes list used in diagnosis/donuts
  calcRebalance();
}

function getRbClasses() {
  const useFii  = document.getElementById('rb-use-fii').checked;
  const useProt = document.getElementById('rb-use-prot').checked;
  return [
    { id:'rf',   label:'Renda Fixa',          color:'#a78bfa' },
    { id:'ac',   label:'AÃ§Ãµes',               color:'#3dd68c' },
    ...(useFii  ? [{ id:'fii',  label:'Fundos ImobiliÃ¡rios', color:'#f59e0b' }] : []),
    ...(useProt ? [{ id:'prot', label:'ProteÃ§Ã£o',            color:'#f87171' }] : [])
  ];
}

function setRbProfile(p) {
  rbProfile = p;
  ['cons','mod','arr'].forEach(k => {
    document.getElementById('rbp-'+k).classList.toggle('active', k === p);
  });
  document.getElementById('rb-target-title').textContent = `CARTEIRA ALVO: ${RB_TARGETS_LABELS[p].toUpperCase()}`;
  buildRbDiag();
  buildRbDonuts();
}

function calcRebalance() {
  const rf   = parseFloat(document.getElementById('rb-rf').value)   || 0;
  const ac   = parseFloat(document.getElementById('rb-ac').value)   || 0;
  const fii  = parseFloat(document.getElementById('rb-fii').value)  || 0;
  const prot = parseFloat(document.getElementById('rb-prot').value) || 0;
  const total = rf + ac + fii + prot;

  // Update total display
  const totalEl = document.getElementById('rb-total');
  totalEl.textContent = fmtBRL(total);

  const section = document.getElementById('rb-result-section');
  if (total <= 0) { section.style.display = 'none'; return; }
  section.style.display = '';

  buildRbDiag();
  buildRbDonuts();
}

function buildRbDiag() {
  const rf   = parseFloat(document.getElementById('rb-rf').value)   || 0;
  const ac   = parseFloat(document.getElementById('rb-ac').value)   || 0;
  const fii  = parseFloat(document.getElementById('rb-fii').value)  || 0;
  const prot = parseFloat(document.getElementById('rb-prot').value) || 0;
  const total = rf + ac + fii + prot;
  if (total <= 0) return;

  const tgt     = getRbTargets()[rbProfile];
  const rbCls   = getRbClasses();
  const current = { rf, ac, fii, prot };
  const grid    = document.getElementById('rb-diag-grid');
  grid.innerHTML = '';

  rbCls.forEach(cls => {
    const currentVal = current[cls.id];
    const currentPct = (currentVal / total) * 100;
    const targetPct  = tgt[cls.id];
    const diff       = targetPct - currentPct;
    const diffVal    = (diff / 100) * total;

    let deltaClass, deltaText, amountText;
    if (Math.abs(diff) < 1.5) {
      deltaClass = 'ok'; deltaText = 'âœ“ Balanceado';
      amountText = 'DiferenÃ§a < 1,5%; sem necessidade de aÃ§Ã£o';
    } else if (diff > 0) {
      deltaClass = 'buy'; deltaText = `+${diff.toFixed(1)}% a comprar`;
      amountText = `Comprar ~${fmtBRL(diffVal)}`;
    } else {
      deltaClass = 'over'; deltaText = `${diff.toFixed(1)}% acima do alvo`;
      amountText = `Alocar novos aportes em outras classes`;
    }

    const cell = document.createElement('div');
    cell.className = 'rb-diag-cell';
    cell.innerHTML = `
      <div class="rb-diag-label" style="color:${cls.color}">${cls.label.toUpperCase()}</div>
      <div class="rb-diag-current">${currentPct.toFixed(1)}%</div>
      <div class="rb-diag-target">Alvo: ${targetPct}% Â· ${fmtBRL(currentVal)}</div>
      <div class="rb-diag-delta ${deltaClass}">${deltaText}</div>
      <div class="rb-diag-amount">${amountText}</div>
    `;
    grid.appendChild(cell);
  });
}

function buildRbDonuts() {
  const rf   = parseFloat(document.getElementById('rb-rf').value)   || 0;
  const ac   = parseFloat(document.getElementById('rb-ac').value)   || 0;
  const fii  = parseFloat(document.getElementById('rb-fii').value)  || 0;
  const prot = parseFloat(document.getElementById('rb-prot').value) || 0;
  const total = rf + ac + fii + prot;
  const tgt     = getRbTargets()[rbProfile];
  const rbCls   = getRbClasses();

  const cs = getComputedStyle(document.documentElement);
  const cTooltip = cs.getPropertyValue('--tooltip-bg').trim();
  const cBorder  = cs.getPropertyValue('--border').trim();
  const cText    = cs.getPropertyValue('--text').trim();
  const cMuted   = cs.getPropertyValue('--muted').trim();
  const colors   = rbCls.map(c => c.color);
  const labels   = rbCls.map(c => c.label);

  const currentPcts = total > 0
    ? rbCls.map(c => ({ rf, ac, fii, prot })[c.id] / total * 100)
    : rbCls.map(() => 100 / rbCls.length);
  const targetPcts = rbCls.map(c => tgt[c.id]);

  const donutOpts = (lbs, data, cols) => ({
    type: 'doughnut',
    data: {
      labels: lbs,
      datasets:[{ data, backgroundColor: cols.map(c => c+'cc'),
        borderColor: cols, borderWidth:1, hoverOffset:4 }]
    },
    options:{
      responsive:true, maintainAspectRatio:false, cutout:'65%',
      plugins:{
        legend:{ display:true, position:'bottom',
          labels:{color:cMuted, font:{family:'DM Mono',size:9}, boxWidth:10, padding:10}},
        tooltip:{ backgroundColor:cTooltip, borderColor:cBorder, borderWidth:1,
          bodyColor:cText, titleColor:cMuted,
          titleFont:{family:'DM Mono',size:9}, bodyFont:{family:'DM Mono',size:10},
          callbacks:{ label: item => `  ${item.label}: ${item.raw.toFixed(1)}%` }}
      }
    }
  });

  const ctx1 = document.getElementById('rbCurrentDonut').getContext('2d');
  if (rbCurrentDonut) rbCurrentDonut.destroy();
  rbCurrentDonut = new Chart(ctx1, donutOpts(labels, currentPcts, colors));

  const ctx2 = document.getElementById('rbTargetDonut').getContext('2d');
  if (rbTargetDonut) rbTargetDonut.destroy();
  rbTargetDonut = new Chart(ctx2, donutOpts(labels, targetPcts, colors));
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INDEPENDÃŠNCIA FINANCEIRA (FIRE)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let fireChart = null;

// AcumulaÃ§Ã£o scenarios: price growth rates (DY is user input, added on top)
const FIRE_SCENARIOS = [
  { id:'cons', label:'Conservador', priceGrowth:0.03, color:'#5b9cf6' },
  { id:'mod',  label:'Moderado',    priceGrowth:0.07, color:'#a88bfa' },
  { id:'arr',  label:'Otimista',    priceGrowth:0.11, color:'#3dd68c' }
];

function calcFire() {
  const patrimonio     = parseFloat(document.getElementById('fi-patrimonio').value) || 50000;
  const aporte         = parseFloat(document.getElementById('fi-aporte').value)     || 2000;
  const gasto          = parseFloat(document.getElementById('fi-gasto').value)      || 10000;
  const dy             = parseFloat(document.getElementById('fi-dy').value)         || 7.0;
  const inflacao       = parseFloat(document.getElementById('fi-inflacao').value)   || 4.0;
  const ajustaInfl     = document.getElementById('fi-ajusta-inflacao').checked;
  const aporteInflacao = document.getElementById('fi-aporte-inflacao').checked;

  // Update toggle label
  const aporteInflLbl = document.getElementById('fi-aporte-inflacao-label');
  if (aporteInflLbl) {
    aporteInflLbl.textContent = aporteInflacao ? 'Sim' : 'NÃ£o';
    aporteInflLbl.classList.toggle('on', aporteInflacao);
  }

  document.getElementById('fi-inflacao-label').textContent = inflacao.toFixed(1) + '%';

  const gastoAnual = gasto * 12;

  // â”€â”€ FIRE targets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Method 1: By DY (perpetuity), live only on dividends
  const metaDY   = gastoAnual / (dy / 100);
  // Method 2: 4% rule (Trinity study), withdraw 4%/year
  const meta4pct = gastoAnual / 0.04;

  // â”€â”€ Time to reach each target (simulation) â”€â”€â”€â”€
  // Accumulation uses TOTAL return: price appreciation + DY reinvested
  // Max 50 years = 600 months
  function timeToReach(meta) {
    const times = {};
    FIRE_SCENARIOS.forEach(sc => {
      const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
      const rMensal   = Math.pow(1 + totalRate, 1/12) - 1;
      const rInflMes  = Math.pow(1 + inflacao/100, 1/12) - 1;
      let acum = patrimonio;
      let found = false;
      for (let m = 1; m <= 600; m++) {
        const aporteM = aporteInflacao ? aporte * Math.pow(1 + rInflMes, m) : aporte;
        acum = acum * (1 + rMensal) + aporteM;
        if (acum >= meta) { times[sc.id] = m; found = true; break; }
      }
      if (!found) times[sc.id] = Infinity;
    });
    return times;
  }

  const timesDY   = timeToReach(metaDY);
  const times4pct = timeToReach(meta4pct);

  // â”€â”€ Update card DY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('fi-meta-dy').textContent     = fmtBRL(metaDY);
  document.getElementById('fi-meta-dy-sub').textContent =
    `Gasto anual R$ ${fmtBRL(gastoAnual).replace('R$ ','')} Ã· DY ${dy}%`;
  const faltaDY = Math.max(metaDY - patrimonio, 0);
  document.getElementById('fi-falta-dy').textContent = fmtBRL(faltaDY);
  renderTempos('fi-tempos-dy', timesDY);

  // â”€â”€ Update card 4% â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  document.getElementById('fi-meta-4pct').textContent     = fmtBRL(meta4pct);
  document.getElementById('fi-meta-4pct-sub').textContent =
    `Gasto anual R$ ${fmtBRL(gastoAnual).replace('R$ ','')} Ã· 4% (= Ã— 300)`;
  const falta4pct = Math.max(meta4pct - patrimonio, 0);
  document.getElementById('fi-falta-4pct').textContent = fmtBRL(falta4pct);
  renderTempos('fi-tempos-4pct', times4pct);

  // â”€â”€ Build freedom curve chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  buildFireChart(patrimonio, aporte, dy, inflacao, gasto, ajustaInfl, aporteInflacao);

  // â”€â”€ Build evolution table (moderado) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  buildFireEvoTable(patrimonio, aporte, dy, inflacao, gasto, aporteInflacao);

  // â”€â”€ Armadilha da InflaÃ§Ã£o â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  buildInflationTrap(dy, inflacao, gasto);
}

function renderTempos(containerId, times) {
  const el = document.getElementById(containerId);
  el.innerHTML = '<div style="font-size:8px;letter-spacing:2px;text-transform:uppercase;color:var(--muted);margin-bottom:6px;">Tempo para chegar lÃ¡</div>';
  FIRE_SCENARIOS.forEach(sc => {
    const m = times[sc.id];
    let valText;
    if (m === Infinity) {
      valText = `<span class="fi-tempo-val inf">NÃ£o alcanÃ§a em 50a</span>`;
    } else {
      const anos = Math.floor(m / 12);
      const mesesR = m % 12;
      const label = anos > 0 ? `${anos}a ${mesesR > 0 ? mesesR+'m' : ''}` : `${m} meses`;
      valText = `<span class="fi-tempo-val ${sc.id}">${label}</span>`;
    }
    el.innerHTML += `
      <div class="fi-tempo-row">
        <span class="fi-tempo-cenario">${sc.label}</span>
        ${valText}
      </div>`;
  });
}

function buildFireChart(patrimonio, aporte, dy, inflacao, gasto, ajustaInfl, aporteInflacao) {
  const cs = getComputedStyle(document.documentElement);
  const cGrid    = cs.getPropertyValue('--chart-grid').trim();
  const cTick    = cs.getPropertyValue('--chart-tick').trim();
  const cBorder  = cs.getPropertyValue('--border').trim();
  const cTooltip = cs.getPropertyValue('--tooltip-bg').trim();
  const cMuted   = cs.getPropertyValue('--muted').trim();
  const cText    = cs.getPropertyValue('--text').trim();
  const cOrange  = cs.getPropertyValue('--orange').trim();

  const MAX_YEARS = 40;
  const labels = Array.from({length: MAX_YEARS}, (_, i) => `${i+1}a`);

  // Build renda mensal curve for each scenario
  const scenarioDatasets = [];
  const crossingBadges = [];

  FIRE_SCENARIOS.forEach(sc => {
    const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
    const rMensal   = Math.pow(1 + totalRate, 1/12) - 1;
    const rInflMes  = Math.pow(1 + inflacao/100, 1/12) - 1;

    const rendaData = [];
    let acum = patrimonio;
    let crossYear = null;

    for (let y = 1; y <= MAX_YEARS; y++) {
      // Simulate 12 months, optionally growing aporte with inflation
      for (let mm = 0; mm < 12; mm++) {
        const monthAbsolute = (y - 1) * 12 + mm + 1;
        const aporteM = aporteInflacao
          ? aporte * Math.pow(1 + rInflMes, monthAbsolute)
          : aporte;
        acum = acum * (1 + rMensal) + aporteM;
      }
      // Monthly dividend income at year y
      const rendaMensal = acum * (dy/100) / 12;
      // Expense at year y (nominal or inflation-adjusted)
      // Monthly expense at year y (nominal or inflation-adjusted), named clearly as monthly
      const gastoMesCorrigido = ajustaInfl ? gasto * Math.pow(1 + inflacao/100, y) : gasto;

      rendaData.push(rendaMensal); // keep as float; fmtBRL rounds for display

      // Detect crossing: renda mensal >= gasto mensal corrigido
      if (crossYear === null && rendaMensal >= gastoMesCorrigido) {
        crossYear = y;
      }
    }

    scenarioDatasets.push({
      label: `Renda ${sc.label}`,
      data: rendaData,
      borderColor: sc.color,
      backgroundColor: sc.color + '12',
      borderWidth: sc.id === 'arr' ? 2.5 : 2,
      pointRadius: 2, pointHoverRadius: 5,
      tension: 0.4, fill: false
    });

    if (crossYear !== null) {
      const anoAtual = new Date().getFullYear();
      crossingBadges.push({ label: sc.label, year: crossYear, color: sc.color, calYear: anoAtual + crossYear });
    } else {
      crossingBadges.push({ label: sc.label, year: null, color: sc.color });
    }
  });

  // Expense line (flat nominal or growing with inflation)
  const expenseData = Array.from({length: MAX_YEARS}, (_, i) => {
    return ajustaInfl ? Math.round(gasto * Math.pow(1 + inflacao/100, i+1)) : gasto;
  });

  scenarioDatasets.push({
    label: ajustaInfl ? `Gasto corrigido (+${inflacao}%/ano)` : 'Gasto mensal (nominal)',
    data: expenseData,
    borderColor: cOrange,
    backgroundColor: 'transparent',
    borderWidth: 1.5,
    borderDash: [6, 4],
    pointRadius: 0,
    tension: 0, fill: false
  });

  // Render crossing badges
  const badgesEl = document.getElementById('fi-crossing-badges');
  badgesEl.innerHTML = '';
  crossingBadges.forEach(b => {
    const badge = document.createElement('div');
    badge.className = 'fi-crossing-badge';
    badge.style.borderColor = b.color;
    badge.style.color = b.color;
    badge.style.background = b.color + '15';
    badge.textContent = b.year
      ? `${b.label}: IF em ${b.year}a (${b.calYear})`
      : `${b.label}: nÃ£o atinge em 40a`;
    badgesEl.appendChild(badge);
  });

  const ctx = document.getElementById('fireChart').getContext('2d');
  if (fireChart) fireChart.destroy();
  fireChart = new Chart(ctx, {
    type: 'line',
    data: { labels, datasets: scenarioDatasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: {
          backgroundColor: cTooltip, borderColor: cBorder, borderWidth: 1,
          titleColor: cMuted, bodyColor: cText,
          titleFont: { family: 'DM Mono', size: 10 },
          bodyFont: { family: 'DM Mono', size: 11 }, padding: 12,
          callbacks: {
            title: items => `Ano ${items[0].dataIndex + 1}`,
            label: item => `  ${item.dataset.label}: ${fmtBRL(item.raw)}/mÃªs`
          }
        }
      },
      scales: {
        x: { grid:{color:cGrid}, ticks:{color:cTick, font:{family:'DM Mono',size:9}, maxTicksLimit:12}, border:{color:cBorder} },
        y: {
          grid:{color:cGrid}, border:{color:cBorder},
          ticks:{
            color:cTick, font:{family:'DM Mono',size:9},
            callback: v => v >= 1e6 ? (v/1e6).toFixed(1)+' mi' : v >= 1e3 ? (v/1e3).toFixed(0)+'k' : v
          },
          title:{display:true, text:'R$/mÃªs', color:cMuted, font:{family:'DM Mono',size:9}}
        }
      }
    }
  });

  // Legend
  const lgd = document.getElementById('fi-legend');
  lgd.innerHTML = '';
  FIRE_SCENARIOS.forEach(sc => {
    const item = document.createElement('div');
    item.className = 'legend-item';
    item.innerHTML = `<div class="legend-line" style="background:${sc.color}"></div><span>Renda ${sc.label}</span>`;
    lgd.appendChild(item);
  });
  const expItem = document.createElement('div');
  expItem.className = 'legend-item';
  expItem.innerHTML = `<div class="legend-line" style="background:repeating-linear-gradient(90deg,${cOrange} 0,${cOrange} 6px,transparent 6px,transparent 10px)"></div><span>${ajustaInfl ? 'Gasto c/ inflaÃ§Ã£o' : 'Gasto nominal'}</span>`;
  lgd.appendChild(expItem);
}

function buildFireEvoTable(patrimonio, aporte, dy, inflacao, gasto, aporteInflacao) {
  const grid = document.getElementById('fi-evo-grid');
  grid.innerHTML = '';

  const sc = FIRE_SCENARIOS.find(s => s.id === 'mod');
  const totalRate = (1 + dy/100) * (1 + sc.priceGrowth) - 1;
  const rMensal   = Math.pow(1 + totalRate, 1/12) - 1;
  const rInflMes  = Math.pow(1 + inflacao/100, 1/12) - 1;

  const milestones = [1, 2, 3, 5, 7, 10, 15, 20, 25, 30];
  let acum = patrimonio;
  let lastYear = 0;
  let monthCount = 0;

  milestones.forEach(y => {
    const monthsToAdvance = (y - lastYear) * 12;
    for (let mm = 0; mm < monthsToAdvance; mm++) {
      monthCount++;
      const aporteM = aporteInflacao
        ? aporte * Math.pow(1 + rInflMes, monthCount)
        : aporte;
      acum = acum * (1 + rMensal) + aporteM;
    }
    lastYear = y;

    const rendaAnual  = acum * (dy / 100);
    const rendaMensal = rendaAnual / 12;
    const gastoCorr   = gasto * Math.pow(1 + inflacao/100, y);
    const isIndep     = rendaMensal >= gastoCorr;

    const cell = document.createElement('div');
    cell.className = 'fi-evo-cell';
    cell.innerHTML = `
      <div class="fi-evo-year">Ano ${y}</div>
      <div class="fi-evo-portfolio">${fmtBRL(acum)}</div>
      <div class="fi-evo-renda">${fmtBRL(rendaAnual)}/ano</div>
      <div class="fi-evo-monthly">${fmtBRL(rendaMensal)}/mÃªs</div>
      ${isIndep ? '<div class="fi-evo-mark">âœ“ INDEPENDÃŠNCIA</div>' : ''}
    `;
    grid.appendChild(cell);
  });
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ARMADILHA DA INFLAÃ‡ÃƒO
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildInflationTrap(dy, inflacao, gasto) {
  const rfTaxa   = parseFloat(document.getElementById('trap-rf-taxa').value) || 11.0;
  const gastoAnual = gasto * 12;
  const ANOS = 20;

  // PatrimÃ´nios necessÃ¡rios hoje (perpetuidade pelo DY/taxa)
  const patRV = gastoAnual / (dy / 100);
  const patRF = gastoAnual / (rfTaxa / 100);

  // Renda mensal hoje
  const rendaHojeRV = patRV * (dy / 100) / 12;   // = gasto (por definiÃ§Ã£o)
  const rendaHojeRF = patRF * (rfTaxa / 100) / 12; // = gasto (por definiÃ§Ã£o)

  // Em 20 anos: cenÃ¡rio moderado RV (+7% preÃ§o + DY reinvestido = total return ~14,49%)
  const rvTotalReturn = (1 + dy/100) * (1 + 0.07) - 1;
  const rVMes = Math.pow(1 + rvTotalReturn, 1/12) - 1;
  // Simula 20 anos sem aportes (simulamos o patrimÃ´nio jÃ¡ acumulado)
  const patRV20 = patRV * Math.pow(1 + rvTotalReturn, ANOS);
  const rendaRV20 = patRV20 * (dy / 100) / 12;

  // Em 20 anos: RF â€” sem price growth, sÃ³ juros sobre o mesmo montante
  // PatrimÃ´nio nominal cresce pelos juros reinvestidos (mas dono retira tudo os juros na perpetuidade)
  // Na perpetuidade pura, o patrimÃ´nio principal nÃ£o cresce â€” o dono gasta tudo que rende
  // EntÃ£o patRF em 20 anos = patRF (nominal, sem crescimento real)
  const rendaRF20 = patRF * (rfTaxa / 100) / 12; // mesma renda nominal (perpÃ©tua)

  // Poder de compra real em 20 anos (deflacionado pela inflaÃ§Ã£o)
  const fatorInfla = Math.pow(1 + inflacao/100, ANOS);
  const realRV20 = rendaRV20 / fatorInfla;  // em R$ de hoje
  const realRF20 = rendaRF20 / fatorInfla;  // em R$ de hoje

  // Gasto desejado daqui a 20 anos (nominal, corrigido pelo IPCA)
  const gasto20nominal = gasto * fatorInfla;

  // Preenche a grid
  document.getElementById('trap-rf-rate-label').textContent = rfTaxa.toFixed(1) + '%';
  document.getElementById('trap-dy-label').textContent      = dy.toFixed(1) + '%';
  document.getElementById('trap-head-dy').textContent       = dy.toFixed(1) + '%';
  document.getElementById('trap-head-rf').textContent       = rfTaxa.toFixed(1) + '%';

  document.getElementById('trap-pat-rv').textContent       = fmtBRL(patRV);
  document.getElementById('trap-pat-rf').textContent       = fmtBRL(patRF);
  document.getElementById('trap-renda-hoje-rv').textContent = fmtBRL(rendaHojeRV) + '/mÃªs';
  document.getElementById('trap-renda-hoje-rf').textContent = fmtBRL(rendaHojeRF) + '/mÃªs';

  document.getElementById('trap-pat20-rv').textContent  = fmtBRL(patRV20);
  document.getElementById('trap-pat20-rf').textContent  = fmtBRL(patRF) + ' (sem crescimento)';

  document.getElementById('trap-renda20-rv').textContent = fmtBRL(rendaRV20) + '/mÃªs';
  document.getElementById('trap-renda20-rf').textContent = fmtBRL(rendaRF20) + '/mÃªs';

  document.getElementById('trap-real20-rv').textContent = fmtBRL(realRV20) + '/mÃªs';
  document.getElementById('trap-real20-rf').textContent = fmtBRL(realRF20) + '/mÃªs';

  document.getElementById('trap-gasto20').textContent = fmtBRL(gasto20nominal) + '/mÃªs';

  // Vereditos
  const cobriuRV = rendaRV20 >= gasto20nominal;
  const cobriuRF = rendaRF20 >= gasto20nominal;

  const vRV = document.getElementById('trap-verdict-rv');
  const vRF = document.getElementById('trap-verdict-rf');
  vRV.textContent   = cobriuRV ? 'âœ“ Sim' : 'âœ— NÃ£o';
  vRV.style.color   = cobriuRV ? 'var(--green)' : 'var(--red)';
  vRF.textContent   = cobriuRF ? 'âœ“ Sim' : 'âœ— NÃ£o';
  vRF.style.color   = cobriuRF ? 'var(--green)' : 'var(--orange)';

  // Nota de rodapÃ© dinÃ¢mica
  const perda = ((1 - realRF20/gasto) * 100).toFixed(0);
  const ganho = ((realRV20/gasto - 1) * 100).toFixed(0);
  document.getElementById('fi-trap-footnote').innerHTML =
    `<strong>Em resumo:</strong> Com Renda Fixa a ${rfTaxa}% lÃ­quido e inflaÃ§Ã£o a ${inflacao}%, sua renda de ${fmtBRL(gasto)}/mÃªs perde <strong style="color:var(--orange);">${perda}% do poder de compra</strong> em ${ANOS} anos, porque vocÃª consome todos os juros sem reinvestir nada. ` +
    `Com aÃ§Ãµes e DY de ${dy}%, o patrimÃ´nio cresce e sua renda real <strong style="color:var(--green);">ganha ${ganho}% de poder de compra</strong> no mesmo perÃ­odo. ` +
    `O maior patrimÃ´nio inicial exigido pelas aÃ§Ãµes Ã© o <em>preÃ§o da proteÃ§Ã£o contra a inflaÃ§Ã£o</em>.`;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// META PATRIMONIAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let metaChart = null;

function calcMeta() {
  const alvo     = parseFloat(document.getElementById('meta-alvo').value)       || 1000000;
  const atual    = parseFloat(document.getElementById('meta-atual').value)      || 0;
  const prazo    = parseInt(document.getElementById('meta-prazo').value)        || 15;
  const taxa     = parseFloat(document.getElementById('meta-taxa').value)       || 11.0;
  const inflacao = parseFloat(document.getElementById('meta-inflacao').value)   || 4.4;
  const aporteJa = parseFloat(document.getElementById('meta-aporte-input').value) || 0;

  const rMes = Math.pow(1 + taxa / 100, 1 / 12) - 1;
  const n    = prazo * 12;

  // Aporte necessÃ¡rio (PMT para atingir FV)
  const fvAtual  = atual * Math.pow(1 + rMes, n);
  const faltaFV  = Math.max(alvo - fvAtual, 0);
  const aporteNec = faltaFV === 0 ? 0
    : rMes === 0 ? faltaFV / n
    : faltaFV * rMes / (Math.pow(1 + rMes, n) - 1);

  // Prazo com o aporte jÃ¡ praticado
  let prazoMeses = Infinity;
  if (aporteJa > 0 || atual > 0) {
    let acum = atual;
    for (let m = 1; m <= 1200; m++) {
      acum = acum * (1 + rMes) + aporteJa;
      if (acum >= alvo) { prazoMeses = m; break; }
    }
  }

  // Totais
  const totalAportado = atual + aporteNec * n;
  const juros  = alvo - totalAportado;
  const jurosPct = totalAportado > 0 ? (juros / totalAportado * 100).toFixed(0) : 0;

  // Valor real (poder de compra de hoje)
  const fatorInfl = Math.pow(1 + inflacao / 100, prazo);
  const alvoReal  = alvo / fatorInfl;

  // Render resultados
  document.getElementById('meta-aporte-necessario').textContent = fmtBRL(aporteNec) + '/mÃªs';
  document.getElementById('meta-aporte-sub').textContent = `para acumular ${fmtBRL(alvo)} em ${prazo} anos`;

  if (prazoMeses === Infinity) {
    const el = document.getElementById('meta-prazo-atual');
    el.textContent = 'NÃ£o alcanÃ§a'; el.style.color = 'var(--orange)';
    document.getElementById('meta-prazo-sub').textContent = 'aumente o aporte ou o prazo';
  } else {
    const a = Math.floor(prazoMeses / 12), mo = prazoMeses % 12;
    const el = document.getElementById('meta-prazo-atual');
    el.textContent = `${a}a${mo > 0 ? ' ' + mo + 'm' : ''}`;
    el.style.color = prazoMeses <= n * 12 ? 'var(--green)' : 'var(--blue)';
    document.getElementById('meta-prazo-sub').textContent = `aportando ${fmtBRL(aporteJa)}/mÃªs`;
  }

  document.getElementById('meta-total-aportado').textContent = fmtBRL(totalAportado);
  document.getElementById('meta-total-sub').textContent = `${fmtBRL(atual)} inicial + ${fmtBRL(aporteNec)}/mÃªs Ã— ${prazo} anos`;
  document.getElementById('meta-juros').textContent = fmtBRL(Math.max(juros, 0));
  document.getElementById('meta-juros-pct').textContent = `${jurosPct}% do total veio dos juros compostos`;
  document.getElementById('meta-valor-real').textContent = fmtBRL(alvoReal);
  document.getElementById('meta-real-sub').textContent = `${fmtBRL(alvo)} corrigido por ${inflacao}% de inflaÃ§Ã£o`;

  buildMetaScenarios(alvo, atual, prazo);
  buildMetaChart(alvo, atual, aporteNec, rMes, n);
  buildMetaMilestones(alvo, atual, aporteNec, rMes, n);
}

function buildMetaScenarios(alvo, atual, prazo) {
  const scenarios = [
    { label: 'Conservador', taxa: 7.0,  cor: 'var(--blue)' },
    { label: 'Moderado',    taxa: 11.0, cor: 'var(--violet)' },
    { label: 'Otimista',    taxa: 14.0, cor: 'var(--green)' },
    { label: 'Selic atual', taxa: 15.0, cor: 'var(--yellow)' },
  ];
  const grid = document.getElementById('meta-scenarios-grid');
  grid.innerHTML = '';
  const n = prazo * 12;

  scenarios.forEach(sc => {
    const r = Math.pow(1 + sc.taxa / 100, 1 / 12) - 1;
    const fvA = atual * Math.pow(1 + r, n);
    const falta = Math.max(alvo - fvA, 0);
    const ap = falta === 0 ? 0 : r === 0 ? falta / n : falta * r / (Math.pow(1 + r, n) - 1);
    const total = atual + ap * n;
    const div = document.createElement('div');
    div.className = 'meta-scenario-card';
    div.innerHTML = `
      <div class="meta-sc-label">${sc.label}</div>
      <div class="meta-sc-rate" style="color:${sc.cor};">${sc.taxa}% a.a.</div>
      <div class="meta-sc-val" style="color:${sc.cor};">${fmtBRL(ap)}<span style="font-size:11px;">/mÃªs</span></div>
      <div class="meta-sc-sub">total investido: ${fmtBRL(total)}</div>`;
    grid.appendChild(div);
  });
}

function buildMetaChart(alvo, atual, aporteNec, rMes, n) {
  const cs = getComputedStyle(document.documentElement);
  const cGrid = cs.getPropertyValue('--chart-grid').trim();
  const cTick = cs.getPropertyValue('--chart-tick').trim();
  const cBorder = cs.getPropertyValue('--border').trim();
  const cTip = cs.getPropertyValue('--tooltip-bg').trim();
  const cMuted = cs.getPropertyValue('--muted').trim();
  const cText = cs.getPropertyValue('--text').trim();

  const labels = [], patrimData = [], aportadoData = [];
  const step = Math.max(1, Math.ceil(n / 40));
  for (let m = 0; m <= n; m += step) {
    labels.push((m / 12).toFixed(m % 12 === 0 ? 0 : 1) + 'a');
    const pat = atual * Math.pow(1 + rMes, m) +
      (rMes === 0 ? aporteNec * m : aporteNec * (Math.pow(1 + rMes, m) - 1) / rMes);
    patrimData.push(pat);
    aportadoData.push(atual + aporteNec * m);
  }

  const ctx = document.getElementById('metaChart').getContext('2d');
  if (metaChart) metaChart.destroy();
  metaChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        { label: 'PatrimÃ´nio acumulado', data: patrimData,
          borderColor: '#3dd68c', backgroundColor: 'rgba(61,214,140,.1)',
          borderWidth: 2.5, pointRadius: 2, tension: 0.4, fill: true },
        { label: 'Total aportado', data: aportadoData,
          borderColor: '#556070', backgroundColor: 'transparent',
          borderWidth: 1.5, borderDash: [5, 4], pointRadius: 0 }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: { display: false },
        tooltip: { backgroundColor: cTip, borderColor: cBorder, borderWidth: 1,
          titleColor: cMuted, bodyColor: cText, padding: 12,
          titleFont: { family: 'DM Mono', size: 10 }, bodyFont: { family: 'DM Mono', size: 11 },
          callbacks: { label: i => `  ${i.dataset.label}: ${fmtBRL(i.raw)}` } }
      },
      scales: {
        x: { grid: { color: cGrid }, ticks: { color: cTick, font: { family: 'DM Mono', size: 9 }, maxTicksLimit: 10 }, border: { color: cBorder } },
        y: { grid: { color: cGrid }, border: { color: cBorder },
          ticks: { color: cTick, font: { family: 'DM Mono', size: 9 },
            callback: v => v >= 1e6 ? (v / 1e6).toFixed(1) + ' mi' : v >= 1e3 ? (v / 1e3).toFixed(0) + 'k' : v } }
      }
    }
  });

  const lgd = document.getElementById('meta-legend');
  lgd.innerHTML = '';
  [['#3dd68c', 'PatrimÃ´nio acumulado'], ['#556070', 'Total aportado']].forEach(([cor, label]) => {
    const d = document.createElement('div'); d.className = 'legend-item';
    d.innerHTML = `<div class="legend-line" style="background:${cor}"></div><span>${label}</span>`;
    lgd.appendChild(d);
  });
}

function buildMetaMilestones(alvo, atual, aporte, rMes, n) {
  const container = document.getElementById('meta-milestones');
  container.innerHTML = '';
  [10, 25, 50, 75, 90, 100].forEach(pct => {
    const meta = alvo * pct / 100;
    let acum = atual, meses = 0;
    while (acum < meta && meses < n + 1) {
      acum = acum * (1 + rMes) + aporte; meses++;
    }
    const div = document.createElement('div');
    div.className = 'meta-milestone';
    if (meses <= n) {
      const a = Math.floor(meses / 12), mo = meses % 12;
      div.innerHTML = `
        <div class="meta-ms-year">${pct}% da meta</div>
        <div class="meta-ms-val">${a}a${mo > 0 ? ' ' + mo + 'm' : ''}</div>
        <div class="meta-ms-pct">${fmtBRL(meta)}</div>
        ${pct === 100 ? '<div class="meta-ms-mark">META ATINGIDA</div>' : ''}`;
    } else {
      div.innerHTML = `<div class="meta-ms-year">${pct}% da meta</div>
        <div class="meta-ms-val" style="color:var(--muted);">AlÃ©m do prazo</div>
        <div class="meta-ms-pct">${fmtBRL(meta)}</div>`;
    }
    container.appendChild(div);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PREÃ‡O JUSTO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function calcPreco() {
  const preco      = parseFloat(document.getElementById('pj-preco').value)       || 0;
  const lpa        = parseFloat(document.getElementById('pj-lpa').value)         || 0;
  const vpa        = parseFloat(document.getElementById('pj-vpa').value)         || 0;
  const dpa = parseFloat(document.getElementById('pj-dpa').value) || 0;

  // Bazin: DPA (R$) Ã· 0,06  â€” usa dividendo real, nÃ£o derivado do preÃ§o atual
  const bazin = dpa > 0 ? dpa / 0.06 : 0;

  // Graham: âˆš(22,5 Ã— LPA Ã— VPA)
  const prod = 22.5 * lpa * vpa;
  const graham = prod > 0 ? Math.sqrt(prod) : 0;

  function margem(justo) {
    if (!justo || !preco) return { txt: 'N/A', cls: '' };
    const pct = (justo - preco) / preco * 100;
    return { txt: (pct >= 0 ? '+' : '') + pct.toFixed(1) + '%', cls: pct >= 0 ? 'positiva' : 'negativa' };
  }
  function veredito(justo) {
    if (!justo || !preco) return { txt: 'Sem dados', cls: '' };
    const pct = (justo - preco) / preco * 100;
    if (pct >= 25)  return { txt: 'Grande oportunidade', cls: 'compra' };
    if (pct >= 5)   return { txt: 'Barata', cls: 'compra' };
    if (pct >= -5)  return { txt: 'PreÃ§o justo', cls: 'neutra' };
    if (pct >= -25) return { txt: 'Cara', cls: 'cara' };
    return { txt: 'Muito cara', cls: 'cara' };
  }

  function renderMethod(prefix, justo, naAplic) {
    const valEl = document.getElementById(`pj-${prefix}-val`);
    const mel   = document.getElementById(`pj-${prefix}-margem`);
    const vel   = document.getElementById(`pj-${prefix}-veredicto`);
    if (naAplic) {
      valEl.textContent = 'NÃ£o aplicÃ¡vel'; valEl.style.color = 'var(--muted)';
      mel.textContent = ''; mel.className = 'pj-margem';
      vel.textContent = 'Sem dados'; vel.className = 'pj-veredicto';
      return;
    }
    valEl.style.color = '';
    valEl.textContent = justo > 0 ? `R$ ${justo.toFixed(2)}` : 'N/A';
    const m = margem(justo);
    mel.textContent = m.txt; mel.className = `pj-margem ${m.cls}`;
    const v = veredito(justo);
    vel.textContent = v.txt; vel.className = `pj-veredicto ${v.cls}`;
  }

  renderMethod('bazin',  bazin,  dpa <= 0);
  renderMethod('graham', graham, lpa <= 0 || vpa <= 0);

  // Sector warnings
  const warnings = [];
  const pvpCalc = vpa > 0 ? preco / vpa : 0;
  if (pvpCalc > 0 && pvpCalc < 0.7) warnings.push({ title: 'PossÃ­vel banco ou financeira', msg: 'P/VP muito baixo (abaixo de 0,7) Ã© comum em bancos e financeiras, onde a alavancagem distorce o patrimÃ´nio lÃ­quido. O modelo de Graham pode subestimar o valor real nesse setor.' });
  if (dpa <= 0) warnings.push({ title: 'Empresa sem dividendos', msg: 'Bazin nÃ£o se aplica a empresas que nÃ£o distribuem proventos. Comum em techs, startups e empresas farmacÃªuticas em expansÃ£o que reinvestem todo o lucro. Considere usar P/L e crescimento de receita como guia.' });
  const plCalc = lpa > 0 ? preco / lpa : 0;
  if (lpa <= 0) warnings.push({ title: 'LPA negativo ou zero', msg: 'Empresa com prejuÃ­zo. Graham nÃ£o se aplica. Verifique se Ã© uma situaÃ§Ã£o pontual (despesa nÃ£o recorrente) ou tendÃªncia. Setores como energia renovÃ¡vel e farmacÃªutico em P&D costumam ter LPA negativo temporÃ¡rio.' });
  if (plCalc > 0 && plCalc > 40) warnings.push({ title: 'P/L muito elevado', msg: 'P/L acima de 40 pode indicar empresa de crescimento (tech, farmÃ¡cia) onde o mercado paga prÃªmio por expectativa futura. Bazin e Graham sÃ£o modelos de valor e podem sinalizar "cara" mesmo que o crescimento justifique o preÃ§o.' });

  const wb = document.getElementById('pj-sector-warning');
  if (warnings.length > 0) {
    wb.style.display = '';
    wb.innerHTML = warnings.map(w => `<div class="pj-sector-warning-inner"><div class="pj-sector-warning-icon">âš ï¸</div><div class="pj-sector-warning-text"><strong>${w.title}:</strong> ${w.msg}</div></div>`).join('');
  } else {
    wb.style.display = 'none';
    wb.innerHTML = '';
  }

  // Consenso â€” detecta divergÃªncia quando mÃ©todos apontam em direÃ§Ãµes opostas
  const validos = [bazin, graham].filter(v => v > 0);
  const media = validos.length > 0 ? validos.reduce((a, b) => a + b, 0) / validos.length : 0;

  document.getElementById('pj-media').textContent = media > 0 ? `R$ ${media.toFixed(2)}` : 'N/A';
  document.getElementById('pj-preco-atual-display').textContent = preco > 0 ? `R$ ${preco.toFixed(2)}` : 'N/A';

  const uEl = document.getElementById('pj-upside');
  if (media > 0 && preco > 0) {
    const up = ((media - preco) / preco * 100).toFixed(1);
    uEl.textContent = (parseFloat(up) >= 0 ? '+' : '') + up + '%';
    uEl.style.color = parseFloat(up) >= 0 ? 'var(--green)' : 'var(--orange)';
  } else { uEl.textContent = 'N/A'; uEl.style.color = ''; }

  const cEl = document.getElementById('pj-consenso-geral');
  // DivergÃªncia: ambos vÃ¡lidos mas um acima e outro abaixo do preÃ§o atual,
  // e a diferenÃ§a entre eles Ã© maior que 30% do preÃ§o
  const ambosValidos = bazin > 0 && graham > 0;
  const diverge = ambosValidos && Math.abs(bazin - graham) / preco > 0.3
    && ((bazin > preco && graham < preco) || (bazin < preco && graham > preco));

  if (diverge) {
    cEl.textContent = 'MÃ©todos divergem';
    cEl.className = 'pj-consenso-val pj-veredicto neutra';
    // add divergence to warnings banner
    const divWarn = document.getElementById('pj-diverge-warn');
    if (!divWarn) {
      const dw = document.createElement('div');
      dw.id = 'pj-diverge-warn';
      dw.className = 'pj-sector-warning-inner';
      dw.innerHTML = `<div class="pj-sector-warning-icon">ğŸ”€</div><div class="pj-sector-warning-text"><strong>MÃ©todos divergem:</strong> Bazin e Graham chegaram a conclusÃµes opostas sobre o preÃ§o atual. Isso costuma ocorrer quando a empresa tem perfil de crescimento (Graham valoriza ativos, Bazin valoriza dividendos). NÃ£o hÃ¡ consenso com os dados atuais. Analise cada mÃ©todo separadamente.</div>`;
      wb.style.display = '';
      wb.appendChild(dw);
    }
  } else {
    document.getElementById('pj-diverge-warn')?.remove();
    const cv = veredito(media);
    cEl.textContent = cv.txt;
    cEl.className = `pj-consenso-val pj-veredicto ${cv.cls}`;
  }

  // Indicadores
  const pl  = lpa  > 0 ? preco / lpa  : 0;
  const pvp = vpa  > 0 ? preco / vpa  : 0;
  const indicators = [
    { label: 'P/L',           val: pl   > 0 ? pl.toFixed(2)  : 'N/A', ref: 'Ideal abaixo de 15',  cls: pl > 0 && pl <= 15 ? 'pj-ind-ok' : pl > 0 && pl <= 25 ? 'pj-ind-warn' : 'pj-ind-bad' },
    { label: 'P/VP',          val: pvp  > 0 ? pvp.toFixed(2) : 'N/A', ref: 'Ideal abaixo de 1,5', cls: pvp > 0 && pvp <= 1.5 ? 'pj-ind-ok' : pvp > 0 && pvp <= 3 ? 'pj-ind-warn' : 'pj-ind-bad' },
    { label: 'DPA (R$)',       val: dpa > 0 ? 'R$ ' + dpa.toFixed(2) : 'N/A', ref: 'Dividendo real anual por aÃ§Ã£o', cls: dpa > 0 ? 'pj-ind-ok' : 'pj-ind-bad' },
    { label: 'DY implÃ­cito',  val: preco > 0 && dpa > 0 ? (dpa/preco*100).toFixed(2)+'%' : 'N/A', ref: 'DPA Ã· preÃ§o atual', cls: preco > 0 && dpa > 0 && (dpa/preco*100) >= 6 ? 'pj-ind-ok' : preco > 0 && dpa > 0 && (dpa/preco*100) >= 3 ? 'pj-ind-warn' : 'pj-ind-bad' },
    { label: 'vs Bazin',      val: bazin > 0 ? (preco / bazin).toFixed(2) + 'x' : 'N/A', ref: 'Abaixo de 1x = barata', cls: bazin > 0 && preco <= bazin ? 'pj-ind-ok' : 'pj-ind-bad' },
    { label: 'vs Graham',     val: graham > 0 ? (preco / graham).toFixed(2) + 'x' : 'N/A', ref: 'Abaixo de 1x = barata', cls: graham > 0 && preco <= graham ? 'pj-ind-ok' : 'pj-ind-bad' },
  ];
  const igrid = document.getElementById('pj-indicators');
  igrid.innerHTML = '';
  indicators.forEach(ind => {
    const d = document.createElement('div'); d.className = 'pj-indicator';
    d.innerHTML = `<div class="pj-ind-label">${ind.label}</div>
      <div class="pj-ind-val ${ind.cls}">${ind.val}</div>
      <div class="pj-ind-ref">${ind.ref}</div>`;
    igrid.appendChild(d);
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// PRINT / PDF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function printPreco() {
  // Ensure the preco tab is visible then print
  showTab('preco');
  setTimeout(() => window.print(), 150);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// EVENT LISTENERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Simulador inputs
document.querySelectorAll('#tab-simulador input[type=number]').forEach(el=>{
  el.addEventListener('input', buildAll);
});

// â”€â”€ CDB IR auto-mapping from horizon â”€â”€
const CDB_IR_MAP = { 6: 22.5, 12: 20, 24: 17.5, 60: 15, 120: 15, 180: 15, 240: 15 };
const CDB_IR_DESC = {
  6:   'â‰¤ 180 dias Â· alÃ­quota mÃ¡xima',
  12:  '181â€“360 dias',
  24:  '361â€“720 dias',
  60:  'acima de 720 dias',
  120: 'acima de 720 dias',
  180: 'acima de 720 dias',
  240: 'acima de 720 dias'
};

function updateCdbIrFromMonths(months) {
  cdbIRpct = CDB_IR_MAP[months] ?? 15;
  const lbl  = document.getElementById('cdbIrAutoLabel');
  const desc = document.getElementById('cdbIrAutoDesc');
  if (lbl)  lbl.textContent  = cdbIRpct.toString().replace('.', ',') + '%';
  if (desc) desc.textContent = (CDB_IR_DESC[months] ?? 'acima de 720 dias') + ' Â· ajusta conforme o prazo selecionado no ranking';
}

// Dividend toggle
const toggleInput = document.getElementById('reinvestToggle');
toggleInput.addEventListener('change',()=>{
  reinvestDivs = toggleInput.checked;
  const aporteNote = document.getElementById('aporteNote');
  const toggleText = document.getElementById('toggleText');
  const divDesc    = document.getElementById('divDescription');
  if (reinvestDivs) {
    toggleText.textContent = 'Reinvestindo dividendos';
    toggleText.classList.add('on');
    divDesc.innerHTML = '<span class="tag-on">âœ¦ Ativado:</span> dividendos compram mais aÃ§Ãµes â†’ portfÃ³lio cresce pelo total return (preÃ§o + DY). DY distribuÃ­do de forma linear mensal (aproximaÃ§Ã£o padrÃ£o de simuladores de longo prazo).';
    aporteNote.textContent = '100% reinvestido';
  } else {
    toggleText.textContent = 'Sacando dividendos';
    toggleText.classList.remove('on');
    divDesc.innerHTML = '<span class="tag-off">âœ¦ Desativado:</span> portfÃ³lio cresce pela valorizaÃ§Ã£o do preÃ§o. Dividendos acumulam como caixa separado. <em>Estimativa simplificada:</em> IR de 15% sÃ³ sobre ganho de preÃ§o na venda, sem isenÃ§Ã£o de R$20k/mÃªs nem compensaÃ§Ã£o de perdas. Dividendos tratados como isentos.';
    aporteNote.textContent = 'dividendos nÃ£o reinvestidos';
  }
  buildAll();
});

// Ranking tabs
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    btn.classList.add('active');
    activeMonths = parseInt(btn.dataset.months);
    updateCdbIrFromMonths(activeMonths);
    buildRanking();
  });
});

// Reserva inputs
document.querySelectorAll('#tab-reserva input, #tab-reserva select').forEach(el=>{
  el.addEventListener('input', calcReserva);
  el.addEventListener('change', calcReserva);
});

// AÃ§Ãµes inputs
document.querySelectorAll('#tab-acoes input[type=number], #tab-acoes input[type=text]').forEach(el=>{
  el.addEventListener('input', calcAcoes);
});
document.getElementById('ac-reinvest').addEventListener('change', function() {
  const lbl  = document.getElementById('ac-reinvest-label');
  const note = document.getElementById('ac-reinvest-note');
  lbl.textContent  = this.checked ? 'Sim' : 'NÃ£o';
  lbl.classList.toggle('on', this.checked);
  note.textContent = this.checked ? 'dividendos compram mais aÃ§Ãµes' : 'dividendos acumulam como caixa';
  calcAcoes();
});

// FIRE inputs
document.querySelectorAll('#tab-fire input[type=number]').forEach(el=>{
  el.addEventListener('input', calcFire);
});

// Filhos toggle label
document.getElementById('res-filhos').addEventListener('change', function() {
  document.getElementById('filhosLabel').textContent = this.checked ? 'Sim' : 'NÃ£o';
  document.getElementById('filhosLabel').classList.toggle('on', this.checked);
  calcReserva();
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
applyTheme('light');
updateCdbIrFromMonths(activeMonths);
buildAll();
rebuildProfiles();

// Fix chart resize on browser zoom, full rebuild with debounce
let resizeTimer = null;
function onResize() {
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(() => {
    // Reset main chart canvas
    const canvas = document.getElementById('mainChart');
    if (canvas) { canvas.style.width = '0'; canvas.style.height = '0'; }
    buildChart();
    buildLegend();

    // Reset reserva chart canvases
    const donut = document.getElementById('resDonut');
    const line  = document.getElementById('resLine');
    const acCv  = document.getElementById('acChart');
    if (donut) { donut.style.width = '0'; donut.style.height = '0'; }
    if (line)  { line.style.width  = '0'; line.style.height  = '0'; }
    if (acCv)  { acCv.style.width  = '0'; acCv.style.height  = '0'; }
    const fireCv = document.getElementById('fireChart');
    if (fireCv) { fireCv.style.width = '0'; fireCv.style.height = '0'; }
    if (resDonutChart) resDonutChart.resize();
    if (resLineChart)  resLineChart.resize();
    if (acChart)       acChart.resize();
    if (fireChart)     fireChart.resize();
  }, 120);
}
if (window.ResizeObserver) {
  new ResizeObserver(onResize).observe(document.querySelector('.chart-wrap'));
  const resCharts = document.querySelector('.res-charts');
  if (resCharts) new ResizeObserver(onResize).observe(resCharts);
}
window.addEventListener('resize', onResize);
</script>
</body>
</html>
